<!DOCTYPE html>

<html lang="es">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1, viewport-fit=cover" name="viewport"/>
<title>V104_TRANSPORT_PLACES_SAFE (hotfix)</title>
<meta content="#1d4ed8" name="theme-color"/>
<link href="manifest.json" rel="manifest"/>
<script src="https://cdn.tailwindcss.com"></script>
<script>
// Data-based delete (global)
function getActiveScenario() {
  // Active scenario (A/B)
  if (typeof curScenario === "function") return curScenario();
  if (typeof state !== "undefined" && state && state.scenarios && state.scenario) return state.scenarios[state.scenario];
  return null;
}
function toast(msg){ try{ alert(msg); }catch{} }
function deleteItemById(kind, id) {
  const sc = getActiveScenario();
  if (!sc) return false;
  const k = String(kind || "").trim();
  const targetId = String(id);
  const arr = (k==="leg") ? sc.legs : (k==="stay") ? sc.stays : (k==="act") ? sc.activities : null;
  if(!arr) return false;
  const idx = arr.findIndex(x => String(x && x.id) === targetId);
  if(idx < 0) return false;
  arr.splice(idx,1);
  return true;
}
</script>
<style>
    /* iPhone safe-area helpers */
    .safe-b { padding-bottom: max(env(safe-area-inset-bottom), 16px); }
    .safe-t { padding-top: max(env(safe-area-inset-top), 12px); }
    .tap { -webkit-tap-highlight-color: transparent; }
  
    /* Read-only mode */
    body.readonly-mode button[disabled],
    body.readonly-mode input[disabled],
    body.readonly-mode select[disabled],
    body.readonly-mode textarea[disabled]{
      opacity: .55;
      cursor: not-allowed;
    }

  /* Timeline highlighting */
  .timelineItem.past { opacity: 0.45; }
  .timelineItem.today { background-color: #ecfdf5; border-color: #10b981; }


.ios-scroll{ -webkit-overflow-scrolling: touch; }

    /* Activities: done/skipped (minimal) */
    .done-item { opacity: 0.55; }
    .done-text { text-decoration: line-through; }
    .skipped-item { opacity: 0.55; }
    .skipped-badge { color: #b91c1c; } /* red-700 */
    .auto-badge { color: #64748b; } /* slate-500 */

    /* Timeline UX states (v32+) ‚Äî force override Tailwind bg/border utilities */
.timelineItem.tl-today{
  background-color: rgba(16,185,129,0.10) !important;
  border-color: rgba(16,185,129,0.22) !important;
}
.timelineItem.tl-today-done{
  background-color: rgba(59,130,246,0.12) !important;
  border-color: rgba(59,130,246,0.28) !important;
}
.timelineItem.tl-auto-done{
  background-color: rgba(100,116,139,0.08) !important;
  border-color: rgba(100,116,139,0.18) !important;
}
.timelineItem.tl-skipped{
  background-color: rgba(239,68,68,0.10) !important;
  border-color: rgba(239,68,68,0.25) !important;
}
.timelineItem.tl-future{
  background-color: rgba(234,179,8,0.08) !important;
  border-color: rgba(234,179,8,0.20) !important;
}


    /* Timeline item notes button */
    .timelineItem .notes-has { font-weight: 700; }

  

/* Timeline notes indicator (v46) */
.tlNotesBtn {
  position: relative;
  opacity: 0.6;
  transition: opacity .15s ease, transform .1s ease;
}

.tlNotesBtn.notes-has {
  opacity: 1;
  transform: scale(1.05);
}

.tlNotesBtn .note-dot {
  position: absolute;
  top: -2px;
  right: -2px;
  width: 8px;
  height: 8px;
  background: #2563eb; /* azul elegante */
  border-radius: 50%;
  box-shadow: 0 0 0 2px white;
}


/* Daily notes in timeline (v46 daily notes highlight + CRUD) */
.tl-dnote { background: rgba(148,163,184,0.10); border-color: rgba(148,163,184,0.25); }
.tl-dnote-has { }
.noteDateActive { background: rgba(59,130,246,0.10); border-color: rgba(59,130,246,0.25); }

    #stickyTotalBar{
      position: fixed;
      left: 0;
      right: 0;
      top: var(--app-header-h, 56px);
      z-index: 950;
    }


    /* --- v50 UX: Sticky summary detail panel + hide legacy summary card --- */
    #summary, #summaryDetail { display: none !important; }
    #stickySummaryDetailInner .row { display:flex; justify-content:space-between; gap:12px; padding:4px 0; }
    #stickySummaryDetailInner .lbl { color: rgb(100 116 139); }
    #stickySummaryDetailInner .val { font-weight: 600; }
    #stickySummaryDetailInner .total { font-weight: 800; }


  /* hide horizontal scrollbar for chips */
  .no-scrollbar::-webkit-scrollbar{display:none}
  .no-scrollbar{-ms-overflow-style:none;scrollbar-width:none}


/* Toggle robusto sin depender de Tailwind din√°mico */
.seg-btn{
  border: 1px solid #e2e8f0;
  background: #ffffff;
  color: #0f172a;
}
.seg-btn.seg-active{
  background: #0f172a;
  border-color: #0f172a;
  color: #ffffff;
}
.seg-btn.seg-inactive{
  background: #ffffff;
  border-color: #e2e8f0;
  color: #0f172a;
}


/* --- v78: Fixed header + fixed totals + spacer --- */
#appHeader{
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  z-index: 1000;
}
#topStackSpacer{ height: calc(var(--app-header-h, 56px) + var(--sticky-totals-h, 0px)); }


/* Timeline time badges (v88) */
.tlTimeBadge{
  display:inline-block;
  padding:2px 8px;
  border-radius:999px;
  font-weight:700;
  font-size:11px;
  line-height:1.2;
  border:1px solid rgba(148,163,184,0.35);
}
.tlTimeToday{ background: rgba(16,185,129,0.14); color:#065f46; border-color: rgba(16,185,129,0.30); }
.tlTimeFuture{ background: rgba(59,130,246,0.10); color:#1d4ed8; border-color: rgba(59,130,246,0.22); }
.tlTimePast{ background: rgba(100,116,139,0.10); color:#334155; border-color: rgba(100,116,139,0.22); }
.tlTimeNone{ background: rgba(148,163,184,0.10); color:#475569; }


/* --- v88c2: Tools bottom sheet (iOS-style) --- */
#toolsBackdrop{
  opacity: 0;
  transition: opacity .22s ease;
  pointer-events: none;
}
#toolsBackdrop.open{
  opacity: 1;
  pointer-events: auto;
}
#toolsSheet{
  pointer-events: none;
  transform: translateY(105%);
  transition: transform .28s cubic-bezier(.2,.8,.2,1);
  will-change: transform;
}
#toolsSheet.open{
  pointer-events: auto;
  transform: translateY(0);
}


    /* Views stable scroll container */
    html, body { height: 100%; overflow: hidden; }
    #mainScroll{
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  overflow: auto;
  -webkit-overflow-scrolling: touch;
  padding-top: var(--top-stack-h, 0px);
  padding-bottom: var(--bottom-nav-h, 0px);
}


/* V89C2b: Fix initial gap (single top-stack compensation) */
#topStackSpacer{ display:none !important; height:0 !important; }

/* Bottom nav must always be visible and outside scroll container */
#bottomNav{ position: fixed; bottom:0; left:0; right:0; z-index:3000; }

/* Ensure scroll container never overlays bottom nav */
#mainScroll{ z-index:0; }

/* FAB add per-view */
#fabAdd{
  position: fixed;
  left: 14px;
  right: auto;
  bottom: calc(var(--bottom-nav-h, 64px) + 16px);
  width: 56px;
  height: 56px;
  border-radius: 999px;
  border: none;
  font-size: 30px;
  line-height: 56px;
  font-weight: 900;
  background: #2563eb;
  color: #fff;
  box-shadow: 0 10px 25px rgba(2,6,23,0.22);
  z-index: 2500;
}
#fabAdd:active{ transform: scale(0.98); }


/* Event Detail Sheet (V89D) */
#eventSheetOverlay{
  position: fixed;
  top: var(--top-stack-h, 0px);
  left: 0; right: 0;
  bottom: var(--bottom-nav-h, 0px);
  background: rgba(0,0,0,0.35);
  z-index: 7000;
}
#eventSheetOverlay.hidden{ display:none; }
#eventSheet{
  position: absolute;
  left: 0; right: 0;
  bottom: 0;
  height: 100%;
  background: #fff;
  border-top-left-radius: 18px;
  border-top-right-radius: 18px;
  box-shadow: 0 -10px 30px rgba(0,0,0,0.15);
  transform: translateY(12px);
  transition: transform 180ms ease;
  display: flex;
  flex-direction: column;
}
#eventSheetOverlay:not(.hidden) #eventSheet{ transform: translateY(0); }
#eventSheetHeader{
  position: sticky;
  top: 0;
  background: #fff;
  z-index: 1;
  padding: 12px 14px;
  border-bottom: 1px solid #e5e7eb;
  display:flex;
  align-items:center;
  justify-content: space-between;
  gap: 12px;
}

#eventSheetClose{ position: relative; z-index: 3; }
#eventSheetBody{
  padding: 12px 14px;
  overflow: auto;
  -webkit-overflow-scrolling: touch;
  flex: 1;
}
body.sheet-open #mainScroll{ overflow: hidden; }
body.sheet-open #eventSheetOverlay{ pointer-events: auto; }

/* Sheet: hide legacy per-item trash buttons to enforce single trash */
#eventSheetBody [data-leg-del],
#eventSheetBody [data-stay-del],
#eventSheetBody [data-act-del] { display:none !important; }


/* -------- Event Sheet premium layout (V89E) -------- */
#eventSheetOverlay{ position:fixed; inset:0; z-index:7000; background:rgba(0,0,0,.35); }
#eventSheet{
  position:fixed; left:0; right:0;
  top: var(--top-stack-h);
  bottom: var(--bottom-nav-h);
  background:#fff;
  border-radius:16px 16px 0 0;
  display:flex; flex-direction:column;
  overflow:hidden;
}
#eventSheetHeader{
  position:sticky; top:0; z-index:9100;
  background:#fff;
  border-bottom:1px solid #e2e8f0;
  padding:10px 12px;
  display:flex; align-items:center; justify-content:space-between; gap:10px;
}
#eventSheetHeader .esHeadLeft{ min-width:0; display:flex; flex-direction:column; gap:2px; }
#eventSheetHeader .esTypeLine{ display:flex; align-items:center; gap:8px; font-weight:800; font-size:12px; color:#0f172a; text-transform:uppercase; letter-spacing:.02em; }
#eventSheetHeader .esSubtitle{ font-weight:700; font-size:14px; color:#0f172a; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
#eventSheetHeader .esHeadRight{ display:flex; align-items:center; gap:8px; }
#eventSheetHeader .esIconBtn{ border:1px solid #e2e8f0; background:#fff; border-radius:12px; padding:8px 10px; font-size:14px; }
.esIconBtn.is-active{ background:#dbeafe; border-color:#93c5fd; box-shadow:0 0 0 2px rgba(59,130,246,0.15) inset; }
.esIconBtn.is-active{ color:#0f172a; }

#eventSheetBody{
  flex:1;
  overflow:auto;
  -webkit-overflow-scrolling:touch;
  padding:12px;
  padding-bottom: max(env(safe-area-inset-bottom), 16px);
}
#eventSheetFooter{
  position:sticky; bottom:0; z-index:9100;
  background:#fff;
  border-top:1px solid #e2e8f0;
  padding:10px 12px;
  display:flex; align-items:center; gap:10px;
  padding-bottom:max(env(safe-area-inset-bottom), 10px);
}
#eventSheetSave{ flex:1; background:#0f172a; color:#fff; border-radius:14px; padding:12px 14px; font-weight:900; }
#eventSheetSaveFeedback{ font-size:12px; font-weight:800; color:#0f172a; background:#e2e8f0; padding:6px 10px; border-radius:999px; white-space:nowrap; }
.esBlock{ border:1px solid #e2e8f0; border-radius:14px; padding:10px; margin-bottom:10px; background:#fff; }
.esBlockTitle{ font-size:11px; font-weight:900; color:#334155; text-transform:uppercase; letter-spacing:.03em; margin-bottom:8px; }
#eventSheetMoreDetails summary{ list-style:none; cursor:pointer; display:flex; align-items:center; justify-content:space-between; gap:10px; }
#eventSheetMoreDetails summary::-webkit-details-marker{ display:none; }


/* V89E1A fixes: ensure sheet footer visible */
#eventSheetFooter{ display:flex !important; background:#fff; }
#eventSheetSave{ display:block !important; }
#eventSheetBody{ padding-bottom: calc(max(env(safe-area-inset-bottom), 16px) + 88px) !important; }


/* V89E2: ensure sheet save footer always visible */
#eventSheetFooter{
  position: sticky !important;
  bottom: 0 !important;
  z-index: 9150 !important;
  background: #fff !important;
  padding-bottom: max(env(safe-area-inset-bottom), 10px) !important;
}
#eventSheet{
  height: calc(100vh - var(--top-stack-h) - var(--bottom-nav-h)) !important;
}
#eventSheetBody{
  padding-bottom: calc(max(env(safe-area-inset-bottom), 16px) + 96px) !important;
}


/* V89E3: harden sheet footer visibility */
#eventSheetFooter{ display:flex !important; position: sticky !important; bottom:0 !important; z-index: 9200 !important; background:#fff !important; }
#eventSheetSave{ display:block !important; }
#eventSheetBody{ padding-bottom: calc(max(env(safe-area-inset-bottom), 16px) + 110px) !important; }


/* V89E3: leg sheet 2-column layout using existing fields */
#eventSheetBody .sheet-leg-editor .grid{
  display: grid !important;
  grid-template-columns: 1fr 1fr !important;
  gap: 10px !important;
}
#eventSheetBody .sheet-leg-editor .grid > div{ width: auto !important; }
#eventSheetBody .sheet-leg-editor .grid .sm\:col-span-3,
#eventSheetBody .sheet-leg-editor .grid .sm\:col-span-2{
  grid-column: auto !important;
}
#eventSheetBody .sheet-leg-editor .grid [data-leg-date],
#eventSheetBody .sheet-leg-editor .grid [data-leg-time],
#eventSheetBody .sheet-leg-editor .grid [data-leg-cost]{
  grid-column: span 2 !important; /* date/time/cost full width to avoid missing arrival fields */
}
#eventSheetBody .sheet-leg-editor [data-leg-del]{ display:none !important; } /* use sheet trash */


/* V89E4: Transport sheet form-first layout */
#eventSheetBody .sheet-leg-editor .grid{
  display:grid !important;
  grid-template-columns: 1fr 1fr !important;
  gap: 10px !important;
}
#eventSheetBody .sheet-leg-editor .grid > div{ width:auto !important; }
#eventSheetBody .sheet-leg-editor .grid .sm\:col-span-3,
#eventSheetBody .sheet-leg-editor .grid .sm\:col-span-2{ grid-column:auto !important; }
#eventSheetBody .sheet-leg-editor .grid [data-leg-cost]{ grid-column: 1 / -1 !important; }
#eventSheetBody .sheet-leg-editor [data-leg-del],
#eventSheetBody .sheet-leg-editor [data-leg-done]{ display:none !important; }


/* V89E5E..V89E5E8 (historical leg-sheet duplicates) cleaned.
   See FINAL: Sheet Transporte single source of truth (end of <style>).
*/

/* FINAL: Sheet Transporte single source of truth */
/* Keeps current appearance/behavior; consolidates leg-sheet + sheet UI rules that were duplicated historically. */

/* Header cleanup (keep header clean, no redundant type/summary lines) */
#eventSheetHeader .esTypeLine{ display:none !important; }
#eventSheetSummaryLine{ display:none !important; }

/* Sheet mini-modals (UI only) ‚Äî always above sheet + block sheet interaction */
#sheetMiniOverlay{
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,.35);
  z-index: 9800 !important;
  pointer-events: auto;
}
.sheetMiniModal{
  position: fixed;
  left: 12px;
  right: 12px;
  top: 18%;
  background: #fff;
  border-radius: 16px;
  z-index: 9900 !important;
  box-shadow: 0 10px 30px rgba(0,0,0,.2);
  overflow: hidden;
  pointer-events: auto;
}
.sheetMiniHeader{
  display:flex;
  align-items:center;
  justify-content:space-between;
  padding: 12px 14px;
  border-bottom: 1px solid rgba(0,0,0,.08);
}
.sheetMiniTitle{ font-weight: 700; }
.sheetMiniClose{
  width:36px;height:36px;border-radius:12px;
}
.sheetMiniBody{ padding: 12px 14px; }

body.mini-open #eventSheet{ pointer-events: none; }
body.mini-open #eventSheetOverlay{ pointer-events: none; }
body.mini-open .sheetMiniModal,
body.mini-open #sheetMiniOverlay{ pointer-events: auto; }

/* iOS no-zoom on form fields inside event sheet (CSS-only) */
#eventSheet, #eventSheetBody{
  -webkit-text-size-adjust: 100%;
  text-size-adjust: 100%;
}
#eventSheetBody input,
#eventSheetBody select,
#eventSheetBody textarea{
  font-size: 16px !important; /* clave para evitar auto-zoom iOS */
  -webkit-transform: translateZ(0);
  transform: translateZ(0);
}
/* Keep date/time at 16px; DO NOT change compact sizing */
#eventSheetBody input[type="date"],
#eventSheetBody input[type="time"]{
  font-size: 16px !important;
}

#eventSheetBody .sheet-leg-editor{
  font-size: 14px !important;
}
#eventSheetBody .sheet-leg-editor label{
  font-size: 12px !important;
  line-height: 1.1 !important;
}

/* Grid gaps (active values) */
#eventSheetBody .sheet-leg-editor .grid{
  column-gap: 14px !important;
  row-gap: 10px !important;
}

/* Make children shrink correctly in 2-col layout */
#eventSheetBody .sheet-leg-editor .grid > *,
#eventSheetBody .sheet-leg-editor .grid > div{
  min-width: 0 !important;
}

/* Uniform inputs (Transport sheet only) */
#eventSheetBody .sheet-leg-editor input,
#eventSheetBody .sheet-leg-editor select,
#eventSheetBody .sheet-leg-editor textarea{
  height: 36px !important;
  padding: 6px 10px !important;
  border-radius: 14px !important;
}

#eventSheetBody .sheet-leg-editor textarea{
  height: auto !important;
  min-height: 72px !important;
}

/* Date/Time compact XS (prevents overlap) */
#eventSheetBody .sheet-leg-editor input[type="date"],
#eventSheetBody .sheet-leg-editor input[type="time"]{
  width: 100% !important;
  max-width: 100% !important;
  height: 24px !important;
  padding: 0px 5px !important;
  line-height: 0.95 !important;
  font-size: 16px !important; /* keep iOS no-zoom */
}

/* UTC label */
#eventSheetBody .sheet-leg-editor .utcLabel{
  white-space: nowrap !important;
  font-size: 12px !important;
  opacity: .75 !important;
}


  .mv-nb{ white-space: nowrap; }

/* ---------------- Subsection fixed header (FIX10) ---------------- */
#subSectionHeader{
  position: fixed;
  left: 0;
  right: 0;
  top: var(--top-stack-h, 0px); /* default: under Totales */
  z-index: 940; /* below timelineControlsRow (950) */
  background: rgba(255,255,255,0.96);
  backdrop-filter: blur(10px);
  -webkit-backdrop-filter: blur(10px);
  border-bottom: 1px solid rgba(15,23,42,0.08);
}
body[data-view="timeline"] #subSectionHeader{
  top: var(--top-stack-h, 0px);
}
#view-legs,
#view-stays,
#view-acts,
#view-meals,
#view-timeline{
  /* Main scroll already compensates top stack (header + totales + subheader).
     Keep only a small breathing space to match other sections. */
  padding-top: 10px;
}

/* V91: timeline old controls are deprecated (kept in DOM but hidden) */
#timelineControlsRow,
#timelineControlsSpacer{
  display:none !important;
}

/* Hide duplicated in-scroll accordion headers (keep in DOM for listeners) */
button[data-acc="timeline"],
button[data-acc="legs"],
button[data-acc="stays"],
button[data-acc="meals"],
button[data-acc="acts"]{
  display: none !important;
}

/* Restore comfortable top padding lost when accordion header is hidden */
div[data-acc-body="timeline"],
div[data-acc-body="legs"],
div[data-acc-body="stays"],
div[data-acc-body="meals"],
div[data-acc-body="acts"]{
  padding-top: 1rem !important;
}
</style>
</head>
<body class="bg-slate-50 text-slate-900">
<!-- Tailwind safelist for classes toggled via JS -->
<div class="hidden bg-slate-900 border-slate-900 bg-slate-900 border-slate-900 text-white text-slate-800 opacity-40"></div>
<!-- Top bar -->
<header class="safe-t bg-white/90 backdrop-blur border-b border-slate-200" id="appHeader">
<div class="max-w-6xl mx-auto px-4 py-3 flex items-center justify-between gap-3">
<div class="flex items-center gap-3">
<img alt="MI VIAJE" class="w-10 h-10 rounded-2xl" src="icon.png"/>
<div class="leading-tight flex flex-col"><div class="flex items-center gap-2 flex-wrap"><div class="font-extrabold tracking-tight text-lg">VIAJE</div><div class="inline-flex items-center gap-1 bg-white border border-slate-200 rounded-2xl p-1"><button class="tap px-3 py-1.5 rounded-xl text-sm font-semibold" id="tabA">A</button><button class="tap px-3 py-1.5 rounded-xl text-sm font-semibold" id="tabB">B</button><button class="tap px-3 py-1.5 rounded-xl text-sm font-semibold opacity-40 cursor-not-allowed" disabled="disabled" id="tabPlus">+</button></div></div><div class="text-[11px] text-slate-500 font-semibold self-end mt-1" id="buildId">V104_TRANSPORT_PLACES_SAFE (hotfix)</div></div>
</div>
<div class="flex items-center gap-2">
<button aria-label="Tools" class="tap w-11 h-11 rounded-2xl border border-slate-200 bg-white hover:bg-slate-50 text-lg font-semibold flex items-center justify-center" id="btnTools" title="Tools">
          ‚öôÔ∏è
        </button></div>
</div>
</header>
<!-- Sticky mini total bar -->
<div class="bg-white/95 backdrop-blur border-b border-slate-200" id="stickyTotalBar">
<div class="max-w-6xl mx-auto px-4 py-2 flex items-center justify-between gap-3">
  <div class="flex items-center gap-2 min-w-0">
    <span class="text-xs font-extrabold tracking-wide text-slate-500">TOTAL</span>
    <span class="text-sm font-semibold text-slate-900 truncate" id="stickyTotalValue">‚Äî</span>
    <select aria-label="Moneda" class="px-2 py-1 rounded-xl border border-slate-200 bg-white text-sm font-semibold" id="displayCurrency">
<option value="EUR">‚Ç¨</option>
<option value="USD">$</option>
<option value="GBP">¬£</option>
<option value="JPY">¬•</option>
</select>
  </div>
  <button class="tap px-3 py-1.5 rounded-xl text-sm font-semibold border border-slate-200 bg-white hover:bg-slate-50 whitespace-nowrap" id="stickyTotalToggle">Detalle ‚ñæ</button>
</div>
<div class="hidden bg-white/95 backdrop-blur border-t border-slate-200" id="stickySummaryDetail">
<div class="max-w-6xl mx-auto px-4 py-3">
<div class="text-sm" id="stickySummaryDetailInner"></div>
</div>
</div>
</div>

<!-- Fixed subsection header (per-view) -->
<div id="subSectionHeader" class="hidden" aria-live="polite">
  <div class="max-w-6xl mx-auto px-5 py-2">
    <div class="grid grid-cols-[auto,1fr,auto] items-center gap-2">
      <div id="subSectionTitle" class="font-extrabold text-slate-900 text-sm leading-tight whitespace-nowrap">‚Äî</div>

      <div id="dateJumpUI" class="hidden">
        <div class="flex items-center justify-center">
          <select id="dateJumpSelect" class="h-8 w-full max-w-[200px] rounded-xl border border-slate-200 bg-white/90 px-3 text-sm font-semibold text-slate-900">
          </select>
        </div>
      </div>

      <button id="dateJumpNowBtn" class="hidden h-8 rounded-xl border border-slate-200 bg-white/90 px-3 text-sm font-semibold text-slate-900 whitespace-nowrap">Hoy</button>
    </div>
  </div>
</div>

<!-- Main -->
<div id="mainScroll"><main class="max-w-6xl mx-auto px-4 pt-0 pb-24">
<!-- Scenario toggle -->
<div class="flex items-center justify-between gap-3 mb-0">
<div class="inline-flex bg-white border border-slate-200 rounded-2xl p-1">
</div>
</div>
<!-- Grid -->
<div class="grid grid-cols-1 lg:grid-cols-12 gap-4"><aside class="lg:col-span-4">
<div class="bg-white border border-slate-200 rounded-3xl p-5 sticky top-24" id="summary">
<div class="flex items-center justify-between gap-3">
<div class="font-extrabold text-lg">RESUMEN</div>
<button class="tap px-3 py-2 rounded-xl border border-slate-200 bg-white hover:bg-slate-50 text-sm font-semibold" id="summaryToggle">Ver detalle ‚ñæ</button>
</div>
<div class="mt-3 space-y-2 text-sm">
<div class="flex justify-between"><span class="text-slate-600">Transporte</span><span class="font-semibold" id="sumTransport">0.00</span></div>
<div class="flex justify-between"><span class="text-slate-600">Alojamiento</span><span class="font-semibold" id="sumStay">0.00</span></div>
<div class="flex justify-between"><span class="text-slate-600">Actividades</span><span class="font-semibold" id="sumActs">0.00</span></div>
<div class="flex justify-between"><span class="text-slate-600">Comidas</span><span class="font-semibold" id="sumMeals">0.00</span></div>
<hr class="my-2"/>
<div class="flex justify-between text-base"><span class="font-extrabold">TOTAL</span><span class="font-extrabold" id="sumTotal">0.00</span></div>
<div class="text-xs text-slate-500">Moneda de visualizaci√≥n: <span class="hidden" id="sumCur">EUR</span></div>
</div>
<div class="mt-4 flex gap-2">
</div>
<div class="mt-3 hidden text-sm bg-slate-50 border border-slate-200 rounded-2xl p-3" id="compareBox"></div>
</div><div class="mt-3 hidden" id="summaryDetail"><button class="tap flex-1 px-4 py-2 rounded-xl border border-slate-200 bg-white hover:bg-slate-50 text-sm font-semibold" id="btnCompare">
              Comparar A/B (simple)
            </button></div>
</aside>
<section class="lg:col-span-8 space-y-4">
<div id="view-timeline">
<!-- TIMELINE --><div class="bg-white border border-slate-200 rounded-3xl overflow-visible">
<button class="w-full tap flex items-center justify-between px-5 py-4" data-acc="timeline">
<div class="flex items-center gap-3">
<span class="inline-flex w-9 h-9 rounded-2xl bg-orange-50 items-center justify-center">üóìÔ∏è</span>
<div class="text-left">
<div class="font-extrabold">Cronograma</div>
</div>
</div>
<span class="accIcon text-slate-400 text-xl">‚ñ¥</span>
</button>
<div class="px-5 pb-5" data-acc-body="timeline" style="overflow: visible;">

<div class="space-y-3" id="timelineList"></div>
</div>
<div class="mt-4 bg-white border border-slate-200 rounded-3xl overflow-hidden">
<button class="w-full tap flex items-center justify-between px-4 py-4" data-acc="dailyNotes">
<div class="flex items-center gap-3">
<span class="inline-flex w-9 h-9 rounded-2xl bg-slate-50 items-center justify-center">üìù</span>
<div class="text-left">
<div class="font-extrabold">NOTAS DEL D√çA</div>
</div>
</div>
<span class="accIcon text-slate-400 text-xl">‚ñæ</span>
</button>
<div class="px-4 pb-4 hidden" data-acc-body="dailyNotes">
<div class="p-3 rounded-2xl border border-slate-200 bg-white" id="dailyNotesBox"></div>
</div>
</div>
</div>
</div>
</section></div>
<!-- end view-timeline -->
<div class="hidden" id="view-legs">
<!-- LOGISTICA -->
<div class="bg-white border border-slate-200 rounded-3xl overflow-hidden">
<button class="w-full tap flex items-center justify-between px-5 py-4" data-acc="legs" id="legsHeader">
<div class="flex items-center gap-3">
<span class="inline-flex w-9 h-9 rounded-2xl bg-blue-50 items-center justify-center">‚úàÔ∏è</span>
<div class="text-left">
<div class="font-extrabold">Transporte</div>
</div>
</div>
<span class="accIcon text-slate-400 text-xl">‚ñæ</span>
</button>
<div class="px-5 pb-5 hidden" data-acc-body="legs">
<button aria-hidden="true" class="tap px-4 py-2 rounded-xl bg-blue-600 hover:bg-blue-700 text-white text-sm font-semibold hidden" id="addLeg" tabindex="-1">+ A√±adir trayecto</button>
<div class="space-y-3" id="legsList"></div>
</div>
</div>
</div>
<!-- end view-legs -->
<div class="hidden" id="view-stays">
<!-- ALOJAMIENTO -->
<div class="bg-white border border-slate-200 rounded-3xl overflow-hidden">
<button class="w-full tap flex items-center justify-between px-5 py-4" data-acc="stays" id="staysHeader">
<div class="flex items-center gap-3">
<span class="inline-flex w-9 h-9 rounded-2xl bg-emerald-50 items-center justify-center">üè®</span>
<div class="text-left">
<div class="font-extrabold">Alojamiento</div>
</div>
</div>
<span class="accIcon text-slate-400 text-xl">‚ñæ</span>
</button>
<div class="px-5 pb-5 hidden" data-acc-body="stays">
<button aria-hidden="true" class="tap px-4 py-2 rounded-xl bg-emerald-600 hover:bg-emerald-700 text-white text-sm font-semibold hidden" id="addStay" tabindex="-1">+ A√±adir alojamiento</button>
<div class="space-y-3" id="staysList"></div>
</div>
</div>
</div>
<!-- end view-stays -->
<div class="hidden" id="view-meals">
<!-- COMIDAS -->
<div class="bg-white border border-slate-200 rounded-3xl overflow-hidden">
<button class="w-full tap flex items-center justify-between px-5 py-4" data-acc="meals">
<div class="flex items-center gap-3">
<span class="inline-flex w-9 h-9 rounded-2xl bg-amber-50 items-center justify-center">üçΩÔ∏è</span>
<div class="text-left">
<div class="font-extrabold">Comida</div>
</div>
</div>
<span class="accIcon text-slate-400 text-xl">‚ñæ</span>
</button>
<div class="px-5 pb-5 hidden" data-acc-body="meals">
<div class="grid grid-cols-1 sm:grid-cols-3 gap-3">
<div>
<label class="text-xs text-slate-600">Gasto diario x persona</label>
<input class="mt-1 w-full px-3 py-2 rounded-xl border border-slate-200" id="mealDaily" min="0" placeholder="Ej: 30" step="0.01" type="number"/>
</div>
<div>
<label class="text-xs text-slate-600">N¬∫ personas</label>
<input class="mt-1 w-full px-3 py-2 rounded-xl border border-slate-200" id="mealPeople" min="1" placeholder="Ej: 2" step="1" type="number"/>
</div>
<div>
<label class="text-xs text-slate-600">D√≠as totales</label>
<input class="mt-1 w-full px-3 py-2 rounded-xl border border-slate-200" id="mealDays" min="1" placeholder="Ej: 20" step="1" type="number"/>
</div>
</div>
<div class="mt-3 text-sm">
<span class="text-slate-600">Total comidas:</span>
<span class="font-extrabold" id="mealTotal">0.00</span>
<span class="text-slate-500" id="mealCur">EUR</span>
</div>
</div>
</div>
</div>
<!-- end view-meals -->
<div class="hidden" id="view-acts">
<!-- ACTIVIDADES -->
<div class="bg-white border border-slate-200 rounded-3xl overflow-hidden">
<button class="w-full tap flex items-center justify-between px-5 py-4" data-acc="acts" id="actsHeader">
<div class="flex items-center gap-3">
<span class="inline-flex w-9 h-9 rounded-2xl bg-fuchsia-50 items-center justify-center">üéØ</span>
<div class="text-left">
<div class="font-extrabold">Actividades</div>
</div>
</div>
<span class="accIcon text-slate-400 text-xl">‚ñæ</span>
</button>
<div class="px-5 pb-5 hidden" data-acc-body="acts">
<button aria-hidden="true" class="tap px-4 py-2 rounded-xl bg-fuchsia-600 hover:bg-fuchsia-700 text-white text-sm font-semibold hidden" id="addAct" tabindex="-1">+ A√±adir actividad</button>
<div class="space-y-3" id="actsList"></div>
</div>
</div>
<!-- IA -->
<div class="bg-white border border-slate-200 rounded-3xl overflow-hidden">
<button class="w-full tap flex items-center justify-between px-5 py-4" data-acc="ai">
<div class="flex items-center gap-3">
<span class="inline-flex w-9 h-9 rounded-2xl bg-violet-50 items-center justify-center">ü§ñ</span>
<div class="text-left">
<div class="font-extrabold">SUGERENCIAS DE LA IA</div>
</div>
</div>
<span class="accIcon text-slate-400 text-xl">‚ñæ</span>
</button>
<div class="px-5 pb-5 hidden" data-acc-body="ai">
<div class="flex flex-wrap gap-2 justify-end mb-3">
<button class="tap px-4 py-2 rounded-xl border border-slate-200 bg-white hover:bg-slate-50 text-sm font-semibold" id="aiPick">1) Elegir temas</button>
<button class="tap px-4 py-2 rounded-xl bg-violet-600 hover:bg-violet-700 text-white text-sm font-semibold" id="aiGenerate">2) Generar gu√≠a</button>
</div>
<div class="text-sm text-slate-500" id="aiStatus">
              Selecciona primero ciudades/actividades/alojamientos, luego genera.
            </div>
<div class="mt-4 space-y-4" id="aiResults"></div>
</div>
</div>
</div>
<!-- end view-acts -->
<!-- Summary -->
</main></div>
<!-- Bottom bar for mobile -->
<nav class="safe-b fixed bottom-0 left-0 right-0 z-[2000] lg:hidden bg-white/95 backdrop-blur border-t border-slate-200" id="bottomNav">
<div class="max-w-6xl mx-auto px-4 py-2 grid grid-cols-5 gap-2 text-xs">
<button class="tap py-2 rounded-xl hover:bg-slate-50" data-jump="timeline">üóìÔ∏è<div>Cronograma</div></button><button class="tap py-2 rounded-xl hover:bg-slate-50" data-jump="legs">‚úàÔ∏è<div>Transporte</div></button>
<button class="tap py-2 rounded-xl hover:bg-slate-50" data-jump="stays">üè®<div>Alojamiento</div></button>
<button class="tap py-2 rounded-xl hover:bg-slate-50" data-jump="meals">üçΩÔ∏è<div>Comida</div></button>
<button class="tap py-2 rounded-xl hover:bg-slate-50" data-jump="acts">üéØ<div>Actividades</div></button>
</div>
</nav>
<!-- Modals -->
<div class="hidden fixed inset-0 z-[6000] bg-black/40" id="modalBackdrop"></div>
<div class="hidden fixed inset-0 z-[6100] flex items-center justify-center p-4" id="modalBox">
<div class="w-full max-w-xl bg-white rounded-3xl border border-slate-200 shadow-xl max-h-[85vh] overflow-y-auto ios-scroll">
<div class="px-5 py-4 flex items-center justify-between border-b border-slate-200 sticky top-0 bg-white z-[6200]">
<div class="font-extrabold" id="modalTitle">Modal</div>
<button class="tap px-3 py-2 rounded-xl hover:bg-slate-50" id="modalClose" style="position:relative; z-index:6200;">‚úï</button>
</div>
<div class="p-5" id="modalBody"></div>
<div class="px-5 py-4 border-t border-slate-200 flex justify-end gap-2" id="modalFooter"></div>
</div>
</div>
<!-- Tools bottom sheet -->
<div class="hidden fixed inset-0 z-[1200] bg-black/50" id="toolsBackdrop"></div>
<div aria-label="Tools" aria-modal="true" class="fixed left-0 right-0 bottom-0 z-[1210]" id="toolsSheet" role="dialog">
<div class="max-w-6xl mx-auto px-0 sm:px-4">
<div class="bg-white rounded-t-3xl border border-slate-200 shadow-2xl overflow-hidden">
<div class="px-5 py-4 flex items-center justify-between border-b border-slate-200 sticky top-0 bg-white z-[6200]">
<div class="font-extrabold">Tools</div>
<button aria-label="Cerrar" class="tap px-3 py-2 rounded-xl hover:bg-slate-50" id="toolsClose">‚úï</button>
</div>
<div class="p-5 max-h-[72vh] overflow-y-auto overscroll-contain ios-scroll">
<div class="space-y-3">
<button class="tap w-full px-4 py-3 rounded-2xl bg-indigo-600 hover:bg-indigo-700 text-white font-semibold" id="toolsSave">
            Guardar
          </button>
<button class="tap w-full px-4 py-3 rounded-2xl border border-slate-200 bg-white hover:bg-slate-50 font-semibold" id="toolsLoad">
            Cargar
          </button>
<button class="tap w-full px-4 py-3 rounded-2xl border border-slate-200 bg-white hover:bg-slate-50 font-semibold" id="btnKey">
            Cambiar clave
          </button>
<button class="tap w-full px-4 py-3 rounded-2xl border border-slate-200 bg-white hover:bg-slate-50 font-semibold" id="btnCopyAtoB">
            Copiar A ‚Üí B
          </button>
<button class="tap w-full px-4 py-3 rounded-2xl border border-slate-200 bg-white hover:bg-slate-50 font-semibold" id="btnCopyBtoA">
            Copiar B ‚Üí A
          </button>
<button class="tap w-full px-4 py-3 rounded-2xl border border-rose-200 bg-rose-50 hover:bg-rose-100 text-rose-700 font-semibold" id="toolsReset">
            Reiniciar viaje
          </button>
<!-- Keep existing Trips button in DOM for legacy listeners (hidden) -->
<button class="hidden" id="btnTrips"></button>
</div>
<div class="mt-4 text-xs text-slate-500">
          Nota: ‚ÄúGuardar‚Äù y ‚ÄúCargar‚Äù abren el panel de archivos (incluye backups).
        </div>
</div>
<div class="safe-b"></div>
</div>
</div>
</div>
<script>
/* ----------------------------- Utilities ----------------------------- */
const $ = (id) => document.getElementById(id);
const escapeHtml = (s) => String(s ?? "").replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#039;");


/* ----------------------------- Views (v89a) ----------------------------- */
let activeView = "timeline";

function getTopStackHeight(){
  const v = getComputedStyle(document.documentElement).getPropertyValue("--top-stack-h").trim();
  const n = parseFloat(v);
  if (!isNaN(n)) return n;
  try { return syncTopStackHeights() || 0; } catch { return 0; }
}

function scrollMainToTop(){
  const ms = document.getElementById("mainScroll");
  const sc = ms || document.scrollingElement || document.documentElement;
  try { sc.scrollTop = 0; } catch {}
  // iOS double pass
  requestAnimationFrame(() => { try { sc.scrollTop = 0; } catch {} });
}


function updateSubSectionHeader(viewName){
  const bar = document.getElementById("subSectionHeader");
  const title = document.getElementById("subSectionTitle");
  if (!bar || !title) return;

  const map = {
    timeline: "Cronograma",
    legs: "Transporte",
    stays: "Alojamiento",
    acts: "Actividades",
    meals: "Comida",
  };

  const txt = map[String(viewName || "")] || "";
  if (!txt) {
    bar.classList.add("hidden");
      try{ ensureTailSpacer(v, 0); }catch(_){ }
    try { document.documentElement.style.setProperty("--subsection-header-h", "0px"); } catch {}
    return;
  }

  title.textContent = txt;
  bar.classList.remove("hidden");
}


function setView(viewName){
  const views = {
    timeline: $("view-timeline"),
    legs: $("view-legs"),
    stays: $("view-stays"),
    meals: $("view-meals"),
    acts: $("view-acts"),
  };

  Object.keys(views).forEach(k => {
    const el = views[k];
    if (!el) return;
    el.classList.toggle("hidden", k !== viewName);
  });

  activeView = viewName;

  // Allow CSS top offsets by active view (timeline exception)
  document.body.dataset.view = String(viewName || "");

  // Fixed subsection title under Totales (and under timeline controls in timeline)
  updateSubSectionHeader(viewName);

  // Ensure required accordions are open (keep listeners intact) + render view content
  if (viewName === "timeline") {
    __ensureAccordionOpen("timeline");
    // Force premium scroll-based timeline mode on every entry
    timelineViewMode = "global";
    activeDayISO = "";
    if (typeof renderTimeline === "function") renderTimeline();
  }
  if (viewName === "legs") {
    __ensureAccordionOpen("legs");
    if (typeof renderLegs === "function") renderLegs();
  }
  if (viewName === "stays") {
    __ensureAccordionOpen("stays");
    if (typeof renderStays === "function") renderStays();
  }
  if (viewName === "acts") {
    __ensureAccordionOpen("acts");
    if (typeof renderActivities === "function") renderActivities();
  }
  if (viewName === "meals") {
    __ensureAccordionOpen("meals");
    if (typeof renderMeals === "function") renderMeals();
  }

  // Keep measured heights in sync (subsection header, etc.)
  scheduleSyncTopStackHeights();

  if (typeof updateFabForView === "function") updateFabForView(viewName);

  // Simple & deterministic: always reset scroll to top on entry (no date auto-jumps)
  try { scrollMainToTop(); } catch(_){ const ms = document.getElementById("mainScroll"); if (ms) ms.scrollTop = 0; }

}


function triggerAddForView(view){
  const clickId = (id) => { const el = document.getElementById(id); if (el) { el.click(); return true; } return false; };
  if (view === "legs") return clickId("addLeg");
  if (view === "stays") return clickId("addStay");
  if (view === "acts") return clickId("addAct");
  if (view === "meals") {
    // No dedicated add button in meals; focus daily input as the primary action
    const el = document.getElementById("mealDaily");
    if (el) { try { el.focus(); } catch {} return true; }
    return false;
  }
  return false;
}
function updateFabForView(view){
  const fab = document.getElementById("fabAdd");
  if (!fab) return;
  const show = (view === "legs" || view === "stays" || view === "acts" || (view === "meals" && document.getElementById("addMeal")));
  fab.classList.toggle("hidden", !show);
  if (!show) { fab.onclick = null; return; }
  fab.onclick = () => { if (!triggerAddForView(view)) alert("No se pudo a√±adir"); };
}


/* ------------------------ Trip name (modal + export/import) ------------------------ */
const TRIP_NAME_KEY = "miviaje.tripName";

function getTripName() {
  const v = localStorage.getItem(TRIP_NAME_KEY) || "";
  return String(v || "").trim();
}

function setTripName(v) {
  localStorage.setItem(TRIP_NAME_KEY, String(v || "").trim());
}

function sanitizeFileBaseName(name) {
  name = String(name || "").trim();
  if (!name) return "MI_VIAJE";

  try {
    name = name.normalize("NFD").replace(/[\u0300-\u036f]/g, "");
  } catch {}

  name = name.replace(/\s+/g, "_");
  name = name.replace(/[^A-Za-z0-9_-]/g, "");
  return name || "MI_VIAJE";
}

function yyyyMmDdToday() {
  return new Date().toISOString().slice(0, 10);
}
/* ---------------------- /Trip name (modal + export/import) ---------------------- */

/* ------------------------ Trip name mode (minimal) ------------------------ */
const LS_TRIP_NAME_MODE = "miviaje.tripNameMode"; // "auto" | "custom"

function getTripNameMode() {
  const v = (localStorage.getItem(LS_TRIP_NAME_MODE) || "").trim();
  return (v === "custom" || v === "auto") ? v : "auto";
}
function setTripNameMode(mode) {
  const m = (mode === "custom") ? "custom" : "auto";
  localStorage.setItem(LS_TRIP_NAME_MODE, m);
}

/**
 * "Destino actual" recalculado:
 * - Prioridad: √∫ltimo leg.to no vac√≠o del escenario actual
 * - Fallback: primer stay.city no vac√≠o
 * - Fallback: primer activity.city no vac√≠o
 * - Fallback final: "MI_VIAJE"
 */
function computeAutoTripName() {
  try {
    const sc = (typeof curScenario === "function") ? curScenario() : null;
    if (sc) {
      const legs = Array.isArray(sc.legs) ? sc.legs : [];
      for (let i = legs.length - 1; i >= 0; i--) {
        const to = String(legs[i]?.to || "").trim();
        if (to) return to;
      }

      const stays = Array.isArray(sc.stays) ? sc.stays : [];
      for (let i = 0; i < stays.length; i++) {
        const city = String(stays[i]?.city || "").trim();
        if (city) return city;
      }

      const acts = Array.isArray(sc.activities) ? sc.activities : [];
      for (let i = 0; i < acts.length; i++) {
        const city = String(acts[i]?.city || "").trim();
        if (city) return city;
      }
    }
  } catch {}
  return "MI_VIAJE";
}
/* ---------------------- /Trip name mode (minimal) ---------------------- */

const cap1 = (s) => {
  s = String(s ?? "").trim();
  if (!s) return "";
  return s.charAt(0).toUpperCase() + s.slice(1);
};
const nowId = () => Math.random().toString(36).slice(2,10);
const parseMoney = (v) => {
  const n = Number(String(v ?? "").replace(",", "."));
  return Number.isFinite(n) ? n : 0;
};
const uniq = (arr) => Array.from(new Set(arr.map(x => String(x).trim()).filter(Boolean)));


/* --------------------------- Date helpers (v89E5E11D) --------------------------- */
function formatDateES(dateStr) {
  // dateStr ‚ÄúYYYY-MM-DD‚Äù -> ‚Äú26 feb 2026‚Äù (sin weekday)
  const s = String(dateStr || "").trim();
  if (!/^\d{4}-\d{2}-\d{2}$/.test(s)) return "";
  const d = new Date(s + "T00:00:00");
  if (Number.isNaN(d.getTime())) return "";
  let out = d.toLocaleDateString('es-ES', { day:'2-digit', month:'short', year:'numeric' });
  // normalizar: quitar puntos si el mes viene ‚Äúfeb.‚Äù -> ‚Äúfeb‚Äù
  out = String(out || "").replace(/\./g, "").replace(/\s+/g, " ").trim();
  return out;
}

function calcDurationText(departDate, departTime, arriveDate, arriveTime) {
  // si falta algo => ""
  const d0 = String(departDate || "").trim();
  const t0 = String(departTime || "").trim();
  const d1 = String(arriveDate || "").trim();
  const t1 = String(arriveTime || "").trim();
  if (!/^\d{4}-\d{2}-\d{2}$/.test(d0) || !/^\d{2}:\d{2}$/.test(t0) || !/^\d{4}-\d{2}-\d{2}$/.test(d1) || !/^\d{2}:\d{2}$/.test(t1)) return "";

  const start = new Date(d0 + "T" + t0);
  const end = new Date(d1 + "T" + t1);
  if (Number.isNaN(start.getTime()) || Number.isNaN(end.getTime())) return "";

  let diffMin = Math.round((end - start) / 60000);

  // si negativo y parece cruce de medianoche, sumar 24h si arriveDate==departDate (fallback)
  if (diffMin < 0 && d1 === d0) diffMin += 24 * 60;

  if (diffMin <= 0) return "";
  const h = Math.floor(diffMin / 60);
  const m = diffMin % 60;

  // devolver: ‚Äú5h‚Äù si m√∫ltiplo de 60; ‚Äú2h 29m‚Äù si no
  if (m === 0) return `${h}h`;
  return `${h}h ${m}m`;
}

/* =========================
   Unified event summary helpers
   (single source of truth for section + timeline)
   ========================= */

function getPersistedFilesCount(item) {
  // Real persisted model only. Do NOT infer from UI buttons.
  const arr = item && item.files;
  return Array.isArray(arr) ? arr.length : 0;
}

function buildEventIndicatorsHTML(item) {
  const hasNotes = !!(item && String(item.notes || "").trim());
  const filesCount = getPersistedFilesCount(item);
  const notesIcon = hasNotes ? `<span class="text-sm leading-none" title="Notas">üóíÔ∏è</span>` : ``;
  const filesIcon = (filesCount > 0) ? `<span class="text-sm leading-none" title="Archivos">üìé</span>` : ``;
  if (!notesIcon && !filesIcon) return ``;
  return `<div class="flex items-center gap-2">${notesIcon}${filesIcon}</div>`;
}

function _mvNoBreakText(s) {
  // Ensures "2h 35m" behaves as a single visual unit (no line break between tokens)
  return escapeHtml(String(s || "").trim()).replace(/\s+/g, "&nbsp;");
}

function formatUTCOffset(off){
  const n = Number(off);
  if (!Number.isFinite(n)) return "";
  const s = (n>=0?"+":"") + String(parseInt(n,10));
  return "UTC" + s;
}
function __utcOffsetOptionsHTML(){
  let out = `<option value="">UTC</option>`;
  for (let i=-12;i<=14;i++){
    const s = (i>=0?"+":"") + i;
    out += `<option value="${i}">UTC${s}</option>`;
  }
  return out;
}
function __toUtcMillisFromLocal(iso, hhmm, offHours){
  const d = String(iso||"").trim();
  const t = String(hhmm||"").trim();
  const off = Number(offHours);
  if (!/^\d{4}-\d{2}-\d{2}$/.test(d) || !/^\d{2}:\d{2}$/.test(t) || !Number.isFinite(off)) return NaN;
  const [Y,M,D] = d.split("-").map(x=>parseInt(x,10));
  const [h,m] = t.split(":").map(x=>parseInt(x,10));
  // Local time at offset -> UTC by subtracting offset hours
  return Date.UTC(Y, M-1, D, h - off, m, 0, 0);
}
function calcDurationTextTZ(departDate, departTime, arriveDate, arriveTime, tzFrom, tzTo){
  const o0 = Number(tzFrom);
  const o1 = Number(tzTo);
  if (!Number.isFinite(o0) || !Number.isFinite(o1)) return calcDurationText(departDate, departTime, arriveDate, arriveTime);
  const start = __toUtcMillisFromLocal(departDate, departTime, o0);
  const end   = __toUtcMillisFromLocal(arriveDate, arriveTime, o1);
  if (!Number.isFinite(start) || !Number.isFinite(end)) return "";
  let diffMin = Math.round((end - start) / 60000);
  if (diffMin <= 0) return "";
  const h = Math.floor(diffMin / 60);
  const m = diffMin % 60;
  if (h <= 0 && m <= 0) return "";
  if (h > 0 && m > 0) return `${h}h ${m}m`;
  if (h > 0) return `${h}h`;
  return `${m}m`;
}


// --- TZ auto (no API): derive UTC offset from city + date/time using Intl timeZone ---
const __CITY_TZ_MAP = {
  "a coru√±a":"Europe/Madrid",
  "abu dhabi":"Asia/Dubai",
  "alicante":"Europe/Madrid",
  "amberes":"Europe/Brussels",
  "amsterdam":"Europe/Amsterdam",
  "anchorage":"America/Anchorage",
  "antwerp":"Europe/Brussels",
  "atenas":"Europe/Athens",
  "athens":"Europe/Athens",
  "atlanta":"America/New_York",
  "auckland":"Pacific/Auckland",
  "austin":"America/Chicago",
  "azores":"Atlantic/Azores",
  "bangkok":"Asia/Bangkok",
  "barcelona":"Europe/Madrid",
  "basel":"Europe/Zurich",
  "beijing":"Asia/Shanghai",
  "belfast":"Europe/London",
  "berlin":"Europe/Berlin",
  "bilbao":"Europe/Madrid",
  "birmingham":"Europe/London",
  "bogota":"America/Bogota",
  "bogot√°":"America/Bogota",
  "bologna":"Europe/Rome",
  "bordeaux":"Europe/Paris",
  "boston":"America/New_York",
  "bratislava":"Europe/Bratislava",
  "bristol":"Europe/London",
  "bruselas":"Europe/Brussels",
  "brussels":"Europe/Brussels",
  "bucarest":"Europe/Bucharest",
  "bucharest":"Europe/Bucharest",
  "budapest":"Europe/Budapest",
  "buenos aires":"America/Argentina/Buenos_Aires",
  "burdeos":"Europe/Paris",
  "cairo":"Africa/Cairo",
  "calgary":"America/Edmonton",
  "cancun":"America/Cancun",
  "canc√∫n":"America/Cancun",
  "cannes":"Europe/Paris",
  "cape town":"Africa/Johannesburg",
  "cardiff":"Europe/London",
  "casablanca":"Africa/Casablanca",
  "catania":"Europe/Rome",
  "chicago":"America/Chicago",
  "ciudad de mexico":"America/Mexico_City",
  "ciudad de m√©xico":"America/Mexico_City",
  "ciudad del cabo":"Africa/Johannesburg",
  "cologne":"Europe/Berlin",
  "copenhagen":"Europe/Copenhagen",
  "copenhague":"Europe/Copenhagen",
  "cordoba":"Europe/Madrid",
  "coruna":"Europe/Madrid",
  "cracovia":"Europe/Warsaw",
  "c√≥rdoba":"Europe/Madrid",
  "dallas":"America/Chicago",
  "delhi":"Asia/Kolkata",
  "den haag":"Europe/Amsterdam",
  "denver":"America/Denver",
  "doha":"Asia/Qatar",
  "donostia":"Europe/Madrid",
  "dresden":"Europe/Berlin",
  "dubai":"Asia/Dubai",
  "dublin":"Europe/Dublin",
  "dub√°i":"Asia/Dubai",
  "dusseldorf":"Europe/Berlin",
  "d√ºsseldorf":"Europe/Berlin",
  "edimburgo":"Europe/London",
  "edinburgh":"Europe/London",
  "eivissa":"Europe/Madrid",
  "el cairo":"Africa/Cairo",
  "estambul":"Europe/Istanbul",
  "estocolmo":"Europe/Stockholm",
  "estraburgo":"Europe/Paris",
  "faro":"Europe/Lisbon",
  "firenze":"Europe/Rome",
  "florence":"Europe/Rome",
  "florencia":"Europe/Rome",
  "fort lauderdale":"America/New_York",
  "frankfurt":"Europe/Berlin",
  "frankfurt am main":"Europe/Berlin",
  "funchal":"Atlantic/Madeira",
  "geneva":"Europe/Zurich",
  "ginebra":"Europe/Zurich",
  "glasgow":"Europe/London",
  "gran canaria":"Atlantic/Canary",
  "granada":"Europe/Madrid",
  "guadalajara":"America/Mexico_City",
  "hamburg":"Europe/Berlin",
  "havana":"America/Havana",
  "hawaii":"Pacific/Honolulu",
  "helsinki":"Europe/Helsinki",
  "hong kong":"Asia/Hong_Kong",
  "honolulu":"Pacific/Honolulu",
  "houston":"America/Chicago",
  "ibiza":"Europe/Madrid",
  "istanbul":"Europe/Istanbul",
  "jakarta":"Asia/Jakarta",
  "johannesburg":"Africa/Johannesburg",
  "koln":"Europe/Berlin",
  "krakow":"Europe/Warsaw",
  "kuala lumpur":"Asia/Kuala_Lumpur",
  "k√∂ln":"Europe/Berlin",
  "la":"America/Los_Angeles",
  "la coru√±a":"Europe/Madrid",
  "la habana":"America/Havana",
  "la haya":"Europe/Amsterdam",
  "las palmas":"Atlantic/Canary",
  "las vegas":"America/Los_Angeles",
  "leipzig":"Europe/Berlin",
  "lille":"Europe/Paris",
  "lima":"America/Lima",
  "lisboa":"Europe/Lisbon",
  "lisbon":"Europe/Lisbon",
  "liverpool":"Europe/London",
  "ljubljana":"Europe/Ljubljana",
  "london":"Europe/London",
  "londres":"Europe/London",
  "los angeles":"America/Los_Angeles",
  "luxembourg":"Europe/Luxembourg",
  "lyon":"Europe/Paris",
  "madeira":"Atlantic/Madeira",
  "madrid":"Europe/Madrid",
  "malaga":"Europe/Madrid",
  "manchester":"Europe/London",
  "manila":"Asia/Manila",
  "marrakech":"Africa/Casablanca",
  "marrakesh":"Africa/Casablanca",
  "marseille":"Europe/Paris",
  "marsella":"Europe/Paris",
  "melbourne":"Australia/Melbourne",
  "mexico city":"America/Mexico_City",
  "miami":"America/New_York",
  "milan":"Europe/Rome",
  "milano":"Europe/Rome",
  "montpellier":"Europe/Paris",
  "montreal":"America/Toronto",
  "montr√©al":"America/Toronto",
  "mumbai":"Asia/Kolkata",
  "munchen":"Europe/Berlin",
  "munich":"Europe/Berlin",
  "murcia":"Europe/Madrid",
  "m√°laga":"Europe/Madrid",
  "m√ºnchen":"Europe/Berlin",
  "nantes":"Europe/Paris",
  "naples":"Europe/Rome",
  "napoles":"Europe/Rome",
  "new delhi":"Asia/Kolkata",
  "new orleans":"America/Chicago",
  "new york":"America/New_York",
  "nice":"Europe/Paris",
  "niza":"Europe/Paris",
  "nuernberg":"Europe/Berlin",
  "nueva orleans":"America/Chicago",
  "nueva york":"America/New_York",
  "nuremberg":"Europe/Berlin",
  "nyc":"America/New_York",
  "n√°poles":"Europe/Rome",
  "n√ºrnberg":"Europe/Berlin",
  "oporto":"Europe/Lisbon",
  "orlando":"America/New_York",
  "osaka":"Asia/Tokyo",
  "oslo":"Europe/Oslo",
  "ottawa":"America/Toronto",
  "oviedo":"Europe/Madrid",
  "palermo":"Europe/Rome",
  "palma":"Europe/Madrid",
  "palma de mallorca":"Europe/Madrid",
  "pamplona":"Europe/Madrid",
  "panama":"America/Panama",
  "panama city":"America/Panama",
  "panam√°":"America/Panama",
  "paris":"Europe/Paris",
  "pekin":"Asia/Shanghai",
  "pek√≠n":"Asia/Shanghai",
  "phoenix":"America/Phoenix",
  "pisa":"Europe/Rome",
  "ponta delgada":"Atlantic/Azores",
  "portland":"America/Los_Angeles",
  "porto":"Europe/Lisbon",
  "praga":"Europe/Prague",
  "prague":"Europe/Prague",
  "puerto vallarta":"America/Mexico_City",
  "punta cana":"America/Santo_Domingo",
  "reykjavik":"Atlantic/Reykjavik",
  "rio":"America/Sao_Paulo",
  "rio de janeiro":"America/Sao_Paulo",
  "roma":"Europe/Rome",
  "rome":"Europe/Rome",
  "rotterdam":"Europe/Amsterdam",
  "salzburg":"Europe/Vienna",
  "san diego":"America/Los_Angeles",
  "san francisco":"America/Los_Angeles",
  "san juan":"America/Puerto_Rico",
  "san sebastian":"Europe/Madrid",
  "santa cruz de tenerife":"Atlantic/Canary",
  "santander":"Europe/Madrid",
  "santiago":"America/Santiago",
  "santiago de chile":"America/Santiago",
  "santiago de compostela":"Europe/Madrid",
  "sao paulo":"America/Sao_Paulo",
  "seattle":"America/Los_Angeles",
  "seoul":"Asia/Seoul",
  "seul":"Asia/Seoul",
  "sevilla":"Europe/Madrid",
  "seville":"Europe/Madrid",
  "shanghai":"Asia/Shanghai",
  "singapore":"Asia/Singapore",
  "singapur":"Asia/Singapore",
  "sofia":"Europe/Sofia",
  "stockholm":"Europe/Stockholm",
  "strasbourg":"Europe/Paris",
  "stuttgart":"Europe/Berlin",
  "sydney":"Australia/Sydney",
  "s√£o paulo":"America/Sao_Paulo",
  "s√≠dney":"Australia/Sydney",
  "tampa":"America/New_York",
  "tenerife":"Atlantic/Canary",
  "the hague":"Europe/Amsterdam",
  "tokyo":"Asia/Tokyo",
  "torino":"Europe/Rome",
  "toronto":"America/Toronto",
  "toulouse":"Europe/Paris",
  "tunis":"Africa/Tunis",
  "turin":"Europe/Rome",
  "t√∫nez":"Africa/Tunis",
  "valencia":"Europe/Madrid",
  "vancouver":"America/Vancouver",
  "varsovia":"Europe/Warsaw",
  "venecia":"Europe/Rome",
  "venezia":"Europe/Rome",
  "venice":"Europe/Rome",
  "viena":"Europe/Vienna",
  "vienna":"Europe/Vienna",
  "vigo":"Europe/Madrid",
  "warsaw":"Europe/Warsaw",
  "washington":"America/New_York",
  "washington dc":"America/New_York",
  "zagreb":"Europe/Zagreb",
  "zaragoza":"Europe/Madrid",
  "zurich":"Europe/Zurich"
};

// --- Airports (local) for IATA recognition / future autocomplete ---
const __AIRPORT_DB = [
  { iata:"MAD", name:'Adolfo Su√°rez Madrid‚ÄìBarajas', city:'Madrid', country:"ES", tz:"Europe/Madrid" },
  { iata:"BCN", name:'Barcelona‚ÄìEl Prat', city:'Barcelona', country:"ES", tz:"Europe/Madrid" },
  { iata:"VLC", name:'Valencia', city:'Valencia', country:"ES", tz:"Europe/Madrid" },
  { iata:"SVQ", name:'Sevilla', city:'Sevilla', country:"ES", tz:"Europe/Madrid" },
  { iata:"BIO", name:'Bilbao', city:'Bilbao', country:"ES", tz:"Europe/Madrid" },
  { iata:"AGP", name:'M√°laga‚ÄìCosta del Sol', city:'M√°laga', country:"ES", tz:"Europe/Madrid" },
  { iata:"PMI", name:'Palma de Mallorca', city:'Palma de Mallorca', country:"ES", tz:"Europe/Madrid" },
  { iata:"IBZ", name:'Ibiza', city:'Ibiza', country:"ES", tz:"Europe/Madrid" },
  { iata:"LPA", name:'Gran Canaria', city:'Las Palmas', country:"ES", tz:"Atlantic/Canary" },
  { iata:"TFS", name:'Tenerife South', city:'Tenerife', country:"ES", tz:"Atlantic/Canary" },
  { iata:"LIS", name:'Lisbon Humberto Delgado', city:'Lisboa', country:"PT", tz:"Europe/Lisbon" },
  { iata:"OPO", name:'Porto', city:'Porto', country:"PT", tz:"Europe/Lisbon" },
  { iata:"FAO", name:'Faro', city:'Faro', country:"PT", tz:"Europe/Lisbon" },
  { iata:"FNC", name:'Madeira', city:'Funchal', country:"PT", tz:"Atlantic/Madeira" },
  { iata:"LHR", name:'London Heathrow', city:'London', country:"GB", tz:"Europe/London" },
  { iata:"LGW", name:'London Gatwick', city:'London', country:"GB", tz:"Europe/London" },
  { iata:"STN", name:'London Stansted', city:'London', country:"GB", tz:"Europe/London" },
  { iata:"MAN", name:'Manchester', city:'Manchester', country:"GB", tz:"Europe/London" },
  { iata:"EDI", name:'Edinburgh', city:'Edinburgh', country:"GB", tz:"Europe/London" },
  { iata:"DUB", name:'Dublin', city:'Dublin', country:"IE", tz:"Europe/Dublin" },
  { iata:"CDG", name:'Paris Charles de Gaulle', city:'Paris', country:"FR", tz:"Europe/Paris" },
  { iata:"ORY", name:'Paris Orly', city:'Paris', country:"FR", tz:"Europe/Paris" },
  { iata:"NCE", name:'Nice C√¥te d‚ÄôAzur', city:'Nice', country:"FR", tz:"Europe/Paris" },
  { iata:"LYS", name:'Lyon‚ÄìSaint-Exup√©ry', city:'Lyon', country:"FR", tz:"Europe/Paris" },
  { iata:"MRS", name:'Marseille Provence', city:'Marseille', country:"FR", tz:"Europe/Paris" },
  { iata:"FCO", name:'Rome Fiumicino', city:'Rome', country:"IT", tz:"Europe/Rome" },
  { iata:"CIA", name:'Rome Ciampino', city:'Rome', country:"IT", tz:"Europe/Rome" },
  { iata:"MXP", name:'Milan Malpensa', city:'Milan', country:"IT", tz:"Europe/Rome" },
  { iata:"LIN", name:'Milan Linate', city:'Milan', country:"IT", tz:"Europe/Rome" },
  { iata:"VCE", name:'Venice Marco Polo', city:'Venice', country:"IT", tz:"Europe/Rome" },
  { iata:"FLR", name:'Florence', city:'Florence', country:"IT", tz:"Europe/Rome" },
  { iata:"NAP", name:'Naples', city:'Naples', country:"IT", tz:"Europe/Rome" },
  { iata:"FRA", name:'Frankfurt', city:'Frankfurt', country:"DE", tz:"Europe/Berlin" },
  { iata:"MUC", name:'Munich', city:'Munich', country:"DE", tz:"Europe/Berlin" },
  { iata:"BER", name:'Berlin Brandenburg', city:'Berlin', country:"DE", tz:"Europe/Berlin" },
  { iata:"DUS", name:'D√ºsseldorf', city:'D√ºsseldorf', country:"DE", tz:"Europe/Berlin" },
  { iata:"HAM", name:'Hamburg', city:'Hamburg', country:"DE", tz:"Europe/Berlin" },
  { iata:"AMS", name:'Amsterdam Schiphol', city:'Amsterdam', country:"NL", tz:"Europe/Amsterdam" },
  { iata:"BRU", name:'Brussels', city:'Brussels', country:"BE", tz:"Europe/Brussels" },
  { iata:"ZRH", name:'Z√ºrich', city:'Zurich', country:"CH", tz:"Europe/Zurich" },
  { iata:"GVA", name:'Geneva', city:'Geneva', country:"CH", tz:"Europe/Zurich" },
  { iata:"VIE", name:'Vienna', city:'Vienna', country:"AT", tz:"Europe/Vienna" },
  { iata:"PRG", name:'Prague V√°clav Havel', city:'Prague', country:"CZ", tz:"Europe/Prague" },
  { iata:"BUD", name:'Budapest', city:'Budapest', country:"HU", tz:"Europe/Budapest" },
  { iata:"WAW", name:'Warsaw Chopin', city:'Warsaw', country:"PL", tz:"Europe/Warsaw" },
  { iata:"ATH", name:'Athens', city:'Athens', country:"GR", tz:"Europe/Athens" },
  { iata:"IST", name:'Istanbul', city:'Istanbul', country:"TR", tz:"Europe/Istanbul" },
  { iata:"JFK", name:'New York JFK', city:'New York', country:"US", tz:"America/New_York" },
  { iata:"LGA", name:'New York LaGuardia', city:'New York', country:"US", tz:"America/New_York" },
  { iata:"EWR", name:'Newark Liberty', city:'New York', country:"US", tz:"America/New_York" },
  { iata:"MIA", name:'Miami', city:'Miami', country:"US", tz:"America/New_York" },
  { iata:"MCO", name:'Orlando International', city:'Orlando', country:"US", tz:"America/New_York" },
  { iata:"TPA", name:'Tampa International', city:'Tampa', country:"US", tz:"America/New_York" },
  { iata:"FLL", name:'Fort Lauderdale‚ÄìHollywood', city:'Fort Lauderdale', country:"US", tz:"America/New_York" },
  { iata:"ATL", name:'Atlanta Hartsfield‚ÄìJackson', city:'Atlanta', country:"US", tz:"America/New_York" },
  { iata:"BOS", name:'Boston Logan', city:'Boston', country:"US", tz:"America/New_York" },
  { iata:"IAD", name:'Washington Dulles', city:'Washington DC', country:"US", tz:"America/New_York" },
  { iata:"DCA", name:'Washington National', city:'Washington DC', country:"US", tz:"America/New_York" },
  { iata:"ORD", name:"Chicago O'Hare", city:'Chicago', country:"US", tz:"America/Chicago" },
  { iata:"MDW", name:'Chicago Midway', city:'Chicago', country:"US", tz:"America/Chicago" },
  { iata:"DFW", name:'Dallas/Fort Worth', city:'Dallas', country:"US", tz:"America/Chicago" },
  { iata:"IAH", name:'Houston George Bush', city:'Houston', country:"US", tz:"America/Chicago" },
  { iata:"AUS", name:'Austin', city:'Austin', country:"US", tz:"America/Chicago" },
  { iata:"DEN", name:'Denver', city:'Denver', country:"US", tz:"America/Denver" },
  { iata:"PHX", name:'Phoenix Sky Harbor', city:'Phoenix', country:"US", tz:"America/Phoenix" },
  { iata:"LAS", name:'Las Vegas Harry Reid', city:'Las Vegas', country:"US", tz:"America/Los_Angeles" },
  { iata:"LAX", name:'Los Angeles', city:'Los Angeles', country:"US", tz:"America/Los_Angeles" },
  { iata:"SFO", name:'San Francisco', city:'San Francisco', country:"US", tz:"America/Los_Angeles" },
  { iata:"SAN", name:'San Diego', city:'San Diego', country:"US", tz:"America/Los_Angeles" },
  { iata:"SEA", name:'Seattle‚ÄìTacoma', city:'Seattle', country:"US", tz:"America/Los_Angeles" },
  { iata:"PDX", name:'Portland', city:'Portland', country:"US", tz:"America/Los_Angeles" },
  { iata:"HNL", name:'Honolulu', city:'Honolulu', country:"US", tz:"Pacific/Honolulu" },
  { iata:"YYZ", name:'Toronto Pearson', city:'Toronto', country:"CA", tz:"America/Toronto" },
  { iata:"YVR", name:'Vancouver', city:'Vancouver', country:"CA", tz:"America/Vancouver" },
  { iata:"MEX", name:'Mexico City', city:'Mexico City', country:"MX", tz:"America/Mexico_City" },
  { iata:"CUN", name:'Canc√∫n', city:'Canc√∫n', country:"MX", tz:"America/Cancun" },
  { iata:"PTY", name:'Panama City Tocumen', city:'Panama City', country:"PA", tz:"America/Panama" },
  { iata:"EZE", name:'Buenos Aires Ezeiza', city:'Buenos Aires', country:"AR", tz:"America/Argentina/Buenos_Aires" },
  { iata:"GRU", name:'S√£o Paulo Guarulhos', city:'S√£o Paulo', country:"BR", tz:"America/Sao_Paulo" },
  { iata:"GIG", name:'Rio de Janeiro Gale√£o', city:'Rio de Janeiro', country:"BR", tz:"America/Sao_Paulo" },
  { iata:"DXB", name:'Dubai International', city:'Dubai', country:"AE", tz:"Asia/Dubai" },
  { iata:"DOH", name:'Doha Hamad', city:'Doha', country:"QA", tz:"Asia/Qatar" },
  { iata:"HND", name:'Tokyo Haneda', city:'Tokyo', country:"JP", tz:"Asia/Tokyo" },
  { iata:"NRT", name:'Tokyo Narita', city:'Tokyo', country:"JP", tz:"Asia/Tokyo" },
  { iata:"SIN", name:'Singapore Changi', city:'Singapore', country:"SG", tz:"Asia/Singapore" },
  { iata:"HKG", name:'Hong Kong International', city:'Hong Kong', country:"HK", tz:"Asia/Hong_Kong" },
  { iata:"BKK", name:'Bangkok Suvarnabhumi', city:'Bangkok', country:"TH", tz:"Asia/Bangkok" },
  { iata:"SYD", name:'Sydney Kingsford Smith', city:'Sydney', country:"AU", tz:"Australia/Sydney" },
  { iata:"AKL", name:'Auckland', city:'Auckland', country:"NZ", tz:"Pacific/Auckland" }
];
const __IATA_TZ_MAP = Object.fromEntries(__AIRPORT_DB.map(a => [a.iata, a.tz]));

function __normalizeCityKey(s){
  const t = String(s||"").trim().toLowerCase();
  if(!t) return "";
  // remove parentheses and extra parts after comma
  const base = t.split(",")[0].replace(/\(.*?\)/g,"").trim();
  return base;
}

function __resolveCityTimeZone(city){
  const k = __normalizeCityKey(city);
  if(!k) return "";
  if(__CITY_TZ_MAP[k]) return __CITY_TZ_MAP[k];
  // try to match by prefix (e.g., "new york city")
  const hit = Object.keys(__CITY_TZ_MAP).find(key => k === key || k.startsWith(key+" "));
  return hit ? __CITY_TZ_MAP[hit] : "";
}


/* === Local Autocomplete (cities + airports) ===
   Deterministic, no external APIs. Mobile-first dropdown.
*/
function __acNorm(s){
  return String(s||"").trim().toLowerCase()
    .normalize("NFD").replace(/[\u0300-\u036f]/g,"");
}
function __acTitleCase(s){
  const t = String(s||"").trim();
  if(!t) return "";
  // keep common particles
  return t.split(/\s+/).map((w,i)=>{
    const lw=w.toLowerCase();
    if(i>0 && ["de","del","la","las","los","y","da","do","di"].includes(lw)) return lw;
    return lw.charAt(0).toUpperCase()+lw.slice(1);
  }).join(" ");
}
const __AC_CITY_LIST = Object.keys(__CITY_TZ_MAP).map(k=>({
  key:k,
  norm:__acNorm(k),
  label:__acTitleCase(k)
}));
const __AC_AIRPORT_LIST = (__AIRPORT_DB||[]).map(a=>({
  ...a,
  normIATA: __acNorm(a.iata),
  normName: __acNorm(a.name),
  normCity: __acNorm(a.city),
  label: `${a.iata} ¬∑ ${a.name} (${a.city})`
}));

function __acEnsureMenu(input){
  // Use a single floating overlay menu anchored to the active input (robust on iOS with sheet scroll + keyboard)
  if(!input) return null;
  let menu = document.getElementById("__acOverlayMenu");
  if(!menu){
    menu = document.createElement("div");
    menu.id = "__acOverlayMenu";
    menu.className = "ac-menu hidden fixed bg-white border border-slate-200 rounded-xl shadow-lg z-50 overflow-auto max-h-52";
    menu.setAttribute("role","listbox");
    menu.style.left = "0px";
    menu.style.top = "0px";
    menu.style.width = "0px";
    menu.style.zIndex = "2147483647";
    document.body.appendChild(menu);
  }
  menu.__acInput = input;
  return menu;
}

function __acPosition(menu, input){
  try{
    if(!menu || menu.classList.contains("hidden")) return;
    input = input || menu.__acInput;
    if(!input) return;

    const r = input.getBoundingClientRect();

    // iOS: visualViewport offsets keep fixed overlays anchored with keyboard/pinch
    const vv = window.visualViewport || null;
    const vvOffTop = vv ? vv.offsetTop : 0;
    const vvOffLeft = vv ? vv.offsetLeft : 0;

    // Keep width aligned with input visual width
    const w = Math.max(180, Math.round(r.width));
    const left = Math.round(r.left + vvOffLeft);

    // NO GAP: menu must touch the input (border-to-border)
    const gap = 0;

    // Temporarily show to apply geometry safely
    const prevHidden = menu.classList.contains("hidden");
    if(prevHidden) menu.classList.remove("hidden");

    const vw = (vv ? vv.width : (window.innerWidth || document.documentElement.clientWidth || 390));
    const vh = (vv ? vv.height : (window.innerHeight || document.documentElement.clientHeight || 700));

    // Tailwind max-h-52 = 13rem = 208px (keep as hard cap, but shrink if needed)
    const HARD_CAP = 208;
    const EDGE = 8;

    // ALWAYS open BELOW the active input
    const top = Math.round(r.bottom + vvOffTop + gap);

    // Reduce max-height to fit BELOW; never flip above and never overlap the input
    const spaceBelow = (vh - EDGE) - top;
    const maxH = Math.max(0, Math.min(HARD_CAP, Math.floor(spaceBelow)));

    // Clamp within viewport horizontally
    const maxLeft = Math.max(EDGE, vw - w - EDGE);
    const clLeft = Math.min(Math.max(EDGE, left), maxLeft);

    menu.style.left = clLeft + "px";
    menu.style.top = top + "px";
    menu.style.width = w + "px";
    menu.style.maxHeight = maxH + "px";

    if(prevHidden) menu.classList.add("hidden");
  }catch{}
}

function __acRender(menu, items, onPick){
  menu.innerHTML = "";
  if(!items.length){
    menu.classList.add("hidden");
    return;
  }
  const frag = document.createDocumentFragment();
  items.forEach((it, idx)=>{
    const b = document.createElement("button");
    b.type="button";
    b.className = "w-full text-left px-3 py-2 text-sm hover:bg-slate-50 active:bg-slate-100";
    b.textContent = it.label;
    b.addEventListener("pointerdown",(e)=>{ e.preventDefault(); e.stopPropagation(); });
    b.addEventListener("mousedown",(e)=>{ e.preventDefault(); e.stopPropagation(); });
    b.addEventListener("click",(e)=>{ e.preventDefault(); e.stopPropagation(); onPick(it); });
    frag.appendChild(b);
  });
  menu.appendChild(frag);
  menu.classList.remove("hidden");
}

function __attachAutocomplete(input, provider, onPick){
  if(!input || input.__acWired) return;
  input.__acWired = true;
  const menu = __acEnsureMenu(input);
  if(!menu) return;

  // Prevent autocomplete interactions from bubbling to sheet/overlay handlers
  menu.addEventListener("pointerdown",(e)=>{ e.stopPropagation(); });
  menu.addEventListener("mousedown",(e)=>{ e.stopPropagation(); });
  menu.addEventListener("click",(e)=>{ e.stopPropagation(); });

  const close = ()=> menu.classList.add("hidden");
  let blurT = null;

  const reposition = ()=>{
    if(menu.classList.contains("hidden")) return;
    __acPosition(menu, input);
  };

  const refresh = ()=>{
    menu.__acInput = input;
    const q = __acNorm(input.value);
    if(!q){ close(); return; }
    const items = provider(q);
    __acRender(menu, items, (it)=>{
      onPick(it);
      close();
      requestAnimationFrame(()=>{ try{ input.focus(); }catch{} });
    });
    // Position after render (needs measured height)
    requestAnimationFrame(reposition);
  };

  input.addEventListener("input", refresh);
  input.addEventListener("focus", refresh);
  input.addEventListener("blur", ()=>{
    clearTimeout(blurT);
    blurT = setTimeout(close, 120);
  });

  // Reposition on sheet scroll / viewport changes (iOS keyboard)
  const sheet = document.getElementById("eventSheetBody");
  if(sheet) sheet.addEventListener("scroll", reposition, { passive:true });
  window.addEventListener("resize", reposition, { passive:true });
  if(window.visualViewport){
    window.visualViewport.addEventListener("resize", reposition, { passive:true });
    window.visualViewport.addEventListener("scroll", reposition, { passive:true });
  }
}

function __cityProvider(q){
  const out = [];
  // prefer prefix, then contains
  for(const c of __AC_CITY_LIST){
    if(c.norm.startsWith(q)) out.push(c);
    if(out.length>=8) break;
  }
  if(out.length<8){
    for(const c of __AC_CITY_LIST){
      if(out.includes(c)) continue;
      if(c.norm.includes(q)) out.push(c);
      if(out.length>=8) break;
    }
  }
  return out;
}

function __airportProvider(q){
  const out = [];
  const isIata = /^[a-z]{1,3}$/.test(q);
  if(isIata){
    for(const a of __AC_AIRPORT_LIST){
      if(a.normIATA.startsWith(q)) out.push(a);
      if(out.length>=10) break;
    }
  }
  if(out.length<10){
    for(const a of __AC_AIRPORT_LIST){
      if(out.includes(a)) continue;
      if(a.normName.includes(q) || a.normCity.includes(q) || a.normIATA===q) out.push(a);
      if(out.length>=10) break;
    }
  }
  return out;
}

function __dispatchInputChange(el){
  try{ el.dispatchEvent(new Event("input",{bubbles:true})); }catch{}
  try{ el.dispatchEvent(new Event("change",{bubbles:true})); }catch{}
}

// WIRING per sheet kind (safe, no side effects outside filling inputs)
function __wireLegAutocomplete(wrap){
  if(!wrap) return;
  const fromCity = wrap.querySelector('[data-sheet-leg="from"]');
  const toCity   = wrap.querySelector('[data-sheet-leg="to"]');
  const outPlace = wrap.querySelector('[data-sheet-leg="placeOut"]');
  const inPlace  = wrap.querySelector('[data-sheet-leg="placeIn"]');

  __attachAutocomplete(fromCity, __cityProvider, (it)=>{
    fromCity.value = it.label; __dispatchInputChange(fromCity);
  });
  __attachAutocomplete(toCity, __cityProvider, (it)=>{
    toCity.value = it.label; __dispatchInputChange(toCity);
  });

  __attachAutocomplete(outPlace, __airportProvider, (it)=>{
    outPlace.value = it.iata; __dispatchInputChange(outPlace);
    // bonus: if city empty, fill it
    if(fromCity && !String(fromCity.value||"").trim()){
      fromCity.value = it.city; __dispatchInputChange(fromCity);
    }
  });
  __attachAutocomplete(inPlace, __airportProvider, (it)=>{
    inPlace.value = it.iata; __dispatchInputChange(inPlace);
    if(toCity && !String(toCity.value||"").trim()){
      toCity.value = it.city; __dispatchInputChange(toCity);
    }
  });
}

function __wireStayAutocomplete(wrap){
  if(!wrap) return;
  const city = wrap.querySelector('[data-sheet-stay="city"]');
  __attachAutocomplete(city, __cityProvider, (it)=>{ city.value = it.label; __dispatchInputChange(city); });
}
function __wireActAutocomplete(wrap){
  if(!wrap) return;
  const city = wrap.querySelector('[data-sheet-act="city"]');
  __attachAutocomplete(city, __cityProvider, (it)=>{ city.value = it.label; __dispatchInputChange(city); });
}


function __tzOffsetMinutes(timeZone, date){
  try{
    const dtf = new Intl.DateTimeFormat("en-US", {
      timeZone,
      hour12: false,
      year: "numeric", month: "2-digit", day: "2-digit",
      hour: "2-digit", minute: "2-digit", second: "2-digit"
    });
    const parts = dtf.formatToParts(date);
    const map = {};
    for (const p of parts) if (p.type !== "literal") map[p.type] = p.value;
    const asUTC = Date.UTC(
      Number(map.year), Number(map.month)-1, Number(map.day),
      Number(map.hour), Number(map.minute), Number(map.second)
    );
    return (asUTC - date.getTime()) / 60000; // minutes to add to UTC to get local
  } catch { return NaN; }
}

function __localToUtcWithZone(iso, hhmm, timeZone){
  const d = String(iso||"").trim();
  const t = String(hhmm||"").trim();
  if (!/^\d{4}-\d{2}-\d{2}$/.test(d) || !/^\d{2}:\d{2}$/.test(t) || !timeZone) return { utc: NaN, offMin: NaN };
  const [Y,M,D] = d.split("-").map(n=>parseInt(n,10));
  const [h,m] = t.split(":").map(n=>parseInt(n,10));
  const guess = Date.UTC(Y, M-1, D, h, m, 0, 0);
  let utc = guess;
  for(let i=0;i<2;i++){
    const offMin = __tzOffsetMinutes(timeZone, new Date(utc));
    if(!Number.isFinite(offMin)) return { utc: NaN, offMin: NaN };
    utc = guess - offMin*60000;
  }
  const offMin2 = __tzOffsetMinutes(timeZone, new Date(utc));
  return { utc, offMin: offMin2 };
}

function __deriveUtcOffsetHours(city, iso, hhmm){
  const tz = __resolveCityTimeZone(city);
  if(!tz) return NaN;
  // If no date/time yet, compute "now" offset for display only
  if (!iso || !hhmm) {
    const offMin = __tzOffsetMinutes(tz, new Date());
    return Number.isFinite(offMin) ? (offMin/60) : NaN;
  }
  const r = __localToUtcWithZone(iso, hhmm, tz);
  return Number.isFinite(r.offMin) ? (r.offMin/60) : NaN;
}

function buildLegSummaryParts(leg) {
  const fromTxt = String(leg?.from || "").trim() || "‚Äî";
  const toTxt   = String(leg?.to   || "").trim() || "‚Äî";
  const title = `${fromTxt} ‚Üí ${toTxt}`;

  const dES = leg?.date ? formatDateES(leg.date) : "";

  const depDate = String(leg?.date || "").trim();
  const depTime = String(leg?.time || "").trim();
  const arrDate = String(leg?.arriveDate || leg?.dateIn || "").trim();
  const arrTime = String(leg?.arriveTime || leg?.timeIn || "").trim();

  const bt0 = depTime ? `<span class="font-semibold">${escapeHtml(depTime)}</span>` : "";
  const bt1 = arrTime ? `<span class="font-semibold">${escapeHtml(arrTime)}</span>` : "";

  // Prefer stored offsets; fallback to auto-derived offsets from city + date/time (no UI)
  const off0 = Number.isFinite(Number(leg?.tzFrom)) ? Number(leg.tzFrom) : __deriveUtcOffsetHours(leg?.from, depDate, depTime);
  const off1 = Number.isFinite(Number(leg?.tzTo))   ? Number(leg.tzTo)   : __deriveUtcOffsetHours(leg?.to,   arrDate, arrTime);

  const durRaw = calcDurationTextTZ(depDate, depTime, arrDate, arrTime, off0, off1);
  const dur = durRaw ? `<span class="mv-nb">${_mvNoBreakText(durRaw)}</span>` : "";

  let timeLine = "";
  if (depTime && arrTime) timeLine = `${bt0} ‚Üí ${bt1}${dur ? " ¬∑ " + dur : ""}`;
  else if (depTime)  timeLine = `${bt0}`;

  const dateHTML = dES ? `<span class="font-semibold">${escapeHtml(dES)}</span>` : "";
  const metaHTML = [dateHTML, timeLine].filter(Boolean).join(" ¬∑ ") || "‚Äî";

  const p0 = String(leg?.placeOut || "").trim();
  const p1 = String(leg?.placeIn || "").trim();
  const placeLineHTML = (p0 || p1)
    ? `<div class="text-xs text-slate-500 mt-0.5">${escapeHtml(p0 || "‚Äî")} ‚Üí ${escapeHtml(p1 || "‚Äî")}</div>`
    : ``;

  return { title, metaHTML, placeLineHTML };
}

function legSummaryLinesHTML(leg, opts){
  opts = opts || {};
  const modeIcon = (typeof legModeIcon==="function") ? legModeIcon(leg.mode) : "‚úàÔ∏è";
  const route = `${(leg.from||"").trim() || "‚Äî"} ‚Üí ${(leg.to||"").trim() || "‚Äî"}`;
  const parts = buildLegSummaryParts(leg);
  return `
    <div class="text-sm font-semibold truncate">${escapeHtml(modeIcon)} <span>${escapeHtml(route)}</span></div>
    <div class="text-xs text-slate-600 mt-0.5 truncate">${parts.metaHTML}</div>
    ${parts.placeLineHTML || ""}`;
}
function buildTimelineSummaryParts(it, jumpType, modelItem, dateLineHTML) {
  if (jumpType === "leg" && modelItem) {
    const parts = buildLegSummaryParts(modelItem);
    return {
      title: parts.title,
      metaHTML: parts.metaHTML,
      placeLineHTML: parts.placeLineHTML,
      metaClass: "text-xs text-slate-600 mt-0.5 truncate",
      indicatorsHTML: "" // timeline uses notesBtn + optional file icon in right rail
    };
  }
  return {
    title: it.title,
    metaHTML: dateLineHTML,
    placeLineHTML: "",
    metaClass: "text-xs text-slate-600 mt-0.5",
    indicatorsHTML: ""
  };
}

/* -------------------------- Timeline jump --------------------------- */
function todayYMD() {
  const d = new Date();
  const y = d.getFullYear();
  const m = String(d.getMonth() + 1).padStart(2, "0");
  const day = String(d.getDate()).padStart(2, "0");
  return `${y}-${m}-${day}`;
}


function getStickyOffset() {
  const header = document.getElementById("appHeader") || document.querySelector("header");
  const totalBar = document.getElementById("stickyTotalBar");
  const controls = document.getElementById("timelineControlsRow");

    const subHeader = document.getElementById("subSectionHeader");
// Prefer measured vars (kept in sync by syncTopStackHeights)
  const root = document.documentElement;
  const varHeader = parseFloat(getComputedStyle(root).getPropertyValue("--app-header-h")) || 0;
  const varTotals = parseFloat(getComputedStyle(root).getPropertyValue("--sticky-totals-h")) || 0;

  let offset = 0;
  offset += varHeader || (header ? header.getBoundingClientRect().height : 0);
  offset += varTotals || (totalBar ? totalBar.getBoundingClientRect().height : 0);

  // Subsection header (fixed per-view)
  if (subHeader && !subHeader.classList.contains("hidden")) {
    offset += subHeader.getBoundingClientRect().height;
  }
offset += 12; // margin
  return offset;
}


function calibrateViewStartGap(){
  const ms = $("mainScroll");
  const totals = $("stickyTotalBar");
  const viewEl = $("view-" + (activeView || ""));
  if (!ms || !totals || !viewEl) return;

  // Only calibrate when user is at the top (avoid messing with contextual scroll)
  if (ms.scrollTop > 2) return;

  // Measure the real visual gap between Totales bottom and current view start
  const totalsBottom = totals.getBoundingClientRect().bottom;
  const viewTop = viewEl.getBoundingClientRect().top;

  const gap = Math.max(0, Math.round(viewTop - totalsBottom));
  document.documentElement.style.setProperty("--view-gap-fix", gap + "px");
}

function syncTopStackHeights(){
  const hdr = $("appHeader");
  const totals = $("stickyTotalBar");
  const nav = $("bottomNav");
  const ms = $("mainScroll");

  const headerH = hdr ? hdr.getBoundingClientRect().height : 0;
  const totalsH = totals ? totals.getBoundingClientRect().height : 0;
  const navH = nav ? nav.getBoundingClientRect().height : 0;

  // Use the real bottom edge of the fixed totals bar as the single source of truth.
  // This avoids first-render discrepancies from borders/safe-area/transforms.
  const topStackH = totals ? totals.getBoundingClientRect().bottom : (headerH + totalsH);

  const root = document.documentElement;
  root.style.setProperty("--app-header-h", headerH + "px");
  root.style.setProperty("--sticky-totals-h", totalsH + "px");
  root.style.setProperty("--top-stack-h", topStackH + "px");
  root.style.setProperty("--bottom-nav-h", navH + "px");

  if (ms){
    ms.style.paddingTop = topStackH + "px";
    ms.style.paddingBottom = "var(--bottom-nav-h)";
  }
  // Timeline fixed controls (only visible in timeline view). Reserve its height in-flow.
  const tcr = $("timelineControlsRow");
  if (tcr){
    const h = tcr.getBoundingClientRect().height || 0;
    if (h > 0) root.style.setProperty("--timeline-controls-h", h + "px");
  }

}

// Keep heights in sync on load and when viewport changes (iOS-friendly)
let __initialScrollFixDone = false;
let __syncTopStackPending = false;
let __syncTopStackDidFirstReset = false;
function scheduleSyncTopStackHeights(){
  if (__syncTopStackPending) return;
  __syncTopStackPending = true;
  requestAnimationFrame(()=>requestAnimationFrame(()=>{
    __syncTopStackPending = false;
    syncTopStackHeights();
    // One-time safety: if mainScroll is born scrolled, reset once.
    const ms = $("mainScroll");
    if (ms && !__syncTopStackDidFirstReset && ms.scrollTop > 4){
      __syncTopStackDidFirstReset = true;
      ms.scrollTop = 0;
    }
  }));
}
document.addEventListener("DOMContentLoaded", scheduleSyncTopStackHeights);
window.addEventListener("load", scheduleSyncTopStackHeights);
window.addEventListener("resize", scheduleSyncTopStackHeights);


function getScrollContainer(){
  return document.getElementById("mainScroll") || document.scrollingElement || document.documentElement;
}

function getScrollTop(){
  const sc = getScrollContainer();
  return (sc === document.documentElement) ? (window["pageYOffset"] || 0) : (sc.scrollTop || 0);
}
function scrollToTopValue(top, behavior="smooth"){
  const sc = getScrollContainer();
  if (sc === document.documentElement){
    // fallback only
    window["scrollTo"]({ top, behavior });
  } else {
    sc.scrollTo({ top, behavior });
  }
}

function scrollToElWithOffset(el, extra = 0, smooth = true) {
  if (!el) return;
  // If this element belongs to a dated group, prefer scrolling to the group's date separator
  try{
    let p = el.previousElementSibling;
    while (p) {
      if (p.classList && p.classList.contains("dateSep")) { el = p; break; }
      p = p.previousElementSibling;
    }
  }catch{}
  const sc = getScrollContainer();
  const offset = getStickyOffset() + (extra || 0);
  const curTop = (sc === document.documentElement) ? getScrollTop() : sc.scrollTop;
  const y = el.getBoundingClientRect().top + curTop - offset;
  sc.scrollTo({ top: Math.max(0, y), behavior: smooth ? "smooth" : "auto" });
}


function getTopStackOffset() {
  const cs = getComputedStyle(document.documentElement);
  const headerH = parseFloat(cs.getPropertyValue("--app-header-h")) || 56;
  const totalsH = parseFloat(cs.getPropertyValue("--sticky-totals-h")) || 0;
  return headerH + totalsH;
}

function scrollToElTopStack(el, extra = 0, smooth = true) {
  // Keep name for compatibility; it uses current sticky offset (header + totals + timeline controls if visible).
  return scrollToElWithOffset(el, extra, smooth);
}


function landUnderTotals(el, extra = 8, opts = { smooth: true }) {
  if (!el) return;
  const sc = getScrollContainer();
  const behavior = (opts && opts.smooth) ? "smooth" : "auto";
  const offset = getStickyOffset() + (extra || 0);
  const curTop = (sc === document.documentElement) ? getScrollTop() : sc.scrollTop;
  const y = el.getBoundingClientRect().top + curTop - offset;
  sc.scrollTo({ top: Math.max(0, y), behavior });
}

let __tlLastActualKey = ""; // in-memory only, used to compute "Pr√≥ximo" relative to "Actual"

function __tlNowMinutes() {
  const n = new Date();
  return n.getHours() * 60 + n.getMinutes();
}

function getEstimatedDurationMinutes(item) {
  // Transporte / Alojamiento / Actividades (fallback 60)
  if (item && (item.legId || String(item.uid||"").startsWith("leg:"))) return 180;
  if (item && (item.stayId || String(item.uid||"").startsWith("stay:"))) return 60;
  if (item && (item.actId || String(item.uid||"").startsWith("act:"))) return 90;
  return 60;
}

function getEventStartDateTime(item) {
  // Returns a Date for today items with valid time, else null
  const d = String(item?.date || "");
  const t = String(item?.time || "");
  if (!/^[0-9]{4}-[0-9]{2}-[0-9]{2}$/.test(d)) return null;
  if (!/^[0-9]{2}:[0-9]{2}$/.test(t)) return null;
  const dt = new Date(`${d}T${t}:00`);
  return Number.isNaN(dt.getTime()) ? null : dt;
}

function __tlPickCurrentItemForToday(items, todayISO) {
  const nowMin = __tlNowMinutes();
  const todays = (items || []).filter(it => String(it.date||"") === String(todayISO) && it.date !== "9999-99-99");
  if (!todays.length) return null;

  // Prefer real events over note markers when choosing "actual"
  const main = todays.filter(it => !it.isNote);

  // Only consider items with a valid time for "in progress"
  const pool = (main.length ? main : todays).filter(it => /^[0-9]{2}:[0-9]{2}$/.test(String(it.time || "")));

  if (!pool.length) return null;

  // In progress: start <= now < end (estimated duration)
  const inProgress = pool.filter(it => {
    const startMin = timeSortKey(it.time);
    const endMin = startMin + getEstimatedDurationMinutes(it);
    return startMin <= nowMin && nowMin < endMin;
  });

  if (!inProgress.length) return null;

  // If several: pick the one that started most recently
  inProgress.sort((a,b) => timeSortKey(b.time) - timeSortKey(a.time));
  return inProgress[0] || null;
}

function __tlEnsureTimelineOpen() {
  const body = document.querySelector('[data-acc-body="timeline"]');
  if (body && body.classList.contains("hidden")) {
    const btn = document.querySelector('[data-acc="timeline"]');
    if (btn) btn.click();
  }
}

function __tlScrollToItemByKey(tlKey) {
  if (!tlKey) return false;
  const els = Array.from(document.querySelectorAll("#timelineList .timelineItem"));
  const el = els.find(x => (x.getAttribute("data-tl-key") || "") === String(tlKey));
  if (!el) return false;
  scrollToElWithOffset(el);
  return true;
}

function scrollToCurrentTimelineItem() {
  __tlEnsureTimelineOpen();

  const todayISO = todayYMD();
  timelineViewMode = "day";
  activeDayISO = todayISO;
  renderTimeline();

  const items = Array.isArray(__tlLastFilteredItems) ? __tlLastFilteredItems : [];
  const cur = __tlPickCurrentItemForToday(items, todayISO);
  if (!cur) {
    alert("No hay eventos en curso ahora mismo");
    return;
  }

  const key = cur.isNote ? `note:${todayISO}` : `${cur.actId ? "act" : (cur.legId ? "leg" : (cur.stayId ? "stay" : ""))}:${(cur.actId || cur.legId || cur.stayId || "")}`;
  __tlLastActualKey = key;
  __tlScrollToItemByKey(key);
}

function scrollToNextAfterCurrent() {
  __tlEnsureTimelineOpen();

  const items = Array.isArray(__tlLastFilteredItems) ? __tlLastFilteredItems : [];
  if (!items.length) { alert("No hay pr√≥ximos eventos."); return; }

  const now = new Date();

  const makeKey = (it) => {
    return it.isNote ? `note:${String(it.date || "")}` : `${it.actId ? "act" : (it.legId ? "leg" : (it.stayId ? "stay" : ""))}:${(it.actId || it.legId || it.stayId || "")}`;
  };

  // If we have a current "Actual" that is truly in progress now, next = item after it.
  let actualIdx = -1;
  if (__tlLastActualKey) {
    actualIdx = items.findIndex(it => makeKey(it) === __tlLastActualKey);
    if (actualIdx >= 0) {
      const it = items[actualIdx];
      const start = getEventStartDateTime(it);
      if (!start) {
        actualIdx = -1;
      } else {
        const durMin = getEstimatedDurationMinutes(it);
        const end = new Date(start.getTime() + durMin * 60000);
        if (!(start.getTime() <= now.getTime() && now.getTime() < end.getTime())) {
          actualIdx = -1;
        }
      }
    }
  }

  let next = null;

  if (actualIdx >= 0) {
    next = items[actualIdx + 1] || null;
  } else {
    // First future item in global ordering (can be tomorrow; includes items without time as 23:59)
    next = items.find(it => {
      const d = String(it.date || "");
      if (!d || d === "9999-99-99") return false;

      const start = getEventStartDateTime(it);
      if (start) {
        return start.getTime() >= now.getTime();
      }

      // No valid time: treat as end-of-day 23:59
      if (!/^[0-9]{4}-[0-9]{2}-[0-9]{2}$/.test(d)) return false;
      const dt = new Date(d + "T23:59:00");
      return dt.getTime() >= now.getTime();
    });
  }

  if (!next) { alert("No hay pr√≥ximos eventos."); return; }

  const dISO = String(next.date || "");
  if (!dISO || dISO === "9999-99-99") { alert("No hay pr√≥ximos eventos."); return; }

  timelineViewMode = "day";
  activeDayISO = dISO;
  renderTimeline();

  const key = makeKey(next);
  __tlLastActualKey = key;

  // Scroll to item (fallback to first item of that day)
  if (!__tlScrollToItemByKey(key)) {
    const first = items.find(it => String(it.date || "") === dISO);
    if (first) __tlScrollToItemByKey(makeKey(first));
  }
}

function scrollToTodayTimelineItem() {
  // Ensure the timeline accordion is open so the scroll makes sense to the user
  const body = document.querySelector('[data-acc-body="timeline"]');
  if (body && body.classList.contains("hidden")) {
    const btn = document.querySelector('[data-acc="timeline"]');
    if (btn) btn.click();
  }
  const t = todayYMD();
  const els = Array.from(document.querySelectorAll("#timelineList .timelineItem"));
  const todayEl = els.find(el => (el.getAttribute("data-date") || "") === t);
  if (todayEl) {
    scrollToElWithOffset(todayEl);
  } else {
    alert("No hay eventos para hoy.");
  }
}

function scrollToNextTimelineItem() {
  // Ensure the timeline accordion is open so the scroll makes sense to the user
  const body = document.querySelector('[data-acc-body="timeline"]');
  if (body && body.classList.contains("hidden")) {
    const btn = document.querySelector('[data-acc="timeline"]');
    if (btn) btn.click();
  }

  const t = todayYMD();
  const els = Array.from(document.querySelectorAll("#timelineList .timelineItem"));
  const next = els.find(el => {
    const d = el.getAttribute("data-date") || "9999-99-99";
    return d !== "9999-99-99" && d >= t;
  });

  if (next) {
    scrollToElWithOffset(next);
  } else {
    alert("No hay pr√≥ximos eventos con fecha a partir de hoy.");
  }
}

function showModal(title, bodyHtml, footerButtons = []) {
  $("modalTitle").textContent = title;
  $("modalBody").innerHTML = bodyHtml;
  const footer = $("modalFooter");
  footer.innerHTML = "";
  for (const b of footerButtons) footer.appendChild(b);
  $("modalBackdrop").classList.remove("hidden");
  $("modalBox").classList.remove("hidden");
}
function closeModal() {
  $("modalBackdrop").classList.add("hidden");
  $("modalBox").classList.add("hidden");
}
$("modalClose").addEventListener("click", closeModal);
$("modalBackdrop").addEventListener("click", closeModal);

/* ----------------------------- State ----------------------------- */
const LS_KEY = "miviaje.rewrite.v1";

// Section item accordion state (v80b)
const __sectionExpanded = {
  legs: new Set(),
  stays: new Set(),
  activities: new Set()
};

/* ---------------- Event Detail Sheet (V89D1) ---------------- */
let __eventSheetCtx = null;

// Event Sheet mode: single source of truth lives in __eventSheetCtx.mode ("view" | "edit")
function getEventSheetMode(){
  try { return (__eventSheetCtx && (__eventSheetCtx.mode === "view" || __eventSheetCtx.mode === "edit")) ? __eventSheetCtx.mode : "edit"; }
  catch { return "edit"; }
}

function applyEventSheetMode(){
  const mode = getEventSheetMode();
  const overlay = document.getElementById("eventSheetOverlay");
  const body = document.getElementById("eventSheetBody");
  if (mode === "view") document.body.classList.add("eventsheet-view");
  else document.body.classList.remove("eventsheet-view");

  const btnSave = document.getElementById("eventSheetSave");
  const btnTrash = document.getElementById("eventSheetTrash");
  const btnEdit = document.getElementById("eventSheetEdit");

  // Pencil is always available (transition to edit); never hide it
  if (btnEdit) {
    btnEdit.disabled = false;
    btnEdit.classList.remove("opacity-50");
    btnEdit.classList.toggle("is-active", mode === "edit");
  }

  // Mutating actions only in edit
  if (btnSave) btnSave.disabled = (mode !== "edit");
  if (btnTrash) btnTrash.disabled = (mode !== "edit");

  // Hard-lock editable controls in view (real read-only)
  if (body) {
    const lock = (mode === "view");
    body.querySelectorAll("input, textarea, select").forEach(el => {
      try {
        if (lock) {
          el.setAttribute("data-es-was-disabled", el.disabled ? "1" : "0");
          el.setAttribute("data-es-was-readonly", el.readOnly ? "1" : "0");
          el.disabled = true;
          el.readOnly = true;
        } else {
          // restore previous state if we captured it; default enable
          const wasDis = el.getAttribute("data-es-was-disabled");
          const wasRO = el.getAttribute("data-es-was-readonly");
          el.disabled = (wasDis === "1");
          el.readOnly = (wasRO === "1");
          el.removeAttribute("data-es-was-disabled");
          el.removeAttribute("data-es-was-readonly");
        }
      } catch {}
    });

    // Disable known mutating chips/toggles in view (but do NOT blanket-disable all buttons)
    body.querySelectorAll("[data-legmode], [data-leg-done], [data-act-done], [data-act-skip], [data-stay-done], [data-stay-skip]").forEach(el => {
      try { el.toggleAttribute("disabled", lock); } catch {}
    });
  }

  // Ensure guards are installed (capture blockers) once
  try { __ensureEventSheetViewGuards(); } catch {}
}

function setEventSheetMode(mode){
  const m = (mode === "view") ? "view" : "edit";
  if (!__eventSheetCtx) __eventSheetCtx = { kind:"", id:"", mode:m, isNew:false, sourceView:"" };
  __eventSheetCtx.mode = m;
  applyEventSheetMode();
}

// Capture-phase guards: block ONLY mutators in view, never block structural tools.
function __ensureEventSheetViewGuards(){
  const body = document.getElementById("eventSheetBody");
  if (!body || body.__esGuardsBound) return;
  body.__esGuardsBound = true;

  const allowIds = new Set(["eventSheetClose","eventSheetEdit","eventSheetNotes","eventSheetAttach"]);
  const isAllowed = (t) => {
    if (!t) return false;
    if (t.id && allowIds.has(t.id)) return true;
    if (t.closest && t.closest("#eventSheetClose,#eventSheetEdit,#eventSheetNotes,#eventSheetAttach")) return true;
    if (t.closest && t.closest("a")) return true; // navigation/links are consult
    if (t.closest && t.closest("[data-es-allow]")) return true;
    return false;
  };

  const isMutator = (t) => {
    if (!t) return false;
    const tag = (t.tagName||"").toLowerCase();
    if (tag === "input" || tag === "textarea" || tag === "select") return true;
    if (t.closest && t.closest("input,textarea,select")) return true;
    // known chips/toggles
    if (t.closest && t.closest("[data-legmode],[data-leg-done],[data-act-done],[data-act-skip],[data-stay-done],[data-stay-skip]")) return true;
    // generic mutator markers (safe)
    if (t.closest && t.closest("[data-mutates],[data-action='mutate']")) return true;
    return false;
  };

  const blockIfView = (e) => {
    if (getEventSheetMode() !== "view") return;
    const t = e.target;
    if (isAllowed(t)) return;
    if (!isMutator(t)) return;
    try { e.preventDefault(); e.stopPropagation(); } catch {}
  };

  ["click","input","change","keydown","paste"].forEach(ev => {
    body.addEventListener(ev, blockIfView, true);
  });
}

function __normKind(k){
  const raw = String(k||"").toLowerCase().trim();
  if (raw === "transport") return "leg";
  if (raw === "lodging") return "stay";
  if (raw === "activity") return "act";
  if (raw === "activities") return "act";
  return raw;
}


function legModeDefault(m){ const v=String(m||"").trim(); return (v==="train"||v==="bus"||v==="car"||v==="boat"||v==="plane") ? v : "plane"; }
function legModeIcon(m){
  const v = legModeDefault(m);
  return (v==="plane") ? "‚úàÔ∏è" : (v==="train") ? "üöÜ" : (v==="bus") ? "üöå" : (v==="car") ? "üöó" : "üö¢";
}
function legModeLabel(m){
  const v = legModeDefault(m);
  return (v==="plane") ? "Avi√≥n" : (v==="train") ? "Tren" : (v==="bus") ? "Bus" : (v==="car") ? "Coche" : "Barco";
}

let __dirtyTimeline = false;
let __dirtySummary = false;


function __buildSheetBlocks(body){
  if (!body) return null;
  body.innerHTML = `
    <div class="esBlock" id="esBlockA"><div class="esBlockTitle">Identidad</div><div id="esA"></div></div>
    <div class="esBlock" id="esBlockB"><div class="esBlockTitle">Ruta / Lugar</div><div id="esB"></div></div>
    <div class="esBlock" id="esBlockC"><div class="esBlockTitle">Tiempo</div><div id="esC"></div></div>
    <div class="esBlock" id="esBlockD"><div class="esBlockTitle">Coste</div><div id="esD"></div></div>
    <details class="esBlock" id="eventSheetMoreDetails">
      <summary><div class="esBlockTitle" style="margin:0;">M√°s detalles</div><div style="font-weight:900;">‚ñæ</div></summary>
      <div id="esE" style="margin-top:10px;"></div>
    </details>
  `;
  return {
    A: body.querySelector("#esA"),
    B: body.querySelector("#esB"),
    C: body.querySelector("#esC"),
    D: body.querySelector("#esD"),
    E: body.querySelector("#esE"),
  };
}


function updateSheetDynamicSummary(){
  const ctx = (window.__sheetCtx || (typeof __eventSheetCtx !== "undefined" ? __eventSheetCtx : null));
  if (!ctx || !ctx.kind || !ctx.id) return;

  const body = document.getElementById("eventSheetBody");
  if (!body) return;

  const routeEl = document.getElementById("sheetSummaryRoute");
  const timeEl  = document.getElementById("sheetSummaryTime");
  const costEl  = document.getElementById("sheetSummaryCost");
  if (!routeEl || !timeEl || !costEl) return;

  const id = String(ctx.id);
  const kind = String(ctx.kind);

  const qs = (sel) => body.querySelector(sel);
  const val = (el) => el ? String(el.value || "").trim() : "";

  let date = "", time = "", cost = "";

  if (kind === "leg"){
    const fromEl = qs(`[data-leg-from="${CSS.escape(id)}"]`);
    const toEl   = qs(`[data-leg-to="${CSS.escape(id)}"]`);
    const dateEl = qs(`[data-leg-date="${CSS.escape(id)}"]`);
    const timeElI = qs(`[data-leg-time="${CSS.escape(id)}"]`);
    const costElI = qs(`[data-leg-cost="${CSS.escape(id)}"]`);

    const from = val(fromEl);
    const to = val(toEl);
    date = val(dateEl);
    time = val(timeElI);
    cost = val(costElI);

    routeEl.textContent = (from && to) ? `${from} ‚Üí ${to}` : (from || to || "‚Äî");
  } else {
    // stays/acts: try common inputs inside moved editor
    const placeEl = qs(`input[data-stay-city="${CSS.escape(id)}"], input[data-act-city="${CSS.escape(id)}"], input[name="city"], input[data-field="city"]`)
                || qs(`input[placeholder*="Ciudad"], input[placeholder*="Lugar"]`);
    const dateEl  = qs(`input[type="date"]`);
    const timeElI = qs(`input[type="time"]`);
    const costElI = qs(`input[name="cost"], input[data-field="cost"], input[type="number"]`);

    const place = val(placeEl);
    date = val(dateEl);
    time = val(timeElI);
    cost = val(costElI);

    routeEl.textContent = place || "‚Äî";
  }

  timeEl.textContent = date ? `${date}${time ? (" ¬∑ "+time) : ""}` : "‚Äî";
  costEl.textContent = cost ? `${cost}` : "‚Äî";
}


function __updateTransportSheetTitle(mode, from, to){
  try{
    const t = document.getElementById("eventSheetTitle");
    if (!t) return;
    const ico = (typeof legModeIcon==="function") ? legModeIcon(mode) : "‚úàÔ∏è";
    const a = String(from||"").trim();
    const b = String(to||"").trim();
    const route = (a||b) ? `${a||"‚Äî"} ‚Üí ${b||"‚Äî"}` : "Nuevo transporte";
    t.textContent = `${ico} ${route}`.trim();
  } catch {}
}

function __renderLegEditorInSheet(body, legObj, itemId, isNew){
  if (!body || !legObj) return false;
  body.innerHTML = "";

  // Chips host
  const chipsHost = document.createElement("div");
  chipsHost.className = "mb-3";


  const modes = [
    { key: "plane", label: "Avi√≥n", icon: "‚úàÔ∏è" },
    { key: "train", label: "Tren", icon: "üöÜ" },
    { key: "bus", label: "Bus", icon: "üöå" },
    { key: "car", label: "Coche", icon: "üöó" },
    { key: "boat", label: "Barco", icon: "üö¢" }
  ];

  chipsHost.innerHTML = `
    <div class="flex gap-2 overflow-x-auto no-scrollbar pb-1">
      ${modes.map(m => `
        <button type="button"
          data-leg-mode="${m.key}"
          aria-label="${m.label}"
        class="legModeChip tap px-4 py-2 rounded-2xl border border-slate-200 bg-white text-sm font-semibold flex items-center gap-2">
          <span class="text-2xl leading-none">${m.icon}</span>
          <span class="sr-only">${m.label}</span>
        </button>
      `).join("")}
    </div>
  `;


  // 2-column form
  const wrap = document.createElement("div");
  const costVal = (isNew && !legObj.cost) ? "" : (legObj.cost ?? "");
  wrap.className = "sheet-leg-editor";
  wrap.innerHTML = `
    <div class="grid grid-cols-1 sm:grid-cols-12 gap-3 items-start">
      <div class="sm:col-span-6">
        <div class="text-xs font-extrabold tracking-wide text-slate-500 mb-2">SALIDA</div>
        <label class="text-xs text-slate-600">Ciudad salida</label>
        <input data-sheet-leg="from" class="mt-1 w-full px-3 py-2 rounded-xl border border-slate-200" placeholder="Ciudad salida">
        <label class="text-xs text-slate-600 mt-2 block">Lugar salida</label>
        <input data-sheet-leg="placeOut" class="mt-1 w-full px-3 py-2 rounded-xl border border-slate-200" placeholder="Lugar salida">
        <label class="text-xs text-slate-600 mt-2 block">Fecha salida</label>
        <input data-sheet-leg="dateOut" type="date" class="mt-1 w-full px-3 py-1.5 text-sm rounded-xl border border-slate-200 h-10">
        <label class="text-xs text-slate-600 mt-2 block">Hora salida</label>
        <div class="mt-1 flex items-center gap-1">
          <input data-sheet-leg="timeOut" type="time" class="w-full px-3 py-1.5 text-sm rounded-xl border border-slate-200 h-10">
          <input data-sheet-leg="tzFrom" type="hidden" value="">
          <span id="legTzFromBadge" class="shrink-0 px-2 py-1.5 rounded-xl border border-slate-200 bg-white text-xs font-semibold h-10 flex items-center">UTC‚Äî</span>
        </div>
      </div>

      <div class="sm:col-span-6">
        <div class="text-xs font-extrabold tracking-wide text-slate-500 mb-2">LLEGADA</div>
        <label class="text-xs text-slate-600">Ciudad llegada</label>
        <input data-sheet-leg="to" class="mt-1 w-full px-3 py-2 rounded-xl border border-slate-200" placeholder="Ciudad llegada">
        <label class="text-xs text-slate-600 mt-2 block">Lugar llegada</label>
        <input data-sheet-leg="placeIn" class="mt-1 w-full px-3 py-2 rounded-xl border border-slate-200" placeholder="Lugar llegada">
        <label class="text-xs text-slate-600 mt-2 block">Fecha llegada</label>
        <input data-sheet-leg="dateIn" type="date" class="mt-1 w-full px-3 py-1.5 text-sm rounded-xl border border-slate-200 h-10">
        <label class="text-xs text-slate-600 mt-2 block">Hora llegada</label>
        <div class="mt-1 flex items-center gap-1">
          <input data-sheet-leg="timeIn" type="time" class="w-full px-3 py-1.5 text-sm rounded-xl border border-slate-200 h-10">
          <input data-sheet-leg="tzTo" type="hidden" value="">
          <span id="legTzToBadge" class="shrink-0 px-2 py-1.5 rounded-xl border border-slate-200 bg-white text-xs font-semibold h-10 flex items-center">UTC‚Äî</span>
        </div>
      </div>

      <div class="sm:col-span-12">
        <label class="text-xs text-slate-600">Coste</label>
        <div class="mt-1 flex items-center gap-2">
          <input data-sheet-leg="cost" type="number" min="0" step="0.01" class="w-full px-3 py-2 rounded-xl border border-slate-200" placeholder="0.00">
          <select data-sheet-leg="currency" class="shrink-0 px-3 py-2 rounded-xl border border-slate-200 bg-white text-sm font-semibold">
            <option value="EUR">EUR ‚Ç¨</option>
            <option value="USD">USD $</option>
            <option value="GBP">GBP ¬£</option>
            <option value="CHF">CHF</option>
          </select>
        </div>
      </div>
    </div>
  `;
  wrap.prepend(chipsHost);
  body.appendChild(wrap);

  // Fill values (map legacy fields)
  const v = (x) => (x == null ? "" : String(x));
  const qs = (k) => wrap.querySelector(`[data-sheet-leg="${k}"]`);

  qs("from").value = v(legObj.from);
  qs("to").value = v(legObj.to);
  qs("placeOut").value = v(legObj.placeOut || "");
  qs("placeIn").value = v(legObj.placeIn || "");
  try{ __wireLegAutocomplete(wrap); }catch{}
  qs("dateOut").value = v(legObj.date || "");
  qs("timeOut").value = v(legObj.time || "");
  qs("dateIn").value = v(legObj.arriveDate || "");
  qs("timeIn").value = v(legObj.arriveTime || "");
  qs("tzFrom").value = (legObj.tzFrom == null || legObj.tzFrom === "" ? "" : String(legObj.tzFrom));
  qs("tzTo").value = (legObj.tzTo == null || legObj.tzTo === "" ? "" : String(legObj.tzTo));
  qs("cost").value = (legObj.cost == null ? "" : String(legObj.cost));
  qs("currency").value = v(legObj.currency || "EUR");

  // Placeholders based on mode
  try {
    const mode = legModeDefault(legObj.mode);
    qs("placeOut").placeholder = __legPlacePlaceholder(mode, "from");
    qs("placeIn").placeholder  = __legPlacePlaceholder(mode, "to");

  // Auto UTC offsets from city (no manual selector). Values stored in hidden tzFrom/tzTo inputs.
  const tzBadgeFrom = document.getElementById("legTzFromBadge");
  const tzBadgeTo   = document.getElementById("legTzToBadge");
  function __updateLegTzBadges(){
    try{
      const cityFrom = qs("from").value;
      const cityTo   = qs("to").value;
      const d0 = qs("dateOut").value;
      const t0 = qs("timeOut").value;
      const d1 = qs("dateIn").value;
      const t1 = qs("timeIn").value;

      const off0 = __deriveUtcOffsetHours(cityFrom, d0, t0);
      const off1 = __deriveUtcOffsetHours(cityTo, d1, t1);

      if (Number.isFinite(off0)) {
        qs("tzFrom").value = String(off0);
        // keep model in sync (programmatic value changes do not trigger input events)
        legObj.tzFrom = off0;
        if (tzBadgeFrom) tzBadgeFrom.textContent = formatUTCOffset(off0);
      } else {
        qs("tzFrom").value = "";
        legObj.tzFrom = null;
        if (tzBadgeFrom) tzBadgeFrom.textContent = "UTC‚Äî";
      }

      if (Number.isFinite(off1)) {
        qs("tzTo").value = String(off1);
        // keep model in sync (programmatic value changes do not trigger input events)
        legObj.tzTo = off1;
        if (tzBadgeTo) tzBadgeTo.textContent = formatUTCOffset(off1);
      } else {
        qs("tzTo").value = "";
        legObj.tzTo = null;
        if (tzBadgeTo) tzBadgeTo.textContent = "UTC‚Äî";
      }
    } catch {}
  }
  // Initial paint + live updates
  __updateLegTzBadges();
  ["from","to","dateOut","timeOut","dateIn","timeIn"].forEach(k=>{
    try { qs(k).addEventListener("input", __updateLegTzBadges); } catch {}
    try { qs(k).addEventListener("change", __updateLegTzBadges); } catch {}
  });

  } catch {}


  const chips = wrap.querySelectorAll(".legModeChip");

  function updateChipUI(selected){
    chips.forEach(c => {
      if (c.dataset.legMode === selected){
        c.classList.remove("bg-white","border-slate-200");
        c.classList.add("bg-slate-900","border-slate-900","text-white");
      } else {
        c.classList.remove("bg-slate-900","border-slate-900","text-white");
        c.classList.add("bg-white","border-slate-200");
      }
    });
  }

  let currentMode = legModeDefault(legObj.mode);
  updateChipUI(currentMode);

  try{ __updateTransportSheetTitle(currentMode, legObj.from, legObj.to); }catch{}


  chips.forEach(c=>{
    c.addEventListener("click", ()=>{
      currentMode = c.dataset.legMode;
      updateChipUI(currentMode);
      // persist mode + update placeholders (no global rerender)
      try { legObj.mode = currentMode; } catch {}
      try{ __updateTransportSheetTitle(currentMode, legObj.from, legObj.to); }catch{}
      try { __updateTransportSheetTitle(currentMode, legObj.from, legObj.to); } catch {}
      try {
        qs("placeOut").placeholder = __legPlacePlaceholder(currentMode, "from");
        qs("placeIn").placeholder  = __legPlacePlaceholder(currentMode, "to");
      } catch {}
    });
  });


  // Bindings (write directly to the same object reference)
  const bind = (key, fn) => {
    const el = qs(key);
    if (!el) return;
    el.addEventListener("input", () => { try { fn(el.value); } catch {} });
    el.addEventListener("change", () => { try { fn(el.value); } catch {} });
  };

  bind("from", (val)=>{ legObj.from = val; try{ __updateTransportSheetTitle(currentMode, legObj.from, legObj.to); }catch{} });
  bind("to", (val)=>{ legObj.to = val;   try{ __updateTransportSheetTitle(currentMode, legObj.from, legObj.to); }catch{} });
  bind("placeOut", (val)=>{ legObj.placeOut = val; });
  bind("placeIn", (val)=>{ legObj.placeIn = val; });
  bind("dateOut", (val)=>{ legObj.date = val; });
  bind("timeOut", (val)=>{ legObj.time = val; });
  bind("tzFrom", (val)=>{ const s = String(val||"").trim(); legObj.tzFrom = (s===""? null : parseInt(s,10)); });
  bind("dateIn", (val)=>{
    legObj.arriveDate = val;
    legObj.dateIn = val;        // compat legacy para timeline/summary
  });
  bind("timeIn", (val)=>{
    legObj.arriveTime = val;
    legObj.timeIn = val;        // compat legacy para timeline/summary
  });
  bind("tzTo", (val)=>{ const s = String(val||"").trim(); legObj.tzTo = (s===""? null : parseInt(s,10)); });
  bind("cost", (val)=>{ const s = String(val||"").trim(); legObj.cost = (s === "") ? null : parseMoney(s); });
  bind("currency", (val)=>{ legObj.currency = val; });
  return true;
}


function __updateStaySheetTitle(city, name){
  try{
    const t = document.getElementById("eventSheetTitle");
    if (!t) return;
    const c = String(city||"").trim();
    const n = String(name||"").trim();
    const detail = [c,n].filter(Boolean).join(" ¬∑ ");
    t.textContent = `üè® ${(detail || "Alojamiento")}`.trim();
  } catch {}
}
function __updateActSheetTitle(city, title){
  try{
    const t = document.getElementById("eventSheetTitle");
    if (!t) return;
    const c = String(city||"").trim();
    const a = String(title||"").trim();
    const detail = [c,a].filter(Boolean).join(" ¬∑ ");
    t.textContent = `üéØ ${(detail || "Actividad")}`.trim();
  } catch {}
}

function __renderStayEditorInSheet(body, stayObj, itemId, isNew){
  if (!body || !stayObj) return false;
  body.innerHTML = "";

  // --- Simple, robust date helpers (no timezones yet) ---
  const __isoToDate = (iso)=>{
    const s = String(iso||"").trim();
    if (!/^\d{4}-\d{2}-\d{2}$/.test(s)) return null;
    // Use midday to avoid DST edge cases
    const d = new Date(s + "T12:00:00");
    return isNaN(d.getTime()) ? null : d;
  };
  const __dateToISO = (d)=>{
    if (!d || isNaN(d.getTime())) return "";
    const y = d.getFullYear();
    const m = String(d.getMonth()+1).padStart(2,"0");
    const day = String(d.getDate()).padStart(2,"0");
    return `${y}-${m}-${day}`;
  };
  const __addDaysISO = (iso, days)=>{
    const d = __isoToDate(iso);
    if (!d) return "";
    const n = Number(days||0);
    d.setDate(d.getDate() + (isFinite(n) ? n : 0));
    return __dateToISO(d);
  };
  const __diffDaysISO = (fromISO, toISO)=>{
    const a = __isoToDate(fromISO);
    const b = __isoToDate(toISO);
    if (!a || !b) return null;
    const ms = b.getTime() - a.getTime();
    const days = Math.round(ms / (24*60*60*1000));
    return isFinite(days) ? days : null;
  };

  // Backwards compatible field name (new): stayObj.checkout (YYYY-MM-DD)
  if (stayObj.checkout == null || String(stayObj.checkout||"").trim() === "") {
    const base = String(stayObj.date||"").trim();
    const nights = Math.max(1, parseInt(String(stayObj.nights ?? 1),10) || 1);
    const co = __addDaysISO(base, nights);
    if (co) stayObj.checkout = co;
  }

  const wrap = document.createElement("div");
  wrap.className = "sheet-leg-editor sheet-stay-editor";

  wrap.innerHTML = `<div class="grid grid-cols-2 gap-3 items-start">
  <!-- Columna izquierda -->
  <div class="min-w-0 space-y-3">
    <div>
      <label class="text-xs text-slate-600">Alojamiento / Hotel / Apartamento</label>
      <input data-stay-name="${escapeHtml(String(itemId))}" data-sheet-stay="name"
        class="mt-1 w-full px-3 py-2 rounded-xl border border-slate-200" placeholder="Nombre del alojamiento">
    </div>

    <div>
      <label class="text-xs text-slate-600">Check-in (fecha)</label>
      <input data-stay-date="${escapeHtml(String(itemId))}" data-sheet-stay="date" type="date"
        class="mt-1 w-full px-3 py-1.5 text-sm rounded-xl border border-slate-200 h-10">
    </div>

    <div>
      <label class="text-xs text-slate-600">Hora de check-in</label>
      <input data-stay-time="${escapeHtml(String(itemId))}" data-sheet-stay="time" type="time"
        class="mt-1 w-full px-3 py-1.5 text-sm rounded-xl border border-slate-200 h-10">
    </div>

    <div>
      <label class="text-xs text-slate-600">UTC</label>
      <div class="mt-1 h-10 px-3 rounded-xl border border-slate-200 flex items-center text-sm font-semibold text-slate-600 bg-white utcLabel">UTC</div>
    </div>

    <div>
      <label class="text-xs text-slate-600">Noches</label>
      <input data-stay-nights="${escapeHtml(String(itemId))}" data-sheet-stay="nights" type="number" min="1" step="1"
        class="mt-1 w-full px-3 py-2 rounded-xl border border-slate-200" placeholder="1">
    </div>
  </div>

  <!-- Columna derecha -->
  <div class="min-w-0 space-y-3">
    <div>
      <label class="text-xs text-slate-600">Ciudad</label>
      <input data-stay-city="${escapeHtml(String(itemId))}" data-sheet-stay="city"
        class="mt-1 w-full px-3 py-2 rounded-xl border border-slate-200" placeholder="Ciudad">
    </div>

    <div>
      <label class="text-xs text-slate-600">Check-out (fecha)</label>
      <input data-sheet-stay="checkout" type="date"
        class="mt-1 w-full px-3 py-1.5 text-sm rounded-xl border border-slate-200 h-10">
    </div>

    <div>
      <label class="text-xs text-slate-600">Hora de check-out <span class="text-slate-400 font-normal">(opcional)</span></label>
      <input data-sheet-stay="checkoutTime" type="time"
        class="mt-1 w-full px-3 py-1.5 text-sm rounded-xl border border-slate-200 h-10" placeholder="">
    </div>

    <div>
      <label class="text-xs text-slate-600">UTC</label>
      <div class="mt-1 h-10 px-3 rounded-xl border border-slate-200 flex items-center text-sm font-semibold text-slate-600 bg-white utcLabel">UTC</div>
    </div>

    <div>
      <label class="text-xs text-slate-600">Coste</label>
      <div class="mt-1 flex items-center gap-2">
        <input data-stay-cost="${escapeHtml(String(itemId))}" data-sheet-stay="cost" type="number" min="0" step="0.01"
          class="w-full px-3 py-2 rounded-xl border border-slate-200" placeholder="0.00">
        <label class="sr-only">Moneda</label>
        <select data-stay-currency="${escapeHtml(String(itemId))}" data-sheet-stay="currency"
          class="shrink-0 px-3 py-2 h-10 rounded-xl border border-slate-200 bg-white text-sm font-semibold">
          <option value="EUR">EUR ‚Ç¨</option>
          <option value="USD">USD $</option>
          <option value="GBP">GBP ¬£</option>
          <option value="CHF">CHF</option>
        </select>
      </div>
    </div>
  </div>
</div>`;

  body.appendChild(wrap);

  const qs = (k) => wrap.querySelector(`[data-sheet-stay="${k}"]`);
  const v = (x) => (x == null ? "" : String(x));

  // Init values
  qs("city").value = v(stayObj.city);
  try{ __wireStayAutocomplete(wrap); }catch{}
  qs("name").value = v(stayObj.name);
  qs("date").value = v(stayObj.date || "");
  qs("time").value = v(stayObj.time || "");
  qs("nights").value = v(stayObj.nights ?? 1);
  qs("checkout").value = v(stayObj.checkout || "");
  qs("checkoutTime").value = v(stayObj.checkoutTime || stayObj.checkout_time || "");
  qs("currency").value = v(stayObj.currency || "EUR");
  qs("cost").value = (stayObj.cost == null ? "" : String(stayObj.cost));

  try { __updateStaySheetTitle(stayObj.city, stayObj.name); } catch {}

  const __syncFromCheckinAndNights = ()=>{
    const ci = String(stayObj.date||"").trim();
    const n = Math.max(1, parseInt(String(stayObj.nights ?? 1),10) || 1);
    const co = __addDaysISO(ci, n);
    if (co) {
      stayObj.checkout = co;
      const el = qs("checkout"); if (el) el.value = co;
    }
  };
  const __syncFromCheckout = ()=>{
    const ci = String(stayObj.date||"").trim();
    const co = String(stayObj.checkout||"").trim();
    const d = __diffDaysISO(ci, co);
    if (d == null) return;
    const nights = Math.max(1, d);
    stayObj.nights = nights;
    const el = qs("nights"); if (el) el.value = String(nights);
  };

  const bind = (key, fn) => {
    const el = qs(key);
    if (!el) return;
    el.addEventListener("input", () => { try { fn(el.value); } catch {} });
    el.addEventListener("change", () => { try { fn(el.value); } catch {} });
  };

  bind("city", (val)=>{ stayObj.city = val; try{ __updateStaySheetTitle(stayObj.city, stayObj.name); }catch{} });
  bind("name", (val)=>{ stayObj.name = val; try{ __updateStaySheetTitle(stayObj.city, stayObj.name); }catch{} });

  bind("date", (val)=>{
    stayObj.date = val;
    // keep checkout aligned when possible
    __syncFromCheckinAndNights();
  });

  bind("time", (val)=>{ stayObj.time = val; });

  bind("nights", (val)=>{
    const n = Math.max(1, parseInt(String(val||"1"),10) || 1);
    stayObj.nights = n;
    __syncFromCheckinAndNights();
  });

  bind("checkout", (val)=>{
    stayObj.checkout = val;
    __syncFromCheckout();
  });

  bind("checkoutTime", (val)=>{ stayObj.checkoutTime = val; });

  bind("currency", (val)=>{ stayObj.currency = val; });

  bind("cost", (val)=>{
    const s = String(val||"").trim();
    stayObj.cost = (s === "") ? null : parseMoney(s);
  });

  return true;
}


function __renderActEditorInSheet(body, actObj, itemId, isNew){
  if (!body || !actObj) return false;
  body.innerHTML = "";

  // Ensure optional fields exist (no currency logic yet)
  if (actObj.duration == null) actObj.duration = "";
  if (actObj.currency == null) actObj.currency = (state.displayCurrency || "EUR");

  const wrap = document.createElement("div");
  wrap.className = "sheet-leg-editor sheet-act-editor";

  // Premium two-column layout (clean + consistent)
  wrap.innerHTML = `
    <div class="grid grid-cols-2 gap-3 items-start">
      <!-- Fila 1 -->
      <div class="min-w-0">
        <label class="text-xs text-slate-600">Actividad</label>
        <input data-act-title="${escapeHtml(String(itemId))}" data-sheet-act="title"
          class="mt-1 w-full px-3 py-2 rounded-xl border border-slate-200" placeholder="Ej: Museo / Tour / Restaurante">
        ${actObj.fromAI ? `<div class="mt-2 text-xs text-slate-500">A√±adida desde IA</div>` : ``}
      </div>

      <div class="min-w-0">
        <label class="text-xs text-slate-600">Ciudad</label>
        <input data-act-city="${escapeHtml(String(itemId))}" data-sheet-act="city"
          class="mt-1 w-full px-3 py-2 rounded-xl border border-slate-200" placeholder="Ciudad">
      </div>

      <!-- Fila 2 -->
      <div class="min-w-0">
        <label class="text-xs text-slate-600">Fecha</label>
        <input data-act-date="${escapeHtml(String(itemId))}" data-sheet-act="date" type="date"
          class="mt-1 w-full px-3 py-1.5 text-sm rounded-xl border border-slate-200 h-10">
      </div>

      <div class="min-w-0">
        <!-- spacer to align duration with hour (fila 3) -->
        <div class="h-10"></div>
      </div>

      <!-- Fila 3 -->
      <div class="min-w-0">
        <label class="text-xs text-slate-600">Hora</label>
        <input data-act-time="${escapeHtml(String(itemId))}" data-sheet-act="time" type="time"
          class="mt-1 w-full px-3 py-1.5 text-sm rounded-xl border border-slate-200 h-10">
      </div>

      <div class="min-w-0">
        <label class="text-xs text-slate-600">Duraci√≥n</label>
        <input data-act-duration="${escapeHtml(String(itemId))}" data-sheet-act="duration"
          class="mt-1 w-full px-3 py-1.5 text-sm rounded-xl border border-slate-200 h-10" placeholder="Ej: 1h 30m">
      </div>

      <!-- Fila 4 -->
      <div class="min-w-0">
        <label class="text-xs text-slate-600">UTC</label>
        <div class="mt-1 h-10 px-3 rounded-xl border border-slate-200 flex items-center text-sm font-semibold text-slate-600 bg-white utcLabel">UTC</div>
      </div>

      <div class="min-w-0">
        <label class="text-xs text-slate-600">UTC</label>
        <div class="mt-1 h-10 px-3 rounded-xl border border-slate-200 flex items-center text-sm font-semibold text-slate-600 bg-white utcLabel">UTC</div>
      </div>

      <!-- Fila 5 -->
      <div class="min-w-0">
        <label class="text-xs text-slate-600">Importe</label>
        <input data-act-cost="${escapeHtml(String(itemId))}" data-sheet-act="cost" type="number" min="0" step="0.01"
          class="mt-1 w-full px-3 py-2 rounded-xl border border-slate-200" placeholder="0.00">
      </div>

      <div class="min-w-0">
        <label class="text-xs text-slate-600">Moneda</label>
        <select data-act-currency="${escapeHtml(String(itemId))}" data-sheet-act="currency"
          class="mt-1 w-full px-3 py-2 rounded-xl border border-slate-200 bg-white">
          <option value="EUR">EUR ‚Ç¨</option>
          <option value="USD">USD $</option>
          <option value="GBP">GBP ¬£</option>
          <option value="CHF">CHF</option>
          <option value="JPY">JPY ¬•</option>
          <option value="CAD">CAD</option>
          <option value="AUD">AUD</option>
          <option value="MXN">MXN</option>
        </select>
      </div>
    </div>
  `;

  body.appendChild(wrap);

  const qs = (k) => wrap.querySelector(`[data-sheet-act="${k}"]`);
  const v = (x) => (x == null ? "" : String(x));

  qs("title").value = v(actObj.title);
  qs("city").value = v(actObj.city);
  try{ __wireActAutocomplete(wrap); }catch{}
  qs("date").value = v(actObj.date || "");
  qs("time").value = v(actObj.time || "");
  qs("duration").value = v(actObj.duration || "");
  qs("currency").value = v(actObj.currency || "EUR");
  qs("cost").value = (actObj.cost == null ? "" : String(actObj.cost));

  try { __updateActSheetTitle(actObj.city, actObj.title); } catch {}

  const bind = (key, fn) => {
    const el = qs(key);
    if (!el) return;
    el.addEventListener("input", () => { try { fn(el.value); } catch {} });
    el.addEventListener("change", () => { try { fn(el.value); } catch {} });
  };

  bind("title", (val)=>{ actObj.title = val; try{ __updateActSheetTitle(actObj.city, actObj.title); }catch{} });
  bind("city", (val)=>{ actObj.city = val; try{ __updateActSheetTitle(actObj.city, actObj.title); }catch{} });
  bind("date", (val)=>{ actObj.date = val; });
  bind("time", (val)=>{ actObj.time = val; });
  bind("duration", (val)=>{ actObj.duration = val; });
  bind("currency", (val)=>{ actObj.currency = String(val||"").trim() || "EUR"; });
  bind("cost", (val)=>{ const s = String(val||"").trim(); actObj.cost = (s === "") ? null : parseMoney(s); });

  return true;
}


function __legPlacePlaceholder(mode, which){
  const m = (typeof legModeDefault === "function") ? legModeDefault(mode) : String(mode||"plane");
  const w = (which === "to") ? "llegada" : "salida";
  if (m === "plane") return `Aeropuerto ${w}`;
  if (m === "train") return `Estaci√≥n ${w}`;
  if (m === "bus") return `Estaci√≥n bus ${w}`;
  if (m === "boat") return `Puerto ${w}`;
  return `Punto ${w}`; // car default
}
function __applyLegPlaceholdersInSheet(id, mode){
  const body = document.getElementById("eventSheetBody");
  if (!body) return;
  const out = body.querySelector(`[data-leg-placeout="${CSS.escape(String(id))}"]`);
  const inn = body.querySelector(`[data-leg-placein="${CSS.escape(String(id))}"]`);
  if (out) out.placeholder = __legPlacePlaceholder(mode, "from");
  if (inn) inn.placeholder = __legPlacePlaceholder(mode, "to");
}

function openEventSheet({ kind, id, mode, isNew, sourceView } = {}) {
  const k = __normKind(kind);
  const itemId = String(id||"").trim();
  const m = (mode === "view") ? "view" : "edit";
  const __srcView = (sourceView ? String(sourceView) : (typeof activeView !== "undefined" ? String(activeView) : "")) || "";
  if (!itemId || (k !== "leg" && k !== "stay" && k !== "act")) return;

  const overlay = document.getElementById("eventSheetOverlay");
  const sheet = document.getElementById("eventSheet");
  const titleEl = document.getElementById("eventSheetTitle");
  const body = document.getElementById("eventSheetBody");
  const mainScroll = document.getElementById("mainScroll");
  if (!overlay || !sheet || !titleEl || !body) return;
  // Event Sheet context (single source of truth)
  __eventSheetCtx = { kind: k, id: itemId, mode: m, isNew: !!isNew, sourceView: __srcView };

  // V89E5D: bind sheet trash context
  try {
    const sheetTrash = document.getElementById("eventSheetTrash");
    if (sheetTrash) { sheetTrash.dataset.kind = k; sheetTrash.dataset.id = itemId; }
  } catch {}


  // Reset any previous sheet-only UI fragments
  try { body.__chipsHost = null; } catch {}

  // Close any previous instance safely
  try { closeEventSheet({ silent: true }); } catch {}

function renderLegModeChips(container, leg, onSelect){
  if (!container) return;
  const cur = legModeDefault(leg && leg.mode);
  const mk = (val, icon, txt) => {
    const active = (cur === val);
    const cls = "tap px-3 py-2 rounded-full text-sm font-semibold border flex items-center gap-2 " +
      (active ? "bg-slate-900 text-white border-slate-900" : "bg-white text-slate-700 border-slate-200");
    return `<button type="button" class="${cls}" data-legmode="${val}" aria-pressed="${active ? "true" : "false"}">${icon} ${txt}</button>`;
  };
  container.innerHTML =
    `<div class="flex gap-2 overflow-x-auto pb-1">` +
      mk("plane","‚úàÔ∏è","Avi√≥n") +
      mk("train","üöÜ","Tren") +
      mk("bus","üöå","Bus") +
      mk("car","üöó","Coche") +
      mk("boat","üö¢","Barco") +
    `</div>`;

  container.querySelectorAll("[data-legmode]").forEach(btn=>{
    btn.addEventListener("click", (e)=> {
      try { e.preventDefault(); e.stopPropagation(); } catch {}
      const v = btn.getAttribute("data-legmode");
      if (!leg || !v) return;

      // Set selected mode (never overwrite an existing valid mode with default unless empty)
      leg.mode = legModeDefault(v);

      try { if (typeof saveState === "function") saveState(); } catch {}

      const sheetOpen = document.body.classList.contains("sheet-open");
      const sameLegInSheet = (typeof __eventSheetCtx !== "undefined" && __eventSheetCtx && __eventSheetCtx.kind === "leg" && String(__eventSheetCtx.id) === String(leg.id));

      // While sheet is open (move-node editor), avoid any rerenders that rebuild lists/sections.
      if (sheetOpen && sameLegInSheet) {
        __dirtyTimeline = true;
        __dirtySummary = true;
        if (typeof onSelect === "function") onSelect(leg.mode);
        // Update only local chips UI
        renderLegModeChips(container, leg, onSelect);
        return;
      }

      // If chips are ever used outside the sheet: safe refresh
      try { if (typeof renderLegs === "function") renderLegs(); } catch {}
      try { if (typeof renderTimeline === "function") renderTimeline(); } catch {}
      try { if (typeof calcSummary === "function") calcSummary(); } catch {}
      if (typeof onSelect === "function") onSelect(leg.mode);
      renderLegModeChips(container, leg, onSelect);
    });
  });
}


  // Ensure expanded sets + rerender so editor node exists
  try {
    if (k === "leg") { __sectionExpanded?.legs?.add(itemId); if (typeof renderLegs === "function") renderLegs(); }
    if (k === "stay") { __sectionExpanded?.stays?.add(itemId); if (typeof renderStays === "function") renderStays(); }
    if (k === "act") { __sectionExpanded?.activities?.add(itemId); if (typeof renderActivities === "function") renderActivities(); }
  } catch {}

  // Find the real editor node (move-node approach: avoid duplicate IDs)
  let node = null;
  let legObj = null;
  let stayObj = null;
  let actObj = null;

  try {
    const sc = (typeof curScenario === "function") ? curScenario() : null;
    if (k === "leg") legObj = sc && Array.isArray(sc.legs) ? sc.legs.find(x => String(x && x.id) === String(itemId)) : null;
    if (k === "stay") stayObj = sc && Array.isArray(sc.stays) ? sc.stays.find(x => String(x && x.id) === String(itemId)) : null;
    if (k === "act") actObj = sc && Array.isArray(sc.activities) ? sc.activities.find(x => String(x && x.id) === String(itemId)) : null;
  } catch {}

  if (k === "leg" && !legObj) { alert("No se encontr√≥ el evento"); return; }
  if (k === "stay" && !stayObj) { alert("No se encontr√≥ el evento"); return; }
  if (k === "act" && !actObj) { alert("No se encontr√≥ el evento"); return; }

// Build a nice title
  try {
    const it = (typeof getItemByTypeAndId === "function") ? getItemByTypeAndId(k, itemId) : null;
    let label = (k === "leg") ? "Transporte" : (k === "stay") ? "Alojamiento" : "Actividad";
    let detail = "";
    let ico = "";
    if (it && k === "leg") ico = legModeIcon(it.mode);
    if (it && k === "stay") ico = "üè®";
    if (it && k === "act") ico = "üéØ";
    if (it && k === "leg") detail = `${it.from||""} ‚Üí ${it.to||""}`.trim();
    if (it && k === "stay") detail = `${it.name||it.place||""}`.trim();
    if (it && k === "act") detail = `${it.title||it.name||""}`.trim();
    titleEl.textContent = (isNew ? ("Nuevo " + label) : label);
    if (ico) titleEl.textContent = `${ico} ${titleEl.textContent}`;
    if (detail) titleEl.textContent = `${titleEl.textContent} ¬∑ ${detail}`;
  } catch { titleEl.textContent = "Evento"; }

  // LEG: render isolated editor HTML (no DOM move from section)
  if (k === "leg") {
    __eventSheetCtx = { kind: k, id: itemId, mode: m, isNew: !!isNew, sourceView: __srcView, prevActiveView: (typeof activeView !== "undefined" ? String(activeView) : ""), prevScrollTop: mainScroll ? mainScroll.scrollTop : 0 };
    const ok = __renderLegEditorInSheet(body, legObj, itemId, !!isNew);
    if (!ok) { alert("No se pudo abrir el editor"); return; }

    overlay.classList.remove("hidden");
    document.body.classList.add("sheet-open");
    try { applyEventSheetMode(); } catch {}
    // In view mode we avoid focusing fields automatically
    try { if (getEventSheetMode() === "edit") { const f = sheet.querySelector("input,textarea,select"); if (f) f.focus({preventScroll:true}); } } catch {}
    return;
  }

  // Header type + icon
  try {
    const typeIconEl = document.getElementById("eventSheetTypeIcon");
    const typeLabelEl = document.getElementById("eventSheetTypeLabel");
    if (typeLabelEl) typeLabelEl.textContent = (k === "leg") ? "Transporte" : (k === "stay") ? "Alojamiento" : "Actividad";
    if (typeIconEl) typeIconEl.textContent = (k === "leg") ? "üõ´" : (k === "stay") ? "üè®" : "üéØ";
  } catch {}


  
  // STAY/ACT: render isolated premium editor HTML (no DOM move from section)
  if (k === "stay") {
    __eventSheetCtx = { kind: k, id: itemId, mode: m, isNew: !!isNew, sourceView: __srcView, prevActiveView: (typeof activeView !== "undefined" ? String(activeView) : ""), prevScrollTop: mainScroll ? mainScroll.scrollTop : 0 };
    const ok = __renderStayEditorInSheet(body, stayObj, itemId, !!isNew);
    if (!ok) { alert("No se pudo abrir el editor"); return; }

    overlay.classList.remove("hidden");
    document.body.classList.add("sheet-open");
    try { applyEventSheetMode(); } catch {}
    try { if (getEventSheetMode() === "edit") { const f = sheet.querySelector("input,textarea,select"); if (f) f.focus({preventScroll:true}); } } catch {}
    return;
  }
  if (k === "act") {
    __eventSheetCtx = { kind: k, id: itemId, mode: m, isNew: !!isNew, sourceView: __srcView, prevActiveView: (typeof activeView !== "undefined" ? String(activeView) : ""), prevScrollTop: mainScroll ? mainScroll.scrollTop : 0 };
    const ok = __renderActEditorInSheet(body, actObj, itemId, !!isNew);
    if (!ok) { alert("No se pudo abrir el editor"); return; }

    overlay.classList.remove("hidden");
    document.body.classList.add("sheet-open");
    try { applyEventSheetMode(); } catch {}
    try { if (getEventSheetMode() === "edit") { const f = sheet.querySelector("input,textarea,select"); if (f) f.focus({preventScroll:true}); } } catch {}
    return;
  }

// If leg: inject mode chips just under title
  try {
    if (k === "leg") {
      const legObj = (typeof getItemByTypeAndId === "function") ? getItemByTypeAndId("leg", itemId) : null;
      const chipsHost = document.createElement("div");
      chipsHost.id = "legModeChipsHost";
      chipsHost.className = "mb-3";
      renderLegModeChips(chipsHost, legObj, (newMode)=>{
        try { if (typeof updateSheetDynamicSummary === "function") updateSheetDynamicSummary(); } catch {}
        try { __applyLegPlaceholdersInSheet(itemId, newMode); } catch {}
        // Update sheet title to reflect icon change (optional)
        try {
          const label = "Transporte";
          const it2 = legObj;
          const detail2 = it2 ? `${it2.from||""} ‚Üí ${it2.to||""}`.trim() : "";
          const icon2 = legModeIcon(newMode);
          titleEl.textContent = detail2 ? `${icon2} ${label} ¬∑ ${detail2}` : `${icon2} ${label}`;
        } catch {}
      });
      // Prepend into body (we'll append node after clearing body)
      body.__chipsHost = chipsHost;
    }
  } catch {}

  // Move node into sheet body
  const parent = node.parentNode;
  const next = node.nextSibling;
  __eventSheetCtx = { kind: k, id: itemId, mode: m, node, parent, next, prevScrollTop: mainScroll ? mainScroll.scrollTop : 0, sourceView: __srcView, prevActiveView: (typeof activeView !== "undefined" ? String(activeView) : "") };
  window.__sheetCtx = { kind: k, id: itemId };
  try {
    const trash = document.getElementById("eventSheetTrash");
    if (trash) { trash.dataset.kind = k; trash.dataset.id = String(itemId); }
  } catch {}

  const blocks = (k === "leg") ? null : __buildSheetBlocks(body);
  // Transport form-first layout: no summary blocks
  if (k === "leg") {
    body.innerHTML = `<div id="legSheetFormHost"></div>`;
  }


  try {
    if (body.__chipsHost) {
      if (k === "leg") {
        const host = document.getElementById("legSheetFormHost");
        if (host) host.appendChild(body.__chipsHost);
      } else if (blocks && blocks.A) {
        blocks.A.appendChild(body.__chipsHost);
      }
    }
  } catch {}
  try { node.classList.remove("hidden"); } catch {}
  try { if (k === "leg") node.classList.add("sheet-leg-editor"); else node.classList.remove("sheet-leg-editor"); } catch {}
  try { if (k === "leg") { const it = (typeof getItemByTypeAndId==="function") ? getItemByTypeAndId("leg", itemId) : null; __applyLegPlaceholdersInSheet(itemId, it ? it.mode : "plane"); } } catch {}
  try {
    if (k === "leg") {
      const host = document.getElementById("legSheetFormHost");
      if (host) host.appendChild(node); else body.appendChild(node);
    } else {
      if (blocks && blocks.E) blocks.E.appendChild(node); else body.appendChild(node);
    }
  } catch { body.appendChild(node); }
  try {
    if (blocks && blocks.E && !blocks.E.__phDone) {
      blocks.E.__phDone = true;
      // If no obvious notes field exists, add a small placeholder above editor
      const ph = document.createElement("div");
      ph.className = "text-sm text-slate-500 mb-2";
      ph.textContent = "Notas y otros detalles";
      blocks.E.prepend(ph);
    }
  } catch {}


  overlay.classList.remove("hidden");
    document.body.classList.add("sheet-open");
    try { applyEventSheetMode(); } catch {}
    // In view mode we avoid focusing fields automatically
    try { if (getEventSheetMode() === "edit") { const f = sheet.querySelector("input,textarea,select"); if (f) f.focus({preventScroll:true}); } } catch {}
  // sheetSummaryLine hidden for leg
  try { const sl = document.getElementById("eventSheetSummaryLine"); if (sl) sl.style.display = (k === "leg") ? "none" : ""; } catch {}

  // Dynamic summary wiring
  try {
    updateSheetDynamicSummary();
    if (!body.__summaryBound) {
      body.__summaryBound = true;
      body.addEventListener("input", ()=> updateSheetDynamicSummary());
      body.addEventListener("change", ()=> updateSheetDynamicSummary());
    }
  } catch {}

  // Focus first input for quick edit
  try {
    if (m === "edit") {
      requestAnimationFrame(() => {
        const first = body.querySelector("input,textarea,select,button");
        if (first && typeof first.focus === "function") first.focus({ preventScroll: true });
      });
    }
  } catch {}

}

function closeEventSheet({ silent } = {}) {
  const overlay = document.getElementById("eventSheetOverlay");
  const body = document.getElementById("eventSheetBody");
  const mainScroll = document.getElementById("mainScroll");
  if (overlay) overlay.classList.add("hidden");
  document.body.classList.remove("sheet-open");
  document.body.classList.remove("eventsheet-view");

  // Flush deferred renders (avoid breaking move-node while sheet open)
  try {
    if (__dirtyTimeline && typeof renderTimeline === "function") renderTimeline();
  } catch {}
  try {
    if (__dirtySummary && typeof calcSummary === "function") calcSummary();
  } catch {}
  __dirtyTimeline = false;
  __dirtySummary = false;


  // Restore moved node if any
  if (__eventSheetCtx && __eventSheetCtx.node && __eventSheetCtx.parent) {
    try {
      const { node, parent, next } = __eventSheetCtx;
      if (next && next.parentNode === parent) parent.insertBefore(node, next);
      else parent.appendChild(node);
    } catch {}
  }

  if (body) body.innerHTML = "";
  const ctx = __eventSheetCtx;

  try { if (ctx && ctx.node) ctx.node.classList.remove("sheet-leg-editor"); } catch {}
  __eventSheetCtx = null;

  // Re-render to reflect any edits
  try {
    if (typeof renderTimeline === "function") renderTimeline();
    if (ctx?.kind === "leg" && typeof renderLegs === "function") renderLegs();
    if (ctx?.kind === "stay" && typeof renderStays === "function") renderStays();
    if (ctx?.kind === "act" && typeof renderActivities === "function") renderActivities();
  } catch {}

  // Restore view context (only if changed while sheet open)
  try {
    const src = ctx && ctx.sourceView ? String(ctx.sourceView) : "";
    if (src && typeof setView === "function" && (typeof activeView !== "undefined") && String(activeView) !== src) {
      setView(src);
    }
  } catch {}

// Restore scroll position (no aggressive jumps)
  try {
    if (mainScroll && typeof ctx?.prevScrollTop === "number") {
      const y = ctx.prevScrollTop;
      try { mainScroll.scrollTop = y; } catch {}
      try { requestAnimationFrame(() => { try { mainScroll.scrollTop = y; } catch {} }); } catch {}
    }
  } catch {}

  if (!silent) {
    try { /* noop */ } catch {}
  }
}

function __initEventSheetBindings(){
  const overlay = document.getElementById("eventSheetOverlay");
  const closeBtn = document.getElementById("eventSheetClose");
  const sheet = document.getElementById("eventSheet");
  if (closeBtn) closeBtn.addEventListener("click", (e) => { e.preventDefault(); e.stopPropagation(); closeEventSheet(); });


  const editBtn = document.getElementById("eventSheetEdit");
  if (editBtn && !editBtn.__bound) {
    editBtn.__bound = true;
    editBtn.addEventListener("click", (e) => {
      try { e.preventDefault(); e.stopPropagation(); } catch {}

      // Toggle edit <-> view for the currently opened sheet.
      try {
        const cur = (typeof getEventSheetMode === "function") ? getEventSheetMode() : "edit";
        if (cur === "edit") {
          // Leaving edit: safest is to discard any unsaved field changes and re-open in view.
          const ctx = (typeof __eventSheetCtx !== "undefined" && __eventSheetCtx) ? __eventSheetCtx : null;
          if (ctx && ctx.kind && ctx.id) {
            try { closeEventSheet({ silent: true }); } catch {}
            try { openEventSheet({ kind: ctx.kind, id: ctx.id, mode: "view", isNew: !!ctx.isNew, sourceView: ctx.sourceView }); } catch {}
          } else {
            try { setEventSheetMode("view"); } catch {}
          }
        } else {
          try { setEventSheetMode("edit"); } catch {}
        }
      } catch {}
    });
  }

  const saveBtn = document.getElementById("eventSheetSave");
  if (saveBtn && !saveBtn.__esModeBound) {
    saveBtn.__esModeBound = true;
    saveBtn.addEventListener("click", (e) => {
      // Respect mode: only save in edit
      if (getEventSheetMode() !== "edit") { try { e.preventDefault(); e.stopPropagation(); } catch {} return; }
      // Let existing handlers (if any) run; do not duplicate saveState here.
    }, true);
  }

  const trashBtn = document.getElementById("eventSheetTrash");
  if (trashBtn && !trashBtn.__bound) {
    trashBtn.__bound = true;
    trashBtn.addEventListener("click", (e) => {
      try { e.preventDefault(); e.stopPropagation(); } catch {}
      if (getEventSheetMode() !== "edit") return;
      const ctx = __eventSheetCtx || {};
      const k = String(ctx.kind || trashBtn.dataset.kind || "");
      const id = String(ctx.id || trashBtn.dataset.id || "");
      if (!k || !id) return;
      if (!confirm("¬øEliminar este elemento?")) return;
      try { deleteItemById(k, id); } catch {}
      try { if (typeof saveState === "function") saveState(); } catch {}
      try { closeEventSheet(); } catch {}
      // Minimal rerender
      try {
        if (k === "leg") { if (typeof renderLegs === "function") renderLegs(); if (typeof renderTimeline === "function") renderTimeline(); }
        else if (k === "stay") { if (typeof renderStays === "function") renderStays(); if (typeof renderTimeline === "function") renderTimeline(); }
        else if (k === "act") { if (typeof renderActs === "function") renderActs(); if (typeof renderTimeline === "function") renderTimeline(); }
        if (typeof calcSummary === "function") calcSummary();
      } catch {}
    });
  }

  if (overlay) overlay.addEventListener("click", (e) => {
    // click outside sheet closes
    if (sheet && sheet.contains(e.target)) return;
    closeEventSheet();
  });
  document.addEventListener("keydown", (e) => {
    if (e.key === "Escape" && !overlay?.classList.contains("hidden")) closeEventSheet();
  });
}
try{
  if (document.readyState === "loading") document.addEventListener("DOMContentLoaded", __initEventSheetBindings, { once:true });
  else __initEventSheetBindings();
}catch{}

const LS_KEY_GEMINI = "miviaje\.gemini\.key";

/* --------------------------- Read-only mode -------------------------- */
const LS_KEY_READONLY = "miviaje.readonly";
function isReadOnly() { return localStorage.getItem(LS_KEY_READONLY) === "1"; }

function setReadOnly(on) {
  localStorage.setItem(LS_KEY_READONLY, on ? "1" : "0");
  applyReadOnlyMode();
}

function applyReadOnlyMode() {
  const on = isReadOnly();

  // body class
  document.body.classList.toggle("readonly-mode", on);

  // Toggle button label
  const btn = $("btnReadOnly");
  if (btn) {
    btn.textContent = on ? "üîì" : "üîí";
    btn.setAttribute("aria-pressed", on ? "true" : "false");
  }

  // Disable all form controls (except file inputs for import/export modal)
  document.querySelectorAll("input, select, textarea").forEach(el => {
    if (el.type === "file") return; // allow import in modal
    el.disabled = on;
  });

  // Disable only the buttons that modify data
  const idsToDisable = [
    "addLeg", "addStay", "addAct",
    "tabA", "tabB",
    "aiPick", "aiGenerate"
  ];
  idsToDisable.forEach(id => {
    const el = $(id);
    if (el) el.disabled = on;
  });

  // Disable delete buttons (created dynamically)
  document.querySelectorAll("[data-leg-del], [data-stay-del], [data-act-del]").forEach(b => {
    b.disabled = on;
  });

  // Block AI actions that add items (created dynamically)
  document.querySelectorAll("#aiResults button").forEach(b => {
    b.disabled = on;
  });
}


/* ------------------------- Sync helpers (iCloud) ------------------------- */
const META_KEY = "miviaje.meta.v1";
const BACKUPS_KEY = "miviaje.backups.v1";
const DEVICE_KEY = "miviaje.deviceName.v1";

function getMeta() {
  try { return JSON.parse(localStorage.getItem(META_KEY) || "{}") || {}; }
  catch { return {}; }
}
function setMeta(patch) {
  const cur = getMeta();
  const next = Object.assign({}, cur, patch || {});
  localStorage.setItem(META_KEY, JSON.stringify(next));
  return next;
}
function getDeviceName(askIfMissing = true) {
  // Fuente de verdad: miviaje.deviceName (nuevo). Compat: miviaje.deviceName.v1 (legacy)
  let v = (localStorage.getItem("miviaje.deviceName") || "").trim();
  if (!v) v = (localStorage.getItem(DEVICE_KEY) || "").trim();

  if (!v && askIfMissing) {
    v = (prompt("Nombre de este dispositivo (ej: iPhone Ana / iPhone Luis):", "") || "").trim();
    if (v) {
      try { localStorage.setItem("miviaje.deviceName", v); } catch {}
      try { localStorage.setItem(DEVICE_KEY, v); } catch {}
    }
  }
  return v || "Dispositivo";
}
function pushBackup(reason, fromPayloadMeta = null) {
  try {
    const meta = getMeta();
    const item = {
      savedAt: new Date().toISOString(),
      reason: reason || "backup",
      deviceName: getDeviceName(false),
      from: fromPayloadMeta || null,
      state
    };
    const list = JSON.parse(localStorage.getItem(BACKUPS_KEY) || "[]");
    list.unshift(item);
    localStorage.setItem(BACKUPS_KEY, JSON.stringify(list.slice(0, 15)));
  } catch {}
}
function getLatestBackup() {
  try {
    const list = JSON.parse(localStorage.getItem(BACKUPS_KEY) || "[]");
    return list?.[0] || null;
  } catch { return null; }
}

const emptyScenario = () => ({
  legs: [],
  stays: [],
  meals: { daily: 0, people: "", days: "" },
  activities: []
,
  dailyNotes: {}
});

let state = {
  scenario: "A",
  displayCurrency: "EUR",
  scenarios: { A: emptyScenario(), B: emptyScenario() },
  aiPick: { cities: [], items: [] } // chosen topics
};

function loadState() {
  try {
    const raw = localStorage.getItem(LS_KEY);
    if (raw) state = Object.assign(state, JSON.parse(raw));
  } catch {}
}
function saveState() {
  localStorage.setItem(LS_KEY, JSON.stringify(state));
  // Update sync meta so "lastSavedAt" reflects real editing time (not only export/import).
  try { setMeta({ lastSavedAt: new Date().toISOString() }); } catch {}
}
function curScenario() { return state.scenarios[state.scenario]; }

/* -------------------------- Currency convert ------------------------- */
function currencySymbol(code){
  switch(String(code||"")){
    case "EUR": return "‚Ç¨";
    case "USD": return "$";
    case "GBP": return "¬£";
    case "JPY": return "¬•";
    case "AUD": return "A$";
    case "CAD": return "C$";
    case "CHF": return "CHF";
    case "MXN": return "MX$";
    default: return String(code||"");
  }
}

/* ----------------------------- FX table ------------------------------ */
/* Fixed internal rates (editable). Values are: 1 UNIT of currency = X EUR.
   Source-free by design (no external API) ‚Äî adjust manually when needed. */
const FX_TO_EUR = {
  EUR: 1.0,
  USD: 0.92,
  GBP: 1.17,
  JPY: 0.0062,
  AUD: 0.61,
  CAD: 0.68,
  CHF: 1.04,
  MXN: 0.052
};

function fxToEUR(code){
  const c = String(code||"EUR").toUpperCase();
  return (FX_TO_EUR[c] != null) ? Number(FX_TO_EUR[c]) : 1.0;
}

function convertMoney(amount, fromCur, toCur){
  const a = Number(amount);
  if (!isFinite(a) || a === 0) return 0;
  const from = String(fromCur||"EUR").toUpperCase();
  const to = String(toCur||"EUR").toUpperCase();
  if (from === to) return a;
  const eur = a * fxToEUR(from);
  return eur / fxToEUR(to);
}

/* Simple: no external API. Keeps values in display currency.
   You can later swap to real rates if needed. */
function setDisplayCurrency(cur) {
  state.displayCurrency = cur;
  try { const sc = curScenario(); if (sc && sc.meals && !sc.meals.currency) sc.meals.currency = cur; } catch {}
  $("sumCur").textContent = cur;
  $("mealCur").textContent = cur;
  saveState();
  renderAll();
  syncStickyTotalsHeightVar();
  }

/* ----------------------------- Accordion ----------------------------- */
function setupAccordion() {
  document.querySelectorAll("[data-acc]").forEach(btn => {
    btn.addEventListener("click", () => {
      const key = btn.getAttribute("data-acc");
      const body = document.querySelector(`[data-acc-body="${key}"]`);
      body.classList.toggle("hidden");

    const isNowHidden = body.classList.contains("hidden");
    if (isNowHidden) {
      if (key === "legs") __sectionExpanded.legs.clear();
      if (key === "stays") __sectionExpanded.stays.clear();
      if (key === "acts") __sectionExpanded.activities.clear();
    } else {
      if (key === "legs") renderLegs();
      if (key === "stays") renderStays();
      if (key === "acts") renderActivities();
    }
      const icon = btn.querySelector(".accIcon");
      icon.textContent = body.classList.contains("hidden") ? "‚ñæ" : "‚ñ¥";
      
    });
  });
}




/* ------------------------------ Rendering ---------------------------- */
function renderAll() {
  renderTabs();
  renderLegs();
  renderStays();
  renderMeals();
  renderActivities();
  renderTimeline();
  calcSummary();
  applyReadOnlyMode();
}

function renderTabs() {
  const a = $("tabA"), b = $("tabB");
  if (a && b) {
    const onA = state.scenario === "A";
    // Compact segmented control for header
    a.className = "tap px-3 py-1.5 rounded-xl text-sm font-semibold " + (onA ? "bg-slate-900 text-white" : "text-slate-700");
    b.className = "tap px-3 py-1.5 rounded-xl text-sm font-semibold " + (!onA ? "bg-slate-900 text-white" : "text-slate-700");
  }
  const dc = document.getElementById("displayCurrency");
  if (dc) dc.value = state.displayCurrency;
  const sc = document.getElementById("sumCur");
  if (sc) sc.textContent = state.displayCurrency;
  const mc = document.getElementById("mealCur");
  if (mc) mc.textContent = state.displayCurrency;
}

function legCard(leg, idx) {
  const st = (typeof computeDoneStateGeneric==="function") ? computeDoneStateGeneric(leg, leg.date) : {done:false,auto:false,skipped:false};
  const modeIcon = (typeof legModeIcon==="function") ? legModeIcon(leg.mode) : "‚úàÔ∏è";

  const route = `${(leg.from||"").trim() || "‚Äî"} ‚Üí ${(leg.to||"").trim() || "‚Äî"}`;
  const __sp = buildLegSummaryParts(leg);

  // UX 2.1: list = consultation only (no internal accordion, no inline edit)
  return `
  <div id="leg-${leg.id}" class="border border-slate-200 rounded-2xl bg-slate-50 ${st.done ? "done-item" : ""} ${st.skipped ? "skipped-item" : ""}">
    <button type="button"
            class="tap w-full text-left p-4 flex items-start justify-between gap-3"
            data-leg-open="${leg.id}" data-sec-toggle="legs" data-sec-id="${leg.id}"
            aria-label="Abrir trayecto">
      <div class="min-w-0">
        <div class="text-sm font-semibold truncate">${modeIcon} <span>${escapeHtml(route)}</span></div>
        <div class="text-xs text-slate-600 mt-0.5 truncate">${__sp.metaHTML}</div>
        ${__sp.placeLineHTML}
      </div>
      <div class="shrink-0 flex items-center gap-2">
        ${buildEventIndicatorsHTML(leg)}
        ${st.skipped ? `<span class="text-xs font-semibold skipped-badge">No hecho</span>` : ""}
        ${st.auto ? `<span class="text-xs font-semibold auto-badge">Auto</span>` : ""}
      </div>
    </button>
  </div>`;
}

function renderLegs() {
  const box = $("legsList");
  const sc = curScenario();

  sortByDateTimeEmptyFirst(sc.legs);
  box.innerHTML = sc.legs.length
    ? __renderGroupedByDate(sc.legs, (it)=>it.date, legCard)
    : `<div class="text-sm text-slate-500">A√±ade trayectos para construir tu ruta.</div>`;

  // UX 2.1: tap on summary opens sheet in view mode
  box.querySelectorAll("[data-leg-open]").forEach(btn => btn.addEventListener("click", (e) => {
    try { e.preventDefault(); e.stopPropagation(); } catch {}
    const id = btn.getAttribute("data-leg-open");
    if (!id) return;
    try { openEventSheet({ kind: "leg", id, mode: "view", sourceView: "legs" }); } catch {}
  }));
}


function staySummaryLinesHTML(stay, opts){
  opts = opts || {};
  const city = (stay.city||"").trim() || "‚Äî";
  const name = (stay.name||"").trim() || "‚Äî";

  // Dates / times (no timezone logic yet)
  const checkInISO = String(stay.date||"").trim();
  const checkInDateES = (checkInISO ? formatDateES(checkInISO) : "") || "‚Äî";
  const checkInTime = (stay.time||"").trim();

  const nights = Number.isFinite(Number(stay.nights)) ? Math.max(1, parseInt(stay.nights,10)) : 1;

  const __addDaysISO_inline = (iso, days)=>{
    const s = String(iso||"").trim();
    if (!/^\d{4}-\d{2}-\d{2}$/.test(s)) return "";
    const d = new Date(s + "T12:00:00");
    if (isNaN(d.getTime())) return "";
    d.setDate(d.getDate() + (Number(days)||0));
    const y = d.getFullYear();
    const m = String(d.getMonth()+1).padStart(2,"0");
    const da = String(d.getDate()).padStart(2,"0");
    return `${y}-${m}-${da}`;
  };

  const coISO_raw = String(stay.checkout||"").trim();
  const checkOutISO = coISO_raw || (checkInISO ? __addDaysISO_inline(checkInISO, nights) : "");
  const checkOutDateES = (checkOutISO ? formatDateES(checkOutISO) : "") || "‚Äî";
  const checkOutTime = String(stay.checkoutTime || stay.checkout_time || "").trim();

  const hasNotes = !!(stay.notes && String(stay.notes).trim());

  const lineCheckIn = `Check-in: <span class="font-semibold">${escapeHtml(checkInDateES)}</span>${checkInTime ? ` <span class="font-semibold">${escapeHtml(checkInTime)}</span>` : ``} <span class="text-slate-500">¬∑</span> <span class="font-semibold">${nights}</span> <span class="text-slate-600">noche${nights===1?"":"s"}</span>`;
  const lineCheckOut = `Check-out: <span class="font-semibold">${escapeHtml(checkOutDateES)}</span>${checkOutTime ? ` <span class="font-semibold">${escapeHtml(checkOutTime)}</span>` : ``}`;

  return `
    <div class="text-sm font-semibold truncate">üè® <span class="font-medium">${escapeHtml(name)}</span><span class="text-slate-400 font-normal"> ¬∑ </span><span>${escapeHtml(city)}</span></div>
    <div class="text-xs text-slate-600 mt-1">${lineCheckIn}${hasNotes ? ` <span class="ml-1">üóíÔ∏è</span>` : ``}</div>
    <div class="text-xs text-slate-600 mt-1">${lineCheckOut}</div>
  `;
}


function stayCard(stay) {
  const st = (typeof computeDoneStateGeneric==="function") ? computeDoneStateGeneric(stay, stay.date || "") : {done:false,auto:false,skipped:false};
  const city = (stay.city||"").trim() || "‚Äî";
  const name = (stay.name||"").trim() || "‚Äî";

  // Dates / times (no timezone logic yet)
  const checkInISO = String(stay.date||"").trim();
  const checkInDateES = (checkInISO ? formatDateES(checkInISO) : "") || "‚Äî";
  const checkInTime = (stay.time||"").trim();

  const nights = Number.isFinite(Number(stay.nights)) ? Math.max(1, parseInt(stay.nights,10)) : 1;

  const __addDaysISO_inline = (iso, days)=>{
    const s = String(iso||"").trim();
    if (!/^\d{4}-\d{2}-\d{2}$/.test(s)) return "";
    const d = new Date(s + "T12:00:00");
    if (isNaN(d.getTime())) return "";
    d.setDate(d.getDate() + (Number(days)||0));
    const y = d.getFullYear();
    const m = String(d.getMonth()+1).padStart(2,"0");
    const da = String(d.getDate()).padStart(2,"0");
    return `${y}-${m}-${da}`;
  };

  const coISO_raw = String(stay.checkout||"").trim();
  const checkOutISO = coISO_raw || (checkInISO ? __addDaysISO_inline(checkInISO, nights) : "");
  const checkOutDateES = (checkOutISO ? formatDateES(checkOutISO) : "") || "‚Äî";
  const checkOutTime = String(stay.checkoutTime || stay.checkout_time || "").trim();

  const hasNotes = !!(stay.notes && String(stay.notes).trim());

  const lineCheckIn = `Check-in: <span class="font-semibold">${escapeHtml(checkInDateES)}</span>${checkInTime ? ` <span class="font-semibold">${escapeHtml(checkInTime)}</span>` : ``} <span class="text-slate-500">¬∑</span> <span class="font-semibold">${nights}</span> <span class="text-slate-600">noche${nights===1?"":"s"}</span>`;
  const showCheckOut = !!(checkOutISO && checkOutISO !== "‚Äî");
  const lineCheckOut = `Check-out: <span class="font-semibold">${escapeHtml(checkOutDateES)}</span>${checkOutTime ? ` <span class="font-semibold">${escapeHtml(checkOutTime)}</span>` : ``}`;

  // Summary (Transport-like): tap opens premium sheet; no old per-item accordion UX
  // Keep an editor node in DOM for move-node sheet (data-sec-body/data-sec-id), but hidden.
  return `
  <div id="stay-${stay.id}" class="border border-slate-200 rounded-2xl bg-slate-50 ${st.done ? "done-item" : ""} ${st.skipped ? "skipped-item" : ""}">
    <button type="button"
            class="tap w-full text-left p-4 flex items-start justify-between gap-3"
            data-stay-open="${stay.id}"
            aria-label="Abrir alojamiento">
      <div class="min-w-0">
        ${staySummaryLinesHTML(stay)}</div>
      </div>
      <div class="shrink-0 flex items-center gap-2">
        ${st.skipped ? `<span class="text-xs font-semibold skipped-badge">No realizado</span>` : (st.auto && st.done ? `<span class="text-xs auto-badge">Asumido</span>` : ``)}
        ${buildEventIndicatorsHTML(stay)}
      </div>
    </button>

    <!-- Hidden editor node for premium sheet (move-node). Not an accordion UI. -->
    <div class="hidden" data-sec-body="stays" data-sec-id="${stay.id}">
      <div class="grid grid-cols-1 sm:grid-cols-12 gap-3 items-end">
        <div class="sm:col-span-4">
          <label class="text-xs text-slate-600">Ciudad</label>
          <input data-stay-city="${stay.id}" class="mt-1 w-full px-3 py-2 rounded-xl border border-slate-200" value="${escapeHtml(stay.city)}" placeholder="Ciudad">
        </div>
        <div class="sm:col-span-4">
          <label class="text-xs text-slate-600">Alojamiento</label>
          <input data-stay-name="${stay.id}" class="mt-1 w-full px-3 py-2 rounded-xl border border-slate-200" value="${escapeHtml(stay.name)}" placeholder="Hotel / Airbnb / Camping‚Ä¶">
        </div>
        <div class="sm:col-span-2">
          <label class="text-xs text-slate-600">Fecha (check-in)</label>
          <input data-stay-date="${stay.id}" type="date" class="mt-1 w-full px-3 py-2 rounded-xl border border-slate-200" value="${escapeHtml(stay.date || "")}">
        </div>
        <div class="sm:col-span-2">
          <label class="text-xs text-slate-600">Hora (opcional)</label>
          <input data-stay-time="${stay.id}" type="time" class="mt-1 w-full px-3 py-2 rounded-xl border border-slate-200" value="${escapeHtml(stay.time || "")}">
        </div>
        <div class="sm:col-span-2">
          <label class="text-xs text-slate-600">Noches</label>
          <input data-stay-nights="${stay.id}" type="number" min="1" step="1" class="mt-1 w-full px-3 py-2 rounded-xl border border-slate-200" value="${escapeHtml(stay.nights ?? 1)}">
        </div>
        <div class="sm:col-span-2">
          <label class="text-xs text-slate-600">Coste</label>
          <input data-stay-cost="${stay.id}" type="number" min="0" step="0.01" class="mt-1 w-full px-3 py-2 rounded-xl border border-slate-200" value="${escapeHtml(stay.cost ?? "")}">
        </div>
        <div class="sm:col-span-8">
          <label class="text-xs text-slate-600">Notas</label>
          <textarea data-stay-notes="${stay.id}" class="mt-1 w-full px-3 py-2 rounded-xl border border-slate-200" rows="3" placeholder="Detalles (check-in, direcci√≥n, etc.)">${escapeHtml(stay.notes || "")}</textarea>
        </div>
        <div class="sm:col-span-2">
          <label class="text-xs text-slate-600">Estado</label>
          <select data-stay-status="${stay.id}" class="mt-1 w-full px-3 py-2 rounded-xl border border-slate-200">
            <option value="">‚Äî</option>
            <option value="done" ${String(stay.status||"")==="done" ? "selected" : ""}>Hecho</option>
            <option value="skipped" ${String(stay.status||"")==="skipped" ? "selected" : ""}>No realizado</option>
          </select>
        </div>
        <div class="sm:col-span-2 flex justify-end">
          <button data-stay-del="${stay.id}" class="tap px-3 py-2 rounded-xl bg-white border border-slate-200 hover:bg-slate-100 text-sm">üóëÔ∏è</button>
        </div>
      </div>
    </div>
  </div>`;
}

function renderStays() {
  const box = $("staysList");
  const sc = curScenario();
  sortByDateTimeEmptyFirst(sc.stays);

  box.innerHTML = sc.stays.length
    ? __renderGroupedByDate(sc.stays, (it)=>it.date, stayCard)
    : `<div class="text-sm text-slate-500">A√±ade alojamientos para organizar tus noches.</div>`;

  // Tap on summary opens premium sheet in view mode (Transport-like)
  box.querySelectorAll("[data-stay-open]").forEach(btn => btn.addEventListener("click", (e) => {
    try { e.preventDefault(); e.stopPropagation(); } catch {}
    const id = btn.getAttribute("data-stay-open");
    if (!id) return;
    try { openEventSheet({ kind: "stay", id, mode: "view", sourceView: "stays" }); } catch {}
  }));

  // Keep existing bindings (editor node lives hidden in DOM; listeners must exist for sheet)
  box.querySelectorAll("[data-stay-del]").forEach(b => b.addEventListener("click", (e) => {
    try { e.preventDefault(); e.stopPropagation(); } catch {}
    const id = b.getAttribute("data-stay-del");
    sc.stays = sc.stays.filter(x => x.id !== id);
    try { __sectionExpanded?.stays?.delete(id); } catch {}
    saveState(); renderAll();
  }));
  box.querySelectorAll("[data-stay-city]").forEach(inp => inp.addEventListener("change", () => {
    const id = inp.getAttribute("data-stay-city");
    const s = sc.stays.find(x => x.id === id);
    if (!s) return;
    s.city = cap1(inp.value); inp.value = s.city;
    saveState(); renderTimeline();
  }));
  box.querySelectorAll("[data-stay-date]").forEach(inp => inp.addEventListener("change", () => {
    const id = inp.getAttribute("data-stay-date");
    const it = sc.stays.find(x => x.id === id);
    if (!it) return;
    it.date = inp.value;
    sortByDateTimeEmptyFirst(sc.stays);
    saveState(); renderTimeline();
  }));
  box.querySelectorAll("[data-stay-time]").forEach(inp => inp.addEventListener("change", () => {
    const id = inp.getAttribute("data-stay-time");
    const it = sc.stays.find(x => x.id === id);
    if (!it) return;
    it.time = inp.value;
    sortByDateTimeEmptyFirst(sc.stays);
    saveState(); renderTimeline();
  }));
  box.querySelectorAll("[data-stay-name]").forEach(inp => inp.addEventListener("change", () => {
    const id = inp.getAttribute("data-stay-name");
    const it = sc.stays.find(x => x.id === id);
    if (!it) return;
    it.name = inp.value.trim();
    saveState(); renderTimeline();
  }));
  box.querySelectorAll("[data-stay-nights]").forEach(inp => inp.addEventListener("input", () => {
    const id = inp.getAttribute("data-stay-nights");
    const it = sc.stays.find(x => x.id === id);
    if (!it) return;
    it.nights = Math.max(1, parseInt(inp.value || "1",10));
    saveState(); calcSummary();
  }));
  box.querySelectorAll("[data-stay-cost]").forEach(inp => inp.addEventListener("input", () => {
    const id = inp.getAttribute("data-stay-cost");
    const it = sc.stays.find(x => x.id === id);
    if (!it) return;
    it.cost = parseMoney(inp.value);
    saveState(); calcSummary();
  }));
  box.querySelectorAll("[data-stay-notes]").forEach(inp => inp.addEventListener("input", () => {
    const id = inp.getAttribute("data-stay-notes");
    const it = sc.stays.find(x => x.id === id);
    if (!it) return;
    it.notes = inp.value;
    saveState();
    __dirtyTimeline = true;
  }));
  box.querySelectorAll("[data-stay-status]").forEach(sel => sel.addEventListener("change", () => {
    const id = sel.getAttribute("data-stay-status");
    const it = sc.stays.find(x => x.id === id);
    if (!it) return;
    it.status = sel.value;
    saveState();
  }));
}


function renderMeals() {
  const sc = curScenario();
  $("mealDaily").value = (sc.meals.daily == null || String(sc.meals.daily).trim()==="") ? "" : sc.meals.daily;

  // Permitir vac√≠o en UI (si est√° vac√≠o, el c√°lculo tratar√° como 1)
  $("mealPeople").value = (sc.meals.people === "" || sc.meals.people == null) ? "" : sc.meals.people;
  $("mealDays").value = (sc.meals.days === "" || sc.meals.days == null) ? "" : sc.meals.days;

  const total = (
    parseMoney(sc.meals.daily) *
    (parseInt(sc.meals.people || 1, 10)) *
    (parseInt(sc.meals.days || 1, 10))
  );
  $("mealTotal").textContent = total.toFixed(2);
}

/* ---------------- Activities: smart done ---------------- */

function todayKey() {
  const d = new Date();
  const y = d.getFullYear();
  const m = String(d.getMonth() + 1).padStart(2, "0");
  const day = String(d.getDate()).padStart(2, "0");
  return `${y}-${m}-${day}`;
}

// Devuelve -1, 0, 1 comparando YYYY-MM-DD (lexicogr√°fico funciona)
function cmpDate(a, b) {
  const A = String(a || "");
  const B = String(b || "");
  if (A === B) return 0;
  return A < B ? -1 : 1;
}

function isPast(dateKey) {
  return cmpDate(String(dateKey || ""), todayKey()) < 0;
}
function isFuture(dateKey) {
  return cmpDate(String(dateKey || ""), todayKey()) > 0;
}/* Timeline category filter (in-memory, no persistence) */
// Timeline view mode (UI only, not persisted)
let timelineViewMode = "global"; // "global" | "day"
let activeDayISO = ""; // used only in day mode
window.__tlControlsTemplateHTML = window.__tlControlsTemplateHTML || "";
let __tlDays = []; // derived cache of available days in current filtered timeline
let __tlLastFilteredItems = []; // cache of current filtered timeline items (in-memory only)

const timelineFilterState = {
  categories: new Set() // empty = show all
};

function sanitizeTimelineFilterState() {
  // Meals is NOT an event category. If old localStorage contains it, drop it safely.
  const allowed = new Set(["Transporte", "Alojamiento", "Actividades"]);
  const cats = timelineFilterState.categories;
  if (!cats || typeof cats.forEach !== "function") return;
  Array.from(cats).forEach(v => { if (!allowed.has(v)) cats.delete(v); });
}


function timelineItemCategory(item) {
  const t = String(item?.type || "").toLowerCase();
  if (t.includes("trayecto") || t.includes("transporte")) return "Transporte";
  if (t.includes("alojamiento")) return "Alojamiento";
  if (t.includes("actividad")) return "Actividades";
  return "";
}

// Pure filter: does not mutate input list
function getFilteredItems(allItems) {
  const cats = timelineFilterState.categories;
  if (!cats || cats.size === 0) return allItems;
  return (allItems || []).filter(it => {
    const c = timelineItemCategory(it);
    return c && cats.has(c);
  });
}

function renderTimelineFilterChips() {
  sanitizeTimelineFilterState();
  const host = document.getElementById("timelineFilterChips");
  if (!host) return;

  const cats = ["Transporte", "Alojamiento", "Actividades"];
  const active = timelineFilterState.categories;

  const chipClass = (isActive) =>
    "tap shrink-0 px-3 py-1.5 rounded-full text-xs font-semibold border " +
    (isActive ? "bg-slate-900 text-white border-slate-900" : "bg-white text-slate-700 border-slate-200");

  const allActive = active.size === 0;

  host.innerHTML = `
    <button class="${chipClass(allActive)}" data-tlchip="ALL">Todos</button>
    ${cats.map(c => `<button class="${chipClass(active.has(c))}" data-tlchip="${c}">${c}</button>`).join("")}
  `;

  host.querySelectorAll("[data-tlchip]").forEach(btn => {
    btn.onclick = () => {
      const v = btn.getAttribute("data-tlchip") || "";
      if (v === "ALL") {
        active.clear();
      } else {
        if (active.has(v)) active.delete(v); else active.add(v);
      }
      renderTimelineFilterChips();
      renderTimeline();
    };
  });
}


// Orden: sin fecha primero (para editar), luego por fecha+hora (24h). Sin hora -> final del d√≠a.

function sortByDateTimeEmptyFirst(list) {
  if (!Array.isArray(list)) return list;
  list.sort((a, b) => {
    const ad = String(a?.date || "").trim();
    const bd = String(b?.date || "").trim();
    if (!ad && bd) return -1;
    if (ad && !bd) return 1;
    if (ad && bd && ad !== bd) return ad < bd ? -1 : 1;
    const at = timeSortKey(a?.time);
    const bt = timeSortKey(b?.time);
    if (at !== bt) return at - bt;
    return String(a?.id || "").localeCompare(String(b?.id || ""));
  });
  return list;
}


/* ---------------- Date grouping helpers (V90B) ---------------- */
function __isValidISODate(d){
  const s = String(d||"").trim();
  if (!/^\d{4}-\d{2}-\d{2}$/.test(s)) return false;
  const [y,m,da]=s.split("-").map(n=>parseInt(n,10));
  if (!y || !m || !da) return false;
  const dt = new Date(y, m-1, da);
  return dt && !isNaN(dt.getTime()) && (dt.getFullYear()===y) && (dt.getMonth()===(m-1)) && (dt.getDate()===da);
}
function __fmtDateES(iso){
  if (!__isValidISODate(iso)) return "Sin fecha";
  const [y,m,d]=String(iso).split("-").map(n=>parseInt(n,10));
  const dt = new Date(y, m-1, d);
  try{
    return dt.toLocaleDateString("es-ES",{ day:"2-digit", month:"short", year:"numeric" }).replace(".", "");
  }catch(_){
    return String(iso);
  }
}
function __dateSeparatorHTML(label, iso){
  const key = (iso && /^[0-9]{4}-[0-9]{2}-[0-9]{2}$/.test(String(iso))) ? String(iso) : "";
  return `
    <div class="mt-4 mb-2 dateSep" ${key ? `data-date-sep="${key}"` : `data-date-sep=""`}>
      <div class="px-3 py-1 rounded-full inline-flex items-center text-xs font-semibold bg-slate-100 text-slate-700 border border-slate-200">
        ${label}
      </div>
    </div>
  `;
}
function __renderGroupedByDate(list, getDateFn, renderItemFn){
  if (!Array.isArray(list) || !list.length) return "";
  const valid = [];
  const invalid = [];
  for (const it of list){
    const d = getDateFn ? getDateFn(it) : "";
    if (__isValidISODate(d)) valid.push(it); else invalid.push(it);
  }
  let out = "";
  let cur = "";
  for (const it of valid){
    const d = String(getDateFn(it)||"").trim();
    if (d !== cur){
      cur = d;
      out += __dateSeparatorHTML(__fmtDateES(d), d);
    }
    out += renderItemFn(it);
  }
  if (invalid.length){
    out += __dateSeparatorHTML("Sin fecha", "");
    for (const it of invalid) out += renderItemFn(it);
  }
  return out;
}
/* ---------------- Upcoming focus helpers (vFIX7) ---------------- */
function __nowMinutes(){
  const d = new Date();
  return d.getHours()*60 + d.getMinutes();
}
function __pickNextId(list){
  if (!Array.isArray(list) || !list.length) return null;
  const tk = todayKey();
  const nm = __nowMinutes();
  for (const it of list){
    const d = String(it?.date || "").trim();
    if (!d) continue;
    if (d > tk) return String(it.id || "");
    if (d === tk){
      const m = timeToMinutes(it?.time);
      if (m === null || m >= nm) return String(it.id || "");
    }
  }
  const first = list.find(x => String(x?.date||"").trim());
  return first ? String(first.id || "") : null;
}
function __focusNextInSection(section){
  try{
    const sc = curScenario();
    let list = [];
    let prefix = "";
    if (section === "legs"){ list = sc.legs || []; prefix = "leg-"; }
    else if (section === "stays"){ list = sc.stays || []; prefix = "stay-"; }
    else if (section === "acts"){ list = sc.activities || []; prefix = "act-"; }
    sortByDateTimeEmptyFirst(list);
    const id = __pickNextId(list);
    if (!id) return;
    const el = document.getElementById(prefix + id);
    if (el) scrollToElWithOffset(el, 0, false);
  } catch {}
}
function __ensureAccordionOpen(accKey){
  const btn = document.querySelector(`[data-acc="${accKey}"]`);
  const body = document.querySelector(`[data-acc-body="${accKey}"]`);
  if (!btn || !body) return;
  const isHidden = body.classList.contains("hidden") || body.style.display === "none" || body.hasAttribute("hidden");
  if (isHidden){
    try { btn.click(); } catch {}
  }
}


function timeToMinutes(t) {
  const v = String(t || "").trim();
  if (!/^\d{2}:\d{2}$/.test(v)) return null;
  const hh = parseInt(v.slice(0,2), 10);
  const mm = parseInt(v.slice(3,5), 10);
  if (Number.isNaN(hh) || Number.isNaN(mm) || hh < 0 || hh > 23 || mm < 0 || mm > 59) return null;
  return hh * 60 + mm;
}

function timeSortKey(t) {
  const m = timeToMinutes(t);
  // Sin hora => al final del d√≠a
  return (m === null) ? (24 * 60 + 1) : m;
}

function promptDate(defaultKey) {
  const def = defaultKey || todayKey();
  const raw = prompt("Fecha (YYYY-MM-DD):", def);
  if (raw === null) return null;
  const v = String(raw).trim();
  if (!/^\d{4}-\d{2}-\d{2}$/.test(v)) return null;

  const d = new Date(v + "T00:00:00");
  if (Number.isNaN(d.getTime())) return null;

  const y = d.getFullYear();
  const m = String(d.getMonth() + 1).padStart(2, "0");
  const day = String(d.getDate()).padStart(2, "0");
  const norm = `${y}-${m}-${day}`;
  return norm === v ? v : null;
}

// Estado visual (no altera datos)
function computeDoneState(act) {
  const dateKey = String(act?.date || "");
  if (act?.doneManual === true) return { done: true, auto: false, skipped: false };
  if (act?.skipped === true) return { done: false, auto: false, skipped: true };
  if (dateKey && isPast(dateKey)) return { done: true, auto: true, skipped: false };
  return { done: false, auto: false, skipped: false };
}

function handleActDoneToggle(id, targetChecked, el) {
  const sc = curScenario();
  const act = (sc?.activities || []).find(a => String(a.id) === String(id));
  if (!act) return;

  const prevVisual = computeDoneState(act);
  const prevChecked = !!prevVisual.done;

  const today = todayKey();
  const dateKey = String(act.date || "");

  if (localStorage.getItem("miviaje.readonly") === "1") {
    if (el) el.checked = prevChecked;
    return;
  }

  if (targetChecked === true) {
    // Sin fecha: permitir asignar fecha si el usuario quiere
    if (!dateKey) {
      const choice = prompt(
        "Evento sin fecha. ¬øQu√© quieres hacer?\n" +
        "1 = Hecho (sin fecha)\n" +
        "2 = Hecho y asignar a HOY\n" +
        "3 = Hecho y elegir fecha‚Ä¶\n\n" +
        "Escribe 1, 2 o 3:",
        "2"
      );
      if (choice === null) { if (el) el.checked = prevChecked; return; }
      const c = String(choice).trim();
      if (c === "1") { act.doneManual = true; act.skipped = false; }
      else if (c === "2") { act.doneManual = true; act.skipped = false; act.date = today; }
      else if (c === "3") {
        const nd = promptDate(today);
        if (nd === null) { if (el) el.checked = prevChecked; return; }
        act.doneManual = true; act.skipped = false; act.date = nd;
      } else { if (el) el.checked = prevChecked; return; }
      saveState();
      renderActivities();
      if (typeof renderTimeline === "function") renderTimeline();
      if (typeof calcSummary === "function") calcSummary();
      return;
    }
    if (dateKey && isFuture(dateKey)) {
      const choice = prompt(
        "Evento futuro. ¬øQu√© quieres hacer?\n" +
        "1 = Hecho (mantener fecha)\n" +
        "2 = Hecho y mover a HOY\n" +
        "3 = Hecho y elegir fecha‚Ä¶\n\n" +
        "Escribe 1, 2 o 3:",
        "2"
      );
      if (choice === null) {
        if (el) el.checked = prevChecked;
        return;
      }
      const c = String(choice).trim();

      if (c === "1") {
        act.doneManual = true;
        act.skipped = false;
      } else if (c === "2") {
        act.doneManual = true;
        act.skipped = false;
        act.date = today;
      } else if (c === "3") {
        const nd = promptDate(today);
        if (nd === null) {
          if (el) el.checked = prevChecked;
          return;
        }
        act.doneManual = true;
        act.skipped = false;
        act.date = nd;
      } else {
        if (el) el.checked = prevChecked;
        return;
      }
    } else {
      act.doneManual = true;
      act.skipped = false;
    }

    saveState();
    renderActivities();
    if (typeof renderTimeline === "function") renderTimeline();
    if (typeof calcSummary === "function") calcSummary();
    return;
  }

  if (targetChecked === false) {
    if (dateKey && isPast(dateKey)) {
      const choice = prompt(
        "Evento pasado. ¬øQu√© quieres hacer?\n" +
        "1 = No realizado (mantener fecha)\n" +
        "2 = Reprogramar\n\n" +
        "Escribe 1 o 2:",
        "1"
      );
      if (choice === null) {
        if (el) el.checked = prevChecked;
        return;
      }
      const c = String(choice).trim();

      if (c === "1") {
        act.doneManual = false;
        act.skipped = true;
      } else if (c === "2") {
        const d = new Date();
        d.setDate(d.getDate() + 1);
        const y = d.getFullYear();
        const m = String(d.getMonth() + 1).padStart(2, "0");
        const day = String(d.getDate()).padStart(2, "0");
        const def = `${y}-${m}-${day}`;

        const nd = promptDate(def);
        if (nd === null) {
          if (el) el.checked = prevChecked;
          return;
        }
        act.date = nd;
        act.doneManual = false;
        act.skipped = false;
      } else {
        if (el) el.checked = prevChecked;
        return;
      }
    } else {
      act.doneManual = false;
      act.skipped = false;
    }

    saveState();
    renderActivities();
    if (typeof renderTimeline === "function") renderTimeline();
    if (typeof calcSummary === "function") calcSummary();
  }
}

/* ---------------- Legs/Stays: smart done (v32+) ---------------- */
// Estado visual gen√©rico para elementos con fecha (legs) o sin fecha (stays)
function computeDoneStateGeneric(item, dateKey) {
  const dk = String(dateKey || "");
  if (item?.doneManual === true) return { done: true, auto: false, skipped: false };
  if (item?.skipped === true) return { done: false, auto: false, skipped: true };
  if (dk && isPast(dk)) return { done: true, auto: true, skipped: false };
  return { done: false, auto: false, skipped: false };
}

function handleLegDoneToggle(id, targetChecked, el) {
  const sc = curScenario();
  const leg = (sc?.legs || []).find(l => String(l.id) === String(id));
  if (!leg) return;

  const prevVisual = computeDoneStateGeneric(leg, leg.date);
  const prevChecked = !!prevVisual.done;

  if (localStorage.getItem("miviaje.readonly") === "1") {
    if (el) el.checked = prevChecked;
    return;
  }

  const today = todayKey();
  const dateKey = String(leg.date || "");

  if (targetChecked === true) {
    // Sin fecha: permitir asignar fecha si el usuario quiere
    if (!dateKey) {
      const choice = prompt(
        "Evento sin fecha. ¬øQu√© quieres hacer?\n" +
        "1 = Hecho (sin fecha)\n" +
        "2 = Hecho y asignar a HOY\n" +
        "3 = Hecho y elegir fecha‚Ä¶\n\n" +
        "Escribe 1, 2 o 3:",
        "2"
      );
      if (choice === null) { if (el) el.checked = prevChecked; return; }
      const c = String(choice).trim();
      if (c === "1") { leg.doneManual = true; leg.skipped = false; }
      else if (c === "2") { leg.doneManual = true; leg.skipped = false; leg.date = today; }
      else if (c === "3") {
        const nd = promptDate(today);
        if (nd === null) { if (el) el.checked = prevChecked; return; }
        leg.doneManual = true; leg.skipped = false; leg.date = nd;
      } else { if (el) el.checked = prevChecked; return; }
      saveState();
      renderLegs();
      if (typeof renderTimeline === "function") renderTimeline();
      if (typeof calcSummary === "function") calcSummary();
      return;
    }
    if (dateKey && isFuture(dateKey)) {
      const choice = prompt(
        "Trayecto futuro. ¬øQu√© quieres hacer?\n" +
        "1 = Hecho (mantener fecha)\n" +
        "2 = Hecho y mover a HOY\n" +
        "3 = Hecho y elegir fecha‚Ä¶\n\n" +
        "Escribe 1, 2 o 3:",
        "2"
      );
      if (choice === null) { if (el) el.checked = prevChecked; return; }
      const c = String(choice).trim();
      if (c === "1") {
        leg.doneManual = true; leg.skipped = false;
      } else if (c === "2") {
        leg.doneManual = true; leg.skipped = false; leg.date = today;
      } else if (c === "3") {
        const nd = promptDate(today);
        if (nd === null) { if (el) el.checked = prevChecked; return; }
        leg.doneManual = true; leg.skipped = false; leg.date = nd;
      } else { if (el) el.checked = prevChecked; return; }
    } else {
      leg.doneManual = true; leg.skipped = false;
    }
    saveState(); renderLegs(); if (typeof renderTimeline === "function") renderTimeline(); if (typeof calcSummary === "function") calcSummary();
    return;
  }

  // targetChecked === false
  if (dateKey && isPast(dateKey)) {
    const choice = prompt(
      "Trayecto pasado. ¬øQu√© quieres hacer?\n" +
      "1 = No realizado (mantener fecha)\n" +
      "2 = Reprogramar\n\n" +
      "Escribe 1 o 2:",
      "1"
    );
    if (choice === null) { if (el) el.checked = prevChecked; return; }
    const c = String(choice).trim();
    if (c === "1") {
      leg.doneManual = false; leg.skipped = true;
    } else if (c === "2") {
      const d = new Date(); d.setDate(d.getDate() + 1);
      const def = d.toISOString().slice(0,10);
      const nd = promptDate(def);
      if (nd === null) { if (el) el.checked = prevChecked; return; }
      leg.date = nd; leg.doneManual = false; leg.skipped = false;
    } else { if (el) el.checked = prevChecked; return; }
  } else {
    leg.doneManual = false; leg.skipped = false;
  }
  saveState(); renderLegs(); if (typeof renderTimeline === "function") renderTimeline(); if (typeof calcSummary === "function") calcSummary();
}

function handleStayDoneToggle(id, targetChecked, el) {
  const sc = curScenario();
  const stay = (sc?.stays || []).find(s => String(s.id) === String(id));
  if (!stay) return;

  const prevVisual = computeDoneStateGeneric(stay, stay.date || ""); // stays no tienen fecha en este build
  const prevChecked = !!prevVisual.done;

  if (localStorage.getItem("miviaje.readonly") === "1") {
    if (el) el.checked = prevChecked;
    return;
  }

  if (targetChecked === true) {
    stay.doneManual = true; stay.skipped = false;
    saveState(); renderStays(); if (typeof renderTimeline === "function") renderTimeline(); if (typeof calcSummary === "function") calcSummary();
    return;
  }

  // OFF: confirmaci√≥n si estaba marcado manual
  if (stay.doneManual === true) {
    const ok = confirm("¬øMarcar este alojamiento como NO realizado?\n(Se mantendr√° en la lista, pero como no realizado.)");
    if (!ok) { if (el) el.checked = prevChecked; return; }
    stay.doneManual = false; stay.skipped = true;
  } else {
    stay.doneManual = false; stay.skipped = false;
  }

  saveState(); renderStays(); if (typeof renderTimeline === "function") renderTimeline(); if (typeof calcSummary === "function") calcSummary();
}
/* ---------------- /Legs/Stays: smart done ---------------- */


/* ---------------- /Activities: smart done ---------------- */



function actSummaryLinesHTML(act, opts){
  opts = opts || {};
  const city = (act.city||"").trim();
  const title = (act.title||act.name||"").trim();
  const dES = (act.date ? formatDateES(act.date) : "");
  const t = (act.time||"").trim();
  const duration = (act.duration||"").trim();
  const hasNotes = !!(act.notes && String(act.notes).trim());

  const line1City = city || "‚Äî";
  const line1Title = title || "‚Äî";

  const line2Date = dES || "‚Äî";
  const line2Time = t || "";

  // Line 1: icono + ciudad + actividad (sin icono entre ciudad y actividad)
const line1 = `<div class="text-sm font-semibold truncate">
  <span class="mr-1">üéØ</span>
  <span>${escapeHtml(line1Title)}</span>
  <span class="text-slate-400"> ¬∑ </span>
  <span class="font-medium">${escapeHtml(line1City)}</span>
  ${hasNotes ? ` <span class="ml-1">üóíÔ∏è</span>` : ``}
  ${act.fromAI ? ` <span class="ml-1 text-slate-500">(IA)</span>` : ``}
</div>`;

  // Line 2: fecha -> hora (fecha primero)
  const line2 = `<div class="text-xs text-slate-600 mt-1 truncate">
    <span class="font-semibold">${escapeHtml(line2Date)}</span>
    ${line2Time ? `<span class="text-slate-400"> ¬∑ </span><span class="font-semibold">${escapeHtml(line2Time)}</span>` : ``}
  </div>`;

  // Line 3: duraci√≥n si existe
  const line3 = duration ? `<div class="text-xs text-slate-600 mt-1 truncate"><span class="text-slate-500">Duraci√≥n:</span> <span>${escapeHtml(duration)}</span></div>` : ``;

  return `${line1}${line2}${line3}`;
}

function actCard(act) {
  const st = (typeof computeDoneStateGeneric==="function") ? computeDoneStateGeneric(act, act.date || "") : {done:false,auto:false,skipped:false};
  const city = (act.city||"").trim() || "‚Äî";
  const title = (act.title||act.name||"").trim() || "‚Äî";
  const dES = (act.date ? formatDateES(act.date) : "") || "‚Äî";
  const t = (act.time||"").trim();
  const when = t ? `${escapeHtml(dES)} ¬∑ ${escapeHtml(t)}` : `${escapeHtml(dES)}`;
  const hasNotes = !!(act.notes && String(act.notes).trim());

  return `
  <div id="act-${act.id}" class="border border-slate-200 rounded-2xl bg-slate-50 ${st.done ? "done-item" : ""} ${st.skipped ? "skipped-item" : ""}">
    <button type="button"
            class="tap w-full text-left p-4 flex items-start justify-between gap-3"
            data-act-open="${act.id}"
            aria-label="Abrir actividad">
      <div class="min-w-0">
        ${actSummaryLinesHTML(act)}
      </div>
      <div class="shrink-0 flex items-center gap-2"><div class="shrink-0 flex items-center gap-2">
        ${st.skipped ? `<span class="text-xs font-semibold skipped-badge">No realizado</span>` : (st.auto && st.done ? `<span class="text-xs auto-badge">Asumido</span>` : ``)}
        ${buildEventIndicatorsHTML(act)}
      </div>
    </button>

    <!-- Hidden editor node for premium sheet (move-node). Not an accordion UI. -->
    <div class="hidden" data-sec-body="activities" data-sec-id="${act.id}">
      <div class="grid grid-cols-1 sm:grid-cols-12 gap-3 items-end">
        <div class="sm:col-span-5">
          <label class="text-xs text-slate-600">Actividad</label>
          <input data-act-title="${act.id}" class="mt-1 w-full px-3 py-2 rounded-xl border border-slate-200" value="${escapeHtml(act.title || "")}" placeholder="Ej: Museo / Tour / Restaurante">
        </div>
        <div class="sm:col-span-3">
          <label class="text-xs text-slate-600">Ciudad</label>
          <input data-act-city="${act.id}" class="mt-1 w-full px-3 py-2 rounded-xl border border-slate-200" value="${escapeHtml(act.city || "")}" placeholder="Ciudad">
        </div>
        <div class="sm:col-span-2">
          <label class="text-xs text-slate-600">Fecha</label>
          <input data-act-date="${act.id}" type="date" class="mt-1 w-full px-3 py-2 rounded-xl border border-slate-200" value="${escapeHtml(act.date||"")}">
        </div>
        <div class="sm:col-span-2">
          <label class="text-xs text-slate-600">Hora</label>
          <input data-act-time="${act.id}" type="time" class="mt-1 w-full px-3 py-2 rounded-xl border border-slate-200" value="${escapeHtml(act.time||"")}">
        </div>
        <div class="sm:col-span-2">
          <label class="text-xs text-slate-600">Coste</label>
          <input data-act-cost="${act.id}" type="number" min="0" step="0.01" class="mt-1 w-full px-3 py-2 rounded-xl border border-slate-200" value="${escapeHtml(act.cost ?? "")}">
        </div>
        <div class="sm:col-span-8">
          <label class="text-xs text-slate-600">Notas</label>
          <textarea data-act-notes="${act.id}" class="mt-1 w-full px-3 py-2 rounded-xl border border-slate-200" rows="3" placeholder="Detalles, enlaces, recordatorios‚Ä¶">${escapeHtml(act.notes || "")}</textarea>
        </div>
        <div class="sm:col-span-2">
          <label class="text-xs text-slate-600">Estado</label>
          <select data-act-status="${act.id}" class="mt-1 w-full px-3 py-2 rounded-xl border border-slate-200">
            <option value="">‚Äî</option>
            <option value="done" ${String(act.status||"")==="done" ? "selected" : ""}>Hecho</option>
            <option value="skipped" ${String(act.status||"")==="skipped" ? "selected" : ""}>No realizado</option>
          </select>
        </div>
        <div class="sm:col-span-2 flex justify-end">
          <button data-act-del="${act.id}" class="tap px-3 py-2 rounded-xl bg-white border border-slate-200 hover:bg-slate-100 text-sm">üóëÔ∏è</button>
        </div>
      </div>
    </div>
  </div>`;
}


function renderActivities() {
  const box = $("actsList");
  const sc = curScenario();
  sortByDateTimeEmptyFirst(sc.activities);

  box.innerHTML = sc.activities.length
    ? __renderGroupedByDate(sc.activities, (it)=>it.date, actCard)
    : `<div class="text-sm text-slate-500">A√±ade actividades o incorpora sugerencias desde la IA.</div>`;

  // Tap on summary opens premium sheet in view mode (Transport-like)
  box.querySelectorAll("[data-act-open]").forEach(btn => btn.addEventListener("click", (e) => {
    try { e.preventDefault(); e.stopPropagation(); } catch {}
    const id = btn.getAttribute("data-act-open");
    if (!id) return;
    try { openEventSheet({ kind: "act", id, mode: "view", sourceView: "acts" }); } catch {}
  }));

  // Keep existing bindings for editor node (hidden in DOM; moved to sheet)
  box.querySelectorAll("[data-act-del]").forEach(b => b.addEventListener("click", (e) => {
    try { e.preventDefault(); e.stopPropagation(); } catch {}
    const id = b.getAttribute("data-act-del");
    sc.activities = sc.activities.filter(x => x.id !== id);
    try { __sectionExpanded?.activities?.delete(id); } catch {}
    saveState(); renderAll();
  }));
  box.querySelectorAll("[data-act-title]").forEach(inp => inp.addEventListener("change", () => {
    const id = inp.getAttribute("data-act-title");
    const it = sc.activities.find(x => x.id === id);
    if (!it) return;
    it.title = inp.value.trim();
    saveState(); renderTimeline();
  }));
  box.querySelectorAll("[data-act-city]").forEach(inp => inp.addEventListener("change", () => {
    const id = inp.getAttribute("data-act-city");
    const it = sc.activities.find(x => x.id === id);
    if (!it) return;
    it.city = cap1(inp.value); inp.value = it.city;
    saveState(); renderTimeline();
  }));
  box.querySelectorAll("[data-act-date]").forEach(inp => inp.addEventListener("change", () => {
    const id = inp.getAttribute("data-act-date");
    const it = sc.activities.find(x => x.id === id);
    if (!it) return;
    it.date = inp.value;
    sortByDateTimeEmptyFirst(sc.activities);
    saveState(); renderTimeline();
  }));
  box.querySelectorAll("[data-act-time]").forEach(inp => inp.addEventListener("change", () => {
    const id = inp.getAttribute("data-act-time");
    const it = sc.activities.find(x => x.id === id);
    if (!it) return;
    it.time = inp.value;
    sortByDateTimeEmptyFirst(sc.activities);
    saveState(); renderTimeline();
  }));
  box.querySelectorAll("[data-act-cost]").forEach(inp => inp.addEventListener("input", () => {
    const id = inp.getAttribute("data-act-cost");
    const it = sc.activities.find(x => x.id === id);
    if (!it) return;
    it.cost = parseMoney(inp.value);
    saveState(); calcSummary();
  }));
  box.querySelectorAll("[data-act-notes]").forEach(inp => inp.addEventListener("input", () => {
    const id = inp.getAttribute("data-act-notes");
    const it = sc.activities.find(x => x.id === id);
    if (!it) return;
    it.notes = inp.value;
    saveState();
    __dirtyTimeline = true;
  }));
  box.querySelectorAll("[data-act-status]").forEach(sel => sel.addEventListener("change", () => {
    const id = sel.getAttribute("data-act-status");
    const it = sc.activities.find(x => x.id === id);
    if (!it) return;
    it.status = sel.value;
    saveState();
  }));
}



/* ---------------- Timeline: jump to item ---------------- */
function openAccordionKey(key) {
  const body = document.querySelector(`[data-acc-body="${key}"]`);
  const btn = document.querySelector(`[data-acc="${key}"]`);
  if (!body || !btn) return;
  if (body.classList.contains("hidden")) btn.click();
}

function scrollAccordionBodyToTop(key) {
  const body = document.querySelector(`[data-acc-body="${key}"]`);
  if (!body) return;
  try { body.scrollTop = 0; } catch {}
}


function jumpToItem(kind, id) {
  const rawKind = String(kind || "").toLowerCase().trim();
  const itemId = String(id || "").trim();
  if (!rawKind || !itemId) return;

  // Sheet-first behavior (V89D1)
  try { if (typeof openEventSheet === "function") { openEventSheet({ kind: rawKind, id: itemId, mode: "view" }); return; } } catch {}

  // 1) kind -> view mapping (timeline "Ir" button)
  const kindMap = {
    leg: "legs",
    transport: "legs",
    stay: "stays",
    lodging: "stays",
    act: "acts",
    activity: "acts",
    meal: "meals",
    meals: "meals"
  };
  const view = kindMap[rawKind];
  if (!view) return;

  // 2) Switch to target view
  try { if (typeof setView === "function") setView(view); } catch {}

  // 3) Ensure the section accordion is open (if accordion shell exists)
  try {
    const accKey = (view === "acts") ? "acts" : view; // keys used by openAccordionKey
    if (typeof openAccordionKey === "function") openAccordionKey(accKey);
  } catch {}

  // 4) Expand target item (if applicable) + rerender that section
  try {
    if (rawKind === "leg" || rawKind === "transport") {
      if (__sectionExpanded?.legs) __sectionExpanded.legs.add(itemId);
      if (typeof renderLegs === "function") renderLegs();
    } else if (rawKind === "stay" || rawKind === "lodging") {
      if (__sectionExpanded?.stays) __sectionExpanded.stays.add(itemId);
      if (typeof renderStays === "function") renderStays();
    } else if (rawKind === "act" || rawKind === "activity") {
      if (__sectionExpanded?.activities) __sectionExpanded.activities.add(itemId);
      if (typeof renderActivities === "function") renderActivities();
    } else {
      // meals are not timeline items in current model; keep safe fallback
      if (typeof renderMeals === "function") renderMeals();
    }
  } catch {}

  // 5) Scroll to the item (minimal; no offsets, no window["scrollTo"])
  const findTargetEl = () => {
    try {
      if (view === "legs") return document.querySelector(`[data-sec-toggle="legs"][data-sec-id="${CSS.escape(itemId)}"]`);
      if (view === "stays") return document.querySelector(`[data-sec-toggle="stays"][data-sec-id="${CSS.escape(itemId)}"]`);
      if (view === "acts") return document.querySelector(`[data-sec-toggle="activities"][data-sec-id="${CSS.escape(itemId)}"]`);
      return null;
    } catch {
      return null;
    }
  };

  // Wait for DOM paint after rerender
  requestAnimationFrame(() => {
    requestAnimationFrame(() => {
      const el = findTargetEl();
      if (el) {
        const ms = document.getElementById("mainScroll");
        if (ms && typeof ms.scrollTo === "function") {
          const topStack = getTopStackHeight();
          const y = el.getBoundingClientRect().top + ms.scrollTop - topStack - 8;
          try { ms.scrollTo({ top: Math.max(0, y), behavior: "smooth" }); } catch { ms.scrollTop = Math.max(0, y); }
          try { el.focus({ preventScroll: true }); } catch {}
        } else if (typeof el.scrollIntoView === "function") {
          try { el.scrollIntoView({ behavior: "smooth", block: "start" }); } catch { el.scrollIntoView(); }
          try { el.focus({ preventScroll: true }); } catch {}
        }
      } else {
        alert("No se encontr√≥ el evento");
      }
    });
  });
}


/* ---------------- Item notes (timeline CRUD) ---------------- */

function getItemByTypeAndId(type, id) {
  const sc = curScenario();
  const t = String(type || "");
  const itemId = String(id || "");
  if (!sc || !t || !itemId) return null;

  if (t === "act") return (sc.activities || []).find(a => String(a.id) === itemId) || null;
  if (t === "leg") return (sc.legs || []).find(l => String(l.id) === itemId) || null;
  if (t === "stay") return (sc.stays || []).find(s => String(s.id) === itemId) || null;
  if (t === "meal") return (sc.meals || []).find(m => String(m.id) === itemId) || null;
  return null;
}

function openItemNotesModal(type, id) {
  const item = getItemByTypeAndId(type, id);
  if (!item) return;

  const ro = (localStorage.getItem("miviaje.readonly") === "1");
  const current = String(item.notes || "");

  const html = `
    <div class="text-sm text-slate-600 mb-2">Observaciones</div>
    <textarea id="itemNotesText" rows="5"
      class="w-full px-3 py-2 rounded-xl border border-slate-200 text-sm bg-white"
      placeholder="Escribe aqu√≠...">${escapeHtml(current)}</textarea>

    <div class="mt-3 flex items-center justify-between gap-2">
      <div class="flex items-center gap-2">
        <button id="itemNotesSave" class="tap px-3 py-2 rounded-xl bg-slate-900 text-white text-sm font-semibold">
          Guardar
        </button>
        <button id="itemNotesDelete" class="tap px-3 py-2 rounded-xl border border-slate-200 bg-white text-sm font-semibold text-red-600">
          Borrar
        </button>
      </div>
      <span id="itemNotesStatus" class="text-xs text-slate-500"></span>
    </div>
  `;

  showModal("Observaciones", html);

  setTimeout(() => {
    const ta = $("itemNotesText");
    const btnSave = $("itemNotesSave");
    const btnDel = $("itemNotesDelete");
    const st = $("itemNotesStatus");

    const hasText = !!String(current || "").trim();
    if (!hasText && btnDel) btnDel.classList.add("hidden");

    if (ro) {
      if (ta) ta.disabled = true;
      if (btnSave) btnSave.disabled = true;
      if (btnDel) btnDel.disabled = true;
      return;
    }

    if (btnSave) {
      btnSave.onclick = () => {
        const txt = String(ta ? ta.value : "").trim();
        item.notes = txt;
        saveState();
        if (st) st.textContent = "Guardado ‚úì";
        renderTimeline();
        closeModal();
      };
    }

    if (btnDel) {
      btnDel.onclick = () => {
        const ok = confirm("¬øBorrar estas observaciones?\n(Esta acci√≥n no borra el item.)");
        if (!ok) return;
        item.notes = "";
        saveState();
        renderTimeline();
        closeModal();
      };
    }
  }, 0);
}


function openDailyNoteModal(dateKey) {
  const sc = curScenario();
  if (!sc.dailyNotes) sc.dailyNotes = {};
  const key = String(dateKey || "").trim();
  if (!key) return;

  const ro = (localStorage.getItem("miviaje.readonly") === "1");
  const current = String(sc.dailyNotes[key] || "");

  const html = `
    <div class="text-sm text-slate-600 mb-2">Notas del d√≠a (${escapeHtml(key)})</div>
    <textarea id="dailyNoteModalText" rows="6"
      class="w-full px-3 py-2 rounded-xl border border-slate-200 text-sm bg-white"
      placeholder="Escribe aqu√≠...">${escapeHtml(current)}</textarea>

    <div class="mt-3 flex items-center justify-between gap-2">
      <div class="flex items-center gap-2">
        <button id="dailyNoteModalSave" class="tap px-3 py-2 rounded-xl bg-slate-900 text-white text-sm font-semibold">
          Guardar
        </button>
        ${current.trim() ? `
          <button id="dailyNoteModalDelete" class="tap px-3 py-2 rounded-xl border border-slate-200 bg-white text-sm font-semibold text-red-600">
            Borrar
          </button>
        ` : ``}
      </div>
      <button id="dailyNoteModalGo" class="tap px-3 py-2 rounded-xl border border-slate-200 bg-white text-sm font-semibold">
        Ir a Notas del d√≠a
      </button>
    </div>
  `;

  showModal("Observaciones", html);

  setTimeout(() => {
    const ta = document.getElementById("dailyNoteModalText");
    const btnSave = document.getElementById("dailyNoteModalSave");
    const btnDel = document.getElementById("dailyNoteModalDelete");
    const btnGo = document.getElementById("dailyNoteModalGo");

    if (ro) {
      if (ta) ta.disabled = true;
      if (btnSave) btnSave.disabled = true;
      if (btnDel) btnDel.disabled = true;
    }

    if (btnGo) {
      btnGo.onclick = () => {
        // Abrir acorde√≥n de Notas del d√≠a y seleccionar fecha
        try {
          const box = document.getElementById("dailyNotesBox");
          if (box) box.dataset.selDate = key;
        } catch {}
        // Si existe funci√≥n de abrir acordeones por id, √∫sala. Si no, jump al timeline/section.
        try {
          const accBtn = document.querySelector('[data-acc="dailyNotes"]');
          if (accBtn) accBtn.click();
        } catch {}
        try {
          const sec = document.getElementById("dailyNotesSection");
          if (sec) sec.scrollIntoView({ behavior: "smooth", block: "start" });
        } catch {}
        try { renderDailyNotes(); } catch {}
        closeModal();
      };
    }

    if (btnSave && !ro) {
      btnSave.onclick = () => {
        const v = String(ta?.value || "").trim();
        if (!v) {
          // Guardar vac√≠o => borrar key
          delete sc.dailyNotes[key];
        } else {
          sc.dailyNotes[key] = v;
        }
        saveState();
        renderTimeline();
        try { renderDailyNotes(); } catch {}
        closeModal();
      };
    }

    if (btnDel && !ro) {
      btnDel.onclick = () => {
        const ok = confirm("¬øBorrar esta nota del d√≠a?");
        if (!ok) return;
        delete sc.dailyNotes[key];
        saveState();
        renderTimeline();
        try { renderDailyNotes(); } catch {}
        closeModal();
      };
    }
  }, 0);
}

/* ---------------- /Timeline: jump to item ---------------- */
const __tlExpanded = new Set();


function formatDayLabel(iso) {
  const v = String(iso || "").trim();
  if (!/^\d{4}-\d{2}-\d{2}$/.test(v)) return "‚Äî";
  const d = new Date(v + "T00:00:00");
  if (Number.isNaN(d.getTime())) return v;
  try {
    return d.toLocaleDateString("es-ES", { weekday: "short", day: "2-digit", month: "short" }).replace(".", "");
  } catch {
    return v;
  }
}

function getTimelineDays(items) {
  const days = [];
  const seen = new Set();
  for (const it of (items || [])) {
    const d = String(it?.date || "").trim();
    if (!d || d === "9999-99-99") continue;
    if (!seen.has(d)) { seen.add(d); days.push(d); }
  }
  days.sort((a,b)=>String(a).localeCompare(String(b)));
  return days;
}

function syncTimelineViewUI(days) {
  const btnG = document.getElementById("tlViewGlobal");
  const btnD = document.getElementById("tlViewDay");
  const navDay = document.getElementById("timelineDayNav");
  const navGlobal = document.getElementById("timelineGlobalNav");
  const lbl = document.getElementById("tlDayLabel");

  // IMPORTANT: With Tailwind CDN, if both bg/text utility classes exist simultaneously,
  // the *CSS generation order* (not the DOM class order) can decide the winner.
  // So we must explicitly add/remove the mutually-exclusive classes (not just toggle one side).
  const setToggleBtn = (btn, isActive) => {
    if (!btn) return;
    btn.classList.toggle("seg-active", !!isActive);
    btn.classList.toggle("seg-inactive", !isActive);
  };

  setToggleBtn(btnG, timelineViewMode === "global");
  setToggleBtn(btnD, timelineViewMode === "day");

  if (navDay) navDay.classList.toggle("hidden", timelineViewMode !== "day");
  if (navGlobal) navGlobal.classList.toggle("hidden", timelineViewMode !== "global");

  if (lbl) lbl.textContent = (timelineViewMode === "day" && activeDayISO) ? formatDayLabel(activeDayISO) : "‚Äî";

  const prev = document.getElementById("tlDayPrev");
  const next = document.getElementById("tlDayNext");
  const idx = (days || []).indexOf(activeDayISO);
  const prevDisabled = (idx === -1) ? true : (idx <= 0);
  const nextDisabled = (idx === -1) ? ((days || []).length === 0) : (idx >= (days.length - 1));

  // Do not use native disabled (it blocks click events on some mobile browsers).
  // We only show a visual hint; bounds are enforced in moveActiveDay().
  if (prev) prev.classList.toggle("opacity-40", prevDisabled);
  if (next) next.classList.toggle("opacity-40", nextDisabled);
}

function setTimelineViewMode(mode) {
  const prev = timelineViewMode;
  timelineViewMode = (mode === "day") ? "day" : "global";
  // When entering day view, active day will be auto-selected in renderTimeline()
  renderTimeline();

  // Entering Day from Global: ensure the first event isn't hidden under the fixed controls bar.
  if (timelineViewMode === "day" && prev !== "day") {
    requestAnimationFrame(() => {
      const nodes = document.querySelectorAll(".timelineItem");
      let first = null;
      for (const el of nodes) {
        const d = (el.getAttribute("data-date") || "").trim();
        if (d === activeDayISO) { first = el; break; }
      }
      if (first) scrollToElWithOffset(first);
    });
  }
  // Entering Global from Day: ensure the timeline is visible under the sticky totals bar.
  if (timelineViewMode === "global" && prev === "day") {
    requestAnimationFrame(() => {
      const first = document.querySelector(".timelineItem");
      const list = document.getElementById("timelineList");
      if (first) {
        scrollToElWithOffset(first, 0);
      } else if (list) {
        scrollToElWithOffset(list, 0);
      } else {
        scrollToTopValue(0, "smooth");
      }
    });
  }

}


function moveActiveDay(delta) {
  const days = Array.isArray(__tlDays) ? __tlDays : [];
  const idx = days.indexOf(activeDayISO);
  const ni = idx + delta;
  if (ni < 0 || ni >= days.length) return;
  activeDayISO = days[ni];
  renderTimeline();
}

function renderTimeline() {
  const today = todayYMD();
  const box = $("timelineList");
  const sc = curScenario();
  const ro = (localStorage.getItem("miviaje.readonly") === "1");
  const actById = new Map((sc.activities || []).map(a => [String(a.id), a]));
  const legById = new Map((sc.legs || []).map(l => [String(l.id), l]));
  const stayById = new Map((sc.stays || []).map(s => [String(s.id), s]));
  const notes = sc.dailyNotes || {};
  renderTimelineFilterChips();
  const items = [];

  for (const leg of sc.legs) {
    items.push({
      date: (leg.date || "9999-99-99"),
      time: (leg.time || ""),
      arriveDate: (leg.arriveDate || ""),
      arriveTime: (leg.arriveTime || ""),
      duration: calcDurationText(leg.date, leg.time, leg.arriveDate, leg.arriveTime),
      type: "Trayecto",
      title: `${leg.from || "‚Äî"} ‚Üí ${leg.to || "‚Äî"}`,
      cost: parseMoney(leg.cost),
      legId: leg.id,
      uid: `leg:${leg.id}`
    });
  }
  for (const s of sc.stays) {
    items.push({ date: (s.date || "9999-99-99"), time: (s.time || ""), type:"Alojamiento", title: `${s.city || "‚Äî"} ‚Ä¢ ${s.name || "Hotel"}`, cost: parseMoney(s.cost), stayId: s.id, uid: `stay:${s.id}` });
  }
  for (const a of sc.activities) {
    items.push({ date: (a.date || "9999-99-99"), time: (a.time || ""), type:"Actividad", title: `${a.city || "‚Äî"} ‚Ä¢ ${a.title || "Actividad"}`, cost: parseMoney(a.cost), actId: a.id, uid: `act:${a.id}` });
  }

  // Add note markers as timeline items so you can see notes even if there was no event that day
  Object.keys(notes).forEach(d => {
    const txt = String(notes[d] || "").trim();
    if (!d || !txt) return;
    items.push({ date: d, type:"Nota", title: "Notas del d√≠a", cost: null, isNote: true, uid: `note:${d}` });
  });

  // Meals is a budget line, not a timeline event. Drop any legacy meal items safely.
  for (let i = items.length - 1; i >= 0; i--) {
    const t = String(items[i]?.type || "").toLowerCase();
    if (t.includes("comida") || t.includes("meal")) items.splice(i, 1);
  }

  items.sort((a,b)=>{
    if (a.date !== b.date) return String(a.date).localeCompare(String(b.date));
    const ta = timeSortKey(a.time);
    const tb = timeSortKey(b.time);
    if (ta !== tb) return ta - tb;
    return String(a.uid || (a.type+':'+(a.legId||a.stayId||a.actId||a.date||''))).localeCompare(String(b.uid || (b.type+':'+(b.legId||b.stayId||b.actId||b.date||''))));
  });

  const filteredItems = getFilteredItems(items);
  __tlLastFilteredItems = filteredItems;

  // Days available in current filtered list (used by Day view navigation)
  const days = getTimelineDays(filteredItems);
  __tlDays = days;

  if (timelineViewMode === "day") {
    // Auto-pick active day ONLY when entering Day mode (do not change it when filters change)
    const t = todayYMD();
    if (!activeDayISO) {
      activeDayISO = days.includes(t) ? t : (days[0] || "");
    }
  }

  syncTimelineViewUI(days);

  let visibleItems = filteredItems;

  if (timelineViewMode === "day") {
    if (!activeDayISO) {
      box.innerHTML = `<div class="text-sm text-slate-500">${(timelineFilterState.categories.size ? "No hay eventos para estos filtros." : "No hay eventos todav√≠a.")}</div>`;
      renderDailyNotes();
      return;
    }
    visibleItems = (filteredItems || []).filter(it => String(it.date || "") === String(activeDayISO));
    if (!visibleItems.length) {
      box.innerHTML = `<div class="text-sm text-slate-500">No hay eventos para este d√≠a con los filtros actuales. Prueba otro d√≠a o quita filtros.</div>`;
      renderDailyNotes();
      return;
    }
  }

  if (!visibleItems.length) {
    box.innerHTML = `<div class="text-sm text-slate-500">${(timelineFilterState.categories.size ? "No hay eventos para este filtro." : "No hay eventos todav√≠a.")}</div>`;
    renderDailyNotes();
    return;
  }

  const showCost = (timelineViewMode === "global");

  const __tlRenderItem = (it) => {
    const isDated = it.date && it.date !== "9999-99-99";
    const jumpType = it.actId ? 'act' : (it.legId ? 'leg' : (it.stayId ? 'stay' : ''));
    const jumpId = it.actId || it.legId || it.stayId || '';
    const __leg = (jumpType === 'leg') ? legById.get(String(jumpId)) : null;
    const __act = (jumpType === 'act') ? actById.get(String(jumpId)) : null;
    const __stay = (jumpType === 'stay') ? stayById.get(String(jumpId)) : null;
    const icon = (jumpType === 'leg') ? legModeIcon(__leg && __leg.mode) : (jumpType === 'stay') ? 'üè®' : (jumpType === 'act') ? 'üéØ' : '';

    const hasNote = !!(isDated && notes[it.date] && String(notes[it.date]).trim());
    const whenLabel = (it.date === "9999-99-99" ? "Sin fecha" : it.date + ((it.time && String(it.time).trim()) ? (" ¬∑ " + String(it.time).trim()) : ""));
    const clsTime = (isDated && it.date < today) ? "past" : (it.date === today ? "today" : "");
    const noteBadge = (it.isNote ? " bg-white" : " bg-slate-50");
    const datePart = (it.date === "9999-99-99" ? "Sin fecha" : String(it.date));
    const timePart = (it.time && String(it.time).trim()) ? String(it.time).trim() : "‚Äî";
    const hasTime = (timePart !== "‚Äî");
    const rel = (it.date === "9999-99-99" ? "" : (String(it.date) < today ? "past" : (String(it.date) > today ? "future" : "today")));
    const timeCls = hasTime
      ? `tlTimeBadge ${rel === "today" ? "tlTimeToday" : (rel === "future" ? "tlTimeFuture" : (rel === "past" ? "tlTimePast" : ""))}`
      : "tlTimeBadge tlTimeNone";
    const dateLineHTML = `${escapeHtml(datePart)}  <span class="${timeCls}">${escapeHtml(timePart)}</span>`;

    const __sum = buildTimelineSummaryParts(it, jumpType, __leg, dateLineHTML);
    let __title = __sum.title;
    let __dateLineHTML = __sum.metaHTML;
    let __placeLineHTML = __sum.placeLineHTML;
    const __metaClass = __sum.metaClass;

// Collapsible: por defecto plegado. (2¬∫ tap sobre expandido => jump)
    const tlKey = it.isNote ? `note:${datePart}` : `${jumpType}:${jumpId}`;
    const isExpanded = __tlExpanded.has(tlKey);

    // L√≠nea meta en detalle (mantiene lo que ya ense√±√°bamos arriba)
    const metaLine = whenLabel;

    // Observaciones por item (leg/stay/act) desde el cronograma
    const itemForNotes = (jumpType === 'act') ? actById.get(String(jumpId))
                      : (jumpType === 'leg') ? legById.get(String(jumpId))
                      : (jumpType === 'stay') ? stayById.get(String(jumpId))
                      : null;
    const hasItemNotes = !!(itemForNotes && String(itemForNotes.notes || "").trim());
    const filesCount = getPersistedFilesCount(itemForNotes);
    const filesIconHTML = (filesCount > 0) ? `<span class="text-sm leading-none" title="Archivos">üìé</span>` : ``;
    const notesBtn = (it.isNote && isDated)
      ? `<button type="button"
                 class="tap tlNotesBtn px-2 py-1 rounded-lg border border-slate-200 bg-white hover:bg-slate-50 text-xs notes-has"
                 data-daily-note-open="${escapeHtml(datePart)}"
                 title="Notas del d√≠a">üóíÔ∏è<span class="note-dot"></span></button>`
      : (hasItemNotes && jumpType && jumpId && !it.isNote)
        ? `<button type="button"
                 class="tap tlNotesBtn px-2 py-1 rounded-lg border border-slate-200 bg-white hover:bg-slate-50 text-xs ${hasItemNotes ? "notes-has" : ""}"
                 data-item-notes-type="${escapeHtml(jumpType)}"
                 data-item-notes-id="${escapeHtml(String(jumpId))}"
                 title="Observaciones">üóíÔ∏è${hasItemNotes ? '<span class="note-dot"></span>' : ''}</button>`
        : "";


    // Checkpoint (Hecho) para Transporte / Alojamiento / Actividades en el cronograma
    let tlCheckbox = "";
    let visualClass = "";
    let tlBadges = "";

    // Visual: Notas del d√≠a (timeline)
    if (it.isNote) {
      visualClass = " tl-dnote tl-dnote-has";
    }

    // Resolver elemento del state + handler seg√∫n tipo
    let kind = "";
    let itemObj = null;

    if (it.actId != null) { kind = "act"; itemObj = actById.get(String(it.actId)); }
    else if (it.legId != null) { kind = "leg"; itemObj = legById.get(String(it.legId)); }
    else if (it.stayId != null) { kind = "stay"; itemObj = stayById.get(String(it.stayId)); }

    if (itemObj && !it.isNote) {
      const dateKey = (kind === "stay") ? "" : String(itemObj.date || it.date || "");
      const st = (kind === "act") ? computeDoneState(itemObj) : computeDoneStateGeneric(itemObj, dateKey);
      const isToday = (dateKey && String(dateKey) === todayKey());

      // Badges
      if (st.skipped) tlBadges = `<span class="text-xs font-semibold skipped-badge">No realizado</span>`;
      else if (st.auto && st.done) tlBadges = `<span class="text-xs auto-badge">Asumido</span>`;

      // Clases visuales
      if (st.skipped) visualClass = " tl-skipped";
      else if (isToday && st.done) visualClass = " tl-today-done";
      else if (isToday && !st.done) visualClass = " tl-today";
      else if (st.auto && st.done) visualClass = " tl-auto-done";
      else if (dateKey && isFuture(dateKey)) visualClass = " tl-future";

      const dataAttr = kind === "act" ? `data-tl-act-done="${escapeHtml(String(it.actId))}"`
                    : kind === "leg" ? `data-tl-leg-done="${escapeHtml(String(it.legId))}"`
                    : `data-tl-stay-done="${escapeHtml(String(it.stayId))}"`;

      tlCheckbox = `<input type="checkbox" class="h-4 w-4" 
                 class="h-4 w-4"
                 ${dataAttr}
                 ${st.done ? "checked" : ""}
                 ${ro ? "disabled" : ""}>`;
    }


    return `
      <div class="timelineItem cursor-pointer ${clsTime}${visualClass} border border-slate-200 rounded-2xl p-3${noteBadge}"
           data-date="${escapeHtml(it.date)}"
           data-tl-jump-type="${jumpType}"
           data-tl-jump-id="${escapeHtml(jumpId)}"
           data-tl-key="${escapeHtml(tlKey)}">

        <div class="flex items-start justify-between gap-3">
          <div class="flex items-start gap-3 min-w-0">
            ${((jumpType==="stay" && __stay) || (jumpType==="act" && __act) || (jumpType==="leg" && __leg)) ? "" : '<div class="shrink-0 text-lg leading-none mt-[2px]">' + escapeHtml(icon || (it.isNote ? "üìù" : "‚Ä¢")) + '</div>'}

            <div class="min-w-0">
              ${(jumpType==="act" && __act) ? actSummaryLinesHTML(__act, {context:"timeline"}) : (jumpType==="stay" && __stay) ? staySummaryLinesHTML(__stay, {context:"timeline"}) : (jumpType==="leg" && __leg) ? legSummaryLinesHTML(__leg, {context:"timeline"}) : `<div class="font-semibold text-sm truncate">${escapeHtml(__title)}</div><div class="${__metaClass}">${__dateLineHTML}</div>${__placeLineHTML || ""}`}
            </div>
          </div>

          <div class="shrink-0 flex items-center gap-2">
            ${filesIconHTML || ""}
            ${tlCheckbox ? tlCheckbox : ""}
            ${notesBtn ? notesBtn : ""}
          </div>
        </div>

        <div class="mt-2 ${isExpanded ? "" : "hidden"}" data-tl-details="${escapeHtml(tlKey)}">
          <div class="text-xs text-slate-500">
            ${hasNote ? "üìù" : ""}
          </div>
          <div class="mt-1 flex items-center ${showCost ? "justify-between" : "justify-end"} gap-3">
            ${(showCost && jumpType !== "leg") ? `<div class="text-sm font-semibold">${it.cost ? it.cost.toFixed(2) : "‚Äî"}</div>` : ``}
            <div class="flex items-center gap-2">
              ${tlBadges ? tlBadges : ""}
              ${(!it.isNote && jumpType && jumpId) ? `<button type="button" class="tap px-2 py-1 rounded-lg border border-slate-200 bg-white hover:bg-slate-50 text-xs" data-tl-go="1">‚Üó Ir</button>` : ``}
            </div>
          </div>
        </div>
      </div>
    `;
};

  box.innerHTML = (timelineViewMode === "global")
    ? __renderGroupedByDate(visibleItems, (x)=> (x.date && x.date !== "9999-99-99" ? x.date : ""), __tlRenderItem)
    : (__dateSeparatorHTML(__fmtDateES(activeDayISO), activeDayISO) + visibleItems.map(__tlRenderItem).join(""));

  // Listeners scoped: checkbox "Hecho" en cronograma (transporte/alojamiento/actividades)
  box.querySelectorAll("[data-tl-act-done]").forEach(cb => {
    cb.onchange = () => handleActDoneToggle(cb.dataset.tlActDone, cb.checked, cb);
  });
  box.querySelectorAll("[data-tl-leg-done]").forEach(cb => {
    cb.onchange = () => handleLegDoneToggle(cb.dataset.tlLegDone, cb.checked, cb);
  });
  box.querySelectorAll("[data-tl-stay-done]").forEach(cb => {
    cb.onchange = () => handleStayDoneToggle(cb.dataset.tlStayDone, cb.checked, cb);
  });

    // Tap en item: abrir Sheet directo (contextual)
// - Click en checkbox/notas/Ir NO debe abrir el sheet
box.querySelectorAll(".timelineItem[data-tl-key]").forEach(row => {
  row.addEventListener("click", (e) => {
    const tag = (e.target && e.target.tagName) ? e.target.tagName.toLowerCase() : "";
    if (tag === "input" || tag === "label" || tag === "button" || tag === "textarea" || tag === "a") return;

    const jt = row.getAttribute("data-tl-jump-type") || "";
    const jid = row.getAttribute("data-tl-jump-id") || "";
    if (!jt || !jid) return; // notes or non-jump rows

    try { openEventSheet({ kind: jt, id: jid, mode: "view", sourceView: "timeline" }); } catch {}
  });
});

// Bot√≥n "Ir" (solo cuando el item est√° expandido)
box.querySelectorAll("[data-tl-go]").forEach(btn => {
  btn.addEventListener("click", (e) => {
    e.stopPropagation();
    const row = btn.closest(".timelineItem");
    if (!row) return;
    const kind = row.getAttribute("data-tl-jump-type");
    const id = row.getAttribute("data-tl-jump-id");
    if (kind && id) { try { openEventSheet({ kind, id, mode: "edit" }); } catch {} }
  });
});

// Observaciones por item (üóíÔ∏è)
box.querySelectorAll("[data-item-notes-type][data-item-notes-id]").forEach(btn => {
  btn.addEventListener("click", (e) => {
    e.stopPropagation();
    openItemNotesModal(btn.getAttribute("data-item-notes-type"), btn.getAttribute("data-item-notes-id"));
  });

// Notas del d√≠a desde el cronograma (üóíÔ∏è)
box.querySelectorAll("[data-daily-note-open]").forEach(btn => {
  btn.addEventListener("click", (e) => {
    e.stopPropagation();
    openDailyNoteModal(btn.dataset.dailyNoteOpen);
  });
});
});


  renderDailyNotes();
}

function renderDailyNotes() {
  const box = document.getElementById("dailyNotesBox");
  if (!box) return;

  const sc = curScenario();
  if (!sc.dailyNotes) sc.dailyNotes = {};

  // Default date: today (YYYY-MM-DD)
  const now = new Date();
  const yyyy = now.getFullYear();
  const mm = String(now.getMonth() + 1).padStart(2, "0");
  const dd = String(now.getDate()).padStart(2, "0");
  const today = `${yyyy}-${mm}-${dd}`;

  // Keep selection in dataset
  const selectedDate = (box.dataset.selDate || today);
  const existing = String(sc.dailyNotes[selectedDate] || "");

  // Read-only fallback
  const ro = (localStorage.getItem("miviaje.readonly") === "1");

  // Dates that already have notes (sorted)
  const noteDates = Object.keys(sc.dailyNotes || {})
    .filter(d => String(sc.dailyNotes[d] || "").trim())
    .sort((a,b) => String(a).localeCompare(String(b)));

  box.innerHTML = `
    <div class="flex items-center justify-between gap-2 mb-2">
      <div class="font-semibold text-sm">Notas del d√≠a</div>
      <input id="dailyNoteDate" type="date" value="${escapeHtml(selectedDate)}"
             class="px-2 py-1 rounded-xl border border-slate-200 text-sm bg-white">
    </div>

    <textarea id="dailyNoteText" rows="3"
      class="w-full px-3 py-2 rounded-xl border border-slate-200 text-sm bg-white"
      placeholder="Apunta aqu√≠ lo importante de ese d√≠a...">${escapeHtml(existing)}</textarea>

    <div class="mt-2 flex items-center gap-2">
      <button id="saveDailyNote"
        class="tap px-3 py-2 rounded-xl bg-slate-900 text-white text-sm font-semibold">
        Guardar nota
      </button>

      <button id="deleteDailyNote"
        class="tap px-3 py-2 rounded-xl border border-slate-200 bg-white text-sm font-semibold text-red-600">
        Borrar
      </button>

      <span id="dailyNoteStatus" class="text-xs text-slate-500"></span>
    </div>

    ${noteDates.length ? `
      <div class="mt-3">
        <div class="text-xs font-semibold text-slate-600 mb-1">D√≠as con notas</div>
        <div class="flex flex-wrap gap-2">
          ${noteDates.map(d => `
            <button class="tap px-2 py-1 rounded-xl border border-slate-200 bg-white text-xs ${d === selectedDate ? "noteDateActive" : ""}"
                    data-note-date="${escapeHtml(d)}">
              ${escapeHtml(d)}
            </button>
          `).join("")}
        </div>
      </div>
    ` : ``}
  `;

  const dateEl = document.getElementById("dailyNoteDate");
  const textEl = document.getElementById("dailyNoteText");
  const btn = document.getElementById("saveDailyNote");
  const delBtn = document.getElementById("deleteDailyNote");
  const status = document.getElementById("dailyNoteStatus");

  // Respect read-only (fallback)
  if (ro) {
    if (dateEl) dateEl.disabled = true;
    if (textEl) textEl.disabled = true;
    if (btn) btn.disabled = true;
    if (delBtn) delBtn.disabled = true;
  }

  // iOS a veces dispara mejor 'input' que 'change'
  const onDateChange = () => {
    box.dataset.selDate = (dateEl.value || today);
    renderDailyNotes();
  };
  if (dateEl) {
    dateEl.onchange = onDateChange;
    dateEl.oninput = onDateChange;
  }

  // Quick-jump buttons
  box.querySelectorAll("[data-note-date]").forEach(b => {
    b.onclick = () => {
      const d = b.getAttribute("data-note-date") || "";
      if (!d) return;
      box.dataset.selDate = d;
      renderDailyNotes();
    };

  // Delete button state
  if (delBtn) {
    const hasTxt = String(sc.dailyNotes[selectedDate] || "").trim();
    delBtn.disabled = ro || !hasTxt;
    delBtn.style.display = hasTxt ? "" : "none";
    delBtn.onclick = () => {
      if (ro) return;
      const k = String(dateEl?.value || "").trim();
      if (!k) return;
      const ok = confirm("¬øBorrar esta nota del d√≠a?");
      if (!ok) return;
      delete sc.dailyNotes[k];
      saveState();
      if (status) status.textContent = "Borrado ‚úì";
      renderDailyNotes();
      if (typeof renderTimeline === "function") renderTimeline();
    };
  }
  });

  if (btn) {
    btn.onclick = () => {
      const k = String(dateEl?.value || "").trim();
      if (!k) return;

      const v = String(textEl?.value || "").trim();
      if (!v) delete sc.dailyNotes[k];
      else sc.dailyNotes[k] = v;

      saveState();

      if (status) status.textContent = "Guardado ‚úì";

      // Refresh timeline so notes are visible there
      if (typeof renderTimeline === "function") renderTimeline();
    };
  }

  // Ensure readonly UI is applied after rerender if available
  try { if (typeof applyReadOnlyMode === "function") applyReadOnlyMode(); } catch {}
  try { if (typeof applyReadOnlyUI === "function") applyReadOnlyUI(); } catch {}
}


/* ---------------------- Summary fold (no persistence) ---------------------- */
let summaryExpanded = false;
// Backward-compat helpers (avoid runtime errors if older patches referenced them)
function bindSummaryToggleOnce(){ /* no-op: applySummaryFold() binds onclick each render */ }
function applySummaryUI(){ /* no-op: kept for compatibility */ }


function applySummaryFold() {
  // Legacy summary is intentionally hidden (see CSS). Keep DOM values updated for calculations.
  const legacySummary = document.getElementById("summary");
  if (legacySummary) legacySummary.classList.add("hidden");
  const legacyDetail = document.getElementById("summaryDetail");
  if (legacyDetail) legacyDetail.classList.add("hidden");

  const t = document.getElementById("stickyTotalToggle");
  const d = document.getElementById("stickySummaryDetail");
  const inner = document.getElementById("stickySummaryDetailInner");

  if (t) t.textContent = summaryExpanded ? "Ocultar ‚ñ¥" : "Detalle ‚ñæ";
  if (d) d.classList.toggle("hidden", !summaryExpanded);

  // Keep top stack measurements deterministic when detail opens/closes
  requestAnimationFrame(() => requestAnimationFrame(() => {
    try { syncTopStackHeights(); } catch {}
    // If user is at the top, keep anchor at the top of content (under Totales)
    try {
      const ms = document.getElementById("mainScroll");
      if (ms && ms.scrollTop < 4) scrollMainToTop();
    requestAnimationFrame(calibrateViewStartGap);
    } catch {}
  }));

  // Re-render sticky detail (cheap + keeps it fresh even if calcSummary runs often)
  if (inner) {
    const targetCur =
      (document.getElementById("displayCurrency")?.value) ||
      (state.displayCurrency) ||
      "EUR";
    const curSym = currencySymbol(targetCur);

    const sumConverted = (arr, fallbackCur="EUR") =>
      (arr||[]).reduce((acc, x) => {
        const cost = parseMoney(x?.cost);
        if (!cost) return acc;
        const fromCur = (x && x.currency) ? String(x.currency) : (state.displayCurrency || fallbackCur);
        return acc + convertMoney(cost, fromCur, targetCur);
      }, 0);

    const sumFor = (sc) => {
      const transport = sumConverted(sc.legs, "EUR");
      const stay = sumConverted(sc.stays, "EUR");
      const acts = sumConverted(sc.activities, "EUR");

      const mealsRaw = parseMoney(sc.meals?.daily) *
                       (parseInt(sc.meals?.people || 1, 10)) *
                       (parseInt(sc.meals?.days || 1, 10));
      const mealsFromCur = (sc.meals && sc.meals.currency) ? String(sc.meals.currency) : (state.displayCurrency || targetCur);
      const meals = convertMoney(mealsRaw, mealsFromCur, targetCur);

      const total = transport + stay + acts + meals;
      return { transport, stay, meals, acts, total };
    };


    const aS = sumFor(state.scenarios.A || emptyScenario());
    const bS = sumFor(state.scenarios.B || emptyScenario());
    const bHasData = (bS.total > 0.00001) || (state.scenarios.B?.legs?.length) || (state.scenarios.B?.stays?.length) || (state.scenarios.B?.activities?.length) || (parseMoney(state.scenarios.B?.meals?.daily) > 0);

    // Sticky bar: best scenario quick hint
    const bestEl = document.getElementById("stickyBestAB");
    if (bestEl) {
      if (!bHasData) {
        bestEl.textContent = "Mejor A";
      } else {
        bestEl.textContent = `Mejor ${aS.total <= bS.total ? "A" : "B"}`;
      }
    }

    const fmt = (n) => (Number(n)||0).toFixed(2);
    const difTxt = (n) => {
      const v = Number(n)||0;
      const s = fmt(Math.abs(v));
      return (v>0 ? "+" : v<0 ? "-" : "") + s;
    };

    const rows = [
      ["Transporte", aS.transport, bS.transport],
      ["Alojamiento", aS.stay, bS.stay],
      ["Comida", aS.meals, bS.meals],
      ["Actividades", aS.acts, bS.acts],
      ["TOTAL", aS.total, bS.total]
    ];

    if (!bHasData) {
      inner.innerHTML = `
        <div class="row"><span class="lbl">Transporte</span><span class="val">${fmt(aS.transport)}</span></div>
        <div class="row"><span class="lbl">Alojamiento</span><span class="val">${fmt(aS.stay)}</span></div>
        <div class="row"><span class="lbl">Comida</span><span class="val">${fmt(aS.meals)}</span></div>
        <div class="row"><span class="lbl">Actividades</span><span class="val">${fmt(aS.acts)}</span></div>
        <hr class="my-2 border-slate-200"/>
        <div class="row"><span class="total">TOTAL</span><span class="total">${fmt(aS.total)}</span></div>
        <div class="mt-1 text-xs text-slate-500">${curSym ? curSym : ""}</div>
      `;
    } else {
      inner.innerHTML = `
        <div class="overflow-x-auto">
          <table class="w-full text-sm">
            <thead>
              <tr class="text-slate-500">
                <th class="text-left font-semibold py-1">Concepto</th>
                <th class="text-right font-semibold py-1">A</th>
                <th class="text-right font-semibold py-1">B</th>
                <th class="text-right font-semibold py-1">Dif</th>
              </tr>
            </thead>
            <tbody>
              ${rows.map(r=>{
                const dif = (r[2]||0) - (r[1]||0);
                const isTot = r[0]==="TOTAL";
                return `
                  <tr class="${isTot ? "border-t border-slate-200" : ""}">
                    <td class="py-1 ${isTot ? "font-extrabold" : "text-slate-600"}">${escapeHtml(r[0])}</td>
                    <td class="py-1 text-right ${isTot ? "font-extrabold" : "font-semibold"}">${fmt(r[1])}</td>
                    <td class="py-1 text-right ${isTot ? "font-extrabold" : "font-semibold"}">${fmt(r[2])}</td>
                    <td class="py-1 text-right ${isTot ? "font-extrabold" : "font-semibold"}">${difTxt(dif)}</td>
                  </tr>`;
              }).join("")}
            </tbody>
          </table>
        </div>
        <div class="mt-1 text-xs text-slate-500">${curSym ? curSym : ""}</div>
      `;
    }
  }

  // Stable binding with reflow correction (prevents content jump/covering)
  if (t) {
    t.onclick = () => {
      const topOffset = __tlGetTopOffsetPx();
      const anchorEl = document.elementFromPoint(16, topOffset + 8);
      const anchor = anchorEl ? (anchorEl.closest('[data-acc-body]') || anchorEl.closest('[data-acc]') || anchorEl) : null;
      const beforeTop = anchor ? anchor.getBoundingClientRect().top : null;

      summaryExpanded = !summaryExpanded;
      applySummaryFold();

      // sync heights then correct scroll so the same anchor stays in place
      try { syncStickyTotalsHeightVar(); } catch {}
      requestAnimationFrame(() => {
        try { syncStickyTotalsHeightVar(); } catch {}
        if (anchor && beforeTop !== null) {
          const afterTop = anchor.getBoundingClientRect().top;
          const diff = afterTop - beforeTop;
          if (Math.abs(diff) > 1) window.scrollBy({ top: diff, left: 0, behavior: "auto" });
        }
      });
    };
  }
}

/* -------------------- /Summary fold (no persistence) -------------------- */

function calcSummary() {
  const sc = curScenario();
  const targetCur =
    (document.getElementById("displayCurrency")?.value) ||
    (state.displayCurrency) ||
    (document.getElementById("sumCur")?.textContent) ||
    "EUR";

  const sumConverted = (arr, fallbackCur="EUR") =>
    (arr||[]).reduce((acc, x) => {
      const cost = parseMoney(x?.cost);
      if (!cost) return acc;
      const fromCur = (x && x.currency) ? String(x.currency) : (state.displayCurrency || fallbackCur);
      return acc + convertMoney(cost, fromCur, targetCur);
    }, 0);

  const transport = sumConverted(sc.legs, "EUR");
  const stay = sumConverted(sc.stays, "EUR");
  const acts = sumConverted(sc.activities, "EUR");

  // Meals: aggregate block. Interpreted in the *display currency* (current app model).
  const mealsRaw = parseMoney(sc.meals?.daily) *
                   (parseInt(sc.meals?.people || 1, 10)) *
                   (parseInt(sc.meals?.days || 1, 10));
  const mealsFromCur = (sc.meals && sc.meals.currency) ? String(sc.meals.currency) : (state.displayCurrency || targetCur);
  const meals = convertMoney(mealsRaw, mealsFromCur, targetCur);

  $("sumTransport").textContent = transport.toFixed(2);
  $("sumStay").textContent = stay.toFixed(2);
  $("sumActs").textContent = acts.toFixed(2);
  $("sumMeals").textContent = meals.toFixed(2);
  $("sumTotal").textContent = (transport + stay + acts + meals).toFixed(2);

  const stickyVal = document.getElementById("stickyTotalValue");
  if (stickyVal) stickyVal.textContent = `${$("sumTotal").textContent}`;

  applySummaryFold();
}

/* --------------------------- Gemini helpers -------------------------- */
function getGeminiKey() {
  return localStorage.getItem(LS_KEY_GEMINI) || "";
}
function setGeminiKey(key) {
  localStorage.setItem(LS_KEY_GEMINI, key.trim());
}
function cleanJsonText(t) {
  t = String(t || "").trim();
  t = t.replace(/```json/gi, "```");
  if (t.startsWith("```")) {
    t = t.replace(/^```[a-zA-Z]*\n?/, "");
    t = t.replace(/```$/, "");
  }
  return t.trim();
}

async function geminiGenerateJSON(prompt, schemaHint = "") {
  const key = getGeminiKey();
  if (!key) throw new Error("NO_KEY");
  const model = "gemini-2.5-flash";
  const url = `https://generativelanguage.googleapis.com/v1beta/models/${model}:generateContent?key=${encodeURIComponent(key)}`;

  const body = {
    contents: [{ role: "user", parts: [{ text: prompt + (schemaHint ? "\n\n" + schemaHint : "") }] }],
    generationConfig: {
      temperature: 0.4,
      responseMimeType: "application/json"
    }
  };

  const r = await fetch(url, { method:"POST", headers: { "Content-Type":"application/json" }, body: JSON.stringify(body) });
  const data = await r.json();
  if (!r.ok) throw new Error("GEMINI_" + r.status + " " + JSON.stringify(data));
  let txt = data?.candidates?.[0]?.content?.parts?.[0]?.text || "";
  txt = cleanJsonText(txt);
  return JSON.parse(txt);
}

/* -------------------------- Timezone automation ---------------------- */
const tzCache = new Map(); // city -> {offset, tz}
async function getCityTimezone(city) {
  city = String(city||"").trim();
  if (!city) return null;
  if (tzCache.has(city)) return tzCache.get(city);

  const schema = `Devuelve SOLO este JSON: {"timezone":"Area/City","offset":-5}\n"offset" debe ser el offset UTC actual aproximado (n√∫mero entero).`;
  const prompt = `Dime la zona horaria IANA y el offset UTC entero aproximado para la ciudad: ${city}.`;
  const res = await geminiGenerateJSON(prompt, schema);
  tzCache.set(city, res);
  return res;
}
async function updateTimezoneForLeg(legId, which) {
  const sc = curScenario();
  const leg = sc.legs.find(x => x.id === legId);
  if (!leg) return;
  const city = which === "from" ? leg.from : leg.to;
  if (!city) return;
  try {
    const tz = await getCityTimezone(city);
    if (!tz) return;
    if (which === "from") leg.tzFrom = tz.offset;
    else leg.tzTo = tz.offset;
    saveState(); renderLegs();
  } catch(e) {
    // silent: key missing or API error
  }
}

/* ------------------------------- AI flow ----------------------------- */
function gatherAIPickOptions() {
  const sc = curScenario();
  const destinations = uniq(sc.legs.map(l => l.to).filter(Boolean));
  const origin = sc.legs.length ? String(sc.legs[0].from || "").trim() : "";
  const filteredDest = destinations.filter(c => c.toLowerCase() !== origin.toLowerCase() && c.toLowerCase() !== "madrid");

  const acts = uniq(sc.activities.map(a => (a.city ? `${a.city}: ${a.title}` : a.title)).filter(Boolean));
  const stays = uniq(sc.stays.map(s => (s.city ? `${s.city}: ${s.name}` : s.name)).filter(Boolean));

  return { origin, cities: filteredDest, acts, stays };
}

function openAIPickModal() {
  const opt = gatherAIPickOptions();
  if (!opt.cities.length && !opt.acts.length && !opt.stays.length) {
    $("aiStatus").textContent = "A√±ade al menos un trayecto, alojamiento o actividad para pedir sugerencias.";
    return;
  }

  const buildChecks = (items, prefix) => items.map((t,i)=>`
    <label class="flex items-center gap-2 py-1">
      <input type="checkbox" data-pick="${prefix}:${i}" class="w-4 h-4">
      <span>${escapeHtml(t)}</span>
    </label>
  `).join("");

  const html = `
    <div class="text-sm text-slate-600 mb-3">
      Selecciona sobre qu√© quieres sugerencias. Se excluye la ciudad de salida (<b>${escapeHtml(opt.origin||"‚Äî")}</b>).
    </div>
    <div class="grid grid-cols-1 sm:grid-cols-3 gap-4">
      <div>
        <div class="font-extrabold mb-2">Destinos</div>
        ${opt.cities.length ? buildChecks(opt.cities, "city") : `<div class="text-sm text-slate-400">‚Äî</div>`}
      </div>
      <div>
        <div class="font-extrabold mb-2">Actividades</div>
        ${opt.acts.length ? buildChecks(opt.acts, "act") : `<div class="text-sm text-slate-400">‚Äî</div>`}
      </div>
      <div>
        <div class="font-extrabold mb-2">Alojamientos</div>
        ${opt.stays.length ? buildChecks(opt.stays, "stay") : `<div class="text-sm text-slate-400">‚Äî</div>`}
      </div>
    </div>
  `;

  const btnSave = document.createElement("button");
  btnSave.className = "tap px-4 py-2 rounded-xl bg-indigo-600 hover:bg-indigo-700 text-white text-sm font-semibold";
  btnSave.textContent = "Guardar selecci√≥n";
  btnSave.onclick = () => {
    const picks = Array.from(document.querySelectorAll("[data-pick]")).filter(x=>x.checked).map(x=>x.getAttribute("data-pick"));
    const cities = picks.filter(p=>p.startsWith("city:")).map(p=>opt.cities[parseInt(p.split(":")[1],10)]);
    const items = picks.filter(p=>!p.startsWith("city:")).map(p=>{
      const [k,idx] = p.split(":");
      const i = parseInt(idx,10);
      if (k==="act") return { type:"activity", text: opt.acts[i] };
      if (k==="stay") return { type:"stay", text: opt.stays[i] };
      return null;
    }).filter(Boolean);

    state.aiPick = { cities, items };
    saveState();
    $("aiStatus").textContent = `Selecci√≥n guardada: ${cities.length} destinos, ${items.length} items. Pulsa "Generar gu√≠a".`;
    closeModal();
  };

  const btnCancel = document.createElement("button");
  btnCancel.className = "tap px-4 py-2 rounded-xl border border-slate-200 bg-white hover:bg-slate-50 text-sm font-semibold";
  btnCancel.textContent = "Cancelar";
  btnCancel.onclick = closeModal;

  showModal("Elegir temas para la IA", html, [btnCancel, btnSave]);
}

function renderAIResults(sections) {
  const box = $("aiResults");
  if (!sections.length) { box.innerHTML = ""; return; }

  box.innerHTML = sections.map((sec, sidx) => {
    const tipsHtml = (sec.tips || []).map(t=>`<li><b>${escapeHtml(t.title||"Tip")}</b>: ${escapeHtml(t.detail||"")}</li>`).join("");
    const spotsHtml = (sec.spots || []).map((sp, i)=>`
      <label class="flex items-start gap-3 p-3 rounded-2xl border border-slate-200 bg-white">
        <input type="checkbox" class="mt-1 w-4 h-4" data-ai-spot="${sidx}:${i}">
        <div>
          <div class="font-extrabold">${escapeHtml(sp.title||"Lugar")}</div>
          <div class="text-sm text-slate-600">${escapeHtml(sp.desc||"")}</div>
          <div class="text-xs text-slate-500 mt-1">${escapeHtml(sec.city||"")}</div>
        </div>
      </label>
    `).join("");

    return `
      <div class="border border-slate-200 rounded-3xl p-4 bg-slate-50">
        <div class="flex items-center justify-between gap-2">
          <div class="font-extrabold text-lg">${escapeHtml(sec.city || sec.topic || "Sugerencias")}</div>
          <span class="text-xs text-slate-500">${(sec.spots||[]).length} lugares</span>
        </div>
        ${(sec.tips && sec.tips.length) ? `
          <div class="mt-3">
            <div class="font-extrabold">Tips √∫tiles</div>
            <ul class="list-disc pl-5 text-sm text-slate-700 mt-1">${tipsHtml}</ul>
          </div>
        ` : ``}
        <div class="mt-3 grid grid-cols-1 gap-2">
          ${spotsHtml || `<div class="text-sm text-slate-500">Sin lugares.</div>`}
        </div>
      </div>
    `;
  }).join("");

  const btnAdd = document.createElement("button");
  btnAdd.className = "tap px-4 py-2 rounded-xl bg-fuchsia-600 hover:bg-fuchsia-700 text-white text-sm font-semibold";
  btnAdd.textContent = "A√±adir seleccionadas a Actividades";
  btnAdd.onclick = () => {
    const sc = curScenario();
    const checks = Array.from(document.querySelectorAll("[data-ai-spot]")).filter(x=>x.checked);
    let added = 0;
    for (const c of checks) {
      const [sidx, i] = c.getAttribute("data-ai-spot").split(":").map(x=>parseInt(x,10));
      const sec = window.__aiSections[sidx];
      const sp = sec.spots[i];
      sc.activities.unshift({
        id: nowId(),
        title: sp.title,
        city: sec.city || "",
        date: "", // optional
        cost: "",
        fromAI: true
      });
      added++;
    }
    saveState();
    renderAll();
  syncStickyTotalsHeightVar();
  $("aiStatus").textContent = added ? `A√±adidas ${added} actividades.` : "No has seleccionado ninguna recomendaci√≥n.";
  };

  // attach under results
  const actionBar = document.createElement("div");
  actionBar.className = "mt-3 flex justify-end";
  actionBar.appendChild(btnAdd);
  box.prepend(actionBar);
}

async function generateAIGuide() {
  const pick = state.aiPick || { cities: [], items: [] };
  if ((!pick.cities || !pick.cities.length) && (!pick.items || !pick.items.length)) {
    $("aiStatus").textContent = "Primero pulsa ‚Äú1) Elegir temas‚Äù y marca al menos un destino o item.";
    return;
  }
  if (!getGeminiKey()) {
    $("aiStatus").textContent = "Primero pulsa ‚ÄúCambiar clave‚Äù y pega tu API Key de Gemini (AIza‚Ä¶).";
    return;
  }

  $("aiStatus").textContent = "Generando gu√≠a‚Ä¶ (Gemini 2.5 Flash)";
  $("aiResults").innerHTML = "";

  const schema = `Devuelve SOLO JSON v√°lido con este formato:
{
  "sections":[
    {
      "city":"Nueva York",
      "spots":[{"title":"...","desc":"..."}],
      "tips":[{"title":"Transporte p√∫blico","detail":"..."}]
    }
  ]
}`;
  const topics = [];
  for (const c of (pick.cities||[])) topics.push({ kind:"city", value:c });
  for (const it of (pick.items||[])) topics.push({ kind:it.type, value:it.text });

  const sections = [];
  for (const t of topics) {
    const prompt = `Eres un gu√≠a local experto y pr√°ctico.
Genera recomendaciones tur√≠sticas y tips √∫tiles para: ${t.value}
Idioma: espa√±ol.
Si es una ciudad, prioriza lugares imprescindibles + 1-2 lugares menos t√≠picos.
Incluye tips √∫tiles (abonos de transporte, c√≥mo moverse, horarios t√≠picos, trucos locales).
M√°ximo: 6 lugares y 4 tips.
NO incluyas URLs.`;
    try {
      const out = await geminiGenerateJSON(prompt, schema);
      for (const sec of (out.sections || [])) {
        // normalize
        sections.push({
          city: sec.city || (t.kind==="city" ? t.value : ""),
          topic: t.value,
          spots: (sec.spots || []).slice(0,6),
          tips: (sec.tips || []).slice(0,4)
        });
      }
    } catch(e) {
      console.error(e);
      $("aiStatus").textContent = "Error generando gu√≠a. Revisa la clave o reintenta.";
      return;
    }
  }

  window.__aiSections = sections;
  $("aiStatus").textContent = `Gu√≠a lista: ${sections.length} bloque(s). Marca lugares para a√±adirlos al plan.`;
  renderAIResults(sections);
}

/* ----------------------- Device name \(minimal\) ------------------------ */
const LS_DEVICE_NAME = "miviaje.deviceName";

function getDeviceName() {
  const v = (localStorage.getItem(LS_DEVICE_NAME) || "").trim();
  return v || "Este iPhone";
}

function setDeviceName(name) {
  const v = String(name || "").trim();
  if (v) localStorage.setItem(LS_DEVICE_NAME, v);
  else localStorage.removeItem(LS_DEVICE_NAME); // vuelve al fallback
  // Mant√©n meta.deviceName alineado (si usas meta)
  if (typeof setMeta === "function") setMeta({ deviceName: getDeviceName() });
}
/* --------------------- /Device name \(minimal\) --------------------- */


/* ------------------------ Save / Load (simple) ----------------------- */

/* ------------------- Manual Backups (list + restore) ------------------- */
const MANUAL_BACKUPS_KEY = "miviaje.backups";
const MANUAL_BACKUPS_MAX = 20;

function deepCloneJSON(obj) {
  try { return JSON.parse(JSON.stringify(obj)); } catch { return null; }
}

function getManualBackups() {
  try {
    const raw = localStorage.getItem(MANUAL_BACKUPS_KEY);
    const arr = raw ? JSON.parse(raw) : [];
    return Array.isArray(arr) ? arr : [];
  } catch {
    return [];
  }
}

function saveManualBackups(list) {
  localStorage.setItem(MANUAL_BACKUPS_KEY, JSON.stringify(list));
}

function enforceManualBackupLimit(list) {
  const sorted = list.slice().sort((a, b) => {
    const ta = Date.parse(a?.savedAt || "") || 0;
    const tb = Date.parse(b?.savedAt || "") || 0;
    return ta - tb;
  });
  return sorted.slice(Math.max(0, sorted.length - MANUAL_BACKUPS_MAX));
}

function createManualBackupEntry(label = "") {
  const snapshot = deepCloneJSON(state);
  if (!snapshot) {
    alert("No se pudo crear el backup (estado no serializable).");
    return null;
  }
  const now = new Date();
  const deviceName = (typeof getDeviceName === "function") ? getDeviceName(false) : "Dispositivo";
  const entry = {
    id: String(Date.now()) + "-" + Math.random().toString(16).slice(2),
    savedAt: now.toISOString(),
    deviceName: label ? `${deviceName} ${label}` : deviceName,
    state: snapshot
  };
  const list = getManualBackups();
  list.push(entry);
  saveManualBackups(enforceManualBackupLimit(list));
  return entry;
}

function formatManualBackupLabel(b) {
  const iso = b?.savedAt || "";
  let pretty = iso;
  try { pretty = new Date(iso).toLocaleString(); } catch {}
  return `${pretty} ¬∑ ${b?.deviceName || "Dispositivo"}`;
}


function getLatestManualBackup() {
  const list = getManualBackups();
  if (!list.length) return null;
  // pick newest by savedAt
  return list.slice().sort((a,b) => (Date.parse(b.savedAt||"")||0) - (Date.parse(a.savedAt||"")||0))[0] || null;
}

function renderManualBackupList() {
  const box = $("manualBackupList");
  if (!box) return;

  const list = getManualBackups().slice().sort((a, b) => {
    const ta = Date.parse(a?.savedAt || "") || 0;
    const tb = Date.parse(b?.savedAt || "") || 0;
    return tb - ta; // newest first
  });

  if (!list.length) {
    box.innerHTML = `<div class="text-sm text-slate-500">A√∫n no hay backups locales.</div>`;
    return;
  }

  box.innerHTML = list.map((b) => `
    <div class="flex items-center justify-between gap-3 p-3 rounded-2xl border border-slate-200 bg-white">
      <div class="min-w-0">
        <div class="text-sm font-semibold truncate">${escapeHtml(formatManualBackupLabel(b))}</div>
      </div>
      <button class="tap px-3 py-2 rounded-xl bg-slate-900 text-white text-sm font-semibold" data-manual-backup-restore="${escapeHtml(b.id || "")}">
        Restaurar
      </button>
    </div>
  `).join("");

  box.querySelectorAll("[data-manual-backup-restore]").forEach(btn => {
    btn.onclick = () => {
      const id = btn.getAttribute("data-manual-backup-restore");
      if (!id) return;
      restoreManualBackupById(id);
    };
  });
}

function restoreManualBackupById(id) {
  const list = getManualBackups();
  const b = list.find(x => x && x.id === id);
  if (!b || !b.state) return;

  const ok = confirm(
    "Vas a restaurar este backup:\n\n" +
    formatManualBackupLabel(b) +
    "\n\nSe har√° un backup autom√°tico del estado actual antes de restaurar."
  );
  if (!ok) return;

  // Safety: automatic backup of current state
  createManualBackupEntry("(auto pre-restore)");

  const next = deepCloneJSON(b.state);
  if (!next) {
    alert("No se pudo restaurar (backup corrupto o no serializable).");
    return;
  }

  state = next;
  saveState();
  closeModal();
  renderAll();
  syncStickyTotalsHeightVar();
  alert("Backup restaurado.");
}
/* ----------------- /Manual Backups (list + restore) ------------------ */


function openTripsModal() {
  const html = `
    <div id="syncStatus" class="text-xs text-slate-500 mb-3"></div>

    <!-- 1) BLOQUE PRINCIPAL ‚Äî ARCHIVOS -->
    <div class="bg-white border border-slate-200 rounded-3xl p-4 sm:p-5">
      <div class="flex items-center justify-between gap-2 mb-3">
        <div>
          <div class="font-extrabold text-base">Archivos</div>
</div>
        <button id="setDeviceName" class="tap px-3 py-2 rounded-xl border border-slate-200 bg-white hover:bg-slate-50 text-xs font-semibold whitespace-nowrap">
          Nombre del iPhone
        </button>
      </div>

      
      <div class="mb-4">
        <label class="text-xs text-slate-600">Nombre del viaje</label>
        <input id="tripNameInput"
               class="mt-1 w-full px-3 py-2 rounded-xl border border-slate-200 bg-white"
               placeholder="Ej: Nueva York"
               autocapitalize="words"
               autocomplete="off"
               spellcheck="false">
        <div class="mt-1 text-xs text-slate-500">
          Se usar√° para el nombre del archivo y para identificar ‚ÄúMis viajes‚Äù.
        </div>
      </div>

<div class="grid grid-cols-1 sm:grid-cols-2 gap-3">
        <button id="doExport" class="tap px-4 py-3 rounded-2xl bg-indigo-600 hover:bg-indigo-700 text-white font-semibold">
          Guardar (descargar .json)
        </button>

        <button id="doExportMilestone" class="tap px-4 py-3 rounded-2xl border border-slate-200 bg-white hover:bg-slate-50 font-semibold">
          Exportar hito
        </button>

        <label class="tap px-4 py-3 rounded-2xl border border-slate-200 bg-white hover:bg-slate-50 font-semibold text-center cursor-pointer sm:col-span-2">
          Cargar (importar .json)
          <input id="doImport" type="file" accept="application/json" class="hidden">
        </label>
      </div>

      <!-- Acorde√≥n: Mis viajes (local) ‚Äî cerrado por defecto -->
      <div class="mt-4 bg-white border border-slate-200 rounded-3xl overflow-hidden">
        <button data-acc="modalTrips" class="w-full tap flex items-center justify-between px-4 py-4">
          <div class="flex items-center gap-3">
            <span class="inline-flex w-9 h-9 rounded-2xl bg-slate-50 items-center justify-center">üóÇÔ∏è</span>
            <div class="text-left">
              <div class="font-extrabold">Mis viajes (local)</div>
</div>
          </div>
          <span class="accIcon text-slate-400 text-xl">‚ñæ</span>
        </button>
        <div data-acc-body="modalTrips" class="px-4 pb-4 hidden">
          <input id="tripSearchInput" type="text" placeholder="Buscar viaje..." class="w-full px-3 py-2 rounded-xl border border-slate-200 bg-white text-sm mb-2"/>
          <div id="tripList" class="space-y-2 max-h-[35vh] overflow-y-auto pr-1 overscroll-contain ios-scroll"></div>
        </div>
      </div>
    </div>

    <!-- 2) BLOQUE SEGURIDAD ‚Äî BACKUPS -->
    <div class="mt-4 bg-white border border-slate-200 rounded-3xl p-4 sm:p-5">
      <div class="flex items-center justify-between mb-3">
        <div>
          <div class="font-extrabold text-base">Seguridad</div>
</div>
        <button id="restoreBackup" class="tap px-3 py-2 rounded-xl border border-slate-200 bg-white hover:bg-slate-50 text-xs font-semibold whitespace-nowrap">
          Restaurar √∫ltimo backup
        </button>
      </div>

      <div class="grid grid-cols-1 sm:grid-cols-2 gap-3">
        <button id="doBackupNow" class="tap px-4 py-3 rounded-2xl bg-emerald-600 hover:bg-emerald-700 text-white font-semibold">
          Crear backup ahora
        </button>

        <div class="text-xs text-slate-500 sm:text-right self-center">
          M√°ximo ${MANUAL_BACKUPS_MAX} backups en este dispositivo
        </div>
      </div>

      <!-- Acorde√≥n: Backups (local) ‚Äî cerrado por defecto -->
      <div class="mt-4 bg-white border border-slate-200 rounded-3xl overflow-hidden">
        <button data-acc="modalBackups" class="w-full tap flex items-center justify-between px-4 py-4">
          <div class="flex items-center gap-3">
            <span class="inline-flex w-9 h-9 rounded-2xl bg-emerald-50 items-center justify-center">üõ°Ô∏è</span>
            <div class="text-left">
              <div class="font-extrabold">Backups (local)</div>
</div>
          </div>
          <span class="accIcon text-slate-400 text-xl">‚ñæ</span>
        </button>
        <div data-acc-body="modalBackups" class="px-4 pb-4 hidden">
          <div id="manualBackupList" class="space-y-2 max-h-[40vh] overflow-y-auto pr-1 overscroll-contain ios-scroll"></div>
        </div>
      </div>
    </div>
  `;

  showModal("Guardar / Cargar", html, []);

  setTimeout(() => {
    const refresh = () => {
      const meta = getMeta();
      const lastSync = meta.lastSyncAt ? new Date(meta.lastSyncAt).toLocaleString() : "Nunca";
      const fromDev = meta.lastSyncedFromDevice ? ` ‚Ä¢ desde ${meta.lastSyncedFromDevice}` : "";
      const lastExport = meta.lastSavedAt ? new Date(meta.lastSavedAt).toLocaleString() : "‚Äî";
      const dev = getDeviceName(false);
      const el = $("syncStatus");
      if (el) {
        const ro = (localStorage.getItem("miviaje.readonly") === "1") ? "ON" : "OFF";
        const exp = meta.lastExportAt || meta.lastSavedAt || null;
        const imp = meta.lastImportAt || meta.lastSyncAt || null;
        const expS = exp ? new Date(exp).toLocaleString() : "Nunca";
        const impS = imp ? new Date(imp).toLocaleString() : "Nunca";
        el.innerHTML = `
          <div class="px-3 py-2 rounded-xl border border-slate-200 bg-slate-50">
            <div class="text-[12px] leading-4 text-slate-700">
              <div class="flex flex-wrap gap-x-3 gap-y-1">
                <span><b>Dispositivo:</b> ${escapeHtml(dev)}</span>
                <span><b>Lectura:</b> ${escapeHtml(ro)}</span>
              </div>
              <div class="flex flex-wrap gap-x-3 gap-y-1 mt-1">
                <span><b>√ölt. export:</b> ${escapeHtml(expS)}</span>
                <span><b>√ölt. import:</b> ${escapeHtml(impS)}${fromDev ? escapeHtml(fromDev) : ""}</span>
              </div>
              ${imp ? ('<div class="mt-1 text-[12px] leading-4 text-slate-600"><b>√öltimo import:</b> ' + escapeHtml(impS) + ((meta.lastImportFromDeviceName || meta.lastSyncedFromDevice) ? (' (origen: ' + escapeHtml(meta.lastImportFromDeviceName || meta.lastSyncedFromDevice) + ')') : '') + '</div>') : ''}
            </div>
          </div>
        `;
      }
      const b = getLatestManualBackup() || getLatestBackup();
      const rb = $("restoreBackup");
      if (rb) {
        rb.disabled = !b;
        rb.classList.toggle("opacity-40", !b);
      }
    };

    $("doExport").onclick = () => { exportTrip(); refresh(); };
    $("doExportMilestone").onclick = () => { exportMilestone(); refresh(); };
    $("doImport").onchange = async (ev) => { await importTrip(ev); refresh(); };

// Trip name input: show custom name if set, otherwise keep empty (auto will use destination)
const tn = $("tripNameInput");
if (tn) {
  const mode = (typeof getTripNameMode === "function") ? getTripNameMode() : (localStorage.getItem("miviaje.tripNameMode") || "auto");
  const saved = (typeof getTripName === "function") ? getTripName() : String(localStorage.getItem("miviaje.tripName") || "").trim();
  tn.value = (mode === "custom" && saved) ? saved : "";
  tn.addEventListener("input", () => {
    const v = String(tn.value || "").trim();
    if (typeof setTripName === "function") setTripName(v);
    else localStorage.setItem("miviaje.tripName", v);
    if (typeof setTripNameMode === "function") setTripNameMode(v ? "custom" : "auto");
    else localStorage.setItem("miviaje.tripNameMode", v ? "custom" : "auto");
  }, { passive: true });
}


    const bn = $("doBackupNow");
    if (bn) {
      bn.onclick = () => {
        const entry = createManualBackupEntry();
        if (entry) {
          renderManualBackupList();
          alert("Backup creado.");
        }
      };
    }

    $("restoreBackup").onclick = () => {
      const b = getLatestManualBackup() || getLatestBackup();
      if (!b) return alert("No hay backups todav√≠a.");
      const label = b.savedAt ? new Date(b.savedAt).toLocaleString() : "(sin fecha)";
      if (!confirm(`¬øRestaurar el √∫ltimo backup?
${label}`)) return;
      state = b.state;
      saveState();
      closeModal();
      renderAll();
  syncStickyTotalsHeightVar();
  alert("Backup restaurado.");
    };

    $("setDeviceName").onclick = () => {
      const v = prompt("Nombre de este iPhone:", (localStorage.getItem(DEVICE_KEY) || "").trim());
      if (v && v.trim()) {
        try { localStorage.setItem("miviaje.deviceName", v.trim()); } catch {}
        try { localStorage.setItem(DEVICE_KEY, v.trim()); } catch {}
        try { setMeta({ deviceName: v.trim() }); } catch {}
      }
      refresh();
    };

    const search = $("tripSearchInput");
    if (search) {
      search.value = "";
      search.oninput = () => renderTripList(search.value);
    }
    renderManualBackupList();
    renderTripList("");
    refresh();

    // Acorde√≥n scoped al modal
    const root = $("modalBody");
    if (root) {
      root.querySelectorAll("[data-acc]").forEach(btn => {
        btn.addEventListener("click", () => {
          const key = btn.getAttribute("data-acc");
          const body = root.querySelector(`[data-acc-body="${key}"]`);
          if (!body) return;
          body.classList.toggle("hidden");
          const icon = btn.querySelector(".accIcon");
          if (icon) icon.textContent = body.classList.contains("hidden") ? "‚ñæ" : "‚ñ¥";
        });
      });
    }
  }, 0);
}

function exportTrip() {
  // 1) Resolver sugerencia base
  const inputEl = document.getElementById("tripNameInput");
  const nameFromInput = inputEl ? String(inputEl.value || "").trim() : "";
  const nameFromLS = (typeof getTripName === "function")
    ? String(getTripName() || "").trim()
    : String(localStorage.getItem("miviaje.tripName") || "").trim();

  const mode = (typeof getTripNameMode === "function") ? getTripNameMode() : "auto";
  const autoName = (typeof computeAutoTripName === "function") ? computeAutoTripName() : "MI_VIAJE";

  // Si el modo es auto, preferimos el destino actual; si es custom, preferimos el nombre guardado
  let baseName = nameFromInput || (mode === "custom" ? (nameFromLS || autoName) : autoName) || "MI_VIAJE";

  // 2) Pedir/confirmar nombre (siempre)
  const entered = prompt("Nombre para este viaje (ej: Jap√≥n 2026):", baseName);
  if (entered === null) return;

  const raw = String(entered || "").trim();

  // 3) Determinar nombre final + modo
  let finalName = raw;
  if (!finalName) {
    // vac√≠o => auto (recalcular)
    finalName = autoName || "MI_VIAJE";
    try { localStorage.setItem("miviaje.tripNameMode", "auto"); } catch {}
  } else {
    // Si el usuario deja el sugerido autom√°tico, lo tratamos como auto; si lo cambia, custom
    const shouldBeAuto = (finalName === autoName);
    try { localStorage.setItem("miviaje.tripNameMode", shouldBeAuto ? "auto" : "custom"); } catch {}
  }

  // Persistir nombre y reflejar en input
  try { localStorage.setItem("miviaje.tripName", finalName); } catch {}
  if (inputEl) inputEl.value = finalName;

  // 4) Export payload + filename
  const payload = { name: finalName, savedAt: new Date().toISOString(), state };

  // Identidad de dispositivo
  payload.deviceName = getDeviceName();

// Sync meta (for multi-device safety)
try {
  setMeta({
    deviceName: getDeviceName(),
    lastExportAt: payload.savedAt,
    lastSavedAt: payload.savedAt
  });
} catch {}


  const list = JSON.parse(localStorage.getItem("miviaje.trip.list") || "[]");
  list.unshift(payload);
  localStorage.setItem("miviaje.trip.list", JSON.stringify(list.slice(0, 30)));

  const base = (typeof sanitizeFileBaseName === "function")
    ? sanitizeFileBaseName(finalName)
    : (finalName.replace(/\s+/g, "_").replace(/[^A-Za-z0-9_-]/g, "") || "MI_VIAJE");
  const date = (typeof yyyyMmDdToday === "function") ? yyyyMmDdToday() : new Date().toISOString().slice(0, 10);
  const filename = `${base}_${date}.json`;
  // --- Share Sheet (iOS) + fallback download (SIN async/await) ---
  const blob = new Blob([JSON.stringify(payload, null, 2)], { type: "application/json" });

  function doDownload() {
    const a = document.createElement("a");
    a.href = URL.createObjectURL(blob);
    a.download = filename;
    a.click();
    URL.revokeObjectURL(a.href);
  }

  try {
    if (navigator.canShare && navigator.share) {
      const file = new File([blob], filename, { type: "application/json" });
      const can = (typeof navigator.canShare === "function")
        ? navigator.canShare({ files: [file] })
        : true;

      if (can) {
        Promise.resolve(
          navigator.share({
            files: [file],
            title: payload?.name || "Mi Viaje",
            text: "Viaje exportado desde Mi Viaje"
          })
        ).catch(() => {
          // Cancelaci√≥n o error ‚Üí fallback a download
          doDownload();
        });
      } else {
        doDownload();
      }
    } else {
      doDownload();
    }
  } catch {
    doDownload();
  }
  // --- FIN ---

  renderTripList();
}

function exportMilestone() {
  // Igual que exportTrip(), pero guarda un "HITO" con timestamp y marca milestone=true.
  const inputEl = document.getElementById("tripNameInput");
  const nameFromInput = inputEl ? String(inputEl.value || "").trim() : "";
  const nameFromLS = (typeof getTripName === "function")
    ? String(getTripName() || "").trim()
    : String(localStorage.getItem("miviaje.tripName") || "").trim();

  const mode = (typeof getTripNameMode === "function") ? getTripNameMode() : "auto";
  const autoName = (typeof computeAutoTripName === "function") ? computeAutoTripName() : "MI_VIAJE";

  let baseName = nameFromInput || (mode === "custom" ? (nameFromLS || autoName) : autoName) || "MI_VIAJE";

  const entered = prompt("Nombre para este HITO (ej: Jap√≥n 2026):", baseName);
  if (entered === null) return;

  const raw = String(entered || "").trim();

  let finalName = raw;
  if (!finalName) {
    finalName = autoName || "MI_VIAJE";
    try { localStorage.setItem("miviaje.tripNameMode", "auto"); } catch {}
  } else {
    const shouldBeAuto = (finalName === autoName);
    try { localStorage.setItem("miviaje.tripNameMode", shouldBeAuto ? "auto" : "custom"); } catch {}
  }

  try { localStorage.setItem("miviaje.tripName", finalName); } catch {}
  if (inputEl) inputEl.value = finalName;

  const payload = { name: finalName, savedAt: new Date().toISOString(), state, milestone: true };

  // Identidad de dispositivo
  payload.deviceName = getDeviceName();

  // Meta: igual que export normal (+ lastMilestoneAt)
  try {
    setMeta({
      deviceName: getDeviceName(),
      lastExportAt: payload.savedAt,
      lastSavedAt: payload.savedAt,
      lastMilestoneAt: payload.savedAt
    });
  } catch {}

  // Guardar en lista local (si existe)
  try {
    const list = JSON.parse(localStorage.getItem("miviaje.trip.list") || "[]");
    list.unshift(payload);
    localStorage.setItem("miviaje.trip.list", JSON.stringify(list.slice(0, 30)));
  } catch {}

  const safe = (typeof sanitizeFileBaseName === "function")
    ? sanitizeFileBaseName(finalName)
    : (finalName.replace(/\s+/g, "_").replace(/[^A-Za-z0-9_-]/g, "") || "MI_VIAJE");

  const d = new Date();
  const pad2 = (n) => String(n).padStart(2, "0");
  const ymd = `${d.getFullYear()}-${pad2(d.getMonth() + 1)}-${pad2(d.getDate())}`;
  const hm = `${pad2(d.getHours())}-${pad2(d.getMinutes())}`;
  const filename = `HITO_${safe}_${ymd}_${hm}.json`;
  // --- Share Sheet (iOS) + fallback download (SIN async/await) ---
  const blob = new Blob([JSON.stringify(payload, null, 2)], { type: "application/json" });

  function doDownload() {
    const a = document.createElement("a");
    a.href = URL.createObjectURL(blob);
    a.download = filename;
    a.click();
    URL.revokeObjectURL(a.href);
  }

  try {
    if (navigator.canShare && navigator.share) {
      const file = new File([blob], filename, { type: "application/json" });
      const can = (typeof navigator.canShare === "function")
        ? navigator.canShare({ files: [file] })
        : true;

      if (can) {
        Promise.resolve(
          navigator.share({
            files: [file],
            title: payload?.name || "Mi Viaje",
            text: "Viaje exportado desde Mi Viaje"
          })
        ).catch(() => {
          // Cancelaci√≥n o error ‚Üí fallback a download
          doDownload();
        });
      } else {
        doDownload();
      }
    } else {
      doDownload();
    }
  } catch {
    doDownload();
  }
  // --- FIN ---

  renderTripList();
}


async function importTrip(ev) {
  const input = ev?.target;
  const file = input?.files?.[0];
  if (!file) return;

  const readAsText = (f) => new Promise((resolve, reject) => {
    try{
      const fr = new FileReader();
      fr.onload = () => resolve(String(fr.result || ""));
      fr.onerror = () => reject(new Error("No se pudo leer el archivo"));
      fr.readAsText(f);
    }catch(err){ reject(err); }
  });

  const normalizeImport = (data) => {
    // Accept: {state:{scenarios:{A,B}}}, {state:<scenario>}, <scenario>
    let src = null;

    // unwrap common envelopes
    if (data && typeof data === "object") {
      if (data.state && typeof data.state === "object") {
        if (data.state.scenarios && typeof data.state.scenarios === "object") {
          // Prefer scenario that matches current active scenario, fallback to A/B
          const key = (state && (state.scenario === "B")) ? "B" : "A";
          src = data.state.scenarios[key] || data.state.scenarios.A || data.state.scenarios.B || null;
        } else {
          src = data.state;
        }
      } else if (data.scenarios && typeof data.scenarios === "object") {
        const key = (state && (state.scenario === "B")) ? "B" : "A";
        src = data.scenarios[key] || data.scenarios.A || data.scenarios.B || null;
      } else {
        src = data;
      }
    }

    if (!src || typeof src !== "object") throw new Error("Formato incorrecto (sin datos de viaje)");

    // Map legacy keys
    const mapped = { ...src };
    if (!mapped.activities && Array.isArray(mapped.acts)) mapped.activities = mapped.acts;

    // Ensure minimum structure
    const normalized = { ...emptyScenario(), ...mapped };

    if (!Array.isArray(normalized.legs)) normalized.legs = [];
    if (!Array.isArray(normalized.stays)) normalized.stays = [];
    if (!Array.isArray(normalized.activities)) normalized.activities = [];
    if (!normalized.meals || typeof normalized.meals !== "object") normalized.meals = { daily: 0, people: "", days: "" };
    normalized.meals = {
      daily: normalized.meals.daily ?? 0,
      people: normalized.meals.people ?? "",
      days: normalized.meals.days ?? ""
    };
    if (!normalized.dailyNotes || typeof normalized.dailyNotes !== "object") normalized.dailyNotes = {};

    const ensureId = (it) => {
      if (!it || typeof it !== "object") return it;
      if (!it.id) it.id = nowId();
      return it;
    };
    normalized.legs = normalized.legs.map(ensureId);
    normalized.stays = normalized.stays.map(ensureId);
    normalized.activities = normalized.activities.map(ensureId);

    return normalized;
  };

  try {
    const txt = await readAsText(file);
    const payload = JSON.parse(txt);

    // Optional: import trip name if present
    if (payload && typeof payload.name === "string" && payload.name.trim()) {
      setTripName(payload.name.trim());
      const tn = $("tripNameInput");
      if (tn) tn.value = payload.name.trim();
    }

    const normalizedScenario = normalizeImport(payload);

    // Safety backup before overwrite (if available)
    try { pushBackup("before_import", { fromFileName: file.name || null }); } catch {}

    const key = (state && state.scenario === "B") ? "B" : "A";
    if (!state.scenarios || typeof state.scenarios !== "object") state.scenarios = { A: emptyScenario(), B: emptyScenario() };

    state.scenarios[key] = normalizedScenario; // <- ACTIVE scenario only
    saveState();
    closeModal();
    renderAll();
    try { syncStickyTotalsHeightVar(); } catch {}

    alert("Importado correctamente");
  } catch (e) {
    alert("Archivo no v√°lido / formato incorrecto");
  } finally {
    if (input) input.value = "";
  }
}

function renderTripList(filterText = "") {
  const box = $("tripList");
  if (!box) return;

  let list = [];
  try {
    list = JSON.parse(localStorage.getItem("miviaje.trip.list") || "[]");
    if (!Array.isArray(list)) list = [];
  } catch {
    list = [];
  }

  const q = String(filterText || "").trim().toLowerCase();

  const fmt = (iso) => {
    if (!iso) return "";
    try { return new Date(iso).toLocaleString(); } catch { return String(iso); }
  };

  const rows = list
    .map((t, idx) => ({ t, idx }))
    .filter(({ t }) => {
      if (!q) return true;
      const name = String(t?.name || "MI VIAJE").toLowerCase();
      const when = fmt(t?.savedAt).toLowerCase();
      const dev = String(t?.deviceName || "").toLowerCase();
      return name.includes(q) || when.includes(q) || dev.includes(q);
    });

  if (!rows.length) {
    box.innerHTML = `<div class="text-sm text-slate-500">No hay viajes que coincidan.</div>`;
    return;
  }

  box.innerHTML = rows.map(({ t, idx }) => `
    <div class="p-3 rounded-2xl border border-slate-200 bg-white">
      <div class="flex items-start justify-between gap-3">
        <div class="min-w-0">
          <div class="font-extrabold truncate">${escapeHtml(t.name || "MI VIAJE")}</div>
</div>
        <div class="flex flex-col items-end gap-2 shrink-0">
          <button class="tap px-3 py-2 rounded-xl bg-slate-900 text-white text-xs font-semibold" data-trip-load="${idx}">Cargar</button>
          <button class="tap text-red-600 text-xs font-semibold" data-trip-del="${idx}">Eliminar</button>
        </div>
      </div>
    </div>
  `).join("");

  box.querySelectorAll("[data-trip-load]").forEach(b => b.onclick = () => {
    const idx = parseInt(b.getAttribute("data-trip-load"), 10);
    const payload = list[idx];
    if (!payload?.state) return;

    const meta = getMeta();
    const remoteAt = payload.savedAt ? Date.parse(payload.savedAt) : NaN;
    const localAtRaw = meta.lastSavedAt || meta.lastSyncAt || "";
    const localAt = localAtRaw ? Date.parse(localAtRaw) : NaN;

    if (Number.isFinite(remoteAt) && Number.isFinite(localAt) && remoteAt < localAt) {
      const r = new Date(payload.savedAt).toLocaleString();
      const l = new Date(localAtRaw).toLocaleString();
      const who = payload.deviceName ? `
(Creado por: ${payload.deviceName})` : "";
      const ok = confirm(`Vas a cargar un viaje local M√ÅS ANTIGUO.

Viaje: ${r}${who}
Tu iPhone: ${l}

¬øQuieres continuar?`);
      if (!ok) return;
    }

    pushBackup("before_local_load", { fromSavedAt: payload.savedAt || null, fromDevice: payload.deviceName || null });

    state = payload.state;
    saveState();

    setMeta({
      lastLoadedLocalAt: new Date().toISOString(),
      lastLoadedFrom: "local_list",
      lastLoadedTripSavedAt: payload.savedAt || null
    });

    closeModal();
    renderAll();
  syncStickyTotalsHeightVar();
  });

  box.querySelectorAll("[data-trip-del]").forEach(btn => btn.onclick = () => {
    const idx = parseInt(btn.getAttribute("data-trip-del"), 10);
    const t = list[idx];
    const name = t?.name || "MI VIAJE";
    const ok = confirm(`¬øEliminar "${name}" del listado local?
(Esta acci√≥n no borra archivos descargados.)`);
    if (!ok) return;

    const next = list.filter((_, i) => i !== idx);
    localStorage.setItem("miviaje.trip.list", JSON.stringify(next));

    const search = $("tripSearchInput");
    renderTripList(search ? search.value : filterText);
  });
}


/* ----------------------------- Events ----------------------------- */
$("tabA").addEventListener("click", ()=>{ state.scenario="A"; saveState(); __sectionExpanded.legs.clear(); __sectionExpanded.stays.clear(); __sectionExpanded.activities.clear(); renderAll(); });
$("tabB").addEventListener("click", ()=>{ state.scenario="B"; saveState(); __sectionExpanded.legs.clear(); __sectionExpanded.stays.clear(); __sectionExpanded.activities.clear(); renderAll(); });

$("displayCurrency").addEventListener("change", (e)=> setDisplayCurrency(e.target.value));

$("addLeg").addEventListener("click", ()=>{
  const sc = curScenario();
  const id = nowId();
  sc.legs.unshift({ id, mode:"plane", from:"", to:"", placeOut:"", placeIn:"", date:"", time:"", arriveDate:"", arriveTime:"", cost:null, currency:(state.displayCurrency||"EUR"), tzFrom:null, tzTo:null });
  __sectionExpanded.legs.add(id);
  saveState(); renderLegs(); renderTimeline(); calcSummary();
  requestAnimationFrame(() => requestAnimationFrame(() => openEventSheet({ kind: "leg", id, mode: "edit", isNew: true })));
  scrollAccordionBodyToTop("legs");
});
$("addStay").addEventListener("click", ()=>{
  const sc = curScenario();
  const id = nowId();
  sc.stays.unshift({ id, city:"", name:"", date:"", time:"", nights:1, cost:null, currency:(state.displayCurrency||"EUR"), checkoutDate:"", checkoutTime:"" });
  __sectionExpanded.stays.add(id);
  saveState(); renderStays(); renderTimeline(); calcSummary();
  requestAnimationFrame(() => requestAnimationFrame(() => openEventSheet({ kind: "stay", id, mode: "edit", isNew: true })));
  scrollAccordionBodyToTop("stays");
});
$("addAct").addEventListener("click", ()=>{
  const sc = curScenario();
  const id = nowId();
  sc.activities.unshift({ id, title:"", city:"", date:"", time:"", duration:"", cost:null, currency:(state.displayCurrency||"EUR"), fromAI:false });
  __sectionExpanded.activities.add(id);
  saveState(); renderActivities(); renderTimeline(); calcSummary();
  requestAnimationFrame(() => requestAnimationFrame(() => openEventSheet({ kind: "act", id, mode: "edit", isNew: true })));
  scrollAccordionBodyToTop("acts");
});

["mealDaily","mealPeople","mealDays"].forEach(id=>{
  $(id).addEventListener("input", ()=>{
    const sc = curScenario();
    const rawDaily = $("mealDaily").value;
    sc.meals.daily = (String(rawDaily).trim() === "") ? null : parseMoney(rawDaily);
    if (!sc.meals.currency) sc.meals.currency = (state.displayCurrency || "EUR");
    const rawP = $("mealPeople").value;
    const rawD = $("mealDays").value;

    sc.meals.people = (String(rawP).trim() === "") ? "" : Math.max(1, parseInt(rawP || "1",10));
    sc.meals.days = (String(rawD).trim() === "") ? "" : Math.max(1, parseInt(rawD || "1",10));
    saveState(); renderMeals(); calcSummary();
  });
});

$("btnKey").addEventListener("click", ()=>{
  const cur = getGeminiKey();
  const key = prompt("Pega tu API Key de Gemini (AIza‚Ä¶):", cur ? "AIza..." : "");
  if (key && key.trim()) { setGeminiKey(key.trim()); alert("Clave guardada en este dispositivo."); }
});

$("aiPick").addEventListener("click", openAIPickModal);
$("aiGenerate").addEventListener("click", generateAIGuide);

$("btnTrips").addEventListener("click", openTripsModal);
/* -------------------------- Tools bottom sheet -------------------------- */
(function(){
  const backdrop = $("toolsBackdrop");
  const sheet = $("toolsSheet");
  const btnOpen = $("btnTools");
  const btnClose = $("toolsClose");

  function openTools(){
    if (!backdrop || !sheet) return;
    backdrop.classList.remove("hidden");
    // allow transition
    requestAnimationFrame(() => {
      backdrop.classList.add("open");
      sheet.classList.add("open");
      requestAnimationFrame(() => { try { syncTopStackHeights(); } catch {} });
    });
    // prevent background scroll (keep window locked; pause main scroll)
    const ms = document.getElementById("mainScroll");
    if (ms) ms.style.overflow = "hidden";
  }

  function closeTools(){
    if (!backdrop || !sheet) return;
    backdrop.classList.remove("open");
    sheet.classList.remove("open");
    // restore scroll after transition
    setTimeout(() => {
      backdrop.classList.add("hidden");
      document.body.style.overflow = "";
      // restore background scroll
      const ms = document.getElementById("mainScroll");
      if (ms) ms.style.overflow = "auto";
      requestAnimationFrame(() => requestAnimationFrame(() => { try { syncTopStackHeights(); } catch {} }));
    }, 280);
  }

  if (btnOpen) btnOpen.addEventListener("click", openTools);
  if (btnClose) btnClose.addEventListener("click", closeTools);
  if (backdrop) backdrop.addEventListener("click", closeTools);

  // stop tap-through
  if (sheet) sheet.addEventListener("click", (e)=>{ e.stopPropagation(); });

  const saveBtn = $("toolsSave");
  const loadBtn = $("toolsLoad");
  const resetBtn = $("toolsReset");
  const copyAtoBBtn = $("btnCopyAtoB");
  const copyBtoABtn = $("btnCopyBtoA");

  function openTripsAndFocus(targetId){
    closeTools();
    openTripsModal();
    // focus target inside modal once mounted
    setTimeout(() => {
      const el = $(targetId);
      if (el) {
        try { el.scrollIntoView({ block: "center", behavior: "smooth" }); } catch { el.scrollIntoView(); }
        try { el.focus({ preventScroll: true }); } catch {}
      }
    }, 30);
  }

  if (saveBtn) saveBtn.addEventListener("click", () => openTripsAndFocus("doExport"));
  if (loadBtn) loadBtn.addEventListener("click", () => openTripsAndFocus("doImport"));

  const __deepClone = (obj) => {
    try { return JSON.parse(JSON.stringify(obj)); } catch { return null; }
  };

  if (copyAtoBBtn) copyAtoBBtn.addEventListener("click", () => {
    closeTools();
    const ok = confirm("Esto sobrescribir√° el viaje destino. ¬øContinuar?");
    if (!ok) return;
    const src = state?.scenarios?.A || emptyScenario();
    const cloned = __deepClone(src);
    if (!cloned) { alert("No se pudo copiar (error interno)."); return; }
    state.scenarios.B = cloned;
    saveState();
    renderAll();
    try { syncStickyTotalsHeightVar(); } catch {}
  });

  if (copyBtoABtn) copyBtoABtn.addEventListener("click", () => {
    closeTools();
    const ok = confirm("Esto sobrescribir√° el viaje destino. ¬øContinuar?");
    if (!ok) return;
    const src = state?.scenarios?.B || emptyScenario();
    const cloned = __deepClone(src);
    if (!cloned) { alert("No se pudo copiar (error interno)."); return; }
    state.scenarios.A = cloned;
    saveState();
    renderAll();
    try { syncStickyTotalsHeightVar(); } catch {}
  });


  if (resetBtn) resetBtn.addEventListener("click", () => {
    closeTools();
    if (!confirm("¬øReiniciar viaje? Esto borrar√° los datos guardados en este dispositivo para este viaje.")) return;
    try { localStorage.removeItem(LS_KEY); } catch {}
    // No tocar claves/ajustes; solo el estado principal
    location.reload();
  });

  // Escape to close
  document.addEventListener("keydown", (e)=>{
    if (e.key === "Escape" && backdrop && !backdrop.classList.contains("hidden")) closeTools();
  });
})();

const __tn = $("timelineNext");
if (__tn) __tn.addEventListener("click", (e) => { e.preventDefault(); e.stopPropagation(); scrollToNextAfterCurrent(); });

const __tt = $("timelineToday");
if (__tt) __tt.addEventListener("click", (e) => { e.preventDefault(); e.stopPropagation(); scrollToCurrentTimelineItem(); });


const __ro = $("btnReadOnly");
if (__ro) __ro.addEventListener("click", () => { setReadOnly(!isReadOnly()); });
$("btnCompare").addEventListener("click", ()=>{
  const a = state.scenarios.A;
  const b = state.scenarios.B;
  const tot = (sc) => sc.legs.reduce((x,y)=>x+parseMoney(y.cost),0)
    + sc.stays.reduce((x,y)=>x+parseMoney(y.cost),0)
    + sc.activities.reduce((x,y)=>x+parseMoney(y.cost),0)
    + parseMoney(sc.meals.daily) * (parseInt(sc.meals.people||1,10)) * (parseInt(sc.meals.days||1,10));
  const ta = tot(a), tb = tot(b);
  $("compareBox").classList.remove("hidden");
  $("compareBox").innerHTML = `
    <div class="font-extrabold">Comparativa (simple)</div>
    <div class="mt-2 flex justify-between"><span>A</span><span class="font-semibold">${ta.toFixed(2)} ${escapeHtml(state.displayCurrency)}</span></div>
    <div class="flex justify-between"><span>B</span><span class="font-semibold">${tb.toFixed(2)} ${escapeHtml(state.displayCurrency)}</span></div>
    <div class="mt-2 text-sm ${ta<=tb ? "text-emerald-700" : "text-emerald-700"}">
      Mejor: <b>${ta<=tb ? "A" : "B"}</b> (${Math.abs(ta-tb).toFixed(2)} de diferencia)
    </div>
  `;
});

/* Bottom nav: switch views (v89a) */
document.querySelectorAll('[data-jump]').forEach(btn => {
  btn.addEventListener('click', () => {
    const key = btn.getAttribute('data-jump');
    if (!key) return;
    try { setView(key); } catch {}
  });
});


function syncHeaderHeightVar(){
  const hdr = document.querySelector("header");
  if (!hdr) return;
  document.documentElement.style.setProperty("--app-header-h", hdr.offsetHeight + "px");
}

/* ----------------------------- Init ----------------------------- */


function syncStickyTotalsHeightVar(){
  // v78: keep legacy callers working
  syncTopStackHeights();
}

function __tlGetTopOffsetPx(){
  const cs = getComputedStyle(document.documentElement);
  const h1 = parseFloat(cs.getPropertyValue("--app-header-h")) || 56;
  const h2 = parseFloat(cs.getPropertyValue("--sticky-totals-h")) || 0;
  return h1 + h2;
}

function rebuildTimelineControlsFixed(){ /* removed */ }


/* removed anyTimelineAccordionOpen */


function showHideTimelineControlsFixed(){ /* removed */ }


function initTimelineControlsFixedObserver(){ /* removed */ }


function __initTimelineNavBindings(){
  const g = document.getElementById("tlViewGlobal");
  const d = document.getElementById("tlViewDay");
  const today = document.getElementById("timelineToday");
  const next = document.getElementById("timelineNext");
  const prevDay = document.getElementById("tlDayPrev");
  const nextDay = document.getElementById("tlDayNext");

  if (g && !g.__bound){
    g.__bound = 1;
    g.addEventListener("click", () => { timelineViewMode = "global"; renderTimeline(); });
  }
  if (d && !d.__bound){
    d.__bound = 1;
    d.addEventListener("click", () => { timelineViewMode = "day"; activeDayISO = ""; renderTimeline(); });
  }
  if (today && !today.__bound){
    today.__bound = 1;
    today.addEventListener("click", () => { try { scrollToCurrentTimelineItem(); } catch {} });
  }
  if (next && !next.__bound){
    next.__bound = 1;
    next.addEventListener("click", () => { try { scrollToNextTimelineItem(); } catch {} });
  }
  if (prevDay && !prevDay.__bound){
    prevDay.__bound = 1;
    prevDay.addEventListener("click", () => { try { moveActiveDay(-1); } catch {} });
  }
  if (nextDay && !nextDay.__bound){
    nextDay.__bound = 1;
    nextDay.addEventListener("click", () => { try { moveActiveDay(1); } catch {} });
  }
}


window.addEventListener('DOMContentLoaded', () => {
  loadState();
  setupAccordion();
  try { __initTimelineNavBindings(); } catch {}

  syncHeaderHeightVar();
  window.addEventListener('resize', () => { syncHeaderHeightVar(); syncStickyTotalsHeightVar(); }, { passive: true });
  
    // Timeline view controls (Global / Day)
    const _tlG = document.getElementById("tlViewGlobal");
    const _tlD = document.getElementById("tlViewDay");
    if (_tlG) _tlG.onclick = (e) => { e.preventDefault(); e.stopPropagation(); setTimelineViewMode("global"); };
    if (_tlD) _tlD.onclick = (e) => { e.preventDefault(); e.stopPropagation(); setTimelineViewMode("day"); };
  
    const _tlPrev = document.getElementById("tlDayPrev");
    const _tlNext = document.getElementById("tlDayNext");
    if (_tlPrev) _tlPrev.onclick = (e) => { e.preventDefault(); e.stopPropagation(); moveActiveDay(-1); };
    if (_tlNext) _tlNext.onclick = (e) => { e.preventDefault(); e.stopPropagation(); moveActiveDay(1); };
  
  renderAll();
  try { setView('timeline'); } catch {}
  // Capture stable template for fixed timeline controls (robust against hidden/visibility changes)
  try {
    const sentinel = document.getElementById("timelineControlsSentinel");
    const originalRow = sentinel ? sentinel.nextElementSibling : null;
    if (originalRow && !window.__tlControlsTemplateHTML) {
      window.__tlControlsTemplateHTML = originalRow.outerHTML;
    } else if (!window.__tlControlsTemplateHTML) {
      const g = document.getElementById("tlViewGlobal");
      const row = g ? g.closest("div.flex.items-center.justify-between") : null;
      if (row) window.__tlControlsTemplateHTML = row.outerHTML;
    }
  } catch (e) { /* no-op */ }

  syncStickyTotalsHeightVar();
  summaryExpanded = false;
  applySummaryFold();
  

  // Sheet trash (single source of truth)
  const sheetTrash = document.getElementById("eventSheetTrash");
  if (sheetTrash && !sheetTrash.__bound) {
    sheetTrash.__bound = true;
    sheetTrash.addEventListener("click", (e) => {
      try { e.preventDefault(); e.stopPropagation(); } catch {}
      const kind = sheetTrash.dataset.kind;
      const id = sheetTrash.dataset.id;
      if (!kind || !id) return;
      if (!confirm("¬øDeseas eliminar este evento?")) return;

      const ok = deleteItemById(kind, id);
      if (!ok) { toast("No se pudo borrar (id no encontrado)"); return; }

      try { if (typeof saveState === "function") saveState(); } catch {}
      try { if (typeof closeEventSheet === "function") closeEventSheet(); } catch {}
      try { if (typeof renderAll === "function") renderAll(); } catch {}
      try { if (typeof renderTimeline === "function") renderTimeline(); } catch {}
      try { if (typeof calcSummary === "function") calcSummary(); } catch {}
    });
  }

  // Sheet save (commit button)
  const sheetSave = document.getElementById("eventSheetSave");
  if (sheetSave && !sheetSave.__bound) {
    sheetSave.__bound = true;
    sheetSave.addEventListener("click", (e) => {
      try { e.preventDefault(); e.stopPropagation(); } catch {}
      try { if (typeof saveState === "function") saveState(); } catch {}

      // Close sheet first (keeps UI consistent)
      try { if (typeof closeEventSheet === "function") closeEventSheet(); } catch {}

      // Re-render only what is needed
      try {
        if (__eventSheetCtx && __eventSheetCtx.kind === "leg") {
          if (typeof renderLegs === "function") renderLegs();
          if (typeof renderTimeline === "function") renderTimeline();
          if (typeof calcSummary === "function") calcSummary();
        } else {
          if (typeof renderAll === "function") renderAll();
        }
      } catch {}

      try {
        const fb = document.getElementById("eventSheetSaveFeedback");
        if (fb) {
          fb.classList.remove("hidden");
          setTimeout(() => fb.classList.add("hidden"), 900);
        }
      } catch {}
    });
  }

});
</script>
<button aria-label="A√±adir" class="hidden" id="fabAdd" title="A√±adir">+</button>
<!-- Event Detail Sheet (V89D) -->
<div aria-hidden="true" class="hidden" id="eventSheetOverlay">
<div aria-label="Detalle del evento" aria-modal="true" id="eventSheet" role="dialog">
<div id="eventSheetHeader">
<div class="esHeadLeft">
<div class="esTypeLine">
<span aria-hidden="true" id="eventSheetTypeIcon">üßæ</span>
<span id="eventSheetTypeLabel">Evento</span>
</div>
<div class="esSubtitle" id="eventSheetTitle">Detalle</div>
<div class="text-xs text-slate-600 mt-1" id="eventSheetSummaryLine">
<span id="sheetSummaryRoute">‚Äî</span> ¬∑ <span id="sheetSummaryTime">‚Äî</span> ¬∑ <span id="sheetSummaryCost">‚Äî</span>
</div>
</div>
<div class="esHeadRight">
<button class="esIconBtn" id="eventSheetAttach" title="Adjuntar archivo" type="button">
            üìé
          </button>
<button class="esIconBtn" id="eventSheetNotes" title="Notas del evento" type="button">
            üìù
          </button>
<button class="esIconBtn" id="eventSheetEdit" title="Editar" type="button">
            ‚úèÔ∏è
          </button>
<button aria-label="Guardar" class="tap esIconBtn" id="eventSheetSave" title="Guardar" type="button">üíæ</button>
<button aria-label="Eliminar" class="tap esIconBtn" id="eventSheetTrash">üóëÔ∏è</button>
<button aria-label="Cerrar" class="tap esIconBtn" id="eventSheetClose">‚úï</button>
</div>
</div>
<div id="eventSheetBody">
<!-- blocks injected on open -->
</div>
<div id="eventSheetFooter">
<div aria-live="polite" class="hidden" id="eventSheetSaveFeedback">Guardado ‚úì</div>
</div>
</div>
</div>
<!--
QA checklist (V89D1):
- [ ] Abrir evento desde cronograma (tap en card): abre sheet y se puede editar; cerrar restaura.
- [ ] Bot√≥n ‚Üó Ir abre sheet del evento correcto (sin cambiar vistas).
- [ ] Tap en item de Transporte/Alojamiento/Actividades abre sheet (CRUD sigue funcionando).
- [ ] Cerrar con ‚úï / tap fuera / ESC funciona y no deja overlays activos.
- [ ] Bottom nav visible; Totales no tapa el sheet; sin IDs duplicados en DOM (move-node).
- [ ] Global/D√≠a/Actual/Pr√≥ximo siguen funcionando sin errores en consola.
-->
<!-- Sheet mini overlay + modals (UI only) -->
<div class="hidden" id="sheetMiniOverlay"></div>
<div class="hidden sheetMiniModal" id="sheetAttachModal">
<div class="sheetMiniHeader">
<div class="sheetMiniTitle">Adjuntar archivo</div>
<button class="sheetMiniClose" id="sheetAttachClose" type="button">‚úï</button>
</div>
<div class="sheetMiniBody">
<p style="opacity:.8">Pr√≥xima fase: aqu√≠ ir√° selecci√≥n de archivo (PDF, imagen, etc.).</p>
</div>
</div>
<div class="hidden sheetMiniModal" id="sheetNotesModal">
<div class="sheetMiniHeader">
<div class="sheetMiniTitle">Notas del evento</div>
<button class="sheetMiniClose" id="sheetNotesClose" type="button">‚úï</button>
</div>
<div class="sheetMiniBody">
<textarea id="sheetNotesDraft" placeholder="Escribe una nota‚Ä¶ (no se guarda a√∫n)" style="width:100%;min-height:120px;"></textarea>
<p style="opacity:.6;font-size:12px;margin-top:8px;">(Fase actual: UI solamente, sin persistencia)</p>
</div>
</div>
<script>
(function(){
  function $(id){ return document.getElementById(id); }

  function openSheetMiniModal(which){
    var overlay = $("sheetMiniOverlay");
    var attach  = $("sheetAttachModal");
    var notes   = $("sheetNotesModal");
    if(!overlay || !attach || !notes) return;

    
    try{ document.body.classList.add("mini-open"); }catch(e){}
overlay.classList.remove("hidden");
    attach.classList.add("hidden");
    notes.classList.add("hidden");

    if(which === "attach") attach.classList.remove("hidden");
    if(which === "notes") notes.classList.remove("hidden");
  }

  function closeSheetMiniModals(){
    var overlay = $("sheetMiniOverlay");
    var attach  = $("sheetAttachModal");
    var notes   = $("sheetNotesModal");
    if(overlay) overlay.classList.add("hidden");
    if(attach) attach.classList.add("hidden");
    if(notes)  notes.classList.add("hidden");
  
    try{ document.body.classList.remove("mini-open"); }catch(e){}
  }

  // Bindings with guards
  document.addEventListener("DOMContentLoaded", function(){
    var btnAttach = $("eventSheetAttach");
    var btnNotes  = $("eventSheetNotes");
    var ov        = $("sheetMiniOverlay");
    var cAttach   = $("sheetAttachClose");
    var cNotes    = $("sheetNotesClose");

    if(btnAttach) btnAttach.addEventListener("click", function(){ openSheetMiniModal("attach"); });
    if(btnNotes)  btnNotes.addEventListener("click", function(){ openSheetMiniModal("notes");  });

    if(ov)      ov.addEventListener("click", closeSheetMiniModals);
    if(cAttach) cAttach.addEventListener("click", closeSheetMiniModals);
    if(cNotes)  cNotes.addEventListener("click", closeSheetMiniModals);
  });

  // Expose helpers (optional, non-invasive)
  window.openSheetMiniModal = openSheetMiniModal;
  window.closeSheetMiniModals = closeSheetMiniModals;
})();
</script>
<script>
document.addEventListener("DOMContentLoaded", () => {
  try { document.body.dataset.view = activeView || ""; } catch {}
  try { updateSubSectionHeader(activeView); } catch {}
});

/* ---------------- DateJumpUI (optional, manual only) ----------------
   Baseline: V97_HYGIENE (no auto-jumps on section entry)
   This module only updates UI on view change and jumps when user interacts.
--------------------------------------------------------------------- */
(function(){
  const SUPPORTED = new Set(["timeline","legs","stays","acts"]);
  const VIEW_ID = { timeline:"view-timeline", legs:"view-legs", stays:"view-stays", acts:"view-acts" };

  function $(id){ return document.getElementById(id); }

  function getMainScroll(){
    return document.getElementById("mainScroll") || document.scrollingElement || document.documentElement;
  }

  function getActiveViewName(fallback){
    try{
      const v = (document.body && document.body.dataset && document.body.dataset.view) ? document.body.dataset.view : "";
      return v || fallback || "";
    }catch(_){ return fallback || ""; }
  }

  function getViewEl(viewName){
    const id = VIEW_ID[String(viewName||"")] || "";
    return id ? document.getElementById(id) : null;
  }

  function collectDates(viewName){
    const viewEl = getViewEl(viewName);
    if (!viewEl) return [];
    const seps = Array.from(viewEl.querySelectorAll("[data-date-sep]"));
    const keys = [];
    for (const el of seps){
      const k = String(el.getAttribute("data-date-sep") || "").trim();
      if (k && /^\d{4}-\d{2}-\d{2}$/.test(k)) keys.push(k);
    }
    // unique + sort
    return Array.from(new Set(keys)).sort();
  }

  function todayYMD(){
    const d = new Date();
    const y = d.getFullYear();
    const m = String(d.getMonth()+1).padStart(2,"0");
    const day = String(d.getDate()).padStart(2,"0");
    return `${y}-${m}-${day}`;
  }

  function chooseRelevant(dates){
    if (!dates || !dates.length) return "";
    const ds = Array.from(dates).filter(Boolean).map(String).sort();
    if (!ds.length) return "";
    const t = todayYMD();
    if (ds.includes(t)) return t;
    const future = ds.find(x => x > t);
    return future || ds[0];
  }

  function forceSubHeaderHeightVar(){
    const sub = document.getElementById("subSectionHeader");
    if (!sub) return 0;
    const h = sub.getBoundingClientRect().height || 0;
    try{ document.documentElement.style.setProperty("--subsection-header-h", h + "px"); }catch(_){}
    return h;
  }

  function fixedHeaderBottomY(){
    // Bottom Y (viewport coords) of the fixed subsection header (includes dateJumpUI when visible)
    const sub = document.getElementById("subSectionHeader");
    if (!sub) return 0;
    return sub.getBoundingClientRect().bottom || 0;
  }

  
  function ensureTailSpacer(viewName, px){
    const viewEl = getViewEl(viewName);
    if (!viewEl) return;
    let sp = viewEl.querySelector('[data-dj-tail="1"]');
    if (!sp){
      sp = document.createElement("div");
      sp.setAttribute("data-dj-tail","1");
      sp.setAttribute("aria-hidden","true");
      sp.style.height = "0px";
      sp.style.pointerEvents = "none";
      sp.style.width = "100%";
      viewEl.appendChild(sp);
    }
    const h = Math.max(0, Math.ceil(px || 0));
    sp.style.height = h + "px";
  }

function scrollToDateSep(viewName, iso){
    const viewEl = getViewEl(viewName);
    if (!viewEl) return false;
    const sep = viewEl.querySelector(`[data-date-sep="${iso}"]`);
    if (!sep) return false;

    const sc = getMainScroll();

    const attemptJump = (triesLeft) => {
      // Ensure CSS vars reflect final fixed header height (dateJumpUI can change it).
      try{ if (typeof syncTopStackHeights === "function") syncTopStackHeights(); }catch(_){}
      forceSubHeaderHeightVar();

      const subBottom = fixedHeaderBottomY();

      // Compute stable target scrollTop using DOM offsets (avoids rect timing drift).
      let y = 0;
      let node = sep;
      while (node && node !== sc && node.offsetParent) {
        y += node.offsetTop || 0;
        node = node.offsetParent;
      }
      // If we didn't reach sc (different offset context), fall back to rect math.
      if (node !== sc) {
        const sepRect = sep.getBoundingClientRect();
        y = (sc.scrollTop || 0) + (sepRect.top || 0);
      }

      const desired = Math.max(0, y - (subBottom + 1));

      // Case l√≠mite (√∫ltima fecha): asegurar recorrido final suficiente SOLO en Transporte.
      if (String(viewName) === "legs"){
        const seps = viewEl.querySelectorAll("[data-date-sep]");
        const lastIso = seps && seps.length ? seps[seps.length - 1].getAttribute("data-date-sep") : null;
        if (lastIso && String(lastIso) === String(iso)){
          // Necesario extra = desired - maxScrollTop (si > 0). A√±adimos tail spacer solo lo justo.
          const maxNow = Math.max(0, (sc.scrollHeight || 0) - (sc.clientHeight || 0));
          const needExtra = Math.max(0, Math.ceil(desired - maxNow) + 12);
          if (needExtra > 0){
            const existing = viewEl.querySelector('[data-dj-tail="1"]');
            const curH = existing ? (parseInt(existing.style.height || "0", 10) || 0) : 0;
            ensureTailSpacer(viewName, Math.max(curH, needExtra));
          }
        } else {
          // Spacer base suficiente para saltos normales.
          ensureTailSpacer(viewName, subBottom + 24);
        }
      } else {
        // Spacer base para el resto de vistas.
        ensureTailSpacer(viewName, subBottom + 24);
      }

      sc.scrollTo({ top: desired, behavior: "auto" });

      // Verify alignment; if layout not settled yet (e.g., spacer just applied), retry next frame.
      requestAnimationFrame(() => {
        const nowRect = sep.getBoundingClientRect();
        const nowDelta = nowRect.top - (fixedHeaderBottomY() + 1);
        if (Math.abs(nowDelta) <= 2) return; // good
        if (triesLeft > 0) attemptJump(triesLeft - 1);
      });
    };

    // 2-frame start to let DOM/styles settle after select change.
    requestAnimationFrame(() => requestAnimationFrame(() => attemptJump(4)));
    return true;
  }

  function setOptions(selectEl, dates){
    selectEl.innerHTML = "";
    for (const iso of dates){
      const opt = document.createElement("option");
      opt.value = iso;
      // Prefer existing formatter if available
      try{
        opt.textContent = (typeof __fmtDateES === "function") ? __fmtDateES(iso) : iso;
      }catch(_){
        opt.textContent = iso;
      }
      selectEl.appendChild(opt);
    }
  }

  function refresh(viewName){
    const bar = $("dateJumpUI");
    const sel = $("dateJumpSelect");
    const btn = $("dateJumpNowBtn");
    if (!bar || !sel || !btn) return;

    const v = String(viewName || getActiveViewName("") || "");
    if (!SUPPORTED.has(v)){
      bar.classList.add("hidden");
      btn.classList.add("hidden");
      try{ if (typeof scheduleSyncTopStackHeights==="function") scheduleSyncTopStackHeights(); else if (typeof syncTopStackHeights==="function") syncTopStackHeights(); }catch(_){ }
      try{ forceSubHeaderHeightVar(); }catch(_){ }
      return;
    }

    const dates = collectDates(v);
    if (!dates.length){
      bar.classList.add("hidden");
      btn.classList.add("hidden");
      try{ if (typeof scheduleSyncTopStackHeights==="function") scheduleSyncTopStackHeights(); else if (typeof syncTopStackHeights==="function") syncTopStackHeights(); }catch(_){ }
      try{ forceSubHeaderHeightVar(); }catch(_){ }
      return;
    }

    // show + populate
    bar.classList.remove("hidden");
    btn.classList.remove("hidden");
    setOptions(sel, dates);

    // Header height changes when dateJumpUI becomes visible (inside subSectionHeader).
    // Make --subsection-header-h the single source of truth for padding/offset.
    try{ if (typeof syncTopStackHeights==="function") syncTopStackHeights(); }catch(_){}
    forceSubHeaderHeightVar();
    // Re-sync in the next frames to catch late layout (Safari/iOS)
    requestAnimationFrame(() => {
      try{ if (typeof syncTopStackHeights==="function") syncTopStackHeights(); }catch(_){}
      forceSubHeaderHeightVar();
      requestAnimationFrame(() => {
        try{ if (typeof syncTopStackHeights==="function") syncTopStackHeights(); }catch(_){}
        forceSubHeaderHeightVar();
      });
    });

// default selected = relevant (but DO NOT auto scroll)
    const rel = chooseRelevant(dates);
    if (rel) sel.value = rel;

    // label button "Hoy" always (manual jump to relevant)
    btn.textContent = "Hoy";
  }

  function bindOnce(){
    const sel = $("dateJumpSelect");
    const btn = $("dateJumpNowBtn");
    if (!sel || !btn) return;

    if (sel.__dj_bound) return;
    sel.__dj_bound = true;

    sel.addEventListener("change", () => {
      const v = getActiveViewName("");
      const iso = sel.value || "";
      if (!iso) return;
      scrollToDateSep(v, iso);
    }, { passive:true });

    btn.addEventListener("click", () => {
      const v = getActiveViewName("");
      const dates = collectDates(v);
      const rel = chooseRelevant(dates);
      if (!rel) return;
      sel.value = rel;
      scrollToDateSep(v, rel);
    }, { passive:true });
  }

  // Patch setView safely WITHOUT changing its internals.
  function patchSetView(){
    const orig = window.setView;
    if (typeof orig !== "function" || orig.__dj_patched) return;

    function autoJumpRelevant(viewName){
      const v = String(viewName || getActiveViewName("") || "");
      if (!SUPPORTED.has(v)) return;

      // Ensure UI is visible + options are populated first
      try{ refresh(v); }catch(_){}

      const sel = $("dateJumpSelect");
      if (!sel) return;

      // Wait for DOM/layout to be ready (separators + header height), then jump.
      requestAnimationFrame(() => {
        requestAnimationFrame(() => {
          // If user already switched again, abort
          if (String(getActiveViewName("") || "") !== v) return;

          // Sync fixed header height (subSectionHeader includes dateJumpUI)
          try{ if (typeof syncTopStackHeights==="function") syncTopStackHeights(); }catch(_){}
          try{ forceSubHeaderHeightVar(); }catch(_){}

          const dates = collectDates(v);
          const rel = chooseRelevant(dates);
          if (!rel) return;

          // Select + jump to the date separator using the same robust path as manual actions.
          sel.value = rel;
          scrollToDateSep(v, rel);
        });
      });
    }

    function wrapped(viewName){
      orig.call(this, viewName);
      // Update UI and auto-jump to relevant date on every entry to supported sections.
      autoJumpRelevant(viewName);
    }
    wrapped.__dj_patched = true;
    window.setView = wrapped;

    // Expose for debugging (optional, no side-effects)
    window.__djAutoJumpRelevant = autoJumpRelevant;
  }

  document.addEventListener("DOMContentLoaded", () => {
    bindOnce();
    patchSetView();
    // Initial paint + initial auto-jump for the initial view (typically timeline).
    const v0 = getActiveViewName("timeline");
    try{ refresh(v0); }catch(_){}
    try{ if (typeof window.__djAutoJumpRelevant === "function") window.__djAutoJumpRelevant(v0); }catch(_){}
  });
})();


/* =========================
   Transport places datasets (ONLY for placeOut/placeIn)
   - Cities autocomplete untouched.
========================= */
const TRAIN_PLACES = [
  {name:"Madrid-Puerta de Atocha", city:"Madrid"},
  {name:"Madrid-Chamart√≠n", city:"Madrid"},
  {name:"Barcelona-Sants", city:"Barcelona"},
  {name:"Valencia Joaqu√≠n Sorolla", city:"Valencia"},
  {name:"Sevilla-Santa Justa", city:"Sevilla"},
  {name:"M√°laga-Mar√≠a Zambrano", city:"M√°laga"},
  {name:"Zaragoza-Delicias", city:"Zaragoza"},
  {name:"Alicante-Terminal", city:"Alicante"},
  {name:"C√≥rdoba Central", city:"C√≥rdoba"},
  {name:"Granada", city:"Granada"}
];

const BUS_PLACES = [
  {name:"Estaci√≥n Sur de Autobuses (M√©ndez √Ålvaro)", city:"Madrid"},
  {name:"Intercambiador de Avenida de Am√©rica", city:"Madrid"},
  {name:"Estaci√≥ del Nord (Autobuses)", city:"Barcelona"},
  {name:"Estaci√≥n de Autobuses de Valencia", city:"Valencia"},
  {name:"Estaci√≥n de Autobuses Plaza de Armas", city:"Sevilla"},
  {name:"Estaci√≥n de Autobuses de M√°laga", city:"M√°laga"},
  {name:"Estaci√≥n de Autobuses de Bilbao", city:"Bilbao"},
  {name:"Estaci√≥n de Autobuses de San Sebasti√°n", city:"San Sebasti√°n"}
];

const BOAT_PLACES = [
  {name:"Puerto de Barcelona", city:"Barcelona"},
  {name:"Puerto de Valencia", city:"Valencia"},
  {name:"Puerto de Palma", city:"Palma"},
  {name:"Puerto de Ibiza", city:"Ibiza"},
  {name:"Puerto de M√°laga", city:"M√°laga"},
  {name:"Puerto de C√°diz", city:"C√°diz"},
  {name:"Puerto de Las Palmas", city:"Las Palmas"},
  {name:"Puerto de Santa Cruz de Tenerife", city:"Santa Cruz de Tenerife"}
];

function __airportPlaceProvider(q){
  // provider for placeOut/placeIn in flight mode
  const qq = String(q||"").trim().toLowerCase();
  const out = [];
  const push = (a)=> out.push({
    kind:"flight",
    iata: a.iata,
    label: `${a.iata} ‚Äî ${a.name} (${a.city})`,
    value: `${a.iata} ¬∑ ${a.name}`,
    city: a.city
  });

  if(!qq){
    for(const a of AIRPORTS){ push(a); if(out.length>=8) break; }
    return out;
  }

  // prioritize IATA prefix 1-3 letters
  for(const a of AIRPORTS){
    if(out.length>=8) break;
    const code = String(a.iata||"").toLowerCase();
    if(code.startsWith(qq)) push(a);
  }
  // then name/city contains
  if(out.length<8){
    for(const a of AIRPORTS){
      if(out.length>=8) break;
      const s = (a.iata+" "+a.name+" "+a.city).toLowerCase();
      if(!String(a.iata||"").toLowerCase().startsWith(qq) && s.includes(qq)) push(a);
    }
  }
  return out.slice(0,8);
}

function __genericPlaceProvider(q, db){
  const qq = String(q||"").trim().toLowerCase();
  const out = [];
  const push = (p)=> out.push({
    kind:"place",
    label: `${p.name}${p.city ? " ("+p.city+")" : ""}`,
    value: p.name,
    city: p.city || ""
  });

  if(!qq){
    for(const p of db){ push(p); if(out.length>=8) break; }
    return out;
  }

  for(const p of db){
    if(out.length>=8) break;
    const s = (p.name+" "+(p.city||"")).toLowerCase();
    if(s.startsWith(qq)) push(p);
  }
  if(out.length<8){
    for(const p of db){
      if(out.length>=8) break;
      const s = (p.name+" "+(p.city||"")).toLowerCase();
      if(!s.startsWith(qq) && s.includes(qq)) push(p);
    }
  }
  return out.slice(0,8);
}

function __placeProviderByMode(modeKey, q){
  const m = String(modeKey||"flight").toLowerCase();
  if(m==="flight") return __airportPlaceProvider(q);
  if(m==="train") return __genericPlaceProvider(q, TRAIN_PLACES);
  if(m==="bus") return __genericPlaceProvider(q, BUS_PLACES);
  if(m==="boat") return __genericPlaceProvider(q, BOAT_PLACES);
  // car/other: keep field free (no menu)
  return [];
}

</script>
</body>
</html>
