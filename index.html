<!DOCTYPE html>

<html lang="es">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1, viewport-fit=cover" name="viewport"/>
<title>MI VIAJE</title>
<meta content="#1d4ed8" name="theme-color"/>
<link href="manifest.json" rel="manifest"/>
<script src="https://cdn.tailwindcss.com"></script>
<style>
    /* iPhone safe-area helpers */
    .safe-b { padding-bottom: max(env(safe-area-inset-bottom), 16px); }
    .safe-t { padding-top: max(env(safe-area-inset-top), 12px); }
    .tap { -webkit-tap-highlight-color: transparent; }
  
    /* Read-only mode */
    body.readonly-mode button[disabled],
    body.readonly-mode input[disabled],
    body.readonly-mode select[disabled],
    body.readonly-mode textarea[disabled]{
      opacity: .55;
  cursor: not-allowed;
}

/* Hard lock: prevent iOS date/time pickers even if something re-enables controls */
body.readonly-mode input:not([type="file"]),
body.readonly-mode select,
body.readonly-mode textarea{
  pointer-events: none;
  -webkit-user-select: none;
  user-select: none;
}


  /* Timeline highlighting */
  .timelineItem.past { opacity: 0.45; }
  .timelineItem.today { background-color: #ecfdf5; border-color: #10b981; }


.ios-scroll{ -webkit-overflow-scrolling: touch; }

    /* Activities: done/skipped (minimal) */
    .done-item { opacity: 0.55; }
    .done-text { text-decoration: line-through; }
    .skipped-item { opacity: 0.55; }
    .skipped-badge { color: #b91c1c; } /* red-700 */
    .auto-badge { color: #64748b; } /* slate-500 */

    /* Timeline UX states (v32+) ‚Äî force override Tailwind bg/border utilities */
.timelineItem.tl-today{
  background-color: rgba(16,185,129,0.10) !important;
  border-color: rgba(16,185,129,0.22) !important;
}
.timelineItem.tl-today-done{
  background-color: rgba(59,130,246,0.12) !important;
  border-color: rgba(59,130,246,0.28) !important;
}
.timelineItem.tl-auto-done{
  background-color: rgba(100,116,139,0.08) !important;
  border-color: rgba(100,116,139,0.18) !important;
}
.timelineItem.tl-skipped{
  background-color: rgba(239,68,68,0.10) !important;
  border-color: rgba(239,68,68,0.25) !important;
}
.timelineItem.tl-future{
  background-color: rgba(234,179,8,0.08) !important;
  border-color: rgba(234,179,8,0.20) !important;
}



    /* Timeline item notes button */
    .timelineItem .notes-has { font-weight: 700; }

  

/* Timeline notes indicator (v46) */
.tlNotesBtn {
  position: relative;
  opacity: 0.6;
  transition: opacity .15s ease, transform .1s ease;
}

.tlNotesBtn.notes-has {
  opacity: 1;
  transform: scale(1.05);
}

.tlNotesBtn .note-dot {
  position: absolute;
  top: -2px;
  right: -2px;
  width: 8px;
  height: 8px;
  background: #2563eb; /* azul elegante */
  border-radius: 50%;
  box-shadow: 0 0 0 2px white;
}



/* Daily notes in timeline (v46 daily notes highlight + CRUD) */
.tl-dnote { background: rgba(148,163,184,0.10); border-color: rgba(148,163,184,0.25); }
.tl-dnote-has { }
.noteDateActive { background: rgba(59,130,246,0.10); border-color: rgba(59,130,246,0.25); }

    /* --- UX: Floating collapse-all FAB + sticky total bar --- */
    @media (max-width: 640px){
      /* Hide header button on mobile; FAB provides access */
      #collapseAll{ display:none; }
    }
    #fabCollapseAll{
      position: fixed;
      right: 14px;
      bottom: calc(env(safe-area-inset-bottom) + 76px);
      width: 44px;
      height: 44px;
            line-height: 44px;
      text-align: center;
border-radius: 999px;
      border: 1px solid rgba(148,163,184,.6);
      background: rgba(255,255,255,.92);
      box-shadow: 0 6px 16px rgba(15,23,42,.12);
      color: #0f172a;
      font-weight: 800;
      z-index: 60; /* above bottom bar */
      opacity: .92;
      -webkit-tap-highlight-color: transparent;
    }
    #fabCollapseAll:active{ transform: translateY(1px); }

    #stickyTotalBar{
      position: fixed;
      left: 0;
      right: 0;
      top: var(--app-header-h, 56px);
      z-index: 950;
    }


    

/* V88J/V88I: Compare A/B bar under totals (always visible) */

/* --- v50 UX: Sticky summary detail panel + hide legacy summary card --- */
    #summary, #summaryDetail { display: none !important; }
    #stickySummaryDetailInner .row { display:flex; justify-content:space-between; gap:12px; padding:4px 0; }
    #stickySummaryDetailInner .lbl { color: rgb(100 116 139); }
    #stickySummaryDetailInner .val { font-weight: 600; }
    #stickySummaryDetailInner .total { font-weight: 800; }


  /* hide horizontal scrollbar for chips */
  .no-scrollbar::-webkit-scrollbar{display:none}
  .no-scrollbar{-ms-overflow-style:none;scrollbar-width:none}


/* Toggle robusto sin depender de Tailwind din√°mico */
.seg-btn{
  border: 1px solid #e2e8f0;
  background: #ffffff;
  color: #0f172a;
}
.seg-btn.seg-active{
  background: #0f172a;
  border-color: #0f172a;
  color: #ffffff;
}
.seg-btn.seg-inactive{
  background: #ffffff;
  border-color: #e2e8f0;
  color: #0f172a;
}


/* Timeline controls sticky (single row, no clone) */
#timelineControlsRow{
  position: sticky;
  top: calc(var(--app-header-h, 56px) + var(--sticky-totals-h, 0px));
  z-index: 60;
  background: rgba(255,255,255,0.97);
  backdrop-filter: blur(8px);
  border-bottom: 1px solid rgba(15,23,42,0.08);
  padding-top: 8px;
  padding-bottom: 8px;
}


/* --- v78: Fixed header + fixed totals + spacer --- */
#appHeader{
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  z-index: 1000;
}
#topStackSpacer{ height: calc(var(--app-header-h, 56px) + var(--sticky-totals-h, 0px)); }


/* Timeline time badges (v88) */
.tlTimeBadge{
  display:inline-block;
  padding:2px 8px;
  border-radius:999px;
  font-weight:700;
  font-size:11px;
  line-height:1.2;
  border:1px solid rgba(148,163,184,0.35);
}
.tlTimeToday{ background: rgba(16,185,129,0.14); color:#065f46; border-color: rgba(16,185,129,0.30); }
.tlTimeFuture{ background: rgba(59,130,246,0.10); color:#1d4ed8; border-color: rgba(59,130,246,0.22); }
.tlTimePast{ background: rgba(100,116,139,0.10); color:#334155; border-color: rgba(100,116,139,0.22); }
.tlTimeNone{ background: rgba(148,163,184,0.10); color:#475569; }



/* V88G2D: Timeline notice toast (non-blocking) */
#timelineNotice{
  position: sticky;
  top: calc(var(--app-header-h, 56px) + var(--sticky-totals-h, 0px) + 8px);
  z-index: 65;
  margin: 8px 0 10px 0;
  padding: 10px 12px;
  border-radius: 14px;
  border: 1px solid rgba(15,23,42,0.10);
  background: rgba(255,255,255,0.95);
  backdrop-filter: blur(8px);
  font-weight: 700;
  color: #0f172a;
  box-shadow: 0 6px 18px rgba(15,23,42,0.10);
}
#timelineNotice.hidden{ display:none; }
</style>
</head>
<body class="bg-slate-50 text-slate-900">
<!-- Tailwind safelist for classes toggled via JS -->
<div class="hidden bg-slate-900 border-slate-900 bg-slate-900 border-slate-900 text-white text-slate-800 opacity-40"></div>
<!-- Top bar -->
<header id="appHeader" class="safe-t bg-white/90 backdrop-blur border-b border-slate-200">
  <div class="max-w-6xl mx-auto px-4 py-2 flex items-center justify-between gap-2">
    <div class="flex items-center gap-2 min-w-0">
      <img src="icon.png" alt="MI VIAJE" class="w-7 h-7 rounded-xl" />
      <div class="font-extrabold tracking-tight text-sm">VIAJE</div>

      <div class="inline-flex items-center gap-1 bg-white border border-slate-200 rounded-2xl p-1 ml-1">
        <button id="chipA" class="tap px-2.5 py-1.5 rounded-2xl text-xs font-extrabold">A</button>
        <button id="chipB" class="tap px-2.5 py-1.5 rounded-2xl text-xs font-extrabold">B</button>
        <button id="chipPlus" class="tap px-2.5 py-1.5 rounded-2xl text-xs font-extrabold border border-slate-200 bg-white text-slate-400 cursor-not-allowed" disabled aria-disabled="true" title="Pr√≥ximamente">+</button>
      </div>
    </div>

    <div class="flex items-center gap-2">
      <button id="btnTools" class="tap w-10 h-10 rounded-2xl border border-slate-200 bg-white hover:bg-slate-50 text-lg font-semibold flex items-center justify-center" aria-label="Herramientas" title="Herramientas">‚öôÔ∏è</button>
      <button id="btnReadOnly" class="tap w-10 h-10 rounded-2xl border border-slate-200 bg-white hover:bg-slate-50 text-lg font-semibold flex items-center justify-center" aria-label="Modo lectura" title="Modo lectura" aria-pressed="false">üîì</button>

      <!-- Keep legacy buttons in DOM (hidden) so we reuse existing handlers without duplicating l√≥gica -->
      <button id="btnTrips" class="hidden" aria-hidden="true" tabindex="-1">Guardar / Cargar</button>
      <button id="btnKey" class="hidden" aria-hidden="true" tabindex="-1">Cambiar clave</button>
    </div>
  </div>
</header>
<!-- Sticky mini total bar -->
<div class="bg-white/95 backdrop-blur border-b border-slate-200" id="stickyTotalBar">
<div class="max-w-6xl mx-auto px-4 py-2 flex items-center justify-between gap-3">
<div class="text-sm font-semibold text-slate-900" id="stickyTotalValue">TOTAL: ‚Äî</div>
<select class="px-3 py-1.5 rounded-xl border border-slate-200 bg-white text-sm" id="displayCurrency" aria-label="Moneda">
  <option value="EUR">‚Ç¨</option>
  <option value="USD">$</option>
  <option value="GBP">¬£</option>
  <option value="JPY">¬•</option>
</select>
<div id="stickyBestHint" class="text-xs font-semibold text-slate-500 whitespace-nowrap"></div>
<button class="tap px-3 py-1.5 rounded-xl text-sm font-semibold border border-slate-200 bg-white hover:bg-slate-50" id="stickyTotalToggle">Ver detalle ‚ñæ</button>
</div>
<div class="hidden bg-white/95 backdrop-blur border-t border-slate-200" id="stickySummaryDetail">
<div class="max-w-6xl mx-auto px-4 py-2">
<div class="text-sm" id="stickySummaryDetailInner"></div>
</div>
</div>
</div>
<div id="topStackSpacer"></div>
<!-- Main -->
<main class="max-w-6xl mx-auto px-4 py-6 pb-24">
<!-- Grid -->
<div class="grid grid-cols-1 lg:grid-cols-12 gap-4"><aside class="lg:col-span-4">
<div class="bg-white border border-slate-200 rounded-3xl p-5 sticky top-24" id="summary">
<div class="flex items-center justify-between gap-3">
<div class="font-extrabold text-lg">RESUMEN</div>
<button class="tap px-3 py-2 rounded-xl border border-slate-200 bg-white hover:bg-slate-50 text-sm font-semibold" id="summaryToggle">Ver detalle ‚ñæ</button>
</div>
<div class="mt-3 space-y-2 text-sm">
<div class="flex justify-between"><span class="text-slate-600">Transporte</span><span class="font-semibold" id="sumTransport">0.00</span></div>
<div class="flex justify-between"><span class="text-slate-600">Alojamiento</span><span class="font-semibold" id="sumStay">0.00</span></div>
<div class="flex justify-between"><span class="text-slate-600">Actividades</span><span class="font-semibold" id="sumActs">0.00</span></div>
<div class="flex justify-between"><span class="text-slate-600">Comidas</span><span class="font-semibold" id="sumMeals">0.00</span></div>
<hr class="my-2"/>
<div class="flex justify-between text-base"><span class="font-extrabold">TOTAL</span><span class="font-extrabold" id="sumTotal">0.00</span></div>
<div class="text-xs text-slate-500">Moneda de visualizaci√≥n: <span id="sumCur">EUR</span></div>
</div>
<div class="mt-4 flex gap-2">
</div>
<div class="mt-3 hidden text-sm bg-slate-50 border border-slate-200 rounded-2xl p-3" id="compareBox"></div>
</div><div class="mt-3 hidden" id="summaryDetail"><button class="tap flex-1 px-4 py-2 rounded-xl border border-slate-200 bg-white hover:bg-slate-50 text-sm font-semibold" id="btnCompare">
              Comparar A/B (simple)
            </button></div>
</aside>
<section class="lg:col-span-8 space-y-4">
<!-- TIMELINE -->
<div class="bg-white border border-slate-200 rounded-3xl overflow-visible">
<button class="w-full tap flex items-center justify-between px-5 py-4" data-acc="timeline">
<div class="flex items-center gap-3">
<span class="inline-flex w-9 h-9 rounded-2xl bg-orange-50 items-center justify-center">üóìÔ∏è</span>
<div class="text-left">
<div class="font-extrabold">Cronograma</div>
</div>
</div>
<span class="accIcon text-slate-400 text-xl">‚ñæ</span>
</button>
<div class="px-5 pb-5 hidden" data-acc-body="timeline" style="overflow: visible;">
  <div id="timelineControlsRow">
<div class="flex items-center justify-between mb-3 gap-3 flex-wrap">
<div class="flex items-center gap-2">
<button class="tap px-3 py-1.5 rounded-lg text-sm font-semibold seg-btn seg-active" id="tlViewGlobal">Global</button>
<button class="tap px-3 py-1.5 rounded-lg text-sm font-semibold seg-btn seg-inactive" id="tlViewDay">D√≠a</button>
</div>
<div class="hidden flex items-center gap-2" id="timelineDayNav">
<button aria-label="D√≠a anterior" class="tap px-3 py-2 rounded-2xl border border-slate-200 bg-white hover:bg-slate-50 text-slate-800 text-sm font-semibold" id="tlDayPrev">‚Üê</button>
<div class="text-sm font-semibold text-slate-700" id="tlDayLabel">‚Äî</div>
<button aria-label="D√≠a siguiente" class="tap px-3 py-2 rounded-2xl border border-slate-200 bg-white hover:bg-slate-50 text-slate-800 text-sm font-semibold" id="tlDayNext">‚Üí</button>
</div>
<div class="flex gap-2 justify-end" id="timelineGlobalNav">
<button class="tap px-4 py-2 rounded-xl border border-slate-200 bg-white hover:bg-slate-50 text-slate-800 text-sm font-semibold" id="timelineToday">Actual</button>
<button class="tap px-4 py-2 rounded-xl bg-slate-900 hover:bg-orange-700 text-white text-sm font-semibold" id="timelineNext">Pr√≥ximo</button>
</div>
</div>
<div class="mb-3 -mx-1">
<div class="flex gap-2 overflow-x-auto no-scrollbar px-1 py-1" id="timelineFilterChips">
<!-- chips injected by JS -->
</div>
</div>
  </div>

  <div id="timelineNotice" class="hidden mb-3 px-4 py-2 rounded-2xl border border-slate-200 bg-slate-50 text-sm text-slate-700"></div>
  <div class="space-y-3" id="timelineList"></div>
<div class="mt-4 bg-white border border-slate-200 rounded-3xl overflow-hidden">
<button class="w-full tap flex items-center justify-between px-4 py-4" data-acc="dailyNotes">
<div class="flex items-center gap-3">
<span class="inline-flex w-9 h-9 rounded-2xl bg-slate-50 items-center justify-center">üìù</span>
<div class="text-left">
<div class="font-extrabold">NOTAS DEL D√çA</div>
</div>
</div>
<span class="accIcon text-slate-400 text-xl">‚ñæ</span>
</button>
<div class="px-4 pb-4 hidden" data-acc-body="dailyNotes">
<div class="p-3 rounded-2xl border border-slate-200 bg-white" id="dailyNotesBox"></div>
</div>
</div>
</div>
</div>
<!-- LOGISTICA -->
<div class="bg-white border border-slate-200 rounded-3xl overflow-hidden">
<button id="legsHeader" class="w-full tap flex items-center justify-between px-5 py-4" data-acc="legs">
<div class="flex items-center gap-3">
<span class="inline-flex w-9 h-9 rounded-2xl bg-blue-50 items-center justify-center">üõ´</span>
<div class="text-left">
<div class="font-extrabold">Transporte</div>
</div>
</div>
<span class="accIcon text-slate-400 text-xl">‚ñæ</span>
</button>
<div class="px-5 pb-5 hidden" data-acc-body="legs">
<div class="flex justify-end mb-3">
<button class="tap px-4 py-2 rounded-xl bg-blue-600 hover:bg-blue-700 text-white text-sm font-semibold" id="addLeg">+ A√±adir trayecto</button>
</div>
<div class="space-y-3" id="legsList"></div>
</div>
</div>
<!-- ALOJAMIENTO -->
<div class="bg-white border border-slate-200 rounded-3xl overflow-hidden">
<button id="staysHeader" class="w-full tap flex items-center justify-between px-5 py-4" data-acc="stays">
<div class="flex items-center gap-3">
<span class="inline-flex w-9 h-9 rounded-2xl bg-emerald-50 items-center justify-center">üè®</span>
<div class="text-left">
<div class="font-extrabold">Alojamiento</div>
</div>
</div>
<span class="accIcon text-slate-400 text-xl">‚ñæ</span>
</button>
<div class="px-5 pb-5 hidden" data-acc-body="stays">
<div class="flex justify-end mb-3">
<button class="tap px-4 py-2 rounded-xl bg-emerald-600 hover:bg-emerald-700 text-white text-sm font-semibold" id="addStay">+ A√±adir alojamiento</button>
</div>
<div class="space-y-3" id="staysList"></div>
</div>
</div>
<!-- COMIDAS -->
<div class="bg-white border border-slate-200 rounded-3xl overflow-hidden">
<button class="w-full tap flex items-center justify-between px-5 py-4" data-acc="meals">
<div class="flex items-center gap-3">
<span class="inline-flex w-9 h-9 rounded-2xl bg-amber-50 items-center justify-center">üçΩÔ∏è</span>
<div class="text-left">
<div class="font-extrabold">Comida</div>
</div>
</div>
<span class="accIcon text-slate-400 text-xl">‚ñæ</span>
</button>
<div class="px-5 pb-5 hidden" data-acc-body="meals">
<div class="grid grid-cols-1 sm:grid-cols-3 gap-3">
<div>
<label class="text-xs text-slate-600">Gasto diario x persona</label>
<input class="mt-1 w-full px-3 py-2 rounded-xl border border-slate-200" id="mealDaily" min="0" placeholder="Ej: 30" step="0.01" type="number"/>
</div>
<div>
<label class="text-xs text-slate-600">N¬∫ personas</label>
<input class="mt-1 w-full px-3 py-2 rounded-xl border border-slate-200" id="mealPeople" min="1" placeholder="Ej: 2" step="1" type="number"/>
</div>
<div>
<label class="text-xs text-slate-600">D√≠as totales</label>
<input class="mt-1 w-full px-3 py-2 rounded-xl border border-slate-200" id="mealDays" min="1" placeholder="Ej: 20" step="1" type="number"/>
</div>
</div>
<div class="mt-3 text-sm">
<span class="text-slate-600">Total comidas:</span>
<span class="font-extrabold" id="mealTotal">0.00</span>
<span class="text-slate-500" id="mealCur">EUR</span>
</div>
</div>
</div>
<!-- ACTIVIDADES -->
<div class="bg-white border border-slate-200 rounded-3xl overflow-hidden">
<button id="actsHeader" class="w-full tap flex items-center justify-between px-5 py-4" data-acc="acts">
<div class="flex items-center gap-3">
<span class="inline-flex w-9 h-9 rounded-2xl bg-fuchsia-50 items-center justify-center">üéØ</span>
<div class="text-left">
<div class="font-extrabold">Actividades</div>
</div>
</div>
<span class="accIcon text-slate-400 text-xl">‚ñæ</span>
</button>
<div class="px-5 pb-5 hidden" data-acc-body="acts">
<div class="flex justify-end mb-3">
<button class="tap px-4 py-2 rounded-xl bg-fuchsia-600 hover:bg-fuchsia-700 text-white text-sm font-semibold" id="addAct">+ A√±adir actividad</button>
</div>
<div class="space-y-3" id="actsList"></div>
</div>
</div>
<!-- IA -->
<div class="bg-white border border-slate-200 rounded-3xl overflow-hidden">
<button class="w-full tap flex items-center justify-between px-5 py-4" data-acc="ai">
<div class="flex items-center gap-3">
<span class="inline-flex w-9 h-9 rounded-2xl bg-violet-50 items-center justify-center">ü§ñ</span>
<div class="text-left">
<div class="font-extrabold">SUGERENCIAS DE LA IA</div>
</div>
</div>
<span class="accIcon text-slate-400 text-xl">‚ñæ</span>
</button>
<div class="px-5 pb-5 hidden" data-acc-body="ai">
<div class="flex flex-wrap gap-2 justify-end mb-3">
<button class="tap px-4 py-2 rounded-xl border border-slate-200 bg-white hover:bg-slate-50 text-sm font-semibold" id="aiPick">1) Elegir temas</button>
<button class="tap px-4 py-2 rounded-xl bg-violet-600 hover:bg-violet-700 text-white text-sm font-semibold" id="aiGenerate">2) Generar gu√≠a</button>
</div>
<div class="text-sm text-slate-500" id="aiStatus">
              Selecciona primero ciudades/actividades/alojamientos, luego genera.
            </div>
<div class="mt-4 space-y-4" id="aiResults"></div>
</div>
</div>
</section>
<!-- Summary -->
</div>
</main>
<!-- Bottom bar for mobile -->
<nav class="safe-b fixed bottom-0 left-0 right-0 z-50 lg:hidden bg-white/95 backdrop-blur border-t border-slate-200">
<div class="max-w-6xl mx-auto px-4 py-2 grid grid-cols-5 gap-2 text-xs">
<button class="tap py-2 rounded-xl hover:bg-slate-50" data-jump="timeline">üóìÔ∏è<div>Cronograma</div></button><button class="tap py-2 rounded-xl hover:bg-slate-50" data-jump="legs">üõ´<div>Transporte</div></button>
<button class="tap py-2 rounded-xl hover:bg-slate-50" data-jump="stays">üè®<div>Alojamiento</div></button>
<button class="tap py-2 rounded-xl hover:bg-slate-50" data-jump="meals">üçΩÔ∏è<div>Comida</div></button>
<button class="tap py-2 rounded-xl hover:bg-slate-50" data-jump="acts">üéØ<div>Actividades</div></button>
</div>
</nav>

<!-- Tools Bottom Sheet (V88I) -->
<div id="toolsOverlay" class="hidden fixed inset-0 z-[5200] bg-black/40 backdrop-blur-[2px]"></div>

<div id="toolsSheet" class="hidden fixed left-0 right-0 bottom-0 z-[90]">
  <div class="max-w-6xl mx-auto px-4 pb-[max(env(safe-area-inset-bottom),16px)]">
    <div class="bg-white/95 backdrop-blur border border-slate-200 rounded-t-3xl shadow-2xl overflow-hidden">
      <div class="px-5 py-4 flex items-center justify-between border-b border-slate-200">
        <div class="font-extrabold">Herramientas</div>
        <button id="btnToolsClose" class="tap px-3 py-2 rounded-xl hover:bg-slate-50" aria-label="Cerrar">‚úï</button>
      </div>

      <div class="p-5 space-y-2">
        <button id="toolTrips" class="w-full tap flex items-center justify-between px-4 py-3 rounded-2xl border border-slate-200 bg-white hover:bg-slate-50 text-sm font-semibold">
          <span class="flex items-center gap-3"><span class="text-lg">üíæ</span><span>Guardar / Cargar</span></span>
          <span class="text-slate-400">‚Ä∫</span>
        </button>

        <button id="toolKey" class="w-full tap flex items-center justify-between px-4 py-3 rounded-2xl border border-slate-200 bg-white hover:bg-slate-50 text-sm font-semibold">
          <span class="flex items-center gap-3"><span class="text-lg">üîë</span><span>Cambiar clave</span></span>
          <span class="text-slate-400">‚Ä∫</span>
        </button>

        <button id="toolResetTrip" class="w-full tap flex items-center justify-between px-4 py-3 rounded-2xl border border-rose-200 bg-rose-50 hover:bg-rose-100 text-sm font-semibold text-rose-700">
          <span class="flex items-center gap-3"><span class="text-lg">üß®</span><span>Reiniciar este viaje</span></span>
          <span class="text-rose-400">‚Ä∫</span>
        </button>

        <div class="pt-2">
          <button id="btnToolsCloseBottom" class="w-full tap px-4 py-3 rounded-2xl border border-slate-200 bg-white hover:bg-slate-50 text-sm font-semibold">
            Cerrar
          </button>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Modals -->
<div class="hidden fixed inset-0 z-[60] bg-black/40" id="modalBackdrop"></div>
<div class="hidden fixed inset-0 z-[70] flex items-center justify-center p-4" id="modalBox">
<div class="w-full max-w-xl bg-white rounded-3xl border border-slate-200 shadow-xl max-h-[85vh] overflow-y-auto ios-scroll">
<div class="px-5 py-4 flex items-center justify-between border-b border-slate-200">
<div class="font-extrabold" id="modalTitle">Modal</div>
<button class="tap px-3 py-2 rounded-xl hover:bg-slate-50" id="modalClose">‚úï</button>
</div>
<div class="p-5" id="modalBody"></div>
<div class="px-5 py-4 border-t border-slate-200 flex justify-end gap-2" id="modalFooter"></div>
</div>
</div>
<script>
/* ----------------------------- Utilities ----------------------------- */
const $ = (id) => document.getElementById(id);
const escapeHtml = (s) => String(s ?? "").replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#039;");


/* ------------------------ Trip name (modal + export/import) ------------------------ */
const TRIP_NAME_KEY = "miviaje.tripName";

function getTripName() {
  const v = localStorage.getItem(TRIP_NAME_KEY) || "";
  return String(v || "").trim();
}

function setTripName(v) {
  localStorage.setItem(TRIP_NAME_KEY, String(v || "").trim());
}

function sanitizeFileBaseName(name) {
  name = String(name || "").trim();
  if (!name) return "MI_VIAJE";

  try {
    name = name.normalize("NFD").replace(/[\u0300-\u036f]/g, "");
  } catch {}

  name = name.replace(/\s+/g, "_");
  name = name.replace(/[^A-Za-z0-9_-]/g, "");
  return name || "MI_VIAJE";
}

function yyyyMmDdToday() {
  return new Date().toISOString().slice(0, 10);
}
/* ---------------------- /Trip name (modal + export/import) ---------------------- */

/* ------------------------ Trip name mode (minimal) ------------------------ */
const LS_TRIP_NAME_MODE = "miviaje.tripNameMode"; // "auto" | "custom"

function getTripNameMode() {
  const v = (localStorage.getItem(LS_TRIP_NAME_MODE) || "").trim();
  return (v === "custom" || v === "auto") ? v : "auto";
}
function setTripNameMode(mode) {
  const m = (mode === "custom") ? "custom" : "auto";
  localStorage.setItem(LS_TRIP_NAME_MODE, m);
}

/**
 * "Destino actual" recalculado:
 * - Prioridad: √∫ltimo leg.to no vac√≠o del escenario actual
 * - Fallback: primer stay.city no vac√≠o
 * - Fallback: primer activity.city no vac√≠o
 * - Fallback final: "MI_VIAJE"
 */
function computeAutoTripName() {
  try {
    const sc = (typeof curScenario === "function") ? curScenario() : null;
    if (sc) {
      const legs = Array.isArray(sc.legs) ? sc.legs : [];
      for (let i = legs.length - 1; i >= 0; i--) {
        const to = String(legs[i]?.to || "").trim();
        if (to) return to;
      }

      const stays = Array.isArray(sc.stays) ? sc.stays : [];
      for (let i = 0; i < stays.length; i++) {
        const city = String(stays[i]?.city || "").trim();
        if (city) return city;
      }

      const acts = Array.isArray(sc.activities) ? sc.activities : [];
      for (let i = 0; i < acts.length; i++) {
        const city = String(acts[i]?.city || "").trim();
        if (city) return city;
      }
    }
  } catch {}
  return "MI_VIAJE";
}
/* ---------------------- /Trip name mode (minimal) ---------------------- */

const cap1 = (s) => {
  s = String(s ?? "").trim();
  if (!s) return "";
  return s.charAt(0).toUpperCase() + s.slice(1);
};
const nowId = () => Math.random().toString(36).slice(2,10);
const parseMoney = (v) => {
  const n = Number(String(v ?? "").replace(",", "."));
  return Number.isFinite(n) ? n : 0;
};
const uniq = (arr) => Array.from(new Set(arr.map(x => String(x).trim()).filter(Boolean)));


/* -------------------------- Timeline jump --------------------------- */
function todayYMD() {
  const d = new Date();
  const y = d.getFullYear();
  const m = String(d.getMonth() + 1).padStart(2, "0");
  const day = String(d.getDate()).padStart(2, "0");
  return `${y}-${m}-${day}`;
}






function getStickyOffset() {
  const header = document.getElementById("appHeader") || document.querySelector("header");
  const totalBar = document.getElementById("stickyTotalBar");
  const controls = document.getElementById("timelineControlsRow");

  // Prefer measured vars (kept in sync by syncTopStackHeights)
  const root = document.documentElement;
  const varHeader = parseFloat(getComputedStyle(root).getPropertyValue("--app-header-h")) || 0;
  const varTotals = parseFloat(getComputedStyle(root).getPropertyValue("--sticky-totals-h")) || 0;

  let offset = 0;
  offset += varHeader || (header ? header.getBoundingClientRect().height : 0);
  offset += varTotals || (totalBar ? totalBar.getBoundingClientRect().height : 0);

  // Controls row only matters when visible (timeline accordion open)
  if (controls && !controls.classList.contains("hidden")) {
    offset += controls.getBoundingClientRect().height;
  }

  offset += 12; // margin
  return offset;
}



function syncTopStackHeights() {
  const header = document.getElementById("appHeader") || document.querySelector("header");
  const totalBar = document.getElementById("stickyTotalBar");
  const spacer = document.getElementById("topStackSpacer");

  const headerH = header ? header.getBoundingClientRect().height : 0;
  const totalsH = totalBar ? totalBar.getBoundingClientRect().height : 0;

  const root = document.documentElement;
  root.style.setProperty("--app-header-h", headerH + "px");
  root.style.setProperty("--sticky-totals-h", totalsH + "px");

  if (spacer) spacer.style.height = (headerH + totalsH) + "px";
}

// Keep heights in sync on load and when viewport changes (iOS address bar / rotation)
window.addEventListener("load", () => setTimeout(syncTopStackHeights, 0));
window.addEventListener("resize", () => setTimeout(syncTopStackHeights, 0));

function scrollToElWithOffset(el, extra = 0) {
  if (!el) return;
  const y = el.getBoundingClientRect().top + window.pageYOffset - (getStickyOffset() + (extra || 0));
  window.scrollTo({ top: Math.max(0, y), behavior: "smooth" });
}

function getTopStackOffset() {
  const cs = getComputedStyle(document.documentElement);
  const headerH = parseFloat(cs.getPropertyValue("--app-header-h")) || 56;
  const totalsH = parseFloat(cs.getPropertyValue("--sticky-totals-h")) || 0;
  return headerH + totalsH;
}

function scrollToElTopStack(el, extra = 0) {
  if (!el) return;
  const y = el.getBoundingClientRect().top + window.pageYOffset - (getTopStackOffset() + (extra || 0));
  window.scrollTo({ top: Math.max(0, y), behavior: "smooth" });
}

function landUnderTotals(el, extraPx = 8, opts = {}) {
  if (!el) return;

  const smooth = !!(opts && opts.smooth);

  // Token to cancel pending landings when layout changes (e.g., user closes an accordion)
  window.__landingToken = (window.__landingToken || 0) + 1;
  const token = window.__landingToken;

  const sync = () => {
    try { syncHeaderHeightVar(); } catch {}
    try { syncTopStackHeights(); } catch {}
    try { syncStickyTotalsHeightVar(); } catch {}
  };

  const doScroll = (behavior) => {
    if (!el) return;
    const topStack = (typeof getTopStackOffset === "function" ? getTopStackOffset() : 0) + (extraPx || 0);
    const y = el.getBoundingClientRect().top + window.pageYOffset - topStack;
    window.scrollTo({ top: Math.max(0, y), behavior: behavior || "auto" });
  };

  sync();

  // First pass
  requestAnimationFrame(() => {
    if ((window.__landingToken || 0) !== token) return;
    if (el.offsetParent === null) return; // not visible
    try { doScroll(smooth ? "smooth" : "auto"); } catch {}
  });
}


let __tlLastActualKey = ""; // in-memory only, used to compute "Pr√≥ximo" relative to "Actual"

function __tlNowMinutes() {
  const n = new Date();
  return n.getHours() * 60 + n.getMinutes();
}

function getEstimatedDurationMinutes(item) {
  // Transporte / Alojamiento / Actividades (fallback 60)
  if (item && (item.legId || String(item.uid||"").startsWith("leg:"))) return 180;
  if (item && (item.stayId || String(item.uid||"").startsWith("stay:"))) return 60;
  if (item && (item.actId || String(item.uid||"").startsWith("act:"))) return 90;
  return 60;
}

function getEventStartDateTime(item) {
  // Returns a Date for today items with valid time, else null
  const d = String(item?.date || "");
  const t = String(item?.time || "");
  if (!/^[0-9]{4}-[0-9]{2}-[0-9]{2}$/.test(d)) return null;
  if (!/^[0-9]{2}:[0-9]{2}$/.test(t)) return null;
  const dt = new Date(`${d}T${t}:00`);
  return Number.isNaN(dt.getTime()) ? null : dt;
}

function __tlPickCurrentItemForToday(items, todayISO) {
  const nowMin = __tlNowMinutes();
  const todays = (items || []).filter(it => String(it.date||"") === String(todayISO) && it.date !== "9999-99-99");
  if (!todays.length) return null;

  // Prefer real events over note markers when choosing "actual"
  const main = todays.filter(it => !it.isNote);

  // Only consider items with a valid time for "in progress"
  const pool = (main.length ? main : todays).filter(it => /^[0-9]{2}:[0-9]{2}$/.test(String(it.time || "")));

  if (!pool.length) return null;

  // In progress: start <= now < end (estimated duration)
  const inProgress = pool.filter(it => {
    const startMin = timeSortKey(it.time);
    const endMin = startMin + getEstimatedDurationMinutes(it);
    return startMin <= nowMin && nowMin < endMin;
  });

  if (!inProgress.length) return null;

  // If several: pick the one that started most recently
  inProgress.sort((a,b) => timeSortKey(b.time) - timeSortKey(a.time));
  return inProgress[0] || null;
}

function __tlEnsureTimelineOpen() {
  const body = document.querySelector('[data-acc-body="timeline"]');
  if (body && body.classList.contains("hidden")) {
    const btn = document.querySelector('[data-acc="timeline"]');
    if (btn) btn.click();
  }
}

function __tlScrollToItemByKey(tlKey) {
  if (!tlKey) return false;
  const els = Array.from(document.querySelectorAll("#timelineList .timelineItem"));
  const el = els.find(x => (x.getAttribute("data-tl-key") || "") === String(tlKey));
  if (!el) return false;
  scrollToElWithOffset(el);
  return true;
}


function showTimelineNotice(text, autoHideMs = 2500) {
  const t = String(text || "").trim();

  // Ensure notice element exists inside timeline (above the list)
  let box = document.getElementById("timelineNotice");
  if (!box) {
    const timelineBody = document.querySelector('[data-acc-body="timeline"]');
    const list = document.getElementById("timelineList");
    if (!timelineBody || !list) return;

    box = document.createElement("div");
    box.id = "timelineNotice";
    box.setAttribute("role", "status");
    box.className = "hidden";
    // Insert right above the list so it remains even when the list re-renders
    timelineBody.insertBefore(box, list);
  }

  // Clear any pending auto-hide
  try {
    if (window.__tlNoticeTimer) clearTimeout(window.__tlNoticeTimer);
  } catch {}
  window.__tlNoticeTimer = null;

  if (!t) {
    box.textContent = "";
    box.classList.add("hidden");
    return;
  }

  box.textContent = t;
  box.classList.remove("hidden");

  // Auto-hide (non-blocking toast)
  const ms = Number(autoHideMs);
  if (Number.isFinite(ms) && ms > 0) {
    window.__tlNoticeTimer = setTimeout(() => {
      try { showTimelineNotice(""); } catch {}
    }, ms);
  }
}

function __tlSetNotice(text) { showTimelineNotice(text); }
function __tlClearNotice() { showTimelineNotice(""); }

function scrollToCurrentTimelineItem() {
  __tlEnsureTimelineOpen();
  // Keep current view/day; "Actual" should not force a day switch.
  try { __tlClearNotice(); } catch {}

  // Ensure items reflect current mode (global/day) before picking.
  try { renderTimeline(); } catch {}

  const todayISO = todayYMD();
  const items = Array.isArray(__tlLastFilteredItems) ? __tlLastFilteredItems : [];
  const cur = __tlPickCurrentItemForToday(items, todayISO);

  if (!cur) {
    showTimelineNotice("No hay eventos en curso ahora mismo");
    return;
  }

  const key = cur.isNote ? `note:${todayISO}` : `${cur.actId ? "act" : (cur.legId ? "leg" : (cur.stayId ? "stay" : ""))}:${(cur.actId || cur.legId || cur.stayId || "")}`;
  __tlScrollToItemByKey(key);
}

function scrollToNextAfterCurrent() {
  __tlEnsureTimelineOpen();
  try { __tlClearNotice(); } catch {}

  // Work from a global ordering to find the next future event deterministically.
  const prevMode = (typeof timelineViewMode !== "undefined") ? timelineViewMode : "global";
  const prevDay  = (typeof activeDayISO !== "undefined") ? activeDayISO : "";

  timelineViewMode = "global";
  renderTimeline();

  const items = Array.isArray(__tlLastFilteredItems) ? __tlLastFilteredItems : [];
  if (!items.length) { __tlSetNotice("No hay pr√≥ximos eventos"); timelineViewMode = prevMode; activeDayISO = prevDay; renderTimeline(); return; }

  const now = new Date();

  const makeKey = (it) => {
    return it.isNote ? `note:${String(it.date || "")}` : `${it.actId ? "act" : (it.legId ? "leg" : (it.stayId ? "stay" : ""))}:${(it.actId || it.legId || it.stayId || "")}`;
  };

  const isFutureOrNow = (it) => {
    const d = String(it.date || "");
    if (!d || d === "9999-99-99") return false;

    const start = getEventStartDateTime(it);
    if (start) return start.getTime() >= now.getTime();

    if (!/^[0-9]{4}-[0-9]{2}-[0-9]{2}$/.test(d)) return false;
    const dt = new Date(d + "T23:59:00");
    return dt.getTime() >= now.getTime();
  };

  const next = items.find(isFutureOrNow) || null;

  if (!next) {
    __tlSetNotice("No hay pr√≥ximos eventos");
    // Restore previous view
    timelineViewMode = prevMode;
    activeDayISO = prevDay;
    renderTimeline();
    return;
  }

  const dISO = String(next.date || "");
  if (!dISO || dISO === "9999-99-99") {
    __tlSetNotice("No hay pr√≥ximos eventos");
    timelineViewMode = prevMode;
    activeDayISO = prevDay;
    renderTimeline();
    return;
  }

  timelineViewMode = "day";
  activeDayISO = dISO;
  renderTimeline();

  const key = makeKey(next);
  // Scroll to item (fallback: first item of that day)
  if (!__tlScrollToItemByKey(key)) {
    const first = items.find(it => String(it.date || "") === dISO);
    if (first) __tlScrollToItemByKey(makeKey(first));
  }
}

function scrollToTodayTimelineItem() {
  // Ensure the timeline accordion is open so the scroll makes sense to the user
  const body = document.querySelector('[data-acc-body="timeline"]');
  if (body && body.classList.contains("hidden")) {
    const btn = document.querySelector('[data-acc="timeline"]');
    if (btn) btn.click();
  }
  const t = todayYMD();
  const els = Array.from(document.querySelectorAll("#timelineList .timelineItem"));
  const todayEl = els.find(el => (el.getAttribute("data-date") || "") === t);
  if (todayEl) {
    scrollToElWithOffset(todayEl);
  } else {
    alert("No hay eventos para hoy.");
  }
}

function scrollToNextTimelineItem() {
  // Ensure the timeline accordion is open so the scroll makes sense to the user
  const body = document.querySelector('[data-acc-body="timeline"]');
  if (body && body.classList.contains("hidden")) {
    const btn = document.querySelector('[data-acc="timeline"]');
    if (btn) btn.click();
  }

  const t = todayYMD();
  const els = Array.from(document.querySelectorAll("#timelineList .timelineItem"));
  const next = els.find(el => {
    const d = el.getAttribute("data-date") || "9999-99-99";
    return d !== "9999-99-99" && d >= t;
  });

  if (next) {
    scrollToElWithOffset(next);
  } else {
    alert("No hay pr√≥ximos eventos con fecha a partir de hoy.");
  }
}

function showModal(title, bodyHtml, footerButtons = []) {
  $("modalTitle").textContent = title;
  $("modalBody").innerHTML = bodyHtml;
  const footer = $("modalFooter");
  footer.innerHTML = "";
  for (const b of footerButtons) footer.appendChild(b);
  $("modalBackdrop").classList.remove("hidden");
  $("modalBox").classList.remove("hidden");
}
function closeModal() {
  $("modalBackdrop").classList.add("hidden");
  $("modalBox").classList.add("hidden");
}
$("modalClose").addEventListener("click", closeModal);
$("modalBackdrop").addEventListener("click", closeModal);

/* -------------------------- Tools Bottom Sheet (V88I) -------------------------- */
function openToolsSheet() {
  const overlay = document.getElementById("toolsOverlay");
  const sheet = document.getElementById("toolsSheet");
  if (!overlay || !sheet) return;

  overlay.classList.remove("hidden");
  sheet.classList.remove("hidden");

  // Keep top-stack vars fresh (Safari/iOS can lag after overlays)
  try { syncTopStackHeights(); } catch {}
  try { setTimeout(() => { try { syncTopStackHeights(); } catch {} }, 50); } catch {}
}
function closeToolsSheet() {
  const overlay = document.getElementById("toolsOverlay");
  const sheet = document.getElementById("toolsSheet");
  if (overlay) overlay.classList.add("hidden");
  if (sheet) sheet.classList.add("hidden");

  // Keep top-stack vars fresh (Safari/iOS can lag after overlays)
  try { syncTopStackHeights(); } catch {}
  try { setTimeout(() => { try { syncTopStackHeights(); } catch {} }, 50); } catch {}
}


// Close on ESC (desktop)
window.addEventListener("keydown", (e) => {
  if (e.key === "Escape") closeToolsSheet();
});

function setupToolsSheet() {
  const btnTools = document.getElementById("btnTools");
  const overlay = document.getElementById("toolsOverlay");
  const closeA = document.getElementById("btnToolsClose");
  const closeB = document.getElementById("btnToolsCloseBottom");

  if (btnTools) btnTools.addEventListener("click", openToolsSheet);
  if (overlay) overlay.addEventListener("click", closeToolsSheet);
  if (closeA) closeA.addEventListener("click", closeToolsSheet);
  if (closeB) closeB.addEventListener("click", closeToolsSheet);

  // Actions: call existing handlers (no re-implementation)
  const toolTrips = document.getElementById("toolTrips");
  const toolKey = document.getElementById("toolKey");
  const toolReset = document.getElementById("toolResetTrip");

  if (toolTrips) toolTrips.addEventListener("click", () => {
    closeToolsSheet();
    const btn = document.getElementById("btnTrips");
    if (btn) btn.click();
  });

  if (toolKey) toolKey.addEventListener("click", () => {
    closeToolsSheet();
    const btn = document.getElementById("btnKey");
    if (btn) btn.click();
  });

  if (toolReset) toolReset.addEventListener("click", () => {
    closeToolsSheet();
    if (typeof openResetTripConfirmModal === "function") openResetTripConfirmModal();
  });
}
/* ------------------------ /Tools Bottom Sheet (V88I) ------------------------ */
/* ----------------------------- State ----------------------------- */
const LS_KEY = "miviaje.rewrite.v1";

// Section item accordion state (v80b)
const __sectionExpanded = {
  legs: new Set(),
  stays: new Set(),
  activities: new Set()
};
const LS_KEY_GEMINI = "miviaje\.gemini\.key";

/* --------------------------- Read-only mode -------------------------- */
const LS_KEY_READONLY = "miviaje.readonly";
function isReadOnly() { return localStorage.getItem(LS_KEY_READONLY) === "1"; }

function setReadOnly(on) {
  localStorage.setItem(LS_KEY_READONLY, on ? "1" : "0");
  applyReadOnlyMode();
}

function applyReadOnlyMode() {
  const on = isReadOnly();
  try { installReadOnlyGuards(); } catch {}

  // body class
  document.body.classList.toggle("readonly-mode", on);

  // Toggle button label
  const btn = $("btnReadOnly");
  if (btn) {
    btn.textContent = on ? "üîí" : "üîì";
    btn.setAttribute("aria-pressed", on ? "true" : "false");
  }

  // Disable all form controls (except file inputs for import/export modal)
  document.querySelectorAll("input, select, textarea").forEach(el => {
    if (el.type === "file") return; // allow import in modal
    // iOS/Safari: disabled is the only reliable way to block date/time pickers
    el.disabled = on;
    if ("readOnly" in el) el.readOnly = on;
  });

  // Disable only the buttons that modify data
  const idsToDisable = [
    "addLeg", "addStay", "addAct",
    "chipA", "chipB",
    "aiPick", "aiGenerate"
  ];
  idsToDisable.forEach(id => {
    const el = $(id);
    if (el) el.disabled = on;
  });

  // Disable delete buttons (created dynamically)
  document.querySelectorAll("[data-leg-del], [data-stay-del], [data-act-del]").forEach(b => {
    b.disabled = on;
  });

  // Block AI actions that add items (created dynamically)
  document.querySelectorAll("#aiResults button").forEach(b => {
    b.disabled = on;
  });
}

let __roGuardsInstalled = false;
function installReadOnlyGuards() {
  if (__roGuardsInstalled) return;
  __roGuardsInstalled = true;

  const isEditableControl = (el) => {
    if (!el) return false;
    if (el.closest && el.closest("#toolsSheet")) return false; // tools UI stays usable
    const tag = (el.tagName || "").toLowerCase();
    if (tag === "input" || tag === "select" || tag === "textarea") return el.type !== "file";
    return false;
  };

  // Capture focus/click/input early to block any late-enabled controls.
  const guard = (e) => {
    if (!isReadOnly()) return;
    const t = e.target;
    if (!isEditableControl(t)) return;
    try { t.disabled = true; } catch {}
    try { t.blur(); } catch {}
    e.preventDefault();
    e.stopPropagation();
  };

  document.addEventListener("focusin", guard, true);
  document.addEventListener("click", guard, true);
  document.addEventListener("input", guard, true);
  document.addEventListener("change", guard, true);
}


/* ------------------------- Sync helpers (iCloud) ------------------------- */
const META_KEY = "miviaje.meta.v1";
const BACKUPS_KEY = "miviaje.backups.v1";
const DEVICE_KEY = "miviaje.deviceName.v1";

function getMeta() {
  try { return JSON.parse(localStorage.getItem(META_KEY) || "{}") || {}; }
  catch { return {}; }
}
function setMeta(patch) {
  const cur = getMeta();
  const next = Object.assign({}, cur, patch || {});
  localStorage.setItem(META_KEY, JSON.stringify(next));
  return next;
}
function getDeviceName(askIfMissing = true) {
  // Fuente de verdad: miviaje.deviceName (nuevo). Compat: miviaje.deviceName.v1 (legacy)
  let v = (localStorage.getItem("miviaje.deviceName") || "").trim();
  if (!v) v = (localStorage.getItem(DEVICE_KEY) || "").trim();

  if (!v && askIfMissing) {
    v = (prompt("Nombre de este dispositivo (ej: iPhone Ana / iPhone Luis):", "") || "").trim();
    if (v) {
      try { localStorage.setItem("miviaje.deviceName", v); } catch {}
      try { localStorage.setItem(DEVICE_KEY, v); } catch {}
    }
  }
  return v || "Dispositivo";
}
function pushBackup(reason, fromPayloadMeta = null) {
  try {
    const meta = getMeta();
    const item = {
      savedAt: new Date().toISOString(),
      reason: reason || "backup",
      deviceName: getDeviceName(false),
      from: fromPayloadMeta || null,
      state
    };
    const list = JSON.parse(localStorage.getItem(BACKUPS_KEY) || "[]");
    list.unshift(item);
    localStorage.setItem(BACKUPS_KEY, JSON.stringify(list.slice(0, 15)));
  } catch {}
}
function getLatestBackup() {
  try {
    const list = JSON.parse(localStorage.getItem(BACKUPS_KEY) || "[]");
    return list?.[0] || null;
  } catch { return null; }
}

const emptyScenario = () => ({
  legs: [],
  stays: [],
  meals: { daily: 0, people: "", days: "" },
  activities: []
,
  dailyNotes: {}
});

let state = {
  scenario: "A",
  displayCurrency: "EUR",
  scenarios: { A: emptyScenario(), B: emptyScenario() },
  aiPick: { cities: [], items: [] } // chosen topics
};

function loadState() {
  try {
    const raw = localStorage.getItem(LS_KEY);
    if (raw) state = Object.assign(state, JSON.parse(raw));
  } catch {}
}
function saveState() {
  localStorage.setItem(LS_KEY, JSON.stringify(state));
  // Update sync meta so "lastSavedAt" reflects real editing time (not only export/import).
  try { setMeta({ lastSavedAt: new Date().toISOString() }); } catch {}
}
function curScenario() { return state.scenarios[state.scenario]; }

/* -------------------------- Currency convert ------------------------- */
/* Simple: no external API. Keeps values in display currency.
   You can later swap to real rates if needed. */
function setDisplayCurrency(cur) {
  state.displayCurrency = cur;
  $("sumCur").textContent = cur;
  $("mealCur").textContent = cur;
  saveState();
  renderAll();
  syncStickyTotalsHeightVar();
  }

/* ----------------------------- Accordion ----------------------------- */
function setupAccordion() {
  document.querySelectorAll("[data-acc]").forEach(btn => {
    btn.addEventListener("click", () => {
      const key = btn.getAttribute("data-acc");
      const body = document.querySelector(`[data-acc-body="${key}"]`);
      const wasHidden = body.classList.contains("hidden");
      body.classList.toggle("hidden");

    const isNowHidden = body.classList.contains("hidden");
    if (isNowHidden) {
      if (key === "legs") __sectionExpanded.legs.clear();
      if (key === "stays") __sectionExpanded.stays.clear();
      if (key === "acts") __sectionExpanded.activities.clear();
    } else {
      if (key === "legs") renderLegs();
      if (key === "stays") renderStays();
      if (key === "acts") renderActivities();
    }
      const icon = btn.querySelector(".accIcon");
      icon.textContent = body.classList.contains("hidden") ? "‚ñæ" : "‚ñ¥";
      updateFabVisibility();

      const isNowHidden2 = body.classList.contains("hidden");
      const justOpened = wasHidden && !isNowHidden2;
      const justClosed = (!wasHidden) && isNowHidden2;
      if (justClosed) {
        // V88G2C: never auto-scroll on close; cancel any pending re-landing pass
        window.__pendingLanding = false;
        window.__landingToken = (window.__landingToken || 0) + 1;
      }
    });
  });
}

function collapseAllAccordions() {
  document.querySelectorAll("[data-acc-body]").forEach(body => body.classList.add("hidden"));
  document.querySelectorAll("[data-acc] .accIcon").forEach(icon => { icon.textContent = "‚ñæ"; });
  updateFabVisibility();

  // v88b: also collapse per-item accordions (legs/stays/activities)
  try {
    __sectionExpanded.legs.clear();
    __sectionExpanded.stays.clear();
    __sectionExpanded.activities.clear();
  } catch {}

  // Re-render sections so items visually collapse
  try { renderLegs(); } catch {}
  try { renderStays(); } catch {}
  try { renderActivities(); } catch {}
}

/* ------------------------- Start state (V88D) ------------------------- */
function forceStartStateTimelineProtagonist() {
  // Ignore any persisted accordion openness: always start consistent.
  try { collapseAllAccordions(); } catch {}

  // Timeline open, other sections closed
  try { openAccordionKey("timeline"); } catch {}

  // Also collapse per-item accordions (so sections truly "start closed")
  try {
    __sectionExpanded.legs.clear();
    __sectionExpanded.stays.clear();
    __sectionExpanded.activities.clear();
  } catch {}

  // Always start at top of the page
  try { window.scrollTo({ top: 0, behavior: "auto" }); } catch {}
}



/* ------------------------- Reset current trip (V88H) ------------------------- */
function resetCurrentScenarioData() {
  const key = state && state.scenario ? state.scenario : "A";
  if (!state || !state.scenarios || !state.scenarios[key]) return;

  // Reset ONLY the active scenario
  state.scenarios[key] = emptyScenario();

  // Reset UI state tied to items (scenario-scoped in practice)
  try {
    __sectionExpanded.legs.clear();
    __sectionExpanded.stays.clear();
    __sectionExpanded.activities.clear();
  } catch {}

  // Persist + re-render
  try { saveState(); } catch {}
  try {
    // After reset: keep timeline in Global and keep sections folded like the base
    if (typeof timelineViewMode !== "undefined") timelineViewMode = "global";
    if (typeof activeDayISO !== "undefined") activeDayISO = "";
    if (typeof showTimelineNotice === "function") showTimelineNotice("");
  } catch {}

  try { renderAll(); } catch {}
  try { forceStartStateTimelineProtagonist(); } catch {}
  try { syncTopStackHeights(); } catch {}
}

function openResetTripConfirmModal() {
  const scLabel = (state && state.scenario === "B") ? "VIAJE ALTERNATIVO" : "MI VIAJE";

  const bodyHtml = `
    <div class="space-y-3">
      <div class="text-sm text-slate-700">
        Vas a borrar todos los datos de <span class="font-extrabold">${scLabel}</span>.
      </div>
      <div class="text-sm font-semibold text-red-700">
        Esta acci√≥n no se puede deshacer.
      </div>
      <div class="mt-2">
        <label class="text-xs text-slate-600">Escribe <span class="font-extrabold">BORRAR</span> para confirmar</label>
        <input id="resetTripConfirmInput" class="mt-1 w-full px-3 py-2 rounded-xl border border-slate-200" placeholder="BORRAR" autocomplete="off" />
      </div>
    </div>
  `;

  const btnCancel = document.createElement("button");
  btnCancel.className = "tap px-4 py-2 rounded-xl border border-slate-200 bg-white hover:bg-slate-50 text-sm font-semibold";
  btnCancel.textContent = "Cancelar";
  btnCancel.addEventListener("click", closeModal);

  const btnDelete = document.createElement("button");
  btnDelete.className = "tap px-4 py-2 rounded-xl bg-red-600 hover:bg-red-700 text-white text-sm font-semibold opacity-50 cursor-not-allowed";
  btnDelete.textContent = "Borrar";
  btnDelete.disabled = true;

  btnDelete.addEventListener("click", () => {
    if (btnDelete.disabled) return;
    closeModal();
    resetCurrentScenarioData();
  });

  showModal("Reiniciar este viaje", bodyHtml, [btnCancel, btnDelete]);

  // Wire input validation after modal is in DOM
  requestAnimationFrame(() => {
    const inp = document.getElementById("resetTripConfirmInput");
    if (!inp) return;
    inp.addEventListener("input", () => {
      const ok = String(inp.value || "").trim().toUpperCase() === "BORRAR";
      btnDelete.disabled = !ok;
      btnDelete.classList.toggle("opacity-50", !ok);
      btnDelete.classList.toggle("cursor-not-allowed", !ok);
    });
    inp.focus({ preventScroll: true });
  });
}
/* ----------------------- /Reset current trip (V88H) ----------------------- */


function anyAccordionOpen() {
  return !!document.querySelector('[data-acc-body]:not(.hidden)');
}

function updateFabVisibility() {
  const fab = document.getElementById('fabCollapseAll');
  if (!fab) return;
  fab.classList.toggle('hidden', !anyAccordionOpen());
}



/* ------------------------------ Rendering ---------------------------- */
function renderAll() {
  renderTabs();
  renderLegs();
  renderStays();
  renderMeals();
  renderActivities();
  renderTimeline();
  calcSummary();
  applyReadOnlyMode();
}

function renderTabs() {
  const a = document.getElementById("chipA");
  const b = document.getElementById("chipB");
  const onA = state.scenario === "A";

  if (a) a.className = "tap px-2.5 py-1.5 rounded-2xl text-xs font-extrabold " + (onA ? "bg-slate-900 text-white" : "bg-white text-slate-900 border border-slate-200");
  if (b) b.className = "tap px-2.5 py-1.5 rounded-2xl text-xs font-extrabold " + (!onA ? "bg-slate-900 text-white" : "bg-white text-slate-900 border border-slate-200");

  const curSel = document.getElementById("displayCurrency");
  if (curSel) curSel.value = state.displayCurrency;

  const cur = state.displayCurrency;
  const sumCur = document.getElementById("sumCur");
  const mealCur = document.getElementById("mealCur");
  if (sumCur) sumCur.textContent = cur;
  if (mealCur) mealCur.textContent = cur;
}

function legCard(leg) {
  const tzFrom = leg.tzFrom ? `<span class="text-xs text-slate-500">UTC ${leg.tzFrom >= 0 ? "+" : ""}${leg.tzFrom}</span>` : `<span class="text-xs text-slate-400">UTC ‚Äî</span>`;
  const tzTo   = leg.tzTo   ? `<span class="text-xs text-slate-500">UTC ${leg.tzTo   >= 0 ? "+" : ""}${leg.tzTo  }</span>` : `<span class="text-xs text-slate-400">UTC ‚Äî</span>`;
  const st = (typeof computeDoneStateGeneric==="function") ? computeDoneStateGeneric(leg, leg.date) : {done:false,auto:false,skipped:false};
  const ro = (localStorage.getItem("miviaje.readonly") === "1");
  const isOpen = __sectionExpanded.legs.has(leg.id);

  const route = `${(leg.from||"").trim() || "‚Äî"} ‚Üí ${(leg.to||"").trim() || "‚Äî"}`;
  const dt = `${(leg.date||"").trim() || "‚Äî"} ${(leg.time||"").trim() || "‚Äî"}`;
  const hasNotes = !!(leg.notes && String(leg.notes).trim());

  return `
  <div id="leg-${leg.id}" class="border border-slate-200 rounded-2xl p-4 bg-slate-50 ${st.done ? "done-item" : ""} ${st.skipped ? "skipped-item" : ""}">
    <div class="flex items-start justify-between gap-3 cursor-pointer" data-sec-toggle="legs" data-sec-id="${leg.id}">
      <div class="min-w-0">
        <div class="text-sm font-semibold truncate">üõ´ Transporte ¬∑ <span class="done-text">${escapeHtml(route)}</span></div>
        <div class="text-xs text-slate-600 mt-0.5">${escapeHtml(dt)} ${hasNotes ? `<span class="ml-1">üóíÔ∏è</span>` : ``}</div>
      </div>
      <div class="shrink-0 flex items-center gap-2">
        ${st.skipped ? `<span class="text-xs font-semibold skipped-badge">No realizado</span>` : (st.auto && st.done ? `<span class="text-xs auto-badge">Asumido</span>` : ``)}
      </div>
    </div>

    <div class="mt-3 ${isOpen ? "" : "hidden"}" data-sec-body="legs" data-sec-id="${leg.id}">
      <div class="grid grid-cols-1 sm:grid-cols-12 gap-3 items-end">
        <div class="sm:col-span-3">
          <label class="text-xs text-slate-600">Salida</label>
          <input data-leg-from="${leg.id}" class="mt-1 w-full px-3 py-2 rounded-xl border border-slate-200" value="${escapeHtml(leg.from)}" placeholder="Ciudad origen">
          <div class="mt-1">${tzFrom}</div>
        </div>
        <div class="sm:col-span-3">
          <label class="text-xs text-slate-600">Llegada</label>
          <input data-leg-to="${leg.id}" class="mt-1 w-full px-3 py-2 rounded-xl border border-slate-200" value="${escapeHtml(leg.to)}" placeholder="Ciudad destino">
          <div class="mt-1">${tzTo}</div>
        </div>
        <div class="sm:col-span-2">
          <label class="text-xs text-slate-600">Fecha</label>
          <input data-leg-date="${leg.id}" type="date" class="mt-1 w-full px-3 py-2 rounded-xl border border-slate-200" value="${escapeHtml(leg.date || "")}">
        </div>
        <div class="sm:col-span-2">
          <label class="text-xs text-slate-600">Hora (opcional)</label>
          <input data-leg-time="${leg.id}" type="time" class="mt-1 w-full px-3 py-2 rounded-xl border border-slate-200" value="${escapeHtml(leg.time || "")}">
        </div>
        <div class="sm:col-span-2">
          <label class="text-xs text-slate-600">Coste</label>
          <input data-leg-cost="${leg.id}" type="number" min="0" step="0.01" class="mt-1 w-full px-3 py-2 rounded-xl border border-slate-200" value="${escapeHtml(leg.cost ?? "")}" placeholder="0.00">
        </div>
        <div class="sm:col-span-2 flex items-center justify-between gap-2">
          <label class="flex items-center gap-2 text-xs text-slate-600">
            <input type="checkbox" class="h-4 w-4" data-leg-done="${leg.id}" ${st.done ? "checked" : ""} ${ro ? "disabled" : ""}>
            Hecho
          </label>
          <button data-leg-del="${leg.id}" class="tap px-3 py-2 rounded-xl bg-white border border-slate-200 hover:bg-slate-100 text-sm">üóëÔ∏è</button>
        </div>
      </div>
    </div>
  </div>`;
}

function renderLegs() {
  const box = $("legsList");
  const sc = curScenario();
  sortByDateTimeEmptyFirst(sc.legs);
  box.innerHTML = sc.legs.length ? sc.legs.map(legCard).join("") : `<div class="text-sm text-slate-500">A√±ade trayectos para construir tu ruta.</div>`;

  // v80b: accordion per item (legs)
  box.querySelectorAll("[data-sec-toggle=\"legs\"]").forEach(h => h.addEventListener("click", (e) => {
    if (e.target.closest("button, input, textarea, select, a, label")) return;
    const id = h.getAttribute("data-sec-id");
    if (!id) return;
    if (__sectionExpanded.legs.has(id)) __sectionExpanded.legs.delete(id);
    else __sectionExpanded.legs.add(id);
    const prevTop = box.scrollTop;
    renderLegs();
    box.scrollTop = prevTop;
  }));

  box.querySelectorAll("[data-leg-del]").forEach(b => b.addEventListener("click", (e) => {
    e.preventDefault();
    e.stopPropagation();

    const id = b.getAttribute("data-leg-del");
    sc.legs = sc.legs.filter(x => x.id !== id);
    __sectionExpanded.legs.delete(id);

    saveState();
    renderTimeline();
    calcSummary();
    renderLegs();
  }));

  box.querySelectorAll("[data-leg-from]").forEach(inp => inp.addEventListener("change", async () => {
    const id = inp.getAttribute("data-leg-from");
    const leg = sc.legs.find(x => x.id === id);
    leg.from = cap1(inp.value);
    inp.value = leg.from;
    saveState(); renderAll();
    await updateTimezoneForLeg(id, "from");
  }));
  box.querySelectorAll("[data-leg-to]").forEach(inp => inp.addEventListener("change", async () => {
    const id = inp.getAttribute("data-leg-to");
    const leg = sc.legs.find(x => x.id === id);
    leg.to = cap1(inp.value);
    inp.value = leg.to;
    saveState(); renderAll();
    await updateTimezoneForLeg(id, "to");
  }));
  box.querySelectorAll("[data-leg-date]").forEach(inp => inp.addEventListener("change", () => {
    const id = inp.getAttribute("data-leg-date");
    const leg = sc.legs.find(x => x.id === id);
    leg.date = inp.value;
    sortByDateTimeEmptyFirst(sc.legs);
    saveState(); renderAll();
  }));
  box.querySelectorAll("[data-leg-time]").forEach(inp => inp.addEventListener("change", () => {
    const id = inp.getAttribute("data-leg-time");
    const leg = sc.legs.find(x => x.id === id);
    leg.time = inp.value;
    sortByDateTimeEmptyFirst(sc.legs);
    saveState(); renderTimeline();
  }));
  box.querySelectorAll("[data-leg-cost]").forEach(inp => inp.addEventListener("input", () => {
    const id = inp.getAttribute("data-leg-cost");
    const leg = sc.legs.find(x => x.id === id);
    leg.cost = parseMoney(inp.value);
    saveState(); calcSummary(); renderTimeline();
  }));

  box.querySelectorAll("[data-leg-done]").forEach(cb => cb.addEventListener("change", () => {
    handleLegDoneToggle(cb.getAttribute("data-leg-done"), cb.checked, cb);
  }));
}

function stayCard(stay) {
  const st = (typeof computeDoneStateGeneric==="function") ? computeDoneStateGeneric(stay, stay.date || "") : {done:false,auto:false,skipped:false};
  const ro = (localStorage.getItem("miviaje.readonly") === "1");
  const isOpen = __sectionExpanded.stays.has(stay.id);

  const city = (stay.city||"").trim() || "‚Äî";
  const name = (stay.name||"").trim() || "‚Äî";
  const dt = `${(stay.date||"").trim() || "‚Äî"} ${(stay.time||"").trim() || "‚Äî"}`;
  const hasNotes = !!(stay.notes && String(stay.notes).trim());

  return `
  <div class="border border-slate-200 rounded-2xl p-4 bg-slate-50 ${st.done ? "done-item" : ""} ${st.skipped ? "skipped-item" : ""}">
    <div class="flex items-start justify-between gap-3 cursor-pointer" data-sec-toggle="stays" data-sec-id="${stay.id}">
      <div class="min-w-0">
        <div class="text-sm font-semibold truncate">üè® Alojamiento ¬∑ <span class="done-text">${escapeHtml(city)} ‚Äî ${escapeHtml(name)}</span></div>
        <div class="text-xs text-slate-600 mt-0.5">${escapeHtml(dt)} ${hasNotes ? `<span class="ml-1">üóíÔ∏è</span>` : ``}</div>
      </div>
      <div class="shrink-0 flex items-center gap-2">
        ${st.skipped ? `<span class="text-xs font-semibold skipped-badge">No realizado</span>` : (st.auto && st.done ? `<span class="text-xs auto-badge">Asumido</span>` : ``)}
      </div>
    </div>

    <div class="mt-3 ${isOpen ? "" : "hidden"}" data-sec-body="stays" data-sec-id="${stay.id}">
      <div class="grid grid-cols-1 sm:grid-cols-12 gap-3 items-end">
        <div class="sm:col-span-4">
          <label class="text-xs text-slate-600">Ciudad</label>
          <input data-stay-city="${stay.id}" class="mt-1 w-full px-3 py-2 rounded-xl border border-slate-200" value="${escapeHtml(stay.city)}" placeholder="Ciudad">
        </div>
        <div class="sm:col-span-4">
          <label class="text-xs text-slate-600">Alojamiento</label>
          <input data-stay-name="${stay.id}" class="mt-1 w-full px-3 py-2 rounded-xl border border-slate-200" value="${escapeHtml(stay.name)}" placeholder="Hotel / Airbnb / Camping‚Ä¶">
        </div>
        <div class="sm:col-span-2">
          <label class="text-xs text-slate-600">Fecha (check-in)</label>
          <input data-stay-date="${stay.id}" type="date" class="mt-1 w-full px-3 py-2 rounded-xl border border-slate-200" value="${escapeHtml(stay.date || "")}">
        </div>
        <div class="sm:col-span-2">
          <label class="text-xs text-slate-600">Hora (opcional)</label>
          <input data-stay-time="${stay.id}" type="time" class="mt-1 w-full px-3 py-2 rounded-xl border border-slate-200" value="${escapeHtml(stay.time || "")}">
        </div>

        <div class="sm:col-span-2">
          <label class="text-xs text-slate-600">Noches</label>
          <input data-stay-nights="${stay.id}" type="number" min="1" step="1" class="mt-1 w-full px-3 py-2 rounded-xl border border-slate-200" value="${escapeHtml(stay.nights ?? 1)}">
        </div>
        <div class="sm:col-span-2">
          <label class="text-xs text-slate-600">Coste</label>
          <input data-stay-cost="${stay.id}" type="number" min="0" step="0.01" class="mt-1 w-full px-3 py-2 rounded-xl border border-slate-200" value="${escapeHtml(stay.cost ?? "")}">
        </div>
        <div class="sm:col-span-2 flex flex-col items-end gap-2">
          <label class="flex items-center gap-2 text-xs text-slate-600">
            <input type="checkbox" class="h-4 w-4" data-stay-done="${stay.id}" ${st.done ? "checked" : ""} ${ro ? "disabled" : ""}>
            Hecho
          </label>
          ${st.skipped ? `<span class="text-xs font-semibold skipped-badge">No realizado</span>` : ``}
          <button data-stay-del="${stay.id}" class="tap px-3 py-2 rounded-xl bg-white border border-slate-200 hover:bg-slate-100 text-sm">üóëÔ∏è</button>
        </div>
      </div>
    </div>
  </div>`;
}
function renderStays() {
  const box = $("staysList");
  const sc = curScenario();
  sortByDateTimeEmptyFirst(sc.stays);
  box.innerHTML = sc.stays.length ? sc.stays.map(stayCard).join("") : `<div class="text-sm text-slate-500">A√±ade alojamientos para estimar noches y coste.</div>`;

  // v80b: accordion per item (stays)
  box.querySelectorAll("[data-sec-toggle=\"stays\"]").forEach(h => h.addEventListener("click", (e) => {
    if (e.target.closest("button, input, textarea, select, a, label")) return;
    const id = h.getAttribute("data-sec-id");
    if (!id) return;
    if (__sectionExpanded.stays.has(id)) __sectionExpanded.stays.delete(id);
    else __sectionExpanded.stays.add(id);
    const prevTop = box.scrollTop;
    renderStays();
    box.scrollTop = prevTop;
  }));

  box.querySelectorAll("[data-stay-del]").forEach(b => b.addEventListener("click", () => {
    const id = b.getAttribute("data-stay-del");
    sc.stays = sc.stays.filter(x => x.id !== id);
    __sectionExpanded.stays.delete(id);
    saveState(); renderAll();
  }));
  box.querySelectorAll("[data-stay-city]").forEach(inp => inp.addEventListener("change", () => {
    const id = inp.getAttribute("data-stay-city");
    const s = sc.stays.find(x => x.id === id);
    s.city = cap1(inp.value); inp.value = s.city;
    saveState(); renderTimeline();
  }));
  box.querySelectorAll("[data-stay-date]").forEach(inp => inp.addEventListener("change", () => {
    const id = inp.getAttribute("data-stay-date");
    sc.stays.find(x => x.id === id).date = inp.value;
    sortByDateTimeEmptyFirst(sc.stays);
    saveState(); renderTimeline();
  }));
  box.querySelectorAll("[data-stay-time]").forEach(inp => inp.addEventListener("change", () => {
    const id = inp.getAttribute("data-stay-time");
    sc.stays.find(x => x.id === id).time = inp.value;
    sortByDateTimeEmptyFirst(sc.stays);
    saveState(); renderTimeline();
  }));
  box.querySelectorAll("[data-stay-name]").forEach(inp => inp.addEventListener("change", () => {
    const id = inp.getAttribute("data-stay-name");
    sc.stays.find(x => x.id === id).name = inp.value.trim();
    saveState(); renderTimeline();
  }));
  box.querySelectorAll("[data-stay-nights]").forEach(inp => inp.addEventListener("input", () => {
    const id = inp.getAttribute("data-stay-nights");
    sc.stays.find(x => x.id === id).nights = Math.max(1, parseInt(inp.value || "1",10));
    saveState(); calcSummary();
  }));
  box.querySelectorAll("[data-stay-cost]").forEach(inp => inp.addEventListener("input", () => {
    const id = inp.getAttribute("data-stay-cost");
    sc.stays.find(x => x.id === id).cost = parseMoney(inp.value);
    saveState(); calcSummary();
  }));

  box.querySelectorAll("[data-stay-done]").forEach(cb => cb.addEventListener("change", () => {
    handleStayDoneToggle(cb.getAttribute("data-stay-done"), cb.checked, cb);
  }));
}

function renderMeals() {
  const sc = curScenario();
  $("mealDaily").value = sc.meals.daily ?? 0;

  // Permitir vac√≠o en UI (si est√° vac√≠o, el c√°lculo tratar√° como 1)
  $("mealPeople").value = (sc.meals.people === "" || sc.meals.people == null) ? "" : sc.meals.people;
  $("mealDays").value = (sc.meals.days === "" || sc.meals.days == null) ? "" : sc.meals.days;

  const total = (
    parseMoney(sc.meals.daily) *
    (parseInt(sc.meals.people || 1, 10)) *
    (parseInt(sc.meals.days || 1, 10))
  );
  $("mealTotal").textContent = total.toFixed(2);
}

/* ---------------- Activities: smart done ---------------- */

function todayKey() {
  const d = new Date();
  const y = d.getFullYear();
  const m = String(d.getMonth() + 1).padStart(2, "0");
  const day = String(d.getDate()).padStart(2, "0");
  return `${y}-${m}-${day}`;
}

// Devuelve -1, 0, 1 comparando YYYY-MM-DD (lexicogr√°fico funciona)
function cmpDate(a, b) {
  const A = String(a || "");
  const B = String(b || "");
  if (A === B) return 0;
  return A < B ? -1 : 1;
}

function isPast(dateKey) {
  return cmpDate(String(dateKey || ""), todayKey()) < 0;
}
function isFuture(dateKey) {
  return cmpDate(String(dateKey || ""), todayKey()) > 0;
}/* Timeline category filter (in-memory, no persistence) */
// Timeline view mode (UI only, not persisted)
let timelineViewMode = "global"; // "global" | "day"
let activeDayISO = ""; // used only in day mode
window.__tlControlsTemplateHTML = window.__tlControlsTemplateHTML || "";
let __tlDays = []; // derived cache of available days in current filtered timeline
let __tlLastFilteredItems = []; // cache of current filtered timeline items (in-memory only)

const timelineFilterState = {
  categories: new Set() // empty = show all
};

function sanitizeTimelineFilterState() {
  // Meals is NOT an event category. If old localStorage contains it, drop it safely.
  const allowed = new Set(["Transporte", "Alojamiento", "Actividades"]);
  const cats = timelineFilterState.categories;
  if (!cats || typeof cats.forEach !== "function") return;
  Array.from(cats).forEach(v => { if (!allowed.has(v)) cats.delete(v); });
}


function timelineItemCategory(item) {
  const t = String(item?.type || "").toLowerCase();
  if (t.includes("trayecto") || t.includes("transporte")) return "Transporte";
  if (t.includes("alojamiento")) return "Alojamiento";
  if (t.includes("actividad")) return "Actividades";
  return "";
}

// Pure filter: does not mutate input list
function getFilteredItems(allItems) {
  const cats = timelineFilterState.categories;
  if (!cats || cats.size === 0) return allItems;
  return (allItems || []).filter(it => {
    const c = timelineItemCategory(it);
    return c && cats.has(c);
  });
}

function renderTimelineFilterChips() {
  sanitizeTimelineFilterState();
  const host = document.getElementById("timelineFilterChips");
  if (!host) return;

  const cats = ["Transporte", "Alojamiento", "Actividades"];
  const active = timelineFilterState.categories;

  const chipClass = (isActive) =>
    "tap shrink-0 px-3 py-1.5 rounded-full text-xs font-semibold border " +
    (isActive ? "bg-slate-900 text-white border-slate-900" : "bg-white text-slate-700 border-slate-200");

  const allActive = active.size === 0;

  host.innerHTML = `
    <button class="${chipClass(allActive)}" data-tlchip="ALL">Todos</button>
    ${cats.map(c => `<button class="${chipClass(active.has(c))}" data-tlchip="${c}">${c}</button>`).join("")}
  `;

  host.querySelectorAll("[data-tlchip]").forEach(btn => {
    btn.onclick = () => {
      const v = btn.getAttribute("data-tlchip") || "";
      if (v === "ALL") {
        active.clear();
      } else {
        if (active.has(v)) active.delete(v); else active.add(v);
      }
      renderTimelineFilterChips();
      renderTimeline();
    };
  });
}


// Orden: sin fecha primero (para editar), luego por fecha+hora (24h). Sin hora -> final del d√≠a.

function sortByDateTimeEmptyFirst(list) {
  if (!Array.isArray(list)) return list;
  list.sort((a, b) => {
    const ad = String(a?.date || "").trim();
    const bd = String(b?.date || "").trim();
    if (!ad && bd) return -1;
    if (ad && !bd) return 1;
    if (ad && bd && ad !== bd) return ad < bd ? -1 : 1;
    const at = timeSortKey(a?.time);
    const bt = timeSortKey(b?.time);
    if (at !== bt) return at - bt;
    return String(a?.id || "").localeCompare(String(b?.id || ""));
  });
  return list;
}


function timeToMinutes(t) {
  const v = String(t || "").trim();
  if (!/^\d{2}:\d{2}$/.test(v)) return null;
  const hh = parseInt(v.slice(0,2), 10);
  const mm = parseInt(v.slice(3,5), 10);
  if (Number.isNaN(hh) || Number.isNaN(mm) || hh < 0 || hh > 23 || mm < 0 || mm > 59) return null;
  return hh * 60 + mm;
}

function timeSortKey(t) {
  const m = timeToMinutes(t);
  // Sin hora => al final del d√≠a
  return (m === null) ? (24 * 60 + 1) : m;
}

function promptDate(defaultKey) {
  const def = defaultKey || todayKey();
  const raw = prompt("Fecha (YYYY-MM-DD):", def);
  if (raw === null) return null;
  const v = String(raw).trim();
  if (!/^\d{4}-\d{2}-\d{2}$/.test(v)) return null;

  const d = new Date(v + "T00:00:00");
  if (Number.isNaN(d.getTime())) return null;

  const y = d.getFullYear();
  const m = String(d.getMonth() + 1).padStart(2, "0");
  const day = String(d.getDate()).padStart(2, "0");
  const norm = `${y}-${m}-${day}`;
  return norm === v ? v : null;
}

// Estado visual (no altera datos)
function computeDoneState(act) {
  const dateKey = String(act?.date || "");
  if (act?.doneManual === true) return { done: true, auto: false, skipped: false };
  if (act?.skipped === true) return { done: false, auto: false, skipped: true };
  if (dateKey && isPast(dateKey)) return { done: true, auto: true, skipped: false };
  return { done: false, auto: false, skipped: false };
}

function handleActDoneToggle(id, targetChecked, el) {
  const sc = curScenario();
  const act = (sc?.activities || []).find(a => String(a.id) === String(id));
  if (!act) return;

  const prevVisual = computeDoneState(act);
  const prevChecked = !!prevVisual.done;

  const today = todayKey();
  const dateKey = String(act.date || "");

  if (localStorage.getItem("miviaje.readonly") === "1") {
    if (el) el.checked = prevChecked;
    return;
  }

  if (targetChecked === true) {
    // Sin fecha: permitir asignar fecha si el usuario quiere
    if (!dateKey) {
      const choice = prompt(
        "Evento sin fecha. ¬øQu√© quieres hacer?\n" +
        "1 = Hecho (sin fecha)\n" +
        "2 = Hecho y asignar a HOY\n" +
        "3 = Hecho y elegir fecha‚Ä¶\n\n" +
        "Escribe 1, 2 o 3:",
        "2"
      );
      if (choice === null) { if (el) el.checked = prevChecked; return; }
      const c = String(choice).trim();
      if (c === "1") { act.doneManual = true; act.skipped = false; }
      else if (c === "2") { act.doneManual = true; act.skipped = false; act.date = today; }
      else if (c === "3") {
        const nd = promptDate(today);
        if (nd === null) { if (el) el.checked = prevChecked; return; }
        act.doneManual = true; act.skipped = false; act.date = nd;
      } else { if (el) el.checked = prevChecked; return; }
      saveState();
      renderActivities();
      if (typeof renderTimeline === "function") renderTimeline();
      if (typeof calcSummary === "function") calcSummary();
      return;
    }
    if (dateKey && isFuture(dateKey)) {
      const choice = prompt(
        "Evento futuro. ¬øQu√© quieres hacer?\n" +
        "1 = Hecho (mantener fecha)\n" +
        "2 = Hecho y mover a HOY\n" +
        "3 = Hecho y elegir fecha‚Ä¶\n\n" +
        "Escribe 1, 2 o 3:",
        "2"
      );
      if (choice === null) {
        if (el) el.checked = prevChecked;
        return;
      }
      const c = String(choice).trim();

      if (c === "1") {
        act.doneManual = true;
        act.skipped = false;
      } else if (c === "2") {
        act.doneManual = true;
        act.skipped = false;
        act.date = today;
      } else if (c === "3") {
        const nd = promptDate(today);
        if (nd === null) {
          if (el) el.checked = prevChecked;
          return;
        }
        act.doneManual = true;
        act.skipped = false;
        act.date = nd;
      } else {
        if (el) el.checked = prevChecked;
        return;
      }
    } else {
      act.doneManual = true;
      act.skipped = false;
    }

    saveState();
    renderActivities();
    if (typeof renderTimeline === "function") renderTimeline();
    if (typeof calcSummary === "function") calcSummary();
    return;
  }

  if (targetChecked === false) {
    if (dateKey && isPast(dateKey)) {
      const choice = prompt(
        "Evento pasado. ¬øQu√© quieres hacer?\n" +
        "1 = No realizado (mantener fecha)\n" +
        "2 = Reprogramar\n\n" +
        "Escribe 1 o 2:",
        "1"
      );
      if (choice === null) {
        if (el) el.checked = prevChecked;
        return;
      }
      const c = String(choice).trim();

      if (c === "1") {
        act.doneManual = false;
        act.skipped = true;
      } else if (c === "2") {
        const d = new Date();
        d.setDate(d.getDate() + 1);
        const y = d.getFullYear();
        const m = String(d.getMonth() + 1).padStart(2, "0");
        const day = String(d.getDate()).padStart(2, "0");
        const def = `${y}-${m}-${day}`;

        const nd = promptDate(def);
        if (nd === null) {
          if (el) el.checked = prevChecked;
          return;
        }
        act.date = nd;
        act.doneManual = false;
        act.skipped = false;
      } else {
        if (el) el.checked = prevChecked;
        return;
      }
    } else {
      act.doneManual = false;
      act.skipped = false;
    }

    saveState();
    renderActivities();
    if (typeof renderTimeline === "function") renderTimeline();
    if (typeof calcSummary === "function") calcSummary();
  }
}

/* ---------------- Legs/Stays: smart done (v32+) ---------------- */
// Estado visual gen√©rico para elementos con fecha (legs) o sin fecha (stays)
function computeDoneStateGeneric(item, dateKey) {
  const dk = String(dateKey || "");
  if (item?.doneManual === true) return { done: true, auto: false, skipped: false };
  if (item?.skipped === true) return { done: false, auto: false, skipped: true };
  if (dk && isPast(dk)) return { done: true, auto: true, skipped: false };
  return { done: false, auto: false, skipped: false };
}

function handleLegDoneToggle(id, targetChecked, el) {
  const sc = curScenario();
  const leg = (sc?.legs || []).find(l => String(l.id) === String(id));
  if (!leg) return;

  const prevVisual = computeDoneStateGeneric(leg, leg.date);
  const prevChecked = !!prevVisual.done;

  if (localStorage.getItem("miviaje.readonly") === "1") {
    if (el) el.checked = prevChecked;
    return;
  }

  const today = todayKey();
  const dateKey = String(leg.date || "");

  if (targetChecked === true) {
    // Sin fecha: permitir asignar fecha si el usuario quiere
    if (!dateKey) {
      const choice = prompt(
        "Evento sin fecha. ¬øQu√© quieres hacer?\n" +
        "1 = Hecho (sin fecha)\n" +
        "2 = Hecho y asignar a HOY\n" +
        "3 = Hecho y elegir fecha‚Ä¶\n\n" +
        "Escribe 1, 2 o 3:",
        "2"
      );
      if (choice === null) { if (el) el.checked = prevChecked; return; }
      const c = String(choice).trim();
      if (c === "1") { leg.doneManual = true; leg.skipped = false; }
      else if (c === "2") { leg.doneManual = true; leg.skipped = false; leg.date = today; }
      else if (c === "3") {
        const nd = promptDate(today);
        if (nd === null) { if (el) el.checked = prevChecked; return; }
        leg.doneManual = true; leg.skipped = false; leg.date = nd;
      } else { if (el) el.checked = prevChecked; return; }
      saveState();
      renderLegs();
      if (typeof renderTimeline === "function") renderTimeline();
      if (typeof calcSummary === "function") calcSummary();
      return;
    }
    if (dateKey && isFuture(dateKey)) {
      const choice = prompt(
        "Trayecto futuro. ¬øQu√© quieres hacer?\n" +
        "1 = Hecho (mantener fecha)\n" +
        "2 = Hecho y mover a HOY\n" +
        "3 = Hecho y elegir fecha‚Ä¶\n\n" +
        "Escribe 1, 2 o 3:",
        "2"
      );
      if (choice === null) { if (el) el.checked = prevChecked; return; }
      const c = String(choice).trim();
      if (c === "1") {
        leg.doneManual = true; leg.skipped = false;
      } else if (c === "2") {
        leg.doneManual = true; leg.skipped = false; leg.date = today;
      } else if (c === "3") {
        const nd = promptDate(today);
        if (nd === null) { if (el) el.checked = prevChecked; return; }
        leg.doneManual = true; leg.skipped = false; leg.date = nd;
      } else { if (el) el.checked = prevChecked; return; }
    } else {
      leg.doneManual = true; leg.skipped = false;
    }
    saveState(); renderLegs(); if (typeof renderTimeline === "function") renderTimeline(); if (typeof calcSummary === "function") calcSummary();
    return;
  }

  // targetChecked === false
  if (dateKey && isPast(dateKey)) {
    const choice = prompt(
      "Trayecto pasado. ¬øQu√© quieres hacer?\n" +
      "1 = No realizado (mantener fecha)\n" +
      "2 = Reprogramar\n\n" +
      "Escribe 1 o 2:",
      "1"
    );
    if (choice === null) { if (el) el.checked = prevChecked; return; }
    const c = String(choice).trim();
    if (c === "1") {
      leg.doneManual = false; leg.skipped = true;
    } else if (c === "2") {
      const d = new Date(); d.setDate(d.getDate() + 1);
      const def = d.toISOString().slice(0,10);
      const nd = promptDate(def);
      if (nd === null) { if (el) el.checked = prevChecked; return; }
      leg.date = nd; leg.doneManual = false; leg.skipped = false;
    } else { if (el) el.checked = prevChecked; return; }
  } else {
    leg.doneManual = false; leg.skipped = false;
  }
  saveState(); renderLegs(); if (typeof renderTimeline === "function") renderTimeline(); if (typeof calcSummary === "function") calcSummary();
}

function handleStayDoneToggle(id, targetChecked, el) {
  const sc = curScenario();
  const stay = (sc?.stays || []).find(s => String(s.id) === String(id));
  if (!stay) return;

  const prevVisual = computeDoneStateGeneric(stay, stay.date || ""); // stays no tienen fecha en este build
  const prevChecked = !!prevVisual.done;

  if (localStorage.getItem("miviaje.readonly") === "1") {
    if (el) el.checked = prevChecked;
    return;
  }

  if (targetChecked === true) {
    stay.doneManual = true; stay.skipped = false;
    saveState(); renderStays(); if (typeof renderTimeline === "function") renderTimeline(); if (typeof calcSummary === "function") calcSummary();
    return;
  }

  // OFF: confirmaci√≥n si estaba marcado manual
  if (stay.doneManual === true) {
    const ok = confirm("¬øMarcar este alojamiento como NO realizado?\n(Se mantendr√° en la lista, pero como no realizado.)");
    if (!ok) { if (el) el.checked = prevChecked; return; }
    stay.doneManual = false; stay.skipped = true;
  } else {
    stay.doneManual = false; stay.skipped = false;
  }

  saveState(); renderStays(); if (typeof renderTimeline === "function") renderTimeline(); if (typeof calcSummary === "function") calcSummary();
}
/* ---------------- /Legs/Stays: smart done ---------------- */


/* ---------------- /Activities: smart done ---------------- */


function actCard(act) {
  const st = computeDoneState(act);
  const ro = (localStorage.getItem("miviaje.readonly") === "1");
  const isOpen = __sectionExpanded.activities.has(act.id);

  const title = (act.title||"").trim() || "‚Äî";
  const city = (act.city||"").trim() || "‚Äî";
  const dt = `${(act.date||"").trim() || "‚Äî"} ${(act.time||"").trim() || "‚Äî"}`;
  const hasNotes = !!(act.notes && String(act.notes).trim());

  return `
  <div id="act-${act.id}" class="border border-slate-200 rounded-2xl p-4 bg-slate-50 ${st.done ? 'done-item' : ''} ${st.skipped ? 'skipped-item' : ''}">
    <div class="flex items-start justify-between gap-3 cursor-pointer" data-sec-toggle="activities" data-sec-id="${act.id}">
      <div class="min-w-0">
        <div class="text-sm font-semibold truncate">üéØ Actividad ¬∑ <span class="done-text">${escapeHtml(title)}</span> <span class="text-slate-500">(${escapeHtml(city)})</span></div>
        <div class="text-xs text-slate-600 mt-0.5">${escapeHtml(dt)} ${hasNotes ? `<span class="ml-1">üóíÔ∏è</span>` : ``}</div>
      </div>
      <div class="shrink-0 flex items-center gap-2">
        ${st.skipped ? `<span class="text-xs font-semibold skipped-badge">No realizado</span>` : (st.auto && st.done ? `<span class="text-xs auto-badge">Asumido</span>` : ``)}
      </div>
    </div>

    <div class="mt-3 ${isOpen ? "" : "hidden"}" data-sec-body="activities" data-sec-id="${act.id}">
      <div class="grid grid-cols-1 sm:grid-cols-12 gap-3 items-end">
        <div class="sm:col-span-4">
          <label class="text-xs text-slate-600">Actividad</label>
          <input data-act-title="${act.id}" class="mt-1 w-full px-3 py-2 rounded-xl border border-slate-200 ${st.done ? 'done-text' : ''}" value="${escapeHtml(act.title)}" placeholder="Ej: Museo / Tour / Restaurante">
        </div>
        <div class="sm:col-span-3">
          <label class="text-xs text-slate-600">Ciudad</label>
          <input data-act-city="${act.id}" class="mt-1 w-full px-3 py-2 rounded-xl border border-slate-200 ${st.done ? 'done-text' : ''}" value="${escapeHtml(act.city)}" placeholder="Ciudad">
        </div>
        <div class="sm:col-span-2">
          <label class="text-xs text-slate-600">Fecha</label>
          <input data-act-date="${act.id}" type="date" class="mt-1 w-full px-3 py-2 rounded-xl border border-slate-200 ${st.done ? 'done-text' : ''}" value="${escapeHtml(act.date||"")}">
        </div>
        <div class="sm:col-span-2">
          <label class="text-xs text-slate-600">Hora (opcional)</label>
          <input data-act-time="${act.id}" type="time" class="mt-1 w-full px-3 py-2 rounded-xl border border-slate-200 ${st.done ? 'done-text' : ''}" value="${escapeHtml(act.time||"")}">
        </div>
        <div class="sm:col-span-2">
          <label class="text-xs text-slate-600">Coste</label>
          <input data-act-cost="${act.id}" type="number" min="0" step="0.01" class="mt-1 w-full px-3 py-2 rounded-xl border border-slate-200 ${st.done ? 'done-text' : ''}" value="${escapeHtml(act.cost ?? "")}">
        </div>
        <div class="sm:col-span-1 flex justify-end gap-2 items-center">
          <label class="flex items-center gap-2 text-xs text-slate-600">
            <input type="checkbox" class="h-4 w-4" data-act-done="${act.id}" ${st.done ? "checked" : ""} ${ro ? "disabled" : ""}>
            Hecho
          </label>
          <button data-act-del="${act.id}" class="tap px-3 py-2 rounded-xl bg-white border border-slate-200 hover:bg-slate-100 text-sm">üóëÔ∏è</button>
        </div>
      </div>
      <div class="mt-2 flex items-center gap-3 text-xs">
        ${st.skipped ? `<span class="font-semibold skipped-badge">No realizado</span>` : ``}
        ${(!st.skipped && st.auto) ? `<span class="auto-badge">Asumido</span>` : ``}
        ${act.fromAI ? `<span class="text-slate-500">A√±adida desde IA</span>` : ``}
      </div>
    </div>
  </div>`;
}

function renderActivities() {
  const box = $("actsList");
  const sc = curScenario();
  sortByDateTimeEmptyFirst(sc.activities);
  box.innerHTML = sc.activities.length ? sc.activities.map(actCard).join("") : `<div class="text-sm text-slate-500">A√±ade actividades o incorpora sugerencias desde la IA.</div>`;

  // v80b: accordion per item (activities)
  box.querySelectorAll("[data-sec-toggle=\"activities\"]").forEach(h => h.addEventListener("click", (e) => {
    if (e.target.closest("button, input, textarea, select, a, label")) return;
    const id = h.getAttribute("data-sec-id");
    if (!id) return;
    if (__sectionExpanded.activities.has(id)) __sectionExpanded.activities.delete(id);
    else __sectionExpanded.activities.add(id);
    const prevTop = box.scrollTop;
    renderActivities();
    box.scrollTop = prevTop;
  }));

  box.querySelectorAll("[data-act-del]").forEach(b => b.addEventListener("click", () => {
    const id = b.getAttribute("data-act-del");
    sc.activities = sc.activities.filter(x => x.id !== id);
    __sectionExpanded.activities.delete(id);
    saveState(); renderAll();
  }));
  box.querySelectorAll("[data-act-title]").forEach(inp => inp.addEventListener("change", () => {
    const id = inp.getAttribute("data-act-title");
    sc.activities.find(x => x.id === id).title = inp.value.trim();
    saveState(); renderTimeline();
  }));
  box.querySelectorAll("[data-act-city]").forEach(inp => inp.addEventListener("change", () => {
    const id = inp.getAttribute("data-act-city");
    const a = sc.activities.find(x => x.id === id);
    a.city = cap1(inp.value); inp.value = a.city;
    saveState(); renderTimeline();
  }));
  box.querySelectorAll("[data-act-date]").forEach(inp => inp.addEventListener("change", () => {
    const id = inp.getAttribute("data-act-date");
    sc.activities.find(x => x.id === id).date = inp.value;
    sortByDateTimeEmptyFirst(sc.activities);
    saveState(); renderTimeline();
  }));
  box.querySelectorAll("[data-act-time]").forEach(inp => inp.addEventListener("change", () => {
    const id = inp.getAttribute("data-act-time");
    sc.activities.find(x => x.id === id).time = inp.value;
    sortByDateTimeEmptyFirst(sc.activities);
    saveState(); renderTimeline();
  }));
  box.querySelectorAll("[data-act-cost]").forEach(inp => inp.addEventListener("input", () => {
    const id = inp.getAttribute("data-act-cost");
    sc.activities.find(x => x.id === id).cost = parseMoney(inp.value);
    saveState(); calcSummary();
  }));
  box.querySelectorAll("[data-act-done]").forEach(cb => cb.addEventListener("change", () => {
    handleActDoneToggle(cb.getAttribute("data-act-done"), cb.checked, cb);
  }));

}


/* ---------------- Timeline: jump to item ---------------- */
function openAccordionKey(key) {
  const body = document.querySelector(`[data-acc-body="${key}"]`);
  const btn = document.querySelector(`[data-acc="${key}"]`);
  if (!body || !btn) return;
  if (body.classList.contains("hidden")) btn.click();
}

function scrollAccordionBodyToTop(key) {
  const body = document.querySelector(`[data-acc-body="${key}"]`);
  if (!body) return;
  try { body.scrollTop = 0; } catch {}
}


function jumpToItem(kind, id) {
  const k = String(kind || "");
  const itemId = String(id || "");
  if (!k || !itemId) return;

  const map = {
    leg:  { acc: "legs",  secToggle: "legs" },
    stay: { acc: "stays", secToggle: "stays" },
    act:  { acc: "acts",  secToggle: "activities" }
  };
  const cfg = map[k];
  if (!cfg) return;

  // 1) Open target accordion section
  openAccordionKey(cfg.acc);

  // 2) Expand target item within section (v80b accordion)
  if (k === "leg") { __sectionExpanded.legs.add(itemId); renderLegs(); }
  else if (k === "stay") { __sectionExpanded.stays.add(itemId); renderStays(); }
  else if (k === "act") { __sectionExpanded.activities.add(itemId); renderActivities(); }

  const accBtn = document.querySelector(`[data-acc="${cfg.acc}"]`);
  const itemEl = document.querySelector(`[data-sec-toggle="${cfg.secToggle}"][data-sec-id="${CSS.escape(itemId)}"]`);

  // 3) After DOM settles, land the target item under Totals (premium, 2-pass only if needed)
  setTimeout(() => {
    const el = itemEl || document.querySelector(`[data-sec-id="${CSS.escape(itemId)}"]`);
    if (el) {
      landUnderTotals(el, 16);
      try { el.focus({ preventScroll: true }); } catch {}
    } else if (accBtn) {
      // Fallback: at least land the section header
      landUnderTotals(accBtn, 8);
    }
  }, 120);
}



/* ---------------- Item notes (timeline CRUD) ---------------- */

function getItemByTypeAndId(type, id) {
  const sc = curScenario();
  const t = String(type || "");
  const itemId = String(id || "");
  if (!sc || !t || !itemId) return null;

  if (t === "act") return (sc.activities || []).find(a => String(a.id) === itemId) || null;
  if (t === "leg") return (sc.legs || []).find(l => String(l.id) === itemId) || null;
  if (t === "stay") return (sc.stays || []).find(s => String(s.id) === itemId) || null;
  if (t === "meal") return (sc.meals || []).find(m => String(m.id) === itemId) || null;
  return null;
}

function openItemNotesModal(type, id) {
  const item = getItemByTypeAndId(type, id);
  if (!item) return;

  const ro = (localStorage.getItem("miviaje.readonly") === "1");
  const current = String(item.notes || "");

  const html = `
    <div class="text-sm text-slate-600 mb-2">Observaciones</div>
    <textarea id="itemNotesText" rows="5"
      class="w-full px-3 py-2 rounded-xl border border-slate-200 text-sm bg-white"
      placeholder="Escribe aqu√≠...">${escapeHtml(current)}</textarea>

    <div class="mt-3 flex items-center justify-between gap-2">
      <div class="flex items-center gap-2">
        <button id="itemNotesSave" class="tap px-3 py-2 rounded-xl bg-slate-900 text-white text-sm font-semibold">
          Guardar
        </button>
        <button id="itemNotesDelete" class="tap px-3 py-2 rounded-xl border border-slate-200 bg-white text-sm font-semibold text-red-600">
          Borrar
        </button>
      </div>
      <span id="itemNotesStatus" class="text-xs text-slate-500"></span>
    </div>
  `;

  showModal("Observaciones", html);

  setTimeout(() => {
    const ta = $("itemNotesText");
    const btnSave = $("itemNotesSave");
    const btnDel = $("itemNotesDelete");
    const st = $("itemNotesStatus");

    const hasText = !!String(current || "").trim();
    if (!hasText && btnDel) btnDel.classList.add("hidden");

    if (ro) {
      if (ta) ta.disabled = true;
      if (btnSave) btnSave.disabled = true;
      if (btnDel) btnDel.disabled = true;
      return;
    }

    if (btnSave) {
      btnSave.onclick = () => {
        const txt = String(ta ? ta.value : "").trim();
        item.notes = txt;
        saveState();
        if (st) st.textContent = "Guardado ‚úì";
        renderTimeline();
        closeModal();
      };
    }

    if (btnDel) {
      btnDel.onclick = () => {
        const ok = confirm("¬øBorrar estas observaciones?\n(Esta acci√≥n no borra el item.)");
        if (!ok) return;
        item.notes = "";
        saveState();
        renderTimeline();
        closeModal();
      };
    }
  }, 0);
}


function openDailyNoteModal(dateKey) {
  const sc = curScenario();
  if (!sc.dailyNotes) sc.dailyNotes = {};
  const key = String(dateKey || "").trim();
  if (!key) return;

  const ro = (localStorage.getItem("miviaje.readonly") === "1");
  const current = String(sc.dailyNotes[key] || "");

  const html = `
    <div class="text-sm text-slate-600 mb-2">Notas del d√≠a (${escapeHtml(key)})</div>
    <textarea id="dailyNoteModalText" rows="6"
      class="w-full px-3 py-2 rounded-xl border border-slate-200 text-sm bg-white"
      placeholder="Escribe aqu√≠...">${escapeHtml(current)}</textarea>

    <div class="mt-3 flex items-center justify-between gap-2">
      <div class="flex items-center gap-2">
        <button id="dailyNoteModalSave" class="tap px-3 py-2 rounded-xl bg-slate-900 text-white text-sm font-semibold">
          Guardar
        </button>
        ${current.trim() ? `
          <button id="dailyNoteModalDelete" class="tap px-3 py-2 rounded-xl border border-slate-200 bg-white text-sm font-semibold text-red-600">
            Borrar
          </button>
        ` : ``}
      </div>
      <button id="dailyNoteModalGo" class="tap px-3 py-2 rounded-xl border border-slate-200 bg-white text-sm font-semibold">
        Ir a Notas del d√≠a
      </button>
    </div>
  `;

  showModal("Observaciones", html);

  setTimeout(() => {
    const ta = document.getElementById("dailyNoteModalText");
    const btnSave = document.getElementById("dailyNoteModalSave");
    const btnDel = document.getElementById("dailyNoteModalDelete");
    const btnGo = document.getElementById("dailyNoteModalGo");

    if (ro) {
      if (ta) ta.disabled = true;
      if (btnSave) btnSave.disabled = true;
      if (btnDel) btnDel.disabled = true;
    }

    if (btnGo) {
      btnGo.onclick = () => {
        // Abrir acorde√≥n de Notas del d√≠a y seleccionar fecha
        try {
          const box = document.getElementById("dailyNotesBox");
          if (box) box.dataset.selDate = key;
        } catch {}
        // Si existe funci√≥n de abrir acordeones por id, √∫sala. Si no, jump al timeline/section.
        try {
          const accBtn = document.querySelector('[data-acc="dailyNotes"]');
          if (accBtn) accBtn.click();
        } catch {}
        try {
          const sec = document.getElementById("dailyNotesSection");
          if (sec) sec.scrollIntoView({ behavior: "smooth", block: "start" });
        } catch {}
        try { renderDailyNotes(); } catch {}
        closeModal();
      };
    }

    if (btnSave && !ro) {
      btnSave.onclick = () => {
        const v = String(ta?.value || "").trim();
        if (!v) {
          // Guardar vac√≠o => borrar key
          delete sc.dailyNotes[key];
        } else {
          sc.dailyNotes[key] = v;
        }
        saveState();
        renderTimeline();
        try { renderDailyNotes(); } catch {}
        closeModal();
      };
    }

    if (btnDel && !ro) {
      btnDel.onclick = () => {
        const ok = confirm("¬øBorrar esta nota del d√≠a?");
        if (!ok) return;
        delete sc.dailyNotes[key];
        saveState();
        renderTimeline();
        try { renderDailyNotes(); } catch {}
        closeModal();
      };
    }
  }, 0);
}

/* ---------------- /Timeline: jump to item ---------------- */
const __tlExpanded = new Set();


function formatDayLabel(iso) {
  const v = String(iso || "").trim();
  if (!/^\d{4}-\d{2}-\d{2}$/.test(v)) return "‚Äî";
  const d = new Date(v + "T00:00:00");
  if (Number.isNaN(d.getTime())) return v;
  try {
    return d.toLocaleDateString("es-ES", { weekday: "short", day: "2-digit", month: "short" }).replace(".", "");
  } catch {
    return v;
  }
}

function getTimelineDays(items) {
  const days = [];
  const seen = new Set();
  for (const it of (items || [])) {
    const d = String(it?.date || "").trim();
    if (!d || d === "9999-99-99") continue;
    if (!seen.has(d)) { seen.add(d); days.push(d); }
  }
  days.sort((a,b)=>String(a).localeCompare(String(b)));
  return days;
}

function syncTimelineViewUI(days) {
  const btnG = document.getElementById("tlViewGlobal");
  const btnD = document.getElementById("tlViewDay");
  const navDay = document.getElementById("timelineDayNav");
  const navGlobal = document.getElementById("timelineGlobalNav");
  const lbl = document.getElementById("tlDayLabel");

  // IMPORTANT: With Tailwind CDN, if both bg/text utility classes exist simultaneously,
  // the *CSS generation order* (not the DOM class order) can decide the winner.
  // So we must explicitly add/remove the mutually-exclusive classes (not just toggle one side).
  const setToggleBtn = (btn, isActive) => {
    if (!btn) return;
    btn.classList.toggle("seg-active", !!isActive);
    btn.classList.toggle("seg-inactive", !isActive);
  };

  setToggleBtn(btnG, timelineViewMode === "global");
  setToggleBtn(btnD, timelineViewMode === "day");

  if (navDay) navDay.classList.toggle("hidden", timelineViewMode !== "day");
  if (navGlobal) navGlobal.classList.toggle("hidden", timelineViewMode !== "global");

  if (lbl) lbl.textContent = (timelineViewMode === "day" && activeDayISO) ? formatDayLabel(activeDayISO) : "‚Äî";

  const prev = document.getElementById("tlDayPrev");
  const next = document.getElementById("tlDayNext");
  const idx = (days || []).indexOf(activeDayISO);
  const prevDisabled = (idx === -1) ? true : (idx <= 0);
  const nextDisabled = (idx === -1) ? ((days || []).length === 0) : (idx >= (days.length - 1));

  // Do not use native disabled (it blocks click events on some mobile browsers).
  // We only show a visual hint; bounds are enforced in moveActiveDay().
  if (prev) prev.classList.toggle("opacity-40", prevDisabled);
  if (next) next.classList.toggle("opacity-40", nextDisabled);
}

function setTimelineViewMode(mode) {
  const prev = timelineViewMode;
  timelineViewMode = (mode === "day") ? "day" : "global";
  // When entering day view, active day will be auto-selected in renderTimeline()
  renderTimeline();

  // Entering Day from Global: ensure the first event isn't hidden under the fixed controls bar.
  if (timelineViewMode === "day" && prev !== "day") {
    requestAnimationFrame(() => {
      const nodes = document.querySelectorAll(".timelineItem");
      let first = null;
      for (const el of nodes) {
        const d = (el.getAttribute("data-date") || "").trim();
        if (d === activeDayISO) { first = el; break; }
      }
      if (first) scrollToElWithOffset(first);
    });
  }
}


function moveActiveDay(delta) {
  const days = Array.isArray(__tlDays) ? __tlDays : [];
  const idx = days.indexOf(activeDayISO);
  const ni = idx + delta;
  if (ni < 0 || ni >= days.length) return;
  activeDayISO = days[ni];
  renderTimeline();
}

function renderTimeline() {
  const today = todayYMD();
  const box = $("timelineList");
  const sc = curScenario();
  const ro = (localStorage.getItem("miviaje.readonly") === "1");
  const actById = new Map((sc.activities || []).map(a => [String(a.id), a]));
  const legById = new Map((sc.legs || []).map(l => [String(l.id), l]));
  const stayById = new Map((sc.stays || []).map(s => [String(s.id), s]));
  const notes = sc.dailyNotes || {};
  renderTimelineFilterChips();
  const items = [];

  for (const leg of sc.legs) {
    items.push({ date: (leg.date || "9999-99-99"), time: (leg.time || ""), type:"Trayecto", title: `${leg.from || "‚Äî"} ‚Üí ${leg.to || "‚Äî"}`, cost: parseMoney(leg.cost), legId: leg.id, uid: `leg:${leg.id}` });
  }
  for (const s of sc.stays) {
    items.push({ date: (s.date || "9999-99-99"), time: (s.time || ""), type:"Alojamiento", title: `${s.city || "‚Äî"} ‚Ä¢ ${s.name || "Hotel"}`, cost: parseMoney(s.cost), stayId: s.id, uid: `stay:${s.id}` });
  }
  for (const a of sc.activities) {
    items.push({ date: (a.date || "9999-99-99"), time: (a.time || ""), type:"Actividad", title: `${a.city || "‚Äî"} ‚Ä¢ ${a.title || "Actividad"}`, cost: parseMoney(a.cost), actId: a.id, uid: `act:${a.id}` });
  }

  // Add note markers as timeline items so you can see notes even if there was no event that day
  Object.keys(notes).forEach(d => {
    const txt = String(notes[d] || "").trim();
    if (!d || !txt) return;
    items.push({ date: d, type:"Nota", title: "Notas del d√≠a", cost: null, isNote: true, uid: `note:${d}` });
  });

  // Meals is a budget line, not a timeline event. Drop any legacy meal items safely.
  for (let i = items.length - 1; i >= 0; i--) {
    const t = String(items[i]?.type || "").toLowerCase();
    if (t.includes("comida") || t.includes("meal")) items.splice(i, 1);
  }

  items.sort((a,b)=>{
    if (a.date !== b.date) return String(a.date).localeCompare(String(b.date));
    const ta = timeSortKey(a.time);
    const tb = timeSortKey(b.time);
    if (ta !== tb) return ta - tb;
    return String(a.uid || (a.type+':'+(a.legId||a.stayId||a.actId||a.date||''))).localeCompare(String(b.uid || (b.type+':'+(b.legId||b.stayId||b.actId||b.date||''))));
  });

  const filteredItems = getFilteredItems(items);
  __tlLastFilteredItems = filteredItems;

  // Days available in current filtered list (used by Day view navigation)
  const days = getTimelineDays(filteredItems);
  __tlDays = days;

  if (timelineViewMode === "day") {
    // Auto-pick active day ONLY when entering Day mode (do not change it when filters change)
    const t = todayYMD();
    if (!activeDayISO) {
      activeDayISO = days.includes(t) ? t : (days[0] || "");
    }
  }

  syncTimelineViewUI(days);

  let visibleItems = filteredItems;

  if (timelineViewMode === "day") {
    if (!activeDayISO) {
      box.innerHTML = `<div class="text-sm text-slate-500">${(timelineFilterState.categories.size ? "No hay eventos para estos filtros." : "No hay eventos todav√≠a.")}</div>`;
      renderDailyNotes();
      return;
    }
    visibleItems = (filteredItems || []).filter(it => String(it.date || "") === String(activeDayISO));
    if (!visibleItems.length) {
      box.innerHTML = `<div class="text-sm text-slate-500">No hay eventos para este d√≠a con los filtros actuales. Prueba otro d√≠a o quita filtros.</div>`;
      renderDailyNotes();
      return;
    }
  }

  if (!visibleItems.length) {
    box.innerHTML = `<div class="text-sm text-slate-500">${(timelineFilterState.categories.size ? "No hay eventos para este filtro." : "No hay eventos todav√≠a.")}</div>`;
    renderDailyNotes();
    return;
  }

  const showCost = (timelineViewMode === "global");

  box.innerHTML = visibleItems.map(it => {
    const isDated = it.date && it.date !== "9999-99-99";
    const jumpType = it.actId ? 'act' : (it.legId ? 'leg' : (it.stayId ? 'stay' : ''));
    const jumpId = it.actId || it.legId || it.stayId || '';
    const icon = (jumpType === 'leg') ? 'üõ´' : (jumpType === 'stay') ? 'üè®' : (jumpType === 'act') ? 'üéØ' : '';

    const hasNote = !!(isDated && notes[it.date] && String(notes[it.date]).trim());
    const whenLabel = (it.date === "9999-99-99" ? "Sin fecha" : it.date + ((it.time && String(it.time).trim()) ? (" ¬∑ " + String(it.time).trim()) : ""));
    const clsTime = (isDated && it.date < today) ? "past" : (it.date === today ? "today" : "");
    const noteBadge = (it.isNote ? " bg-white" : " bg-slate-50");
    const datePart = (it.date === "9999-99-99" ? "Sin fecha" : String(it.date));
    const timePart = (it.time && String(it.time).trim()) ? String(it.time).trim() : "‚Äî";
    const hasTime = (timePart !== "‚Äî");
    const rel = (it.date === "9999-99-99" ? "" : (String(it.date) < today ? "past" : (String(it.date) > today ? "future" : "today")));
    const timeCls = hasTime
      ? `tlTimeBadge ${rel === "today" ? "tlTimeToday" : (rel === "future" ? "tlTimeFuture" : (rel === "past" ? "tlTimePast" : ""))}`
      : "tlTimeBadge tlTimeNone";
    const dateLineHTML = `${escapeHtml(datePart)}  <span class="${timeCls}">${escapeHtml(timePart)}</span>`;

    // Collapsible: por defecto plegado. (2¬∫ tap sobre expandido => jump)
    const tlKey = it.isNote ? `note:${datePart}` : `${jumpType}:${jumpId}`;
    const isExpanded = __tlExpanded.has(tlKey);

    // L√≠nea meta en detalle (mantiene lo que ya ense√±√°bamos arriba)
    const metaLine = whenLabel;

    // Observaciones por item (leg/stay/act) desde el cronograma
    const itemForNotes = (jumpType === 'act') ? actById.get(String(jumpId))
                      : (jumpType === 'leg') ? legById.get(String(jumpId))
                      : (jumpType === 'stay') ? stayById.get(String(jumpId))
                      : null;
    const hasItemNotes = !!(itemForNotes && String(itemForNotes.notes || "").trim());
    const notesBtn = (it.isNote && isDated)
      ? `<button type="button"
                 class="tap tlNotesBtn px-2 py-1 rounded-lg border border-slate-200 bg-white hover:bg-slate-50 text-xs notes-has"
                 data-daily-note-open="${escapeHtml(datePart)}"
                 title="Notas del d√≠a">üóíÔ∏è<span class="note-dot"></span></button>`
      : (jumpType && jumpId && !it.isNote)
        ? `<button type="button"
                 class="tap tlNotesBtn px-2 py-1 rounded-lg border border-slate-200 bg-white hover:bg-slate-50 text-xs ${hasItemNotes ? "notes-has" : ""}"
                 data-item-notes-type="${escapeHtml(jumpType)}"
                 data-item-notes-id="${escapeHtml(String(jumpId))}"
                 title="Observaciones">üóíÔ∏è${hasItemNotes ? '<span class="note-dot"></span>' : ''}</button>`
        : "";



    // Checkpoint (Hecho) para Transporte / Alojamiento / Actividades en el cronograma
    let tlCheckbox = "";
    let visualClass = "";
    let tlBadges = "";

    // Visual: Notas del d√≠a (timeline)
    if (it.isNote) {
      visualClass = " tl-dnote tl-dnote-has";
    }

    // Resolver elemento del state + handler seg√∫n tipo
    let kind = "";
    let itemObj = null;

    if (it.actId != null) { kind = "act"; itemObj = actById.get(String(it.actId)); }
    else if (it.legId != null) { kind = "leg"; itemObj = legById.get(String(it.legId)); }
    else if (it.stayId != null) { kind = "stay"; itemObj = stayById.get(String(it.stayId)); }

    if (itemObj && !it.isNote) {
      const dateKey = (kind === "stay") ? "" : String(itemObj.date || it.date || "");
      const st = (kind === "act") ? computeDoneState(itemObj) : computeDoneStateGeneric(itemObj, dateKey);
      const isToday = (dateKey && String(dateKey) === todayKey());

      // Badges
      if (st.skipped) tlBadges = `<span class="text-xs font-semibold skipped-badge">No realizado</span>`;
      else if (st.auto && st.done) tlBadges = `<span class="text-xs auto-badge">Asumido</span>`;

      // Clases visuales
      if (st.skipped) visualClass = " tl-skipped";
      else if (isToday && st.done) visualClass = " tl-today-done";
      else if (isToday && !st.done) visualClass = " tl-today";
      else if (st.auto && st.done) visualClass = " tl-auto-done";
      else if (dateKey && isFuture(dateKey)) visualClass = " tl-future";

      const dataAttr = kind === "act" ? `data-tl-act-done="${escapeHtml(String(it.actId))}"`
                    : kind === "leg" ? `data-tl-leg-done="${escapeHtml(String(it.legId))}"`
                    : `data-tl-stay-done="${escapeHtml(String(it.stayId))}"`;

      tlCheckbox = `<input type="checkbox" class="h-4 w-4" 
                 class="h-4 w-4"
                 ${dataAttr}
                 ${st.done ? "checked" : ""}
                 ${ro ? "disabled" : ""}>`;
    }


    return `
      <div class="timelineItem cursor-pointer ${clsTime}${visualClass} border border-slate-200 rounded-2xl p-3${noteBadge}"
           data-date="${escapeHtml(it.date)}"
           data-tl-jump-type="${jumpType}"
           data-tl-jump-id="${escapeHtml(jumpId)}"
           data-tl-key="${escapeHtml(tlKey)}">

        <div class="flex items-start justify-between gap-3">
          <div class="flex items-start gap-3 min-w-0">
            <div class="shrink-0 text-lg leading-none mt-[2px]">${escapeHtml(icon || (it.isNote ? "üìù" : "‚Ä¢"))}</div>

            <div class="min-w-0">
              <div class="font-semibold text-sm truncate">${escapeHtml(it.title)}</div>
              <div class="text-xs text-slate-600 mt-0.5">${dateLineHTML}</div>
            </div>
          </div>

          <div class="shrink-0 flex items-center gap-2">
            ${tlCheckbox ? tlCheckbox : ""}
            ${notesBtn ? notesBtn : ""}
          </div>
        </div>

        <div class="mt-2 ${isExpanded ? "" : "hidden"}" data-tl-details="${escapeHtml(tlKey)}">
          <div class="text-xs text-slate-500">
            ${escapeHtml(metaLine)}
            ${hasNote ? " üìù" : ""}
          </div>
          <div class="mt-1 flex items-center ${showCost ? "justify-between" : "justify-end"} gap-3">
            ${showCost ? `<div class="text-sm font-semibold">${it.cost ? it.cost.toFixed(2) : "‚Äî"}</div>` : ``}
            <div class="flex items-center gap-2">
              ${tlBadges ? tlBadges : ""}
              ${(!it.isNote && jumpType && jumpId) ? `<button type="button" class="tap px-2 py-1 rounded-lg border border-slate-200 bg-white hover:bg-slate-50 text-xs" data-tl-go="1">‚Üó Ir</button>` : ``}
            </div>
          </div>
        </div>
      </div>
    `;
}).join("");

  // Listeners scoped: checkbox "Hecho" en cronograma (transporte/alojamiento/actividades)
  box.querySelectorAll("[data-tl-act-done]").forEach(cb => {
    cb.onchange = () => handleActDoneToggle(cb.dataset.tlActDone, cb.checked, cb);
  });
  box.querySelectorAll("[data-tl-leg-done]").forEach(cb => {
    cb.onchange = () => handleLegDoneToggle(cb.dataset.tlLegDone, cb.checked, cb);
  });
  box.querySelectorAll("[data-tl-stay-done]").forEach(cb => {
    cb.onchange = () => handleStayDoneToggle(cb.dataset.tlStayDone, cb.checked, cb);
  });

    // Tap en item: toggle real (plegar/desplegar)
// - Click en checkbox/notas/Ir NO debe plegar/desplegar
box.querySelectorAll(".timelineItem[data-tl-key]").forEach(row => {
  row.addEventListener("click", (e) => {
    const tag = (e.target && e.target.tagName) ? e.target.tagName.toLowerCase() : "";
    if (tag === "input" || tag === "label" || tag === "button" || tag === "textarea" || tag === "a") return;

    const key = row.getAttribute("data-tl-key") || "";
    if (!key) return;

    if (__tlExpanded.has(key)) __tlExpanded.delete(key);
    else __tlExpanded.add(key);

    renderTimeline();
  });
});

// Bot√≥n "Ir" (solo cuando el item est√° expandido)
box.querySelectorAll("[data-tl-go]").forEach(btn => {
  btn.addEventListener("click", (e) => {
    e.stopPropagation();
    const row = btn.closest(".timelineItem");
    if (!row) return;
    const kind = row.getAttribute("data-tl-jump-type");
    const id = row.getAttribute("data-tl-jump-id");
    if (kind && id) jumpToItem(kind, id);
  });
});

// Observaciones por item (üóíÔ∏è)
box.querySelectorAll("[data-item-notes-type][data-item-notes-id]").forEach(btn => {
  btn.addEventListener("click", (e) => {
    e.stopPropagation();
    openItemNotesModal(btn.getAttribute("data-item-notes-type"), btn.getAttribute("data-item-notes-id"));
  });

// Notas del d√≠a desde el cronograma (üóíÔ∏è)
box.querySelectorAll("[data-daily-note-open]").forEach(btn => {
  btn.addEventListener("click", (e) => {
    e.stopPropagation();
    openDailyNoteModal(btn.dataset.dailyNoteOpen);
  });
});
});


  renderDailyNotes();
}

function renderDailyNotes() {
  const box = document.getElementById("dailyNotesBox");
  if (!box) return;

  const sc = curScenario();
  if (!sc.dailyNotes) sc.dailyNotes = {};

  // Default date: today (YYYY-MM-DD)
  const now = new Date();
  const yyyy = now.getFullYear();
  const mm = String(now.getMonth() + 1).padStart(2, "0");
  const dd = String(now.getDate()).padStart(2, "0");
  const today = `${yyyy}-${mm}-${dd}`;

  // Keep selection in dataset
  const selectedDate = (box.dataset.selDate || today);
  const existing = String(sc.dailyNotes[selectedDate] || "");

  // Read-only fallback
  const ro = (localStorage.getItem("miviaje.readonly") === "1");

  // Dates that already have notes (sorted)
  const noteDates = Object.keys(sc.dailyNotes || {})
    .filter(d => String(sc.dailyNotes[d] || "").trim())
    .sort((a,b) => String(a).localeCompare(String(b)));

  box.innerHTML = `
    <div class="flex items-center justify-between gap-2 mb-2">
      <div class="font-semibold text-sm">Notas del d√≠a</div>
      <input id="dailyNoteDate" type="date" value="${escapeHtml(selectedDate)}"
             class="px-2 py-1 rounded-xl border border-slate-200 text-sm bg-white">
    </div>

    <textarea id="dailyNoteText" rows="3"
      class="w-full px-3 py-2 rounded-xl border border-slate-200 text-sm bg-white"
      placeholder="Apunta aqu√≠ lo importante de ese d√≠a...">${escapeHtml(existing)}</textarea>

    <div class="mt-2 flex items-center gap-2">
      <button id="saveDailyNote"
        class="tap px-3 py-2 rounded-xl bg-slate-900 text-white text-sm font-semibold">
        Guardar nota
      </button>

      <button id="deleteDailyNote"
        class="tap px-3 py-2 rounded-xl border border-slate-200 bg-white text-sm font-semibold text-red-600">
        Borrar
      </button>

      <span id="dailyNoteStatus" class="text-xs text-slate-500"></span>
    </div>

    ${noteDates.length ? `
      <div class="mt-3">
        <div class="text-xs font-semibold text-slate-600 mb-1">D√≠as con notas</div>
        <div class="flex flex-wrap gap-2">
          ${noteDates.map(d => `
            <button class="tap px-2 py-1 rounded-xl border border-slate-200 bg-white text-xs ${d === selectedDate ? "noteDateActive" : ""}"
                    data-note-date="${escapeHtml(d)}">
              ${escapeHtml(d)}
            </button>
          `).join("")}
        </div>
      </div>
    ` : ``}
  `;

  const dateEl = document.getElementById("dailyNoteDate");
  const textEl = document.getElementById("dailyNoteText");
  const btn = document.getElementById("saveDailyNote");
  const delBtn = document.getElementById("deleteDailyNote");
  const status = document.getElementById("dailyNoteStatus");

  // Respect read-only (fallback)
  if (ro) {
    if (dateEl) dateEl.disabled = true;
    if (textEl) textEl.disabled = true;
    if (btn) btn.disabled = true;
    if (delBtn) delBtn.disabled = true;
  }

  // iOS a veces dispara mejor 'input' que 'change'
  const onDateChange = () => {
    box.dataset.selDate = (dateEl.value || today);
    renderDailyNotes();
  };
  if (dateEl) {
    dateEl.onchange = onDateChange;
    dateEl.oninput = onDateChange;
  }

  // Quick-jump buttons
  box.querySelectorAll("[data-note-date]").forEach(b => {
    b.onclick = () => {
      const d = b.getAttribute("data-note-date") || "";
      if (!d) return;
      box.dataset.selDate = d;
      renderDailyNotes();
    };

  // Delete button state
  if (delBtn) {
    const hasTxt = String(sc.dailyNotes[selectedDate] || "").trim();
    delBtn.disabled = ro || !hasTxt;
    delBtn.style.display = hasTxt ? "" : "none";
    delBtn.onclick = () => {
      if (ro) return;
      const k = String(dateEl?.value || "").trim();
      if (!k) return;
      const ok = confirm("¬øBorrar esta nota del d√≠a?");
      if (!ok) return;
      delete sc.dailyNotes[k];
      saveState();
      if (status) status.textContent = "Borrado ‚úì";
      renderDailyNotes();
      if (typeof renderTimeline === "function") renderTimeline();
    };
  }
  });

  if (btn) {
    btn.onclick = () => {
      const k = String(dateEl?.value || "").trim();
      if (!k) return;

      const v = String(textEl?.value || "").trim();
      if (!v) delete sc.dailyNotes[k];
      else sc.dailyNotes[k] = v;

      saveState();

      if (status) status.textContent = "Guardado ‚úì";

      // Refresh timeline so notes are visible there
      if (typeof renderTimeline === "function") renderTimeline();
    };
  }

  // Ensure readonly UI is applied after rerender if available
  try { if (typeof applyReadOnlyMode === "function") applyReadOnlyMode(); } catch {}
  try { if (typeof applyReadOnlyUI === "function") applyReadOnlyUI(); } catch {}
}


/* ---------------------- Summary fold (no persistence) ---------------------- */
let summaryExpanded = false;
// Backward-compat helpers (avoid runtime errors if older patches referenced them)
function bindSummaryToggleOnce(){ /* no-op: applySummaryFold() binds onclick each render */ }
function applySummaryUI(){ /* no-op: kept for compatibility */ }


function applySummaryFold() {
  // Legacy summary is intentionally hidden (see CSS). Keep DOM values updated for calculations.
  const legacySummary = document.getElementById("summary");
  if (legacySummary) legacySummary.classList.add("hidden");
  const legacyDetail = document.getElementById("summaryDetail");
  if (legacyDetail) legacyDetail.classList.add("hidden");

  const t = document.getElementById("stickyTotalToggle");
  const d = document.getElementById("stickySummaryDetail");
  const inner = document.getElementById("stickySummaryDetailInner");

  if (t) t.textContent = summaryExpanded ? "Ocultar detalle ‚ñ¥" : "Ver detalle ‚ñæ";
  if (d) d.classList.toggle("hidden", !summaryExpanded);

  // Re-render sticky detail (cheap + keeps it fresh even if calcSummary runs often)
  if (inner) {
    const curCode = (document.getElementById("sumCur")?.textContent) || (document.getElementById("displayCurrency")?.value || "");
    const curSym = (curCode === "EUR") ? "‚Ç¨" : (curCode === "USD") ? "$" : (curCode === "GBP") ? "¬£" : (curCode === "JPY") ? "¬•" : curCode;

    const br = (sc) => {
      if (!sc) return { transport:0, stay:0, acts:0, meals:0, total:0, count:0 };
      const transport = (sc.legs || []).reduce((a,x)=>a+parseMoney(x.cost),0);
      const stay = (sc.stays || []).reduce((a,x)=>a+parseMoney(x.cost),0);
      const acts = (sc.activities || []).reduce((a,x)=>a+parseMoney(x.cost),0);
      const meals = sc.meals ? (parseMoney(sc.meals.daily) * (parseInt(sc.meals.people||1,10)) * (parseInt(sc.meals.days||1,10))) : 0;
      const count = (sc.legs||[]).length + (sc.stays||[]).length + (sc.activities||[]).length + (meals > 0 ? 1 : 0);
      const total = transport + stay + acts + meals;
      return { transport, stay, acts, meals, total, count };
    };

    const A = br(state.scenarios?.A);
    const B = br(state.scenarios?.B);
    const bothHaveData = (A.total > 0 && B.total > 0) || (A.count > 0 && B.count > 0);

    const difCell = (dif) => {
      const difTxt = (Math.abs(dif) < 0.005) ? "0.00" : (dif > 0 ? "+" + fmtMoney(dif) : fmtMoney(dif));
      const difCls = (Math.abs(dif) < 0.005) ? "text-slate-500" : (dif < 0 ? "text-emerald-700" : "text-rose-700");
      return `<td class="py-1 text-right font-semibold ${difCls}">${difTxt}</td>`;
    };

    if (!bothHaveData) {
      inner.innerHTML = `
        <div class="text-xs text-slate-500 mb-2">Detalle (${escapeHtml(curSym)})</div>
        <table class="w-full text-sm">
          <thead>
            <tr class="text-xs text-slate-500">
              <th class="text-left font-semibold py-1">Categor√≠a</th>
              <th class="text-right font-semibold py-1">A</th>
            </tr>
          </thead>
          <tbody>
            <tr><td class="py-1 pr-3 text-slate-700">Transporte</td><td class="py-1 text-right font-semibold">${fmtMoney(A.transport)}</td></tr>
            <tr><td class="py-1 pr-3 text-slate-700">Alojamiento</td><td class="py-1 text-right font-semibold">${fmtMoney(A.stay)}</td></tr>
            <tr><td class="py-1 pr-3 text-slate-700">Actividades</td><td class="py-1 text-right font-semibold">${fmtMoney(A.acts)}</td></tr>
            <tr><td class="py-1 pr-3 text-slate-700">Comida</td><td class="py-1 text-right font-semibold">${fmtMoney(A.meals)}</td></tr>
            <tr><td colspan="2"><hr class="my-2 border-slate-200"/></td></tr>
            <tr><td class="py-1 font-extrabold">TOTAL</td><td class="py-1 text-right font-extrabold">${fmtMoney(A.total)}</td></tr>
          </tbody>
        </table>
      `;
    } else {
      inner.innerHTML = `
        <div class="text-xs text-slate-500 mb-2">Detalle (${escapeHtml(curSym)}) ‚Ä¢ Dif = B ‚àí A</div>
        <table class="w-full text-sm">
          <thead>
            <tr class="text-xs text-slate-500">
              <th class="text-left font-semibold py-1">Categor√≠a</th>
              <th class="text-right font-semibold py-1">A</th>
              <th class="text-right font-semibold py-1">B</th>
              <th class="text-right font-semibold py-1">Dif</th>
            </tr>
          </thead>
          <tbody>
            <tr><td class="py-1 pr-3 text-slate-700">Transporte</td><td class="py-1 text-right font-semibold">${fmtMoney(A.transport)}</td><td class="py-1 text-right font-semibold">${fmtMoney(B.transport)}</td>${difCell(B.transport - A.transport)}</tr>
            <tr><td class="py-1 pr-3 text-slate-700">Alojamiento</td><td class="py-1 text-right font-semibold">${fmtMoney(A.stay)}</td><td class="py-1 text-right font-semibold">${fmtMoney(B.stay)}</td>${difCell(B.stay - A.stay)}</tr>
            <tr><td class="py-1 pr-3 text-slate-700">Actividades</td><td class="py-1 text-right font-semibold">${fmtMoney(A.acts)}</td><td class="py-1 text-right font-semibold">${fmtMoney(B.acts)}</td>${difCell(B.acts - A.acts)}</tr>
            <tr><td class="py-1 pr-3 text-slate-700">Comida</td><td class="py-1 text-right font-semibold">${fmtMoney(A.meals)}</td><td class="py-1 text-right font-semibold">${fmtMoney(B.meals)}</td>${difCell(B.meals - A.meals)}</tr>
            <tr><td colspan="4"><hr class="my-2 border-slate-200"/></td></tr>
            <tr><td class="py-1 font-extrabold">TOTAL</td><td class="py-1 text-right font-extrabold">${fmtMoney(A.total)}</td><td class="py-1 text-right font-extrabold">${fmtMoney(B.total)}</td>${difCell(B.total - A.total)}</tr>
          </tbody>
        </table>
      `;
    }
  }

  // Toggle expands/collapses the sticky panel only; preserve viewport (reflow-safe).
  if (t) {
    t.onclick = () => {
      const oldStack = getTopStackOffset();
      summaryExpanded = !summaryExpanded;
      applySummaryFold();
      requestAnimationFrame(() => {
        try { syncTopStackHeights(); } catch {}
        const newStack = getTopStackOffset();
        const dy = newStack - oldStack;
        if (dy) window.scrollBy({ top: dy, behavior: "auto" });
        setTimeout(() => { try { syncTopStackHeights(); } catch {} }, 50);
      });
    };
  }
}

 /* -------------------- /Summary fold (no persistence) -------------------- */

function calcSummary() {
  const sc = curScenario();
  const transport = sc.legs.reduce((a,x)=>a+parseMoney(x.cost),0);
  const stay = sc.stays.reduce((a,x)=>a+parseMoney(x.cost),0);
  const acts = sc.activities.reduce((a,x)=>a+parseMoney(x.cost),0);
  const meals = parseMoney(sc.meals.daily) * (parseInt(sc.meals.people||1,10)) * (parseInt(sc.meals.days||1,10));

  $("sumTransport").textContent = transport.toFixed(2);
  $("sumStay").textContent = stay.toFixed(2);
  $("sumActs").textContent = acts.toFixed(2);
  $("sumMeals").textContent = meals.toFixed(2);
  $("sumTotal").textContent = (transport+stay+acts+meals).toFixed(2);
  const stickyVal = document.getElementById("stickyTotalValue");
  if (stickyVal) {
    const curTxt = (document.getElementById("sumCur")?.textContent) || (document.getElementById("displayCurrency")?.value || "");
    stickyVal.textContent = `TOTAL: ${$("sumTotal").textContent}${curTxt ? " " + curTxt : ""}`;
  }
  // summary fold (no persistence)
  applySummaryFold();
  updateBestHint();
}

// --- Totals: best hint (A vs B) ---
function calcScenarioBreakdown(sc) {
  if (!sc) return { total:0, count:0 };
  const transport = (sc.legs || []).reduce((a,x)=>a+parseMoney(x.cost),0);
  const stay = (sc.stays || []).reduce((a,x)=>a+parseMoney(x.cost),0);
  const acts = (sc.activities || []).reduce((a,x)=>a+parseMoney(x.cost),0);
  const meals = sc.meals ? (parseMoney(sc.meals.daily) * (parseInt(sc.meals.people||1,10)) * (parseInt(sc.meals.days||1,10))) : 0;
  const total = transport + stay + acts + meals;
  const count = (sc.legs||[]).length + (sc.stays||[]).length + (sc.activities||[]).length + (meals > 0 ? 1 : 0);
  return { total, count };
}

function updateBestHint() {
  const el = document.getElementById("stickyBestHint");
  if (!el) return;
  const A = calcScenarioBreakdown(state.scenarios?.A);
  const B = calcScenarioBreakdown(state.scenarios?.B);
  const show = (A.total > 0 && B.total > 0) || (A.count > 0 && B.count > 0);
  if (!show) { el.textContent = ""; el.className = "text-xs font-semibold text-slate-500 whitespace-nowrap"; return; }

  if (Math.abs(A.total - B.total) < 0.005) {
    el.textContent = "Igual";
    el.className = "text-xs font-semibold text-slate-500 whitespace-nowrap";
    return;
  }
  const best = (A.total <= B.total) ? "A" : "B";
  el.textContent = "Mejor: " + best;
  el.className = "text-xs font-semibold whitespace-nowrap " + (best === "A" ? "text-emerald-700" : "text-rose-700");
}


/* --------------------------- Gemini helpers -------------------------- */
function getGeminiKey() {
  return localStorage.getItem(LS_KEY_GEMINI) || "";
}
function setGeminiKey(key) {
  localStorage.setItem(LS_KEY_GEMINI, key.trim());
}
function cleanJsonText(t) {
  t = String(t || "").trim();
  t = t.replace(/```json/gi, "```");
  if (t.startsWith("```")) {
    t = t.replace(/^```[a-zA-Z]*\n?/, "");
    t = t.replace(/```$/, "");
  }
  return t.trim();
}

async function geminiGenerateJSON(prompt, schemaHint = "") {
  const key = getGeminiKey();
  if (!key) throw new Error("NO_KEY");
  const model = "gemini-2.5-flash";
  const url = `https://generativelanguage.googleapis.com/v1beta/models/${model}:generateContent?key=${encodeURIComponent(key)}`;

  const body = {
    contents: [{ role: "user", parts: [{ text: prompt + (schemaHint ? "\n\n" + schemaHint : "") }] }],
    generationConfig: {
      temperature: 0.4,
      responseMimeType: "application/json"
    }
  };

  const r = await fetch(url, { method:"POST", headers: { "Content-Type":"application/json" }, body: JSON.stringify(body) });
  const data = await r.json();
  if (!r.ok) throw new Error("GEMINI_" + r.status + " " + JSON.stringify(data));
  let txt = data?.candidates?.[0]?.content?.parts?.[0]?.text || "";
  txt = cleanJsonText(txt);
  return JSON.parse(txt);
}

/* -------------------------- Timezone automation ---------------------- */
const tzCache = new Map(); // city -> {offset, tz}
async function getCityTimezone(city) {
  city = String(city||"").trim();
  if (!city) return null;
  if (tzCache.has(city)) return tzCache.get(city);

  const schema = `Devuelve SOLO este JSON: {"timezone":"Area/City","offset":-5}\n"offset" debe ser el offset UTC actual aproximado (n√∫mero entero).`;
  const prompt = `Dime la zona horaria IANA y el offset UTC entero aproximado para la ciudad: ${city}.`;
  const res = await geminiGenerateJSON(prompt, schema);
  tzCache.set(city, res);
  return res;
}
async function updateTimezoneForLeg(legId, which) {
  const sc = curScenario();
  const leg = sc.legs.find(x => x.id === legId);
  if (!leg) return;
  const city = which === "from" ? leg.from : leg.to;
  if (!city) return;
  try {
    const tz = await getCityTimezone(city);
    if (!tz) return;
    if (which === "from") leg.tzFrom = tz.offset;
    else leg.tzTo = tz.offset;
    saveState(); renderLegs();
  } catch(e) {
    // silent: key missing or API error
  }
}

/* ------------------------------- AI flow ----------------------------- */
function gatherAIPickOptions() {
  const sc = curScenario();
  const destinations = uniq(sc.legs.map(l => l.to).filter(Boolean));
  const origin = sc.legs.length ? String(sc.legs[0].from || "").trim() : "";
  const filteredDest = destinations.filter(c => c.toLowerCase() !== origin.toLowerCase() && c.toLowerCase() !== "madrid");

  const acts = uniq(sc.activities.map(a => (a.city ? `${a.city}: ${a.title}` : a.title)).filter(Boolean));
  const stays = uniq(sc.stays.map(s => (s.city ? `${s.city}: ${s.name}` : s.name)).filter(Boolean));

  return { origin, cities: filteredDest, acts, stays };
}

function openAIPickModal() {
  const opt = gatherAIPickOptions();
  if (!opt.cities.length && !opt.acts.length && !opt.stays.length) {
    $("aiStatus").textContent = "A√±ade al menos un trayecto, alojamiento o actividad para pedir sugerencias.";
    return;
  }

  const buildChecks = (items, prefix) => items.map((t,i)=>`
    <label class="flex items-center gap-2 py-1">
      <input type="checkbox" data-pick="${prefix}:${i}" class="w-4 h-4">
      <span>${escapeHtml(t)}</span>
    </label>
  `).join("");

  const html = `
    <div class="text-sm text-slate-600 mb-3">
      Selecciona sobre qu√© quieres sugerencias. Se excluye la ciudad de salida (<b>${escapeHtml(opt.origin||"‚Äî")}</b>).
    </div>
    <div class="grid grid-cols-1 sm:grid-cols-3 gap-4">
      <div>
        <div class="font-extrabold mb-2">Destinos</div>
        ${opt.cities.length ? buildChecks(opt.cities, "city") : `<div class="text-sm text-slate-400">‚Äî</div>`}
      </div>
      <div>
        <div class="font-extrabold mb-2">Actividades</div>
        ${opt.acts.length ? buildChecks(opt.acts, "act") : `<div class="text-sm text-slate-400">‚Äî</div>`}
      </div>
      <div>
        <div class="font-extrabold mb-2">Alojamientos</div>
        ${opt.stays.length ? buildChecks(opt.stays, "stay") : `<div class="text-sm text-slate-400">‚Äî</div>`}
      </div>
    </div>
  `;

  const btnSave = document.createElement("button");
  btnSave.className = "tap px-4 py-2 rounded-xl bg-indigo-600 hover:bg-indigo-700 text-white text-sm font-semibold";
  btnSave.textContent = "Guardar selecci√≥n";
  btnSave.onclick = () => {
    const picks = Array.from(document.querySelectorAll("[data-pick]")).filter(x=>x.checked).map(x=>x.getAttribute("data-pick"));
    const cities = picks.filter(p=>p.startsWith("city:")).map(p=>opt.cities[parseInt(p.split(":")[1],10)]);
    const items = picks.filter(p=>!p.startsWith("city:")).map(p=>{
      const [k,idx] = p.split(":");
      const i = parseInt(idx,10);
      if (k==="act") return { type:"activity", text: opt.acts[i] };
      if (k==="stay") return { type:"stay", text: opt.stays[i] };
      return null;
    }).filter(Boolean);

    state.aiPick = { cities, items };
    saveState();
    $("aiStatus").textContent = `Selecci√≥n guardada: ${cities.length} destinos, ${items.length} items. Pulsa "Generar gu√≠a".`;
    closeModal();
  };

  const btnCancel = document.createElement("button");
  btnCancel.className = "tap px-4 py-2 rounded-xl border border-slate-200 bg-white hover:bg-slate-50 text-sm font-semibold";
  btnCancel.textContent = "Cancelar";
  btnCancel.onclick = closeModal;

  showModal("Elegir temas para la IA", html, [btnCancel, btnSave]);
}

function renderAIResults(sections) {
  const box = $("aiResults");
  if (!sections.length) { box.innerHTML = ""; return; }

  box.innerHTML = sections.map((sec, sidx) => {
    const tipsHtml = (sec.tips || []).map(t=>`<li><b>${escapeHtml(t.title||"Tip")}</b>: ${escapeHtml(t.detail||"")}</li>`).join("");
    const spotsHtml = (sec.spots || []).map((sp, i)=>`
      <label class="flex items-start gap-3 p-3 rounded-2xl border border-slate-200 bg-white">
        <input type="checkbox" class="mt-1 w-4 h-4" data-ai-spot="${sidx}:${i}">
        <div>
          <div class="font-extrabold">${escapeHtml(sp.title||"Lugar")}</div>
          <div class="text-sm text-slate-600">${escapeHtml(sp.desc||"")}</div>
          <div class="text-xs text-slate-500 mt-1">${escapeHtml(sec.city||"")}</div>
        </div>
      </label>
    `).join("");

    return `
      <div class="border border-slate-200 rounded-3xl p-4 bg-slate-50">
        <div class="flex items-center justify-between gap-2">
          <div class="font-extrabold text-lg">${escapeHtml(sec.city || sec.topic || "Sugerencias")}</div>
          <span class="text-xs text-slate-500">${(sec.spots||[]).length} lugares</span>
        </div>
        ${(sec.tips && sec.tips.length) ? `
          <div class="mt-3">
            <div class="font-extrabold">Tips √∫tiles</div>
            <ul class="list-disc pl-5 text-sm text-slate-700 mt-1">${tipsHtml}</ul>
          </div>
        ` : ``}
        <div class="mt-3 grid grid-cols-1 gap-2">
          ${spotsHtml || `<div class="text-sm text-slate-500">Sin lugares.</div>`}
        </div>
      </div>
    `;
  }).join("");

  const btnAdd = document.createElement("button");
  btnAdd.className = "tap px-4 py-2 rounded-xl bg-fuchsia-600 hover:bg-fuchsia-700 text-white text-sm font-semibold";
  btnAdd.textContent = "A√±adir seleccionadas a Actividades";
  btnAdd.onclick = () => {
    const sc = curScenario();
    const checks = Array.from(document.querySelectorAll("[data-ai-spot]")).filter(x=>x.checked);
    let added = 0;
    for (const c of checks) {
      const [sidx, i] = c.getAttribute("data-ai-spot").split(":").map(x=>parseInt(x,10));
      const sec = window.__aiSections[sidx];
      const sp = sec.spots[i];
      sc.activities.unshift({
        id: nowId(),
        title: sp.title,
        city: sec.city || "",
        date: "", // optional
        cost: 0,
        fromAI: true
      });
      added++;
    }
    saveState();
    renderAll();
  syncStickyTotalsHeightVar();
  $("aiStatus").textContent = added ? `A√±adidas ${added} actividades.` : "No has seleccionado ninguna recomendaci√≥n.";
  };

  // attach under results
  const actionBar = document.createElement("div");
  actionBar.className = "mt-3 flex justify-end";
  actionBar.appendChild(btnAdd);
  box.prepend(actionBar);
}

async function generateAIGuide() {
  const pick = state.aiPick || { cities: [], items: [] };
  if ((!pick.cities || !pick.cities.length) && (!pick.items || !pick.items.length)) {
    $("aiStatus").textContent = "Primero pulsa ‚Äú1) Elegir temas‚Äù y marca al menos un destino o item.";
    return;
  }
  if (!getGeminiKey()) {
    $("aiStatus").textContent = "Primero pulsa ‚ÄúCambiar clave‚Äù y pega tu API Key de Gemini (AIza‚Ä¶).";
    return;
  }

  $("aiStatus").textContent = "Generando gu√≠a‚Ä¶ (Gemini 2.5 Flash)";
  $("aiResults").innerHTML = "";

  const schema = `Devuelve SOLO JSON v√°lido con este formato:
{
  "sections":[
    {
      "city":"Nueva York",
      "spots":[{"title":"...","desc":"..."}],
      "tips":[{"title":"Transporte p√∫blico","detail":"..."}]
    }
  ]
}`;
  const topics = [];
  for (const c of (pick.cities||[])) topics.push({ kind:"city", value:c });
  for (const it of (pick.items||[])) topics.push({ kind:it.type, value:it.text });

  const sections = [];
  for (const t of topics) {
    const prompt = `Eres un gu√≠a local experto y pr√°ctico.
Genera recomendaciones tur√≠sticas y tips √∫tiles para: ${t.value}
Idioma: espa√±ol.
Si es una ciudad, prioriza lugares imprescindibles + 1-2 lugares menos t√≠picos.
Incluye tips √∫tiles (abonos de transporte, c√≥mo moverse, horarios t√≠picos, trucos locales).
M√°ximo: 6 lugares y 4 tips.
NO incluyas URLs.`;
    try {
      const out = await geminiGenerateJSON(prompt, schema);
      for (const sec of (out.sections || [])) {
        // normalize
        sections.push({
          city: sec.city || (t.kind==="city" ? t.value : ""),
          topic: t.value,
          spots: (sec.spots || []).slice(0,6),
          tips: (sec.tips || []).slice(0,4)
        });
      }
    } catch(e) {
      console.error(e);
      $("aiStatus").textContent = "Error generando gu√≠a. Revisa la clave o reintenta.";
      return;
    }
  }

  window.__aiSections = sections;
  $("aiStatus").textContent = `Gu√≠a lista: ${sections.length} bloque(s). Marca lugares para a√±adirlos al plan.`;
  renderAIResults(sections);
}

/* ----------------------- Device name \(minimal\) ------------------------ */
const LS_DEVICE_NAME = "miviaje.deviceName";

function getDeviceName() {
  const v = (localStorage.getItem(LS_DEVICE_NAME) || "").trim();
  return v || "Este iPhone";
}

function setDeviceName(name) {
  const v = String(name || "").trim();
  if (v) localStorage.setItem(LS_DEVICE_NAME, v);
  else localStorage.removeItem(LS_DEVICE_NAME); // vuelve al fallback
  // Mant√©n meta.deviceName alineado (si usas meta)
  if (typeof setMeta === "function") setMeta({ deviceName: getDeviceName() });
}
/* --------------------- /Device name \(minimal\) --------------------- */


/* ------------------------ Save / Load (simple) ----------------------- */

/* ------------------- Manual Backups (list + restore) ------------------- */
const MANUAL_BACKUPS_KEY = "miviaje.backups";
const MANUAL_BACKUPS_MAX = 20;

function deepCloneJSON(obj) {
  try { return JSON.parse(JSON.stringify(obj)); } catch { return null; }
}

function getManualBackups() {
  try {
    const raw = localStorage.getItem(MANUAL_BACKUPS_KEY);
    const arr = raw ? JSON.parse(raw) : [];
    return Array.isArray(arr) ? arr : [];
  } catch {
    return [];
  }
}

function saveManualBackups(list) {
  localStorage.setItem(MANUAL_BACKUPS_KEY, JSON.stringify(list));
}

function enforceManualBackupLimit(list) {
  const sorted = list.slice().sort((a, b) => {
    const ta = Date.parse(a?.savedAt || "") || 0;
    const tb = Date.parse(b?.savedAt || "") || 0;
    return ta - tb;
  });
  return sorted.slice(Math.max(0, sorted.length - MANUAL_BACKUPS_MAX));
}

function createManualBackupEntry(label = "") {
  const snapshot = deepCloneJSON(state);
  if (!snapshot) {
    alert("No se pudo crear el backup (estado no serializable).");
    return null;
  }
  const now = new Date();
  const deviceName = (typeof getDeviceName === "function") ? getDeviceName(false) : "Dispositivo";
  const entry = {
    id: String(Date.now()) + "-" + Math.random().toString(16).slice(2),
    savedAt: now.toISOString(),
    deviceName: label ? `${deviceName} ${label}` : deviceName,
    state: snapshot
  };
  const list = getManualBackups();
  list.push(entry);
  saveManualBackups(enforceManualBackupLimit(list));
  return entry;
}

function formatManualBackupLabel(b) {
  const iso = b?.savedAt || "";
  let pretty = iso;
  try { pretty = new Date(iso).toLocaleString(); } catch {}
  return `${pretty} ¬∑ ${b?.deviceName || "Dispositivo"}`;
}


function getLatestManualBackup() {
  const list = getManualBackups();
  if (!list.length) return null;
  // pick newest by savedAt
  return list.slice().sort((a,b) => (Date.parse(b.savedAt||"")||0) - (Date.parse(a.savedAt||"")||0))[0] || null;
}

function renderManualBackupList() {
  const box = $("manualBackupList");
  if (!box) return;

  const list = getManualBackups().slice().sort((a, b) => {
    const ta = Date.parse(a?.savedAt || "") || 0;
    const tb = Date.parse(b?.savedAt || "") || 0;
    return tb - ta; // newest first
  });

  if (!list.length) {
    box.innerHTML = `<div class="text-sm text-slate-500">A√∫n no hay backups locales.</div>`;
    return;
  }

  box.innerHTML = list.map((b) => `
    <div class="flex items-center justify-between gap-3 p-3 rounded-2xl border border-slate-200 bg-white">
      <div class="min-w-0">
        <div class="text-sm font-semibold truncate">${escapeHtml(formatManualBackupLabel(b))}</div>
      </div>
      <button class="tap px-3 py-2 rounded-xl bg-slate-900 text-white text-sm font-semibold" data-manual-backup-restore="${escapeHtml(b.id || "")}">
        Restaurar
      </button>
    </div>
  `).join("");

  box.querySelectorAll("[data-manual-backup-restore]").forEach(btn => {
    btn.onclick = () => {
      const id = btn.getAttribute("data-manual-backup-restore");
      if (!id) return;
      restoreManualBackupById(id);
    };
  });
}

function restoreManualBackupById(id) {
  const list = getManualBackups();
  const b = list.find(x => x && x.id === id);
  if (!b || !b.state) return;

  const ok = confirm(
    "Vas a restaurar este backup:\n\n" +
    formatManualBackupLabel(b) +
    "\n\nSe har√° un backup autom√°tico del estado actual antes de restaurar."
  );
  if (!ok) return;

  // Safety: automatic backup of current state
  createManualBackupEntry("(auto pre-restore)");

  const next = deepCloneJSON(b.state);
  if (!next) {
    alert("No se pudo restaurar (backup corrupto o no serializable).");
    return;
  }

  state = next;
  saveState();
  closeModal();
  renderAll();
  syncStickyTotalsHeightVar();
  alert("Backup restaurado.");
}
/* ----------------- /Manual Backups (list + restore) ------------------ */


function openTripsModal() {
  const html = `
    <div id="syncStatus" class="text-xs text-slate-500 mb-3"></div>

    <!-- 1) BLOQUE PRINCIPAL ‚Äî ARCHIVOS -->
    <div class="bg-white border border-slate-200 rounded-3xl p-4 sm:p-5">
      <div class="flex items-center justify-between gap-2 mb-3">
        <div>
          <div class="font-extrabold text-base">Archivos</div>
</div>
        <button id="setDeviceName" class="tap px-3 py-2 rounded-xl border border-slate-200 bg-white hover:bg-slate-50 text-xs font-semibold whitespace-nowrap">
          Nombre del iPhone
        </button>
      </div>

      
      <div class="mb-4">
        <label class="text-xs text-slate-600">Nombre del viaje</label>
        <input id="tripNameInput"
               class="mt-1 w-full px-3 py-2 rounded-xl border border-slate-200 bg-white"
               placeholder="Ej: Nueva York"
               autocapitalize="words"
               autocomplete="off"
               spellcheck="false">
        <div class="mt-1 text-xs text-slate-500">
          Se usar√° para el nombre del archivo y para identificar ‚ÄúMis viajes‚Äù.
        </div>
      </div>

<div class="grid grid-cols-1 sm:grid-cols-2 gap-3">
        <button id="doExport" class="tap px-4 py-2 rounded-2xl bg-indigo-600 hover:bg-indigo-700 text-white font-semibold">
          Guardar (descargar .json)
        </button>

        <button id="doExportMilestone" class="tap px-4 py-2 rounded-2xl border border-slate-200 bg-white hover:bg-slate-50 font-semibold">
          Exportar hito
        </button>

        <label class="tap px-4 py-2 rounded-2xl border border-slate-200 bg-white hover:bg-slate-50 font-semibold text-center cursor-pointer sm:col-span-2">
          Cargar (importar .json)
          <input id="doImport" type="file" accept="application/json" class="hidden">
        </label>
      </div>

      <!-- Acorde√≥n: Mis viajes (local) ‚Äî cerrado por defecto -->
      <div class="mt-4 bg-white border border-slate-200 rounded-3xl overflow-hidden">
        <button data-acc="modalTrips" class="w-full tap flex items-center justify-between px-4 py-4">
          <div class="flex items-center gap-3">
            <span class="inline-flex w-9 h-9 rounded-2xl bg-slate-50 items-center justify-center">üóÇÔ∏è</span>
            <div class="text-left">
              <div class="font-extrabold">Mis viajes (local)</div>
</div>
          </div>
          <span class="accIcon text-slate-400 text-xl">‚ñæ</span>
        </button>
        <div data-acc-body="modalTrips" class="px-4 pb-4 hidden">
          <input id="tripSearchInput" type="text" placeholder="Buscar viaje..." class="w-full px-3 py-2 rounded-xl border border-slate-200 bg-white text-sm mb-2"/>
          <div id="tripList" class="space-y-2 max-h-[35vh] overflow-y-auto pr-1 overscroll-contain ios-scroll"></div>
        </div>
      </div>
    </div>

    <!-- 2) BLOQUE SEGURIDAD ‚Äî BACKUPS -->
    <div class="mt-4 bg-white border border-slate-200 rounded-3xl p-4 sm:p-5">
      <div class="flex items-center justify-between mb-3">
        <div>
          <div class="font-extrabold text-base">Seguridad</div>
</div>
        <button id="restoreBackup" class="tap px-3 py-2 rounded-xl border border-slate-200 bg-white hover:bg-slate-50 text-xs font-semibold whitespace-nowrap">
          Restaurar √∫ltimo backup
        </button>
      </div>

      <div class="grid grid-cols-1 sm:grid-cols-2 gap-3">
        <button id="doBackupNow" class="tap px-4 py-2 rounded-2xl bg-emerald-600 hover:bg-emerald-700 text-white font-semibold">
          Crear backup ahora
        </button>

        <div class="text-xs text-slate-500 sm:text-right self-center">
          M√°ximo ${MANUAL_BACKUPS_MAX} backups en este dispositivo
        </div>
      </div>

      <!-- Acorde√≥n: Backups (local) ‚Äî cerrado por defecto -->
      <div class="mt-4 bg-white border border-slate-200 rounded-3xl overflow-hidden">
        <button data-acc="modalBackups" class="w-full tap flex items-center justify-between px-4 py-4">
          <div class="flex items-center gap-3">
            <span class="inline-flex w-9 h-9 rounded-2xl bg-emerald-50 items-center justify-center">üõ°Ô∏è</span>
            <div class="text-left">
              <div class="font-extrabold">Backups (local)</div>
</div>
          </div>
          <span class="accIcon text-slate-400 text-xl">‚ñæ</span>
        </button>
        <div data-acc-body="modalBackups" class="px-4 pb-4 hidden">
          <div id="manualBackupList" class="space-y-2 max-h-[40vh] overflow-y-auto pr-1 overscroll-contain ios-scroll"></div>
        </div>
      </div>
    </div>
  `;

  showModal("Guardar / Cargar", html, []);

  setTimeout(() => {
    const refresh = () => {
      const meta = getMeta();
      const lastSync = meta.lastSyncAt ? new Date(meta.lastSyncAt).toLocaleString() : "Nunca";
      const fromDev = meta.lastSyncedFromDevice ? ` ‚Ä¢ desde ${meta.lastSyncedFromDevice}` : "";
      const lastExport = meta.lastSavedAt ? new Date(meta.lastSavedAt).toLocaleString() : "‚Äî";
      const dev = getDeviceName(false);
      const el = $("syncStatus");
      if (el) {
        const ro = (localStorage.getItem("miviaje.readonly") === "1") ? "ON" : "OFF";
        const exp = meta.lastExportAt || meta.lastSavedAt || null;
        const imp = meta.lastImportAt || meta.lastSyncAt || null;
        const expS = exp ? new Date(exp).toLocaleString() : "Nunca";
        const impS = imp ? new Date(imp).toLocaleString() : "Nunca";
        el.innerHTML = `
          <div class="px-3 py-2 rounded-xl border border-slate-200 bg-slate-50">
            <div class="text-[12px] leading-4 text-slate-700">
              <div class="flex flex-wrap gap-x-3 gap-y-1">
                <span><b>Dispositivo:</b> ${escapeHtml(dev)}</span>
                <span><b>Lectura:</b> ${escapeHtml(ro)}</span>
              </div>
              <div class="flex flex-wrap gap-x-3 gap-y-1 mt-1">
                <span><b>√ölt. export:</b> ${escapeHtml(expS)}</span>
                <span><b>√ölt. import:</b> ${escapeHtml(impS)}${fromDev ? escapeHtml(fromDev) : ""}</span>
              </div>
              ${imp ? ('<div class="mt-1 text-[12px] leading-4 text-slate-600"><b>√öltimo import:</b> ' + escapeHtml(impS) + ((meta.lastImportFromDeviceName || meta.lastSyncedFromDevice) ? (' (origen: ' + escapeHtml(meta.lastImportFromDeviceName || meta.lastSyncedFromDevice) + ')') : '') + '</div>') : ''}
            </div>
          </div>
        `;
      }
      const b = getLatestManualBackup() || getLatestBackup();
      const rb = $("restoreBackup");
      if (rb) {
        rb.disabled = !b;
        rb.classList.toggle("opacity-40", !b);
      }
    };

    $("doExport").onclick = () => { exportTrip(); refresh(); };
    $("doExportMilestone").onclick = () => { exportMilestone(); refresh(); };
    $("doImport").onchange = async (ev) => { await importTrip(ev); refresh(); };

// Trip name input: show custom name if set, otherwise keep empty (auto will use destination)
const tn = $("tripNameInput");
if (tn) {
  const mode = (typeof getTripNameMode === "function") ? getTripNameMode() : (localStorage.getItem("miviaje.tripNameMode") || "auto");
  const saved = (typeof getTripName === "function") ? getTripName() : String(localStorage.getItem("miviaje.tripName") || "").trim();
  tn.value = (mode === "custom" && saved) ? saved : "";
  tn.addEventListener("input", () => {
    const v = String(tn.value || "").trim();
    if (typeof setTripName === "function") setTripName(v);
    else localStorage.setItem("miviaje.tripName", v);
    if (typeof setTripNameMode === "function") setTripNameMode(v ? "custom" : "auto");
    else localStorage.setItem("miviaje.tripNameMode", v ? "custom" : "auto");
  }, { passive: true });
}



    const bn = $("doBackupNow");
    if (bn) {
      bn.onclick = () => {
        const entry = createManualBackupEntry();
        if (entry) {
          renderManualBackupList();
          alert("Backup creado.");
        }
      };
    }

    $("restoreBackup").onclick = () => {
      const b = getLatestManualBackup() || getLatestBackup();
      if (!b) return alert("No hay backups todav√≠a.");
      const label = b.savedAt ? new Date(b.savedAt).toLocaleString() : "(sin fecha)";
      if (!confirm(`¬øRestaurar el √∫ltimo backup?
${label}`)) return;
      state = b.state;
      saveState();
      closeModal();
      renderAll();
  syncStickyTotalsHeightVar();
  alert("Backup restaurado.");
    };

    $("setDeviceName").onclick = () => {
      const v = prompt("Nombre de este iPhone:", (localStorage.getItem(DEVICE_KEY) || "").trim());
      if (v && v.trim()) {
        try { localStorage.setItem("miviaje.deviceName", v.trim()); } catch {}
        try { localStorage.setItem(DEVICE_KEY, v.trim()); } catch {}
        try { setMeta({ deviceName: v.trim() }); } catch {}
      }
      refresh();
    };

    const search = $("tripSearchInput");
    if (search) {
      search.value = "";
      search.oninput = () => renderTripList(search.value);
    }
    renderManualBackupList();
    renderTripList("");
    refresh();

    // Acorde√≥n scoped al modal
    const root = $("modalBody");
    if (root) {
      root.querySelectorAll("[data-acc]").forEach(btn => {
        btn.addEventListener("click", () => {
          const key = btn.getAttribute("data-acc");
          const body = root.querySelector(`[data-acc-body="${key}"]`);
          if (!body) return;
          body.classList.toggle("hidden");
          const icon = btn.querySelector(".accIcon");
          if (icon) icon.textContent = body.classList.contains("hidden") ? "‚ñæ" : "‚ñ¥";
        });
      });
    }
  }, 0);
}

function exportTrip() {
  // 1) Resolver sugerencia base
  const inputEl = document.getElementById("tripNameInput");
  const nameFromInput = inputEl ? String(inputEl.value || "").trim() : "";
  const nameFromLS = (typeof getTripName === "function")
    ? String(getTripName() || "").trim()
    : String(localStorage.getItem("miviaje.tripName") || "").trim();

  const mode = (typeof getTripNameMode === "function") ? getTripNameMode() : "auto";
  const autoName = (typeof computeAutoTripName === "function") ? computeAutoTripName() : "MI_VIAJE";

  // Si el modo es auto, preferimos el destino actual; si es custom, preferimos el nombre guardado
  let baseName = nameFromInput || (mode === "custom" ? (nameFromLS || autoName) : autoName) || "MI_VIAJE";

  // 2) Pedir/confirmar nombre (siempre)
  const entered = prompt("Nombre para este viaje (ej: Jap√≥n 2026):", baseName);
  if (entered === null) return;

  const raw = String(entered || "").trim();

  // 3) Determinar nombre final + modo
  let finalName = raw;
  if (!finalName) {
    // vac√≠o => auto (recalcular)
    finalName = autoName || "MI_VIAJE";
    try { localStorage.setItem("miviaje.tripNameMode", "auto"); } catch {}
  } else {
    // Si el usuario deja el sugerido autom√°tico, lo tratamos como auto; si lo cambia, custom
    const shouldBeAuto = (finalName === autoName);
    try { localStorage.setItem("miviaje.tripNameMode", shouldBeAuto ? "auto" : "custom"); } catch {}
  }

  // Persistir nombre y reflejar en input
  try { localStorage.setItem("miviaje.tripName", finalName); } catch {}
  if (inputEl) inputEl.value = finalName;

  // 4) Export payload + filename
  const payload = { name: finalName, savedAt: new Date().toISOString(), state };

  // Identidad de dispositivo
  payload.deviceName = getDeviceName();

// Sync meta (for multi-device safety)
try {
  setMeta({
    deviceName: getDeviceName(),
    lastExportAt: payload.savedAt,
    lastSavedAt: payload.savedAt
  });
} catch {}


  const list = JSON.parse(localStorage.getItem("miviaje.trip.list") || "[]");
  list.unshift(payload);
  localStorage.setItem("miviaje.trip.list", JSON.stringify(list.slice(0, 30)));

  const base = (typeof sanitizeFileBaseName === "function")
    ? sanitizeFileBaseName(finalName)
    : (finalName.replace(/\s+/g, "_").replace(/[^A-Za-z0-9_-]/g, "") || "MI_VIAJE");
  const date = (typeof yyyyMmDdToday === "function") ? yyyyMmDdToday() : new Date().toISOString().slice(0, 10);
  const filename = `${base}_${date}.json`;
  // --- Share Sheet (iOS) + fallback download (SIN async/await) ---
  const blob = new Blob([JSON.stringify(payload, null, 2)], { type: "application/json" });

  function doDownload() {
    const a = document.createElement("a");
    a.href = URL.createObjectURL(blob);
    a.download = filename;
    a.click();
    URL.revokeObjectURL(a.href);
  }

  try {
    if (navigator.canShare && navigator.share) {
      const file = new File([blob], filename, { type: "application/json" });
      const can = (typeof navigator.canShare === "function")
        ? navigator.canShare({ files: [file] })
        : true;

      if (can) {
        Promise.resolve(
          navigator.share({
            files: [file],
            title: payload?.name || "Mi Viaje",
            text: "Viaje exportado desde Mi Viaje"
          })
        ).catch(() => {
          // Cancelaci√≥n o error ‚Üí fallback a download
          doDownload();
        });
      } else {
        doDownload();
      }
    } else {
      doDownload();
    }
  } catch {
    doDownload();
  }
  // --- FIN ---

  renderTripList();
}

function exportMilestone() {
  // Igual que exportTrip(), pero guarda un "HITO" con timestamp y marca milestone=true.
  const inputEl = document.getElementById("tripNameInput");
  const nameFromInput = inputEl ? String(inputEl.value || "").trim() : "";
  const nameFromLS = (typeof getTripName === "function")
    ? String(getTripName() || "").trim()
    : String(localStorage.getItem("miviaje.tripName") || "").trim();

  const mode = (typeof getTripNameMode === "function") ? getTripNameMode() : "auto";
  const autoName = (typeof computeAutoTripName === "function") ? computeAutoTripName() : "MI_VIAJE";

  let baseName = nameFromInput || (mode === "custom" ? (nameFromLS || autoName) : autoName) || "MI_VIAJE";

  const entered = prompt("Nombre para este HITO (ej: Jap√≥n 2026):", baseName);
  if (entered === null) return;

  const raw = String(entered || "").trim();

  let finalName = raw;
  if (!finalName) {
    finalName = autoName || "MI_VIAJE";
    try { localStorage.setItem("miviaje.tripNameMode", "auto"); } catch {}
  } else {
    const shouldBeAuto = (finalName === autoName);
    try { localStorage.setItem("miviaje.tripNameMode", shouldBeAuto ? "auto" : "custom"); } catch {}
  }

  try { localStorage.setItem("miviaje.tripName", finalName); } catch {}
  if (inputEl) inputEl.value = finalName;

  const payload = { name: finalName, savedAt: new Date().toISOString(), state, milestone: true };

  // Identidad de dispositivo
  payload.deviceName = getDeviceName();

  // Meta: igual que export normal (+ lastMilestoneAt)
  try {
    setMeta({
      deviceName: getDeviceName(),
      lastExportAt: payload.savedAt,
      lastSavedAt: payload.savedAt,
      lastMilestoneAt: payload.savedAt
    });
  } catch {}

  // Guardar en lista local (si existe)
  try {
    const list = JSON.parse(localStorage.getItem("miviaje.trip.list") || "[]");
    list.unshift(payload);
    localStorage.setItem("miviaje.trip.list", JSON.stringify(list.slice(0, 30)));
  } catch {}

  const safe = (typeof sanitizeFileBaseName === "function")
    ? sanitizeFileBaseName(finalName)
    : (finalName.replace(/\s+/g, "_").replace(/[^A-Za-z0-9_-]/g, "") || "MI_VIAJE");

  const d = new Date();
  const pad2 = (n) => String(n).padStart(2, "0");
  const ymd = `${d.getFullYear()}-${pad2(d.getMonth() + 1)}-${pad2(d.getDate())}`;
  const hm = `${pad2(d.getHours())}-${pad2(d.getMinutes())}`;
  const filename = `HITO_${safe}_${ymd}_${hm}.json`;
  // --- Share Sheet (iOS) + fallback download (SIN async/await) ---
  const blob = new Blob([JSON.stringify(payload, null, 2)], { type: "application/json" });

  function doDownload() {
    const a = document.createElement("a");
    a.href = URL.createObjectURL(blob);
    a.download = filename;
    a.click();
    URL.revokeObjectURL(a.href);
  }

  try {
    if (navigator.canShare && navigator.share) {
      const file = new File([blob], filename, { type: "application/json" });
      const can = (typeof navigator.canShare === "function")
        ? navigator.canShare({ files: [file] })
        : true;

      if (can) {
        Promise.resolve(
          navigator.share({
            files: [file],
            title: payload?.name || "Mi Viaje",
            text: "Viaje exportado desde Mi Viaje"
          })
        ).catch(() => {
          // Cancelaci√≥n o error ‚Üí fallback a download
          doDownload();
        });
      } else {
        doDownload();
      }
    } else {
      doDownload();
    }
  } catch {
    doDownload();
  }
  // --- FIN ---

  renderTripList();
}





async function importTrip(ev) {
  const input = ev.target;
  const file = input?.files?.[0];
  if (!file) return;
  const txt = await file.text();

  try {
    const payload = JSON.parse(txt);
    if (payload && typeof payload.name === "string" && payload.name.trim()) {
      setTripName(payload.name.trim());
      const tn = $("tripNameInput");
      if (tn) tn.value = payload.name.trim();
    }
    if (!payload || !payload.state) throw new Error("Formato no v√°lido (falta state)");

    const meta = getMeta();
    const remoteAt = payload.savedAt ? Date.parse(payload.savedAt) : NaN;
    const localAtRaw = meta.lastSavedAt || meta.lastSyncAt || "";
    const localAt = localAtRaw ? Date.parse(localAtRaw) : NaN;


    // --- PREVIEW (para confirmaciones de import) ---
    const previewName = (payload?.name ? String(payload.name).trim() : "") || "Sin nombre";
    const previewSavedAt = (!payload.savedAt || !Number.isFinite(remoteAt)) ? "Fecha desconocida" : new Date(payload.savedAt).toLocaleString();
    const previewDevice = (payload?.deviceName ? String(payload.deviceName).trim() : "") || "Dispositivo desconocido";
    const previewLocal = localAtRaw ? new Date(localAtRaw).toLocaleString() : "Desconocido";

    const previewText =
      "Vista previa del fichero:\n" +
      `- Nombre: ${previewName}\n` +
      `- Guardado: ${previewSavedAt}\n` +
      `- Dispositivo: ${previewDevice}\n\n` +
      "Tu versi√≥n local:\n" +
      `- √ölt. guardado: ${previewLocal}\n`

    // --- BLOQUEO POR CONFLICTO: "mismo dispositivo" ---
    const deviceLocal = getDeviceName(false);
    const deviceFromFile = (payload?.deviceName ? String(payload.deviceName).trim() : "");

    // Si el fichero parece exportado desde ESTE MISMO dispositivo, bloqueamos casos peligrosos
    if (deviceFromFile && deviceFromFile === deviceLocal) {
      // a) fecha desconocida -> BLOQUEAR
      if (!payload.savedAt || !Number.isFinite(remoteAt)) {
        alert(
          "üö® IMPORTACI√ìN BLOQUEADA\n\n" +
          "Este fichero parece exportado desde ESTE MISMO dispositivo y la fecha es desconocida.\n" +
          "Importar podr√≠a sobrescribir tu versi√≥n actual.\n\n" +
          previewText
        );
        input.value = "";
        return;
      }

      // b) fecha v√°lida, y NO es m√°s nuevo que tu versi√≥n -> BLOQUEAR por defecto
      if (Number.isFinite(localAt) && remoteAt <= localAt) {
        const msg =
          "üö® IMPORTACI√ìN BLOQUEADA (mismo dispositivo)\n\n" +
          previewText +
          "\n" +
          `Tu versi√≥n: ${previewLocal}\n` +
          `Fichero: ${previewSavedAt}\n\n` +
          "Parece el mismo dispositivo y no es m√°s nuevo.\n" +
          "Para evitar sobrescrituras, la importaci√≥n est√° bloqueada.";

        const wantsForce = confirm(msg + "\n\n¬øQuieres FORZAR la importaci√≥n igualmente?");
        if (!wantsForce) { input.value = ""; return; }

        const confirm2 = prompt("√öltimo paso: escribe IMPORTAR para confirmar la importaci√≥n forzada:", "");
        if (String(confirm2 || "").trim() !== "IMPORTAR") { input.value = ""; return; }
        // Si pasa los 2 pasos, seguimos con la l√≥gica normal
      }
    }
    // --- FIN BLOQUEO POR CONFLICTO ---

;

    if (Number.isFinite(remoteAt) && Number.isFinite(localAt) && remoteAt < localAt) {
      const r = new Date(payload.savedAt).toLocaleString();
      const l = new Date(localAtRaw).toLocaleString();
      const who = payload.deviceName ? `\n(Exportado por: ${payload.deviceName})` : "";
      const ok = confirm(
        "üö® FICHERO M√ÅS ANTIGUO\n" +
        "El fichero que vas a importar es M√ÅS ANTIGUO que tu versi√≥n actual. Puedes perder cambios.\n\n" +
        `Tu versi√≥n: ${previewLocal}\n` +
        `Fichero: ${previewSavedAt}\n\n` +
        previewText +
        "\n¬øImportar igualmente?"
      );
      if (!ok) { input.value = ""; return; }
    } else if (!payload.savedAt || !Number.isFinite(remoteAt)) {
      const ok = confirm(
        "‚ö†Ô∏è FECHA DESCONOCIDA\n" +
        "El fichero no tiene savedAt v√°lido. Podr√≠as perder cambios si es m√°s antiguo.\n\n" +
        previewText +
        "\n¬øImportar igualmente?"
      );
      if (!ok) { input.value = ""; return; }
    }

    // Safety backup before overwrite
    pushBackup("before_import", { fromFileName: file.name, fromSavedAt: payload.savedAt || null, fromDevice: payload.deviceName || null });

    state = payload.state;
    saveState();
    closeModal();
    renderAll();
  syncStickyTotalsHeightVar();
  const now = new Date().toISOString();
    setMeta({
      lastImportAt: now,
      lastSyncAt: now,
      lastSyncedFromDevice: payload.deviceName || "Archivo",
      lastImportFromDeviceName: (payload?.deviceName ? String(payload.deviceName).trim() : "") || null,
      lastImportedSavedAt: payload.savedAt || null,
      lastSavedAt: (Number.isFinite(remoteAt) ? new Date(remoteAt).toISOString() : now)
    });

    alert("Viaje cargado.");
  } catch(e) {
    alert("No se pudo cargar: " + e.message);
  } finally {
    if (input) input.value = "";
  }
}


function renderTripList(filterText = "") {
  const box = $("tripList");
  if (!box) return;

  let list = [];
  try {
    list = JSON.parse(localStorage.getItem("miviaje.trip.list") || "[]");
    if (!Array.isArray(list)) list = [];
  } catch {
    list = [];
  }

  const q = String(filterText || "").trim().toLowerCase();

  const fmt = (iso) => {
    if (!iso) return "";
    try { return new Date(iso).toLocaleString(); } catch { return String(iso); }
  };

  const rows = list
    .map((t, idx) => ({ t, idx }))
    .filter(({ t }) => {
      if (!q) return true;
      const name = String(t?.name || "MI VIAJE").toLowerCase();
      const when = fmt(t?.savedAt).toLowerCase();
      const dev = String(t?.deviceName || "").toLowerCase();
      return name.includes(q) || when.includes(q) || dev.includes(q);
    });

  if (!rows.length) {
    box.innerHTML = `<div class="text-sm text-slate-500">No hay viajes que coincidan.</div>`;
    return;
  }

  box.innerHTML = rows.map(({ t, idx }) => `
    <div class="p-3 rounded-2xl border border-slate-200 bg-white">
      <div class="flex items-start justify-between gap-3">
        <div class="min-w-0">
          <div class="font-extrabold truncate">${escapeHtml(t.name || "MI VIAJE")}</div>
</div>
        <div class="flex flex-col items-end gap-2 shrink-0">
          <button class="tap px-3 py-2 rounded-xl bg-slate-900 text-white text-xs font-semibold" data-trip-load="${idx}">Cargar</button>
          <button class="tap text-red-600 text-xs font-semibold" data-trip-del="${idx}">Eliminar</button>
        </div>
      </div>
    </div>
  `).join("");

  box.querySelectorAll("[data-trip-load]").forEach(b => b.onclick = () => {
    const idx = parseInt(b.getAttribute("data-trip-load"), 10);
    const payload = list[idx];
    if (!payload?.state) return;

    const meta = getMeta();
    const remoteAt = payload.savedAt ? Date.parse(payload.savedAt) : NaN;
    const localAtRaw = meta.lastSavedAt || meta.lastSyncAt || "";
    const localAt = localAtRaw ? Date.parse(localAtRaw) : NaN;

    if (Number.isFinite(remoteAt) && Number.isFinite(localAt) && remoteAt < localAt) {
      const r = new Date(payload.savedAt).toLocaleString();
      const l = new Date(localAtRaw).toLocaleString();
      const who = payload.deviceName ? `
(Creado por: ${payload.deviceName})` : "";
      const ok = confirm(`Vas a cargar un viaje local M√ÅS ANTIGUO.

Viaje: ${r}${who}
Tu iPhone: ${l}

¬øQuieres continuar?`);
      if (!ok) return;
    }

    pushBackup("before_local_load", { fromSavedAt: payload.savedAt || null, fromDevice: payload.deviceName || null });

    state = payload.state;
    saveState();

    setMeta({
      lastLoadedLocalAt: new Date().toISOString(),
      lastLoadedFrom: "local_list",
      lastLoadedTripSavedAt: payload.savedAt || null
    });

    closeModal();
    renderAll();
  syncStickyTotalsHeightVar();
  });

  box.querySelectorAll("[data-trip-del]").forEach(btn => btn.onclick = () => {
    const idx = parseInt(btn.getAttribute("data-trip-del"), 10);
    const t = list[idx];
    const name = t?.name || "MI VIAJE";
    const ok = confirm(`¬øEliminar "${name}" del listado local?
(Esta acci√≥n no borra archivos descargados.)`);
    if (!ok) return;

    const next = list.filter((_, i) => i !== idx);
    localStorage.setItem("miviaje.trip.list", JSON.stringify(next));

    const search = $("tripSearchInput");
    renderTripList(search ? search.value : filterText);
  });
}



/* ----------------------------- Events ----------------------------- */
const __chipA = document.getElementById("chipA");
if (__chipA) __chipA.addEventListener("click", ()=>{ state.scenario="A"; saveState(); __sectionExpanded.legs.clear(); __sectionExpanded.stays.clear(); __sectionExpanded.activities.clear(); renderAll(); });
const __chipB = document.getElementById("chipB");
if (__chipB) __chipB.addEventListener("click", ()=>{ state.scenario="B"; saveState(); __sectionExpanded.legs.clear(); __sectionExpanded.stays.clear(); __sectionExpanded.activities.clear(); renderAll(); });

$("displayCurrency").addEventListener("change", (e)=> setDisplayCurrency(e.target.value));

$("addLeg").addEventListener("click", ()=>{
  const sc = curScenario();
  const id = nowId();
  sc.legs.unshift({ id, from:"", to:"", date:"", time:"", cost:0, tzFrom:null, tzTo:null });
  __sectionExpanded.legs.add(id);
  saveState(); renderLegs(); renderTimeline(); calcSummary();
  scrollAccordionBodyToTop("legs");
});
$("addStay").addEventListener("click", ()=>{
  const sc = curScenario();
  const id = nowId();
  sc.stays.unshift({ id, city:"", name:"", date:"", time:"", nights:1, cost:0 });
  __sectionExpanded.stays.add(id);
  saveState(); renderStays(); renderTimeline(); calcSummary();
  scrollAccordionBodyToTop("stays");
});
$("addAct").addEventListener("click", ()=>{
  const sc = curScenario();
  const id = nowId();
  sc.activities.unshift({ id, title:"", city:"", date:"", time:"", cost:0, fromAI:false });
  __sectionExpanded.activities.add(id);
  saveState(); renderActivities(); renderTimeline(); calcSummary();
  scrollAccordionBodyToTop("acts");
});

["mealDaily","mealPeople","mealDays"].forEach(id=>{
  $(id).addEventListener("input", ()=>{
    const sc = curScenario();
    sc.meals.daily = parseMoney($("mealDaily").value);
    const rawP = $("mealPeople").value;
    const rawD = $("mealDays").value;

    sc.meals.people = (String(rawP).trim() === "") ? "" : Math.max(1, parseInt(rawP || "1",10));
    sc.meals.days = (String(rawD).trim() === "") ? "" : Math.max(1, parseInt(rawD || "1",10));
    saveState(); renderMeals(); calcSummary();
  });
});

$("btnKey").addEventListener("click", ()=>{
  const cur = getGeminiKey();
  const key = prompt("Pega tu API Key de Gemini (AIza‚Ä¶):", cur ? "AIza..." : "");
  if (key && key.trim()) { setGeminiKey(key.trim()); alert("Clave guardada en este dispositivo."); }
});

$("aiPick").addEventListener("click", openAIPickModal);
$("aiGenerate").addEventListener("click", generateAIGuide);

$("btnTrips").addEventListener("click", openTripsModal);
const __tn = $("timelineNext");
if (__tn) __tn.addEventListener("click", (e) => { e.preventDefault(); e.stopPropagation(); scrollToNextAfterCurrent(); });

const __tt = $("timelineToday");
if (__tt) __tt.addEventListener("click", (e) => { e.preventDefault(); e.stopPropagation(); scrollToCurrentTimelineItem(); });




$("btnReadOnly").addEventListener("click", () => {
  setReadOnly(!isReadOnly());
});
$("btnCompare").addEventListener("click", ()=>{
  const a = state.scenarios.A;
  const b = state.scenarios.B;
  const tot = (sc) => sc.legs.reduce((x,y)=>x+parseMoney(y.cost),0)
    + sc.stays.reduce((x,y)=>x+parseMoney(y.cost),0)
    + sc.activities.reduce((x,y)=>x+parseMoney(y.cost),0)
    + parseMoney(sc.meals.daily) * (parseInt(sc.meals.people||1,10)) * (parseInt(sc.meals.days||1,10));
  const ta = tot(a), tb = tot(b);
  $("compareBox").classList.remove("hidden");
  $("compareBox").innerHTML = `
    <div class="font-extrabold">Comparativa (simple)</div>
    <div class="mt-2 flex justify-between"><span>A</span><span class="font-semibold">${ta.toFixed(2)} ${escapeHtml(state.displayCurrency)}</span></div>
    <div class="flex justify-between"><span>B</span><span class="font-semibold">${tb.toFixed(2)} ${escapeHtml(state.displayCurrency)}</span></div>
    <div class="mt-2 text-sm ${ta<=tb ? "text-emerald-700" : "text-emerald-700"}">
      Mejor: <b>${ta<=tb ? "A" : "B"}</b> (${Math.abs(ta-tb).toFixed(2)} de diferencia)
    </div>
  `;
});

/* Bottom nav jump (premium header landing) */
function scrollToSectionHeader(accKey) {
  const headerBtn = document.querySelector(`[data-acc="${accKey}"]`);
  if (!headerBtn) return;

  // Ensure accordion is open so the landing makes sense visually
  if (typeof openAccordionKey === "function") openAccordionKey(accKey);

  // Premium fine scroll: header sits just under Totals
  setTimeout(() => {
    scrollToElWithOffset(headerBtn, 10);
  }, 0);
}

/* Jump nav */
document.querySelectorAll('[data-jump]').forEach(btn => {
  btn.addEventListener('click', () => {
    const key = btn.getAttribute('data-jump');
    if (!key) return;

    const accBtn = document.querySelector(`[data-acc="${key}"]`);
    if (!accBtn) return;

    const body = document.querySelector(`[data-acc-body="${key}"]`);

    // Bottom-nav driven landing only
    window.__pendingLandingKey = key;

    const scheduleFrames = (n, fn) => {
      let i = 0;
      const step = () => {
        i++;
        if (i >= n) return fn();
        requestAnimationFrame(step);
      };
      requestAnimationFrame(step);
    };

    const frames = (key === "stays" || key === "acts") ? 3 : 2;
    const doLanding = () => {
      // First landing (bottom nav intent): smooth ONCE
      landUnderTotals(accBtn, 8, { smooth: true });

      const threshold = (key === "acts") ? 6 : 8;

      const getErr = () => {
        try { syncHeaderHeightVar(); } catch {}
        try { syncTopStackHeights(); } catch {}
        const topStack = (typeof getTopStackOffset === "function" ? getTopStackOffset() : 0) + 8;
        return accBtn.getBoundingClientRect().top - topStack;
      };

      const correctAuto = (delayMs) => {
        setTimeout(() => {
          if (window.__pendingLandingKey !== key) return;
          try { syncHeaderHeightVar(); } catch {}
          try { syncTopStackHeights(); } catch {}
          landUnderTotals(accBtn, 8, { smooth: false }); // auto correction (no smooth)
        }, delayMs);
      };

      // Measure error after the first landing; correct only if real drift exists
      requestAnimationFrame(() => {
        try {
          const err1 = getErr();
          if (Math.abs(err1) > threshold) {
            correctAuto(120);

            // Activities: deterministic extra correction window (only if still off)
            if (key === "acts") {
              setTimeout(() => {
                if (window.__pendingLandingKey !== key) return;
                const err2 = getErr();
                if (Math.abs(err2) > threshold) {
                  try { syncHeaderHeightVar(); } catch {}
                  try { syncTopStackHeights(); } catch {}
                  landUnderTotals(accBtn, 8, { smooth: false }); // 3rd correction (auto)
                }
              }, 220);
            }
          }
        } catch {}
      });

      // Clear intent after correction window
      const clearAfter = (key === "acts") ? 380 : 260;
      setTimeout(() => {
        if (window.__pendingLandingKey === key) window.__pendingLandingKey = "";
      }, clearAfter);
    };



    // Ensure target accordion is open, then land after settle frames
    if (body && body.classList.contains('hidden')) {
      accBtn.click();
      scheduleFrames(frames, doLanding);
      return;
    }

    // Already open: still land for consistent alignment
    scheduleFrames(2, doLanding);
  });
});


function syncHeaderHeightVar(){
  const hdr = document.querySelector("header");
  if (!hdr) return;
  document.documentElement.style.setProperty("--app-header-h", hdr.offsetHeight + "px");
}

/* ----------------------------- Init ----------------------------- */


function syncStickyTotalsHeightVar(){
  // v78: keep legacy callers working
  syncTopStackHeights();
}

function __tlGetTopOffsetPx(){
  const cs = getComputedStyle(document.documentElement);
  const h1 = parseFloat(cs.getPropertyValue("--app-header-h")) || 56;
  const h2 = parseFloat(cs.getPropertyValue("--sticky-totals-h")) || 0;
  return h1 + h2;
}

function rebuildTimelineControlsFixed(){ /* removed */ }


/* removed anyTimelineAccordionOpen */


function showHideTimelineControlsFixed(){ /* removed */ }


function initTimelineControlsFixedObserver(){ /* removed */ }



window.addEventListener('DOMContentLoaded', () => {
  loadState();
  try { setupToolsSheet(); } catch {}
  // V88G2b: deterministic timeline start (Global, no filters)
  try { timelineViewMode = 'global'; } catch {}
  try { if (typeof activeDayISO !== 'undefined') activeDayISO = ''; } catch {}
  try { if (typeof timelineFilterState !== 'undefined' && timelineFilterState.categories) timelineFilterState.categories.clear(); } catch {}

  setupAccordion();
  forceStartStateTimelineProtagonist();
  // V88H: reset current trip (scenario) ‚Äî safe, modal-confirmed
  const btnResetTrip = document.getElementById("btnResetTrip");
  if (btnResetTrip) btnResetTrip.addEventListener("click", openResetTripConfirmModal);

  syncHeaderHeightVar();
  window.addEventListener('resize', () => { syncHeaderHeightVar(); syncStickyTotalsHeightVar(); }, { passive: true });
  
    const fab = document.getElementById('fabCollapseAll');
    if (fab) fab.onclick = () => { collapseAllAccordions(); window.scrollTo({ top: 0, behavior: 'smooth' }); };
  
    const ca = document.getElementById("collapseAll");
    if (ca) ca.onclick = () => { collapseAllAccordions(); window.scrollTo({ top: 0, behavior: 'smooth' }); };
  
    // Timeline view controls (Global / Day)
    const _tlG = document.getElementById("tlViewGlobal");
    const _tlD = document.getElementById("tlViewDay");
    if (_tlG) _tlG.onclick = (e) => { e.preventDefault(); e.stopPropagation(); setTimelineViewMode("global"); };
    if (_tlD) _tlD.onclick = (e) => { e.preventDefault(); e.stopPropagation(); setTimelineViewMode("day"); };
  
    const _tlPrev = document.getElementById("tlDayPrev");
    const _tlNext = document.getElementById("tlDayNext");
    if (_tlPrev) _tlPrev.onclick = (e) => { e.preventDefault(); e.stopPropagation(); moveActiveDay(-1); };
    if (_tlNext) _tlNext.onclick = (e) => { e.preventDefault(); e.stopPropagation(); moveActiveDay(1); };
  
  renderAll();
  // Capture stable template for fixed timeline controls (robust against hidden/visibility changes)
  try {
    const sentinel = document.getElementById("timelineControlsSentinel");
    const originalRow = sentinel ? sentinel.nextElementSibling : null;
    if (originalRow && !window.__tlControlsTemplateHTML) {
      window.__tlControlsTemplateHTML = originalRow.outerHTML;
    } else if (!window.__tlControlsTemplateHTML) {
      const g = document.getElementById("tlViewGlobal");
      const row = g ? g.closest("div.flex.items-center.justify-between") : null;
      if (row) window.__tlControlsTemplateHTML = row.outerHTML;
    }
  } catch (e) { /* no-op */ }

  syncStickyTotalsHeightVar();
  summaryExpanded = false;
  applySummaryFold();
  updateFabVisibility();
});
</script>
<!-- Floating FAB: Collapse all -->
<button aria-label="Plegar todo" class="hidden" id="fabCollapseAll" title="Plegar todo">‚ñæ‚ñæ</button>
</body>
</html>