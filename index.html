<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"/>
  <title>MI VIAJE</title>
  <meta name="theme-color" content="#1d4ed8"/>
  <link rel="manifest" href="manifest.json">
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    /* iPhone safe-area helpers */
    .safe-b { padding-bottom: max(env(safe-area-inset-bottom), 16px); }
    .safe-t { padding-top: max(env(safe-area-inset-top), 12px); }
    .tap { -webkit-tap-highlight-color: transparent; }
  </style>
</head>
<body class="bg-slate-50 text-slate-900">
  <!-- Top bar -->
  <header class="safe-t sticky top-0 z-40 bg-white/90 backdrop-blur border-b border-slate-200">
    <div class="max-w-6xl mx-auto px-4 py-3 flex items-center justify-between gap-3">
      <div class="flex items-center gap-3">
        <img src="icon.png" class="w-10 h-10 rounded-2xl" alt="MI VIAJE"/>
        <div class="leading-tight">
          <div class="font-extrabold tracking-tight text-lg">MI VIAJE</div>
          <div class="text-xs text-slate-500">Build rewrite ‚Ä¢ iPhone-first ‚Ä¢ Gemini</div>
        </div>
      </div>

      <div class="flex items-center gap-2">
        <button id="btnTrips" class="tap px-3 py-2 rounded-xl border border-slate-200 bg-white hover:bg-slate-50 text-sm font-semibold">
          Guardar / Cargar
        </button>
        <button id="btnKey" class="tap px-3 py-2 rounded-xl bg-indigo-600 hover:bg-indigo-700 text-white text-sm font-semibold">
          Cambiar clave
        </button>
      </div>
    </div>
  </header>

  <!-- Main -->
  <main class="max-w-6xl mx-auto px-4 py-6 pb-24">
    <!-- Scenario toggle -->
    <div class="flex items-center justify-between gap-3 mb-5">
      <div class="inline-flex bg-white border border-slate-200 rounded-2xl p-1">
        <button id="tabA" class="tap px-4 py-2 rounded-2xl text-sm font-semibold">MI VIAJE</button>
        <button id="tabB" class="tap px-4 py-2 rounded-2xl text-sm font-semibold">VIAJE ALTERNATIVO</button>
      </div>

      <div class="flex items-center gap-2">
        <label class="text-sm text-slate-600">Moneda</label>
        <select id="displayCurrency" class="px-3 py-2 rounded-xl border border-slate-200 bg-white text-sm">
          <option value="EUR">‚Ç¨ EUR</option>
          <option value="USD">$ USD</option>
          <option value="GBP">¬£ GBP</option>
          <option value="JPY">¬• JPY</option>
        </select>
      </div>
    </div>

    <!-- Grid -->
    <div class="grid grid-cols-1 lg:grid-cols-12 gap-4">
      <section class="lg:col-span-8 space-y-4">

        <!-- LOGISTICA -->
        <div class="bg-white border border-slate-200 rounded-3xl overflow-hidden">
          <button data-acc="legs" class="w-full tap flex items-center justify-between px-5 py-4">
            <div class="flex items-center gap-3">
              <span class="inline-flex w-9 h-9 rounded-2xl bg-blue-50 items-center justify-center">üß≠</span>
              <div class="text-left">
                <div class="font-extrabold">LOG√çSTICA & TIEMPOS</div>
                <div class="text-xs text-slate-500">Trayectos, ciudades y husos</div>
              </div>
            </div>
            <span class="accIcon text-slate-400 text-xl">‚ñæ</span>
          </button>
          <div data-acc-body="legs" class="px-5 pb-5 hidden">
            <div class="flex justify-end mb-3">
              <button id="addLeg" class="tap px-4 py-2 rounded-xl bg-blue-600 hover:bg-blue-700 text-white text-sm font-semibold">+ A√±adir trayecto</button>
            </div>
            <div id="legsList" class="space-y-3"></div>
          </div>
        </div>

        <!-- ALOJAMIENTO -->
        <div class="bg-white border border-slate-200 rounded-3xl overflow-hidden">
          <button data-acc="stays" class="w-full tap flex items-center justify-between px-5 py-4">
            <div class="flex items-center gap-3">
              <span class="inline-flex w-9 h-9 rounded-2xl bg-emerald-50 items-center justify-center">üè®</span>
              <div class="text-left">
                <div class="font-extrabold">ESTANCIA & HOTELES</div>
                <div class="text-xs text-slate-500">Alojamientos, noches y coste</div>
              </div>
            </div>
            <span class="accIcon text-slate-400 text-xl">‚ñæ</span>
          </button>
          <div data-acc-body="stays" class="px-5 pb-5 hidden">
            <div class="flex justify-end mb-3">
              <button id="addStay" class="tap px-4 py-2 rounded-xl bg-emerald-600 hover:bg-emerald-700 text-white text-sm font-semibold">+ A√±adir alojamiento</button>
            </div>
            <div id="staysList" class="space-y-3"></div>
          </div>
        </div>

        <!-- COMIDAS -->
        <div class="bg-white border border-slate-200 rounded-3xl overflow-hidden">
          <button data-acc="meals" class="w-full tap flex items-center justify-between px-5 py-4">
            <div class="flex items-center gap-3">
              <span class="inline-flex w-9 h-9 rounded-2xl bg-amber-50 items-center justify-center">üçΩÔ∏è</span>
              <div class="text-left">
                <div class="font-extrabold">COMIDAS & DIETA</div>
                <div class="text-xs text-slate-500">Estimaci√≥n diaria por persona</div>
              </div>
            </div>
            <span class="accIcon text-slate-400 text-xl">‚ñæ</span>
          </button>
          <div data-acc-body="meals" class="px-5 pb-5 hidden">
            <div class="grid grid-cols-1 sm:grid-cols-3 gap-3">
              <div>
                <label class="text-xs text-slate-600">Gasto diario x persona</label>
                <input id="mealDaily" type="number" min="0" step="0.01" class="mt-1 w-full px-3 py-2 rounded-xl border border-slate-200" placeholder="Ej: 30">
              </div>
              <div>
                <label class="text-xs text-slate-600">N¬∫ personas</label>
                <input id="mealPeople" type="number" min="1" step="1" class="mt-1 w-full px-3 py-2 rounded-xl border border-slate-200" value="1">
              </div>
              <div>
                <label class="text-xs text-slate-600">D√≠as totales</label>
                <input id="mealDays" type="number" min="1" step="1" class="mt-1 w-full px-3 py-2 rounded-xl border border-slate-200" value="1">
              </div>
            </div>
            <div class="mt-3 text-sm">
              <span class="text-slate-600">Total comidas:</span>
              <span id="mealTotal" class="font-extrabold">0.00</span>
              <span id="mealCur" class="text-slate-500">EUR</span>
            </div>
          </div>
        </div>

        <!-- IA -->
        <div class="bg-white border border-slate-200 rounded-3xl overflow-hidden">
          <button data-acc="ai" class="w-full tap flex items-center justify-between px-5 py-4">
            <div class="flex items-center gap-3">
              <span class="inline-flex w-9 h-9 rounded-2xl bg-violet-50 items-center justify-center">ü§ñ</span>
              <div class="text-left">
                <div class="font-extrabold">SUGERENCIAS DE LA IA</div>
                <div class="text-xs text-slate-500">Lugares + tips √∫tiles (transporte, pases, etc.)</div>
              </div>
            </div>
            <span class="accIcon text-slate-400 text-xl">‚ñæ</span>
          </button>
          <div data-acc-body="ai" class="px-5 pb-5 hidden">
            <div class="flex flex-wrap gap-2 justify-end mb-3">
              <button id="aiPick" class="tap px-4 py-2 rounded-xl border border-slate-200 bg-white hover:bg-slate-50 text-sm font-semibold">1) Elegir temas</button>
              <button id="aiGenerate" class="tap px-4 py-2 rounded-xl bg-violet-600 hover:bg-violet-700 text-white text-sm font-semibold">2) Generar gu√≠a</button>
            </div>

            <div id="aiStatus" class="text-sm text-slate-500">
              Selecciona primero ciudades/actividades/alojamientos, luego genera.
            </div>

            <div id="aiResults" class="mt-4 space-y-4"></div>
          </div>
        </div>

        <!-- ACTIVIDADES -->
        <div class="bg-white border border-slate-200 rounded-3xl overflow-hidden">
          <button data-acc="acts" class="w-full tap flex items-center justify-between px-5 py-4">
            <div class="flex items-center gap-3">
              <span class="inline-flex w-9 h-9 rounded-2xl bg-fuchsia-50 items-center justify-center">üéØ</span>
              <div class="text-left">
                <div class="font-extrabold">OCIO & EXPERIENCIAS</div>
                <div class="text-xs text-slate-500">Actividades manuales y sugeridas</div>
              </div>
            </div>
            <span class="accIcon text-slate-400 text-xl">‚ñæ</span>
          </button>
          <div data-acc-body="acts" class="px-5 pb-5 hidden">
            <div class="flex justify-end mb-3">
              <button id="addAct" class="tap px-4 py-2 rounded-xl bg-fuchsia-600 hover:bg-fuchsia-700 text-white text-sm font-semibold">+ A√±adir actividad</button>
            </div>
            <div id="actsList" class="space-y-3"></div>
          </div>
        </div>

        <!-- TIMELINE -->
        <div class="bg-white border border-slate-200 rounded-3xl overflow-hidden">
          <button data-acc="timeline" class="w-full tap flex items-center justify-between px-5 py-4">
            <div class="flex items-center gap-3">
              <span class="inline-flex w-9 h-9 rounded-2xl bg-orange-50 items-center justify-center">üóìÔ∏è</span>
              <div class="text-left">
                <div class="font-extrabold">CRONOGRAMA</div>
                <div class="text-xs text-slate-500">Vista simple ordenada por fecha</div>
              </div>
            </div>
            <span class="accIcon text-slate-400 text-xl">‚ñæ</span>
          </button>
          <div data-acc-body="timeline" class="px-5 pb-5 hidden">
            <div id="timelineList" class="space-y-2"></div>
          </div>
        </div>

      </section>

      <!-- Summary -->
      <aside class="lg:col-span-4">
        <div class="bg-white border border-slate-200 rounded-3xl p-5 sticky top-24">
          <div class="font-extrabold text-lg">RESUMEN</div>
          <div class="mt-3 space-y-2 text-sm">
            <div class="flex justify-between"><span class="text-slate-600">Transporte</span><span id="sumTransport" class="font-semibold">0.00</span></div>
            <div class="flex justify-between"><span class="text-slate-600">Alojamiento</span><span id="sumStay" class="font-semibold">0.00</span></div>
            <div class="flex justify-between"><span class="text-slate-600">Actividades</span><span id="sumActs" class="font-semibold">0.00</span></div>
            <div class="flex justify-between"><span class="text-slate-600">Comidas</span><span id="sumMeals" class="font-semibold">0.00</span></div>
            <hr class="my-2">
            <div class="flex justify-between text-base"><span class="font-extrabold">TOTAL</span><span id="sumTotal" class="font-extrabold">0.00</span></div>
            <div class="text-xs text-slate-500">Moneda de visualizaci√≥n: <span id="sumCur">EUR</span></div>
          </div>

          <div class="mt-4 flex gap-2">
            <button id="btnCompare" class="tap flex-1 px-4 py-2 rounded-xl border border-slate-200 bg-white hover:bg-slate-50 text-sm font-semibold">
              Comparar A/B (simple)
            </button>
          </div>

          <div id="compareBox" class="mt-3 hidden text-sm bg-slate-50 border border-slate-200 rounded-2xl p-3"></div>
        </div>
      </aside>
    </div>
  </main>

  <!-- Bottom bar for mobile -->
  <nav class="safe-b fixed bottom-0 left-0 right-0 z-50 lg:hidden bg-white/95 backdrop-blur border-t border-slate-200">
    <div class="max-w-6xl mx-auto px-4 py-2 grid grid-cols-5 gap-2 text-xs">
      <button class="tap py-2 rounded-xl hover:bg-slate-50" data-jump="legs">üß≠<div>Plan</div></button>
      <button class="tap py-2 rounded-xl hover:bg-slate-50" data-jump="stays">üè®<div>Hoteles</div></button>
      <button class="tap py-2 rounded-xl hover:bg-slate-50" data-jump="meals">üçΩÔ∏è<div>Comidas</div></button>
      <button class="tap py-2 rounded-xl hover:bg-slate-50" data-jump="ai">ü§ñ<div>IA</div></button>
      <button class="tap py-2 rounded-xl hover:bg-slate-50" data-jump="timeline">üóìÔ∏è<div>Timeline</div></button>
    </div>
  </nav>

  <!-- Modals -->
  <div id="modalBackdrop" class="hidden fixed inset-0 z-[60] bg-black/40"></div>

  <div id="modalBox" class="hidden fixed inset-0 z-[70] flex items-center justify-center p-4">
    <div class="w-full max-w-xl bg-white rounded-3xl border border-slate-200 shadow-xl overflow-hidden">
      <div class="px-5 py-4 flex items-center justify-between border-b border-slate-200">
        <div class="font-extrabold" id="modalTitle">Modal</div>
        <button id="modalClose" class="tap px-3 py-2 rounded-xl hover:bg-slate-50">‚úï</button>
      </div>
      <div class="p-5" id="modalBody"></div>
      <div class="px-5 py-4 border-t border-slate-200 flex justify-end gap-2" id="modalFooter"></div>
    </div>
  </div>

<script>
/* ----------------------------- Utilities ----------------------------- */
const $ = (id) => document.getElementById(id);
const escapeHtml = (s) => String(s ?? "").replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#039;");
const cap1 = (s) => {
  s = String(s ?? "").trim();
  if (!s) return "";
  return s.charAt(0).toUpperCase() + s.slice(1);
};
const nowId = () => Math.random().toString(36).slice(2,10);
const parseMoney = (v) => {
  const n = Number(String(v ?? "").replace(",", "."));
  return Number.isFinite(n) ? n : 0;
};
const uniq = (arr) => Array.from(new Set(arr.map(x => String(x).trim()).filter(Boolean)));

function showModal(title, bodyHtml, footerButtons = []) {
  $("modalTitle").textContent = title;
  $("modalBody").innerHTML = bodyHtml;
  const footer = $("modalFooter");
  footer.innerHTML = "";
  for (const b of footerButtons) footer.appendChild(b);
  $("modalBackdrop").classList.remove("hidden");
  $("modalBox").classList.remove("hidden");
}
function closeModal() {
  $("modalBackdrop").classList.add("hidden");
  $("modalBox").classList.add("hidden");
}
$("modalClose").addEventListener("click", closeModal);
$("modalBackdrop").addEventListener("click", closeModal);

/* ----------------------------- State ----------------------------- */
const LS_KEY = "miviaje.rewrite.v1";
const LS_KEY_GEMINI = "miviaje.gemini.key";

/* ------------------------- Sync helpers (iCloud) ------------------------- */
const META_KEY = "miviaje.meta.v1";
const BACKUPS_KEY = "miviaje.backups.v1";
const DEVICE_KEY = "miviaje.deviceName.v1";

function getMeta() {
  try { return JSON.parse(localStorage.getItem(META_KEY) || "{}") || {}; }
  catch { return {}; }
}
function setMeta(patch) {
  const cur = getMeta();
  const next = Object.assign({}, cur, patch || {});
  localStorage.setItem(META_KEY, JSON.stringify(next));
  return next;
}
function getDeviceName(askIfMissing = true) {
  let v = (localStorage.getItem(DEVICE_KEY) || "").trim();
  if (!v && askIfMissing) {
    v = (prompt("Nombre de este dispositivo (ej: iPhone Juan / iPhone Mar√≠a):", "") || "").trim();
    if (v) localStorage.setItem(DEVICE_KEY, v);
  }
  return v || "Dispositivo";
}
function pushBackup(reason, fromPayloadMeta = null) {
  try {
    const meta = getMeta();
    const item = {
      savedAt: new Date().toISOString(),
      reason: reason || "backup",
      deviceName: getDeviceName(false),
      from: fromPayloadMeta || null,
      state
    };
    const list = JSON.parse(localStorage.getItem(BACKUPS_KEY) || "[]");
    list.unshift(item);
    localStorage.setItem(BACKUPS_KEY, JSON.stringify(list.slice(0, 15)));
  } catch {}
}
function getLatestBackup() {
  try {
    const list = JSON.parse(localStorage.getItem(BACKUPS_KEY) || "[]");
    return list?.[0] || null;
  } catch { return null; }
}

const emptyScenario = () => ({
  legs: [],
  stays: [],
  meals: { daily: 0, people: 1, days: 1 },
  activities: []
});

let state = {
  scenario: "A",
  displayCurrency: "EUR",
  scenarios: { A: emptyScenario(), B: emptyScenario() },
  aiPick: { cities: [], items: [] } // chosen topics
};

function loadState() {
  try {
    const raw = localStorage.getItem(LS_KEY);
    if (raw) state = Object.assign(state, JSON.parse(raw));
  } catch {}
}
function saveState() {
  localStorage.setItem(LS_KEY, JSON.stringify(state));
}
function curScenario() { return state.scenarios[state.scenario]; }

/* -------------------------- Currency convert ------------------------- */
/* Simple: no external API. Keeps values in display currency.
   You can later swap to real rates if needed. */
function setDisplayCurrency(cur) {
  state.displayCurrency = cur;
  $("sumCur").textContent = cur;
  $("mealCur").textContent = cur;
  saveState();
  renderAll();
}

/* ----------------------------- Accordion ----------------------------- */
function setupAccordion() {
  document.querySelectorAll("[data-acc]").forEach(btn => {
    btn.addEventListener("click", () => {
      const key = btn.getAttribute("data-acc");
      const body = document.querySelector(`[data-acc-body="${key}"]`);
      body.classList.toggle("hidden");
      const icon = btn.querySelector(".accIcon");
      icon.textContent = body.classList.contains("hidden") ? "‚ñæ" : "‚ñ¥";
    });
  });
  // Open first two by default
  document.querySelector('[data-acc="legs"]').click();
  document.querySelector('[data-acc="stays"]').click();
}

/* ------------------------------ Rendering ---------------------------- */
function renderAll() {
  renderTabs();
  renderLegs();
  renderStays();
  renderMeals();
  renderActivities();
  renderTimeline();
  calcSummary();
}

function renderTabs() {
  const a = $("tabA"), b = $("tabB");
  const onA = state.scenario === "A";
  a.className = "tap px-4 py-2 rounded-2xl text-sm font-semibold " + (onA ? "bg-indigo-600 text-white" : "text-slate-700");
  b.className = "tap px-4 py-2 rounded-2xl text-sm font-semibold " + (!onA ? "bg-indigo-600 text-white" : "text-slate-700");
  $("displayCurrency").value = state.displayCurrency;
  $("sumCur").textContent = state.displayCurrency;
  $("mealCur").textContent = state.displayCurrency;
}

function legCard(leg) {
  const tzFrom = leg.tzFrom ? `<span class="text-xs text-slate-500">UTC ${leg.tzFrom >= 0 ? "+" : ""}${leg.tzFrom}</span>` : `<span class="text-xs text-slate-400">UTC ‚Äî</span>`;
  const tzTo   = leg.tzTo   ? `<span class="text-xs text-slate-500">UTC ${leg.tzTo   >= 0 ? "+" : ""}${leg.tzTo}</span>` : `<span class="text-xs text-slate-400">UTC ‚Äî</span>`;
  return `
  <div class="border border-slate-200 rounded-2xl p-4 bg-slate-50">
    <div class="grid grid-cols-1 sm:grid-cols-12 gap-3 items-end">
      <div class="sm:col-span-3">
        <label class="text-xs text-slate-600">Salida</label>
        <input data-leg-from="${leg.id}" class="mt-1 w-full px-3 py-2 rounded-xl border border-slate-200" value="${escapeHtml(leg.from)}" placeholder="Ciudad origen">
        <div class="mt-1">${tzFrom}</div>
      </div>
      <div class="sm:col-span-3">
        <label class="text-xs text-slate-600">Llegada</label>
        <input data-leg-to="${leg.id}" class="mt-1 w-full px-3 py-2 rounded-xl border border-slate-200" value="${escapeHtml(leg.to)}" placeholder="Ciudad destino">
        <div class="mt-1">${tzTo}</div>
      </div>
      <div class="sm:col-span-2">
        <label class="text-xs text-slate-600">Fecha</label>
        <input data-leg-date="${leg.id}" type="date" class="mt-1 w-full px-3 py-2 rounded-xl border border-slate-200" value="${escapeHtml(leg.date || "")}">
      </div>
      <div class="sm:col-span-2">
        <label class="text-xs text-slate-600">Coste</label>
        <input data-leg-cost="${leg.id}" type="number" min="0" step="0.01" class="mt-1 w-full px-3 py-2 rounded-xl border border-slate-200" value="${escapeHtml(leg.cost ?? "")}" placeholder="0.00">
      </div>
      <div class="sm:col-span-2 flex justify-end">
        <button data-leg-del="${leg.id}" class="tap px-3 py-2 rounded-xl bg-white border border-slate-200 hover:bg-slate-100 text-sm">üóëÔ∏è</button>
      </div>
    </div>
  </div>`;
}

function renderLegs() {
  const box = $("legsList");
  const sc = curScenario();
  box.innerHTML = sc.legs.length ? sc.legs.map(legCard).join("") : `<div class="text-sm text-slate-500">A√±ade trayectos para construir tu ruta.</div>`;

  box.querySelectorAll("[data-leg-del]").forEach(b => b.addEventListener("click", () => {
    const id = b.getAttribute("data-leg-del");
    sc.legs = sc.legs.filter(x => x.id !== id);
    saveState(); renderAll();
  }));

  box.querySelectorAll("[data-leg-from]").forEach(inp => inp.addEventListener("change", async () => {
    const id = inp.getAttribute("data-leg-from");
    const leg = sc.legs.find(x => x.id === id);
    leg.from = cap1(inp.value);
    inp.value = leg.from;
    saveState(); renderAll();
    await updateTimezoneForLeg(id, "from");
  }));
  box.querySelectorAll("[data-leg-to]").forEach(inp => inp.addEventListener("change", async () => {
    const id = inp.getAttribute("data-leg-to");
    const leg = sc.legs.find(x => x.id === id);
    leg.to = cap1(inp.value);
    inp.value = leg.to;
    saveState(); renderAll();
    await updateTimezoneForLeg(id, "to");
  }));
  box.querySelectorAll("[data-leg-date]").forEach(inp => inp.addEventListener("change", () => {
    const id = inp.getAttribute("data-leg-date");
    const leg = sc.legs.find(x => x.id === id);
    leg.date = inp.value;
    saveState(); renderAll();
  }));
  box.querySelectorAll("[data-leg-cost]").forEach(inp => inp.addEventListener("input", () => {
    const id = inp.getAttribute("data-leg-cost");
    const leg = sc.legs.find(x => x.id === id);
    leg.cost = parseMoney(inp.value);
    saveState(); calcSummary(); renderTimeline();
  }));
}

function stayCard(stay) {
  return `
  <div class="border border-slate-200 rounded-2xl p-4 bg-slate-50">
    <div class="grid grid-cols-1 sm:grid-cols-12 gap-3 items-end">
      <div class="sm:col-span-4">
        <label class="text-xs text-slate-600">Ciudad</label>
        <input data-stay-city="${stay.id}" class="mt-1 w-full px-3 py-2 rounded-xl border border-slate-200" value="${escapeHtml(stay.city)}" placeholder="Ciudad">
      </div>
      <div class="sm:col-span-3">
        <label class="text-xs text-slate-600">Hotel</label>
        <input data-stay-name="${stay.id}" class="mt-1 w-full px-3 py-2 rounded-xl border border-slate-200" value="${escapeHtml(stay.name)}" placeholder="Nombre">
      </div>
      <div class="sm:col-span-2">
        <label class="text-xs text-slate-600">Noches</label>
        <input data-stay-nights="${stay.id}" type="number" min="1" step="1" class="mt-1 w-full px-3 py-2 rounded-xl border border-slate-200" value="${escapeHtml(stay.nights ?? 1)}">
      </div>
      <div class="sm:col-span-2">
        <label class="text-xs text-slate-600">Coste</label>
        <input data-stay-cost="${stay.id}" type="number" min="0" step="0.01" class="mt-1 w-full px-3 py-2 rounded-xl border border-slate-200" value="${escapeHtml(stay.cost ?? "")}">
      </div>
      <div class="sm:col-span-1 flex justify-end">
        <button data-stay-del="${stay.id}" class="tap px-3 py-2 rounded-xl bg-white border border-slate-200 hover:bg-slate-100 text-sm">üóëÔ∏è</button>
      </div>
    </div>
  </div>`;
}
function renderStays() {
  const box = $("staysList");
  const sc = curScenario();
  box.innerHTML = sc.stays.length ? sc.stays.map(stayCard).join("") : `<div class="text-sm text-slate-500">A√±ade alojamientos para estimar noches y coste.</div>`;

  box.querySelectorAll("[data-stay-del]").forEach(b => b.addEventListener("click", () => {
    const id = b.getAttribute("data-stay-del");
    sc.stays = sc.stays.filter(x => x.id !== id);
    saveState(); renderAll();
  }));
  box.querySelectorAll("[data-stay-city]").forEach(inp => inp.addEventListener("change", () => {
    const id = inp.getAttribute("data-stay-city");
    const s = sc.stays.find(x => x.id === id);
    s.city = cap1(inp.value); inp.value = s.city;
    saveState(); renderTimeline();
  }));
  box.querySelectorAll("[data-stay-name]").forEach(inp => inp.addEventListener("change", () => {
    const id = inp.getAttribute("data-stay-name");
    sc.stays.find(x => x.id === id).name = inp.value.trim();
    saveState(); renderTimeline();
  }));
  box.querySelectorAll("[data-stay-nights]").forEach(inp => inp.addEventListener("input", () => {
    const id = inp.getAttribute("data-stay-nights");
    sc.stays.find(x => x.id === id).nights = Math.max(1, parseInt(inp.value || "1",10));
    saveState(); calcSummary();
  }));
  box.querySelectorAll("[data-stay-cost]").forEach(inp => inp.addEventListener("input", () => {
    const id = inp.getAttribute("data-stay-cost");
    sc.stays.find(x => x.id === id).cost = parseMoney(inp.value);
    saveState(); calcSummary();
  }));
}

function renderMeals() {
  const sc = curScenario();
  $("mealDaily").value = sc.meals.daily ?? 0;
  $("mealPeople").value = sc.meals.people ?? 1;
  $("mealDays").value = sc.meals.days ?? 1;
  const total = (parseMoney(sc.meals.daily) * (parseInt(sc.meals.people||1,10)) * (parseInt(sc.meals.days||1,10)));
  $("mealTotal").textContent = total.toFixed(2);
}

function actCard(act) {
  return `
  <div class="border border-slate-200 rounded-2xl p-4 bg-slate-50">
    <div class="grid grid-cols-1 sm:grid-cols-12 gap-3 items-end">
      <div class="sm:col-span-4">
        <label class="text-xs text-slate-600">Actividad</label>
        <input data-act-title="${act.id}" class="mt-1 w-full px-3 py-2 rounded-xl border border-slate-200" value="${escapeHtml(act.title)}" placeholder="Ej: Museo / Tour / Restaurante">
      </div>
      <div class="sm:col-span-3">
        <label class="text-xs text-slate-600">Ciudad</label>
        <input data-act-city="${act.id}" class="mt-1 w-full px-3 py-2 rounded-xl border border-slate-200" value="${escapeHtml(act.city)}" placeholder="Ciudad">
      </div>
      <div class="sm:col-span-2">
        <label class="text-xs text-slate-600">Fecha</label>
        <input data-act-date="${act.id}" type="date" class="mt-1 w-full px-3 py-2 rounded-xl border border-slate-200" value="${escapeHtml(act.date||"")}">
      </div>
      <div class="sm:col-span-2">
        <label class="text-xs text-slate-600">Coste</label>
        <input data-act-cost="${act.id}" type="number" min="0" step="0.01" class="mt-1 w-full px-3 py-2 rounded-xl border border-slate-200" value="${escapeHtml(act.cost ?? "")}">
      </div>
      <div class="sm:col-span-1 flex justify-end">
        <button data-act-del="${act.id}" class="tap px-3 py-2 rounded-xl bg-white border border-slate-200 hover:bg-slate-100 text-sm">üóëÔ∏è</button>
      </div>
    </div>
    ${act.fromAI ? `<div class="mt-2 text-xs text-slate-500">A√±adida desde IA</div>` : ``}
  </div>`;
}
function renderActivities() {
  const box = $("actsList");
  const sc = curScenario();
  box.innerHTML = sc.activities.length ? sc.activities.map(actCard).join("") : `<div class="text-sm text-slate-500">A√±ade actividades o incorpora sugerencias desde la IA.</div>`;

  box.querySelectorAll("[data-act-del]").forEach(b => b.addEventListener("click", () => {
    const id = b.getAttribute("data-act-del");
    sc.activities = sc.activities.filter(x => x.id !== id);
    saveState(); renderAll();
  }));
  box.querySelectorAll("[data-act-title]").forEach(inp => inp.addEventListener("change", () => {
    const id = inp.getAttribute("data-act-title");
    sc.activities.find(x => x.id === id).title = inp.value.trim();
    saveState(); renderTimeline();
  }));
  box.querySelectorAll("[data-act-city]").forEach(inp => inp.addEventListener("change", () => {
    const id = inp.getAttribute("data-act-city");
    const a = sc.activities.find(x => x.id === id);
    a.city = cap1(inp.value); inp.value = a.city;
    saveState(); renderTimeline();
  }));
  box.querySelectorAll("[data-act-date]").forEach(inp => inp.addEventListener("change", () => {
    const id = inp.getAttribute("data-act-date");
    sc.activities.find(x => x.id === id).date = inp.value;
    saveState(); renderTimeline();
  }));
  box.querySelectorAll("[data-act-cost]").forEach(inp => inp.addEventListener("input", () => {
    const id = inp.getAttribute("data-act-cost");
    sc.activities.find(x => x.id === id).cost = parseMoney(inp.value);
    saveState(); calcSummary();
  }));
}

function renderTimeline() {
  const box = $("timelineList");
  const sc = curScenario();
  const items = [];

  for (const leg of sc.legs) {
    items.push({ date: leg.date || "9999-99-99", type:"Trayecto", title: `${leg.from || "‚Äî"} ‚Üí ${leg.to || "‚Äî"}`, cost: parseMoney(leg.cost) });
  }
  for (const s of sc.stays) {
    items.push({ date: "9999-99-99", type:"Alojamiento", title: `${s.city || "‚Äî"} ‚Ä¢ ${s.name || "Hotel"}`, cost: parseMoney(s.cost) });
  }
  for (const a of sc.activities) {
    items.push({ date: a.date || "9999-99-99", type:"Actividad", title: `${a.city || "‚Äî"} ‚Ä¢ ${a.title || "Actividad"}`, cost: parseMoney(a.cost) });
  }

  items.sort((x,y)=> String(x.date).localeCompare(String(y.date)));

  if (!items.length) {
    box.innerHTML = `<div class="text-sm text-slate-500">No hay eventos todav√≠a.</div>`;
    return;
  }

  box.innerHTML = items.map(it => `
    <div class="flex items-start justify-between gap-3 border border-slate-200 rounded-2xl p-3 bg-slate-50">
      <div>
        <div class="text-xs text-slate-500">${it.date === "9999-99-99" ? "Sin fecha" : it.date} ‚Ä¢ ${it.type}</div>
        <div class="font-semibold">${escapeHtml(it.title)}</div>
      </div>
      <div class="font-semibold">${it.cost ? it.cost.toFixed(2) : "‚Äî"}</div>
    </div>
  `).join("");
}

function calcSummary() {
  const sc = curScenario();
  const transport = sc.legs.reduce((a,x)=>a+parseMoney(x.cost),0);
  const stay = sc.stays.reduce((a,x)=>a+parseMoney(x.cost),0);
  const acts = sc.activities.reduce((a,x)=>a+parseMoney(x.cost),0);
  const meals = parseMoney(sc.meals.daily) * (parseInt(sc.meals.people||1,10)) * (parseInt(sc.meals.days||1,10));

  $("sumTransport").textContent = transport.toFixed(2);
  $("sumStay").textContent = stay.toFixed(2);
  $("sumActs").textContent = acts.toFixed(2);
  $("sumMeals").textContent = meals.toFixed(2);
  $("sumTotal").textContent = (transport+stay+acts+meals).toFixed(2);
}

/* --------------------------- Gemini helpers -------------------------- */
function getGeminiKey() {
  return localStorage.getItem(LS_KEY_GEMINI) || "";
}
function setGeminiKey(key) {
  localStorage.setItem(LS_KEY_GEMINI, key.trim());
}
function cleanJsonText(t) {
  t = String(t || "").trim();
  t = t.replace(/```json/gi, "```");
  if (t.startsWith("```")) {
    t = t.replace(/^```[a-zA-Z]*\n?/, "");
    t = t.replace(/```$/, "");
  }
  return t.trim();
}

async function geminiGenerateJSON(prompt, schemaHint = "") {
  const key = getGeminiKey();
  if (!key) throw new Error("NO_KEY");
  const model = "gemini-2.5-flash";
  const url = `https://generativelanguage.googleapis.com/v1beta/models/${model}:generateContent?key=${encodeURIComponent(key)}`;

  const body = {
    contents: [{ role: "user", parts: [{ text: prompt + (schemaHint ? "\n\n" + schemaHint : "") }] }],
    generationConfig: {
      temperature: 0.4,
      responseMimeType: "application/json"
    }
  };

  const r = await fetch(url, { method:"POST", headers: { "Content-Type":"application/json" }, body: JSON.stringify(body) });
  const data = await r.json();
  if (!r.ok) throw new Error("GEMINI_" + r.status + " " + JSON.stringify(data));
  let txt = data?.candidates?.[0]?.content?.parts?.[0]?.text || "";
  txt = cleanJsonText(txt);
  return JSON.parse(txt);
}

/* -------------------------- Timezone automation ---------------------- */
const tzCache = new Map(); // city -> {offset, tz}
async function getCityTimezone(city) {
  city = String(city||"").trim();
  if (!city) return null;
  if (tzCache.has(city)) return tzCache.get(city);

  const schema = `Devuelve SOLO este JSON: {"timezone":"Area/City","offset":-5}\n"offset" debe ser el offset UTC actual aproximado (n√∫mero entero).`;
  const prompt = `Dime la zona horaria IANA y el offset UTC entero aproximado para la ciudad: ${city}.`;
  const res = await geminiGenerateJSON(prompt, schema);
  tzCache.set(city, res);
  return res;
}
async function updateTimezoneForLeg(legId, which) {
  const sc = curScenario();
  const leg = sc.legs.find(x => x.id === legId);
  if (!leg) return;
  const city = which === "from" ? leg.from : leg.to;
  if (!city) return;
  try {
    const tz = await getCityTimezone(city);
    if (!tz) return;
    if (which === "from") leg.tzFrom = tz.offset;
    else leg.tzTo = tz.offset;
    saveState(); renderLegs();
  } catch(e) {
    // silent: key missing or API error
  }
}

/* ------------------------------- AI flow ----------------------------- */
function gatherAIPickOptions() {
  const sc = curScenario();
  const destinations = uniq(sc.legs.map(l => l.to).filter(Boolean));
  const origin = sc.legs.length ? String(sc.legs[0].from || "").trim() : "";
  const filteredDest = destinations.filter(c => c.toLowerCase() !== origin.toLowerCase() && c.toLowerCase() !== "madrid");

  const acts = uniq(sc.activities.map(a => (a.city ? `${a.city}: ${a.title}` : a.title)).filter(Boolean));
  const stays = uniq(sc.stays.map(s => (s.city ? `${s.city}: ${s.name}` : s.name)).filter(Boolean));

  return { origin, cities: filteredDest, acts, stays };
}

function openAIPickModal() {
  const opt = gatherAIPickOptions();
  if (!opt.cities.length && !opt.acts.length && !opt.stays.length) {
    $("aiStatus").textContent = "A√±ade al menos un trayecto, alojamiento o actividad para pedir sugerencias.";
    return;
  }

  const buildChecks = (items, prefix) => items.map((t,i)=>`
    <label class="flex items-center gap-2 py-1">
      <input type="checkbox" data-pick="${prefix}:${i}" class="w-4 h-4">
      <span>${escapeHtml(t)}</span>
    </label>
  `).join("");

  const html = `
    <div class="text-sm text-slate-600 mb-3">
      Selecciona sobre qu√© quieres sugerencias. Se excluye la ciudad de salida (<b>${escapeHtml(opt.origin||"‚Äî")}</b>).
    </div>
    <div class="grid grid-cols-1 sm:grid-cols-3 gap-4">
      <div>
        <div class="font-extrabold mb-2">Destinos</div>
        ${opt.cities.length ? buildChecks(opt.cities, "city") : `<div class="text-sm text-slate-400">‚Äî</div>`}
      </div>
      <div>
        <div class="font-extrabold mb-2">Actividades</div>
        ${opt.acts.length ? buildChecks(opt.acts, "act") : `<div class="text-sm text-slate-400">‚Äî</div>`}
      </div>
      <div>
        <div class="font-extrabold mb-2">Alojamientos</div>
        ${opt.stays.length ? buildChecks(opt.stays, "stay") : `<div class="text-sm text-slate-400">‚Äî</div>`}
      </div>
    </div>
  `;

  const btnSave = document.createElement("button");
  btnSave.className = "tap px-4 py-2 rounded-xl bg-indigo-600 hover:bg-indigo-700 text-white text-sm font-semibold";
  btnSave.textContent = "Guardar selecci√≥n";
  btnSave.onclick = () => {
    const picks = Array.from(document.querySelectorAll("[data-pick]")).filter(x=>x.checked).map(x=>x.getAttribute("data-pick"));
    const cities = picks.filter(p=>p.startsWith("city:")).map(p=>opt.cities[parseInt(p.split(":")[1],10)]);
    const items = picks.filter(p=>!p.startsWith("city:")).map(p=>{
      const [k,idx] = p.split(":");
      const i = parseInt(idx,10);
      if (k==="act") return { type:"activity", text: opt.acts[i] };
      if (k==="stay") return { type:"stay", text: opt.stays[i] };
      return null;
    }).filter(Boolean);

    state.aiPick = { cities, items };
    saveState();
    $("aiStatus").textContent = `Selecci√≥n guardada: ${cities.length} destinos, ${items.length} items. Pulsa "Generar gu√≠a".`;
    closeModal();
  };

  const btnCancel = document.createElement("button");
  btnCancel.className = "tap px-4 py-2 rounded-xl border border-slate-200 bg-white hover:bg-slate-50 text-sm font-semibold";
  btnCancel.textContent = "Cancelar";
  btnCancel.onclick = closeModal;

  showModal("Elegir temas para la IA", html, [btnCancel, btnSave]);
}

function renderAIResults(sections) {
  const box = $("aiResults");
  if (!sections.length) { box.innerHTML = ""; return; }

  box.innerHTML = sections.map((sec, sidx) => {
    const tipsHtml = (sec.tips || []).map(t=>`<li><b>${escapeHtml(t.title||"Tip")}</b>: ${escapeHtml(t.detail||"")}</li>`).join("");
    const spotsHtml = (sec.spots || []).map((sp, i)=>`
      <label class="flex items-start gap-3 p-3 rounded-2xl border border-slate-200 bg-white">
        <input type="checkbox" class="mt-1 w-4 h-4" data-ai-spot="${sidx}:${i}">
        <div>
          <div class="font-extrabold">${escapeHtml(sp.title||"Lugar")}</div>
          <div class="text-sm text-slate-600">${escapeHtml(sp.desc||"")}</div>
          <div class="text-xs text-slate-500 mt-1">${escapeHtml(sec.city||"")}</div>
        </div>
      </label>
    `).join("");

    return `
      <div class="border border-slate-200 rounded-3xl p-4 bg-slate-50">
        <div class="flex items-center justify-between gap-2">
          <div class="font-extrabold text-lg">${escapeHtml(sec.city || sec.topic || "Sugerencias")}</div>
          <span class="text-xs text-slate-500">${(sec.spots||[]).length} lugares</span>
        </div>
        ${(sec.tips && sec.tips.length) ? `
          <div class="mt-3">
            <div class="font-extrabold">Tips √∫tiles</div>
            <ul class="list-disc pl-5 text-sm text-slate-700 mt-1">${tipsHtml}</ul>
          </div>
        ` : ``}
        <div class="mt-3 grid grid-cols-1 gap-2">
          ${spotsHtml || `<div class="text-sm text-slate-500">Sin lugares.</div>`}
        </div>
      </div>
    `;
  }).join("");

  const btnAdd = document.createElement("button");
  btnAdd.className = "tap px-4 py-2 rounded-xl bg-fuchsia-600 hover:bg-fuchsia-700 text-white text-sm font-semibold";
  btnAdd.textContent = "A√±adir seleccionadas a Actividades";
  btnAdd.onclick = () => {
    const sc = curScenario();
    const checks = Array.from(document.querySelectorAll("[data-ai-spot]")).filter(x=>x.checked);
    let added = 0;
    for (const c of checks) {
      const [sidx, i] = c.getAttribute("data-ai-spot").split(":").map(x=>parseInt(x,10));
      const sec = window.__aiSections[sidx];
      const sp = sec.spots[i];
      sc.activities.push({
        id: nowId(),
        title: sp.title,
        city: sec.city || "",
        date: "", // optional
        cost: 0,
        fromAI: true
      });
      added++;
    }
    saveState();
    renderAll();
    $("aiStatus").textContent = added ? `A√±adidas ${added} actividades.` : "No has seleccionado ninguna recomendaci√≥n.";
  };

  // attach under results
  const actionBar = document.createElement("div");
  actionBar.className = "mt-3 flex justify-end";
  actionBar.appendChild(btnAdd);
  box.prepend(actionBar);
}

async function generateAIGuide() {
  const pick = state.aiPick || { cities: [], items: [] };
  if ((!pick.cities || !pick.cities.length) && (!pick.items || !pick.items.length)) {
    $("aiStatus").textContent = "Primero pulsa ‚Äú1) Elegir temas‚Äù y marca al menos un destino o item.";
    return;
  }
  if (!getGeminiKey()) {
    $("aiStatus").textContent = "Primero pulsa ‚ÄúCambiar clave‚Äù y pega tu API Key de Gemini (AIza‚Ä¶).";
    return;
  }

  $("aiStatus").textContent = "Generando gu√≠a‚Ä¶ (Gemini 2.5 Flash)";
  $("aiResults").innerHTML = "";

  const schema = `Devuelve SOLO JSON v√°lido con este formato:
{
  "sections":[
    {
      "city":"Nueva York",
      "spots":[{"title":"...","desc":"..."}],
      "tips":[{"title":"Transporte p√∫blico","detail":"..."}]
    }
  ]
}`;
  const topics = [];
  for (const c of (pick.cities||[])) topics.push({ kind:"city", value:c });
  for (const it of (pick.items||[])) topics.push({ kind:it.type, value:it.text });

  const sections = [];
  for (const t of topics) {
    const prompt = `Eres un gu√≠a local experto y pr√°ctico.
Genera recomendaciones tur√≠sticas y tips √∫tiles para: ${t.value}
Idioma: espa√±ol.
Si es una ciudad, prioriza lugares imprescindibles + 1-2 lugares menos t√≠picos.
Incluye tips √∫tiles (abonos de transporte, c√≥mo moverse, horarios t√≠picos, trucos locales).
M√°ximo: 6 lugares y 4 tips.
NO incluyas URLs.`;
    try {
      const out = await geminiGenerateJSON(prompt, schema);
      for (const sec of (out.sections || [])) {
        // normalize
        sections.push({
          city: sec.city || (t.kind==="city" ? t.value : ""),
          topic: t.value,
          spots: (sec.spots || []).slice(0,6),
          tips: (sec.tips || []).slice(0,4)
        });
      }
    } catch(e) {
      console.error(e);
      $("aiStatus").textContent = "Error generando gu√≠a. Revisa la clave o reintenta.";
      return;
    }
  }

  window.__aiSections = sections;
  $("aiStatus").textContent = `Gu√≠a lista: ${sections.length} bloque(s). Marca lugares para a√±adirlos al plan.`;
  renderAIResults(sections);
}

/* ------------------------ Save / Load (simple) ----------------------- */
function openTripsModal() {
  const html = `
    <div class="text-sm text-slate-600 mb-3">
      Guardar / Cargar en el dispositivo. Tambi√©n se guarda una copia local para listar viajes.
    </div>
    <div id="syncStatus" class="text-xs text-slate-500 mb-3"></div>
    <div class="flex items-center justify-between gap-2 mb-3">
      <button id="restoreBackup" class="tap px-3 py-2 rounded-xl border border-slate-200 bg-white hover:bg-slate-50 text-xs font-semibold">Restaurar √∫ltimo backup</button>
      <button id="setDeviceName" class="tap px-3 py-2 rounded-xl border border-slate-200 bg-white hover:bg-slate-50 text-xs font-semibold">Nombre del iPhone</button>
    </div>
    <div class="grid grid-cols-1 sm:grid-cols-2 gap-3">
      <button id="doExport" class="tap px-4 py-3 rounded-2xl bg-indigo-600 hover:bg-indigo-700 text-white font-semibold">Guardar (descargar .json)</button>
      <label class="tap px-4 py-3 rounded-2xl border border-slate-200 bg-white hover:bg-slate-50 font-semibold text-center cursor-pointer">
        Cargar (importar .json)
        <input id="doImport" type="file" accept="application/json" class="hidden">
      </label>
    </div>
    <div class="mt-4">
      <div class="font-extrabold mb-2">Mis viajes (local)</div>
      <div id="tripList" class="space-y-2"></div>
    </div>
  `;
  showModal("Guardar / Cargar", html, []);
  setTimeout(() => {
    const refresh = () => {
      const meta = getMeta();
      const lastSync = meta.lastSyncAt ? new Date(meta.lastSyncAt).toLocaleString() : "Nunca";
      const fromDev = meta.lastSyncedFromDevice ? ` ‚Ä¢ desde ${meta.lastSyncedFromDevice}` : "";
      const lastExport = meta.lastSavedAt ? new Date(meta.lastSavedAt).toLocaleString() : "‚Äî";
      const dev = getDeviceName(false);
      $("syncStatus").textContent = `Este iPhone: ${dev} ‚Ä¢ √öltima sincronizaci√≥n: ${lastSync}${fromDev} ‚Ä¢ √öltima exportaci√≥n: ${lastExport}`;
      const b = getLatestBackup();
      $("restoreBackup").disabled = !b;
      $("restoreBackup").classList.toggle("opacity-40", !b);
    };

    $("doExport").onclick = () => { exportTrip(); refresh(); };
    $("doImport").onchange = async (ev) => { await importTrip(ev); refresh(); };
    $("restoreBackup").onclick = () => {
      const b = getLatestBackup();
      if (!b) return alert("No hay backups todav√≠a.");
      if (!confirm(`¬øRestaurar el √∫ltimo backup?\n${b.savedAt}\nMotivo: ${b.reason}`)) return;
      state = b.state;
      saveState();
      closeModal();
      renderAll();
      alert("Backup restaurado.");
    };
    $("setDeviceName").onclick = () => {
      const v = prompt("Nombre de este iPhone:", (localStorage.getItem(DEVICE_KEY) || "").trim());
      if (v && v.trim()) localStorage.setItem(DEVICE_KEY, v.trim());
      refresh();
    };

    renderTripList();
    refresh();
  }, 0);
}

function exportTrip() {
  const deviceName = getDeviceName(true);

  // Warn if this device has synced more recently than it has exported
  const meta = getMeta();
  if (meta.lastSyncAt) {
    const lastSync = Date.parse(meta.lastSyncAt);
    const lastExport = meta.lastSavedAt ? Date.parse(meta.lastSavedAt) : 0;
    if (Number.isFinite(lastSync) && lastSync && lastExport < lastSync) {
      const when = new Date(meta.lastSyncAt).toLocaleString();
      const from = meta.lastSyncedFromDevice ? ` (desde ${meta.lastSyncedFromDevice})` : "";
      const ok = confirm(`Ojo: este iPhone sincroniz√≥ el ${when}${from}, pero a√∫n no ha exportado despu√©s.\n\nSi exportas ahora desde un tel√©fono que no ha importado lo √∫ltimo, podr√≠as sobrescribir el archivo maestro de iCloud.\n\n¬øQuieres exportar igualmente?`);
      if (!ok) return;
    }
  }

  const name = prompt("Nombre para este viaje (ej: Jap√≥n 2026):", "MI VIAJE");
  const savedAtNow = new Date().toISOString();
  const payload = {
    schemaVersion: 1,
    name: name || "MI VIAJE",
    savedAt: savedAtNow,
    deviceName,
    state
  };

  // save to local list
  const list = JSON.parse(localStorage.getItem("miviaje.trip.list") || "[]");
  list.unshift(payload);
  localStorage.setItem("miviaje.trip.list", JSON.stringify(list.slice(0,30)));

  // update meta
  setMeta({ lastSavedAt: savedAtNow, lastSavedByDevice: deviceName });

  const blob = new Blob([JSON.stringify(payload, null, 2)], { type:"application/json" });
  const a = document.createElement("a");
  a.href = URL.createObjectURL(blob);
  a.download = (payload.name.replace(/[^\w\-]+/g,"_") || "mi_viaje") + ".json";
  a.click();
  URL.revokeObjectURL(a.href);
  renderTripList();
}


async function importTrip(ev) {
  const input = ev.target;
  const file = input?.files?.[0];
  if (!file) return;
  const txt = await file.text();

  try {
    const payload = JSON.parse(txt);
    if (!payload || !payload.state) throw new Error("Formato no v√°lido (falta state)");

    const meta = getMeta();
    const remoteAt = payload.savedAt ? Date.parse(payload.savedAt) : NaN;
    const localAtRaw = meta.lastSavedAt || meta.lastSyncAt || "";
    const localAt = localAtRaw ? Date.parse(localAtRaw) : NaN;

    if (Number.isFinite(remoteAt) && Number.isFinite(localAt) && remoteAt < localAt) {
      const r = new Date(payload.savedAt).toLocaleString();
      const l = new Date(localAtRaw).toLocaleString();
      const who = payload.deviceName ? `\n(Exportado por: ${payload.deviceName})` : "";
      const ok = confirm(`Vas a cargar una versi√≥n M√ÅS ANTIGUA.\n\nArchivo: ${r}${who}\nTu iPhone: ${l}\n\n¬øQuieres continuar?`);
      if (!ok) { input.value = ""; return; }
    } else if (!payload.savedAt) {
      const ok = confirm("El archivo no incluye fecha (savedAt). ¬øQuieres importar igualmente?");
      if (!ok) { input.value = ""; return; }
    }

    // Safety backup before overwrite
    pushBackup("before_import", { fromFileName: file.name, fromSavedAt: payload.savedAt || null, fromDevice: payload.deviceName || null });

    state = payload.state;
    saveState();
    closeModal();
    renderAll();

    const now = new Date().toISOString();
    setMeta({
      lastSyncAt: now,
      lastSyncedFromDevice: payload.deviceName || "Archivo",
      lastImportedSavedAt: payload.savedAt || null
    });

    alert("Viaje cargado.");
  } catch(e) {
    alert("No se pudo cargar: " + e.message);
  } finally {
    if (input) input.value = "";
  }
}


function renderTripList() {
  const box = $("tripList");
  if (!box) return;
  const list = JSON.parse(localStorage.getItem("miviaje.trip.list") || "[]");
  if (!list.length) { box.innerHTML = `<div class="text-sm text-slate-500">A√∫n no hay viajes guardados localmente.</div>`; return; }
  box.innerHTML = list.map((t, idx)=>`
    <button class="tap w-full text-left p-3 rounded-2xl border border-slate-200 bg-white hover:bg-slate-50" data-trip="${idx}">
      <div class="font-extrabold">${escapeHtml(t.name || "MI VIAJE")}</div>
      <div class="text-xs text-slate-500">${escapeHtml(t.savedAt || "")}${t.deviceName ? " ‚Ä¢ " + escapeHtml(t.deviceName) : ""}</div>
    </button>
  `).join("");
  box.querySelectorAll("[data-trip]").forEach(b => b.onclick = () => {
    const idx = parseInt(b.getAttribute("data-trip"),10);
    const payload = list[idx];
    if (!payload?.state) return;

    const meta = getMeta();
    const remoteAt = payload.savedAt ? Date.parse(payload.savedAt) : NaN;
    const localAtRaw = meta.lastSavedAt || meta.lastSyncAt || "";
    const localAt = localAtRaw ? Date.parse(localAtRaw) : NaN;

    if (Number.isFinite(remoteAt) && Number.isFinite(localAt) && remoteAt < localAt) {
      const r = new Date(payload.savedAt).toLocaleString();
      const l = new Date(localAtRaw).toLocaleString();
      const who = payload.deviceName ? `\n(Creado por: ${payload.deviceName})` : "";
      const ok = confirm(`Vas a cargar un viaje local M√ÅS ANTIGUO.\n\nViaje: ${r}${who}\nTu iPhone: ${l}\n\n¬øQuieres continuar?`);
      if (!ok) return;
    }

    pushBackup("before_local_load", { fromSavedAt: payload.savedAt || null, fromDevice: payload.deviceName || null });

    state = payload.state;
    saveState();

    setMeta({
      lastLoadedLocalAt: new Date().toISOString(),
      lastLoadedFrom: "local_list",
      lastLoadedTripSavedAt: payload.savedAt || null
    });

    closeModal();
    renderAll();
  });
}

/* ----------------------------- Events ----------------------------- */
$("tabA").addEventListener("click", ()=>{ state.scenario="A"; saveState(); renderAll(); });
$("tabB").addEventListener("click", ()=>{ state.scenario="B"; saveState(); renderAll(); });

$("displayCurrency").addEventListener("change", (e)=> setDisplayCurrency(e.target.value));

$("addLeg").addEventListener("click", ()=>{
  const sc = curScenario();
  sc.legs.push({ id: nowId(), from:"", to:"", date:"", cost:0, tzFrom:null, tzTo:null });
  saveState(); renderLegs(); renderTimeline(); calcSummary();
});
$("addStay").addEventListener("click", ()=>{
  const sc = curScenario();
  sc.stays.push({ id: nowId(), city:"", name:"", nights:1, cost:0 });
  saveState(); renderStays(); renderTimeline(); calcSummary();
});
$("addAct").addEventListener("click", ()=>{
  const sc = curScenario();
  sc.activities.push({ id: nowId(), title:"", city:"", date:"", cost:0, fromAI:false });
  saveState(); renderActivities(); renderTimeline(); calcSummary();
});

["mealDaily","mealPeople","mealDays"].forEach(id=>{
  $(id).addEventListener("input", ()=>{
    const sc = curScenario();
    sc.meals.daily = parseMoney($("mealDaily").value);
    sc.meals.people = Math.max(1, parseInt($("mealPeople").value||"1",10));
    sc.meals.days = Math.max(1, parseInt($("mealDays").value||"1",10));
    saveState(); renderMeals(); calcSummary();
  });
});

$("btnKey").addEventListener("click", ()=>{
  const cur = getGeminiKey();
  const key = prompt("Pega tu API Key de Gemini (AIza‚Ä¶):", cur ? "AIza..." : "");
  if (key && key.trim()) { setGeminiKey(key.trim()); alert("Clave guardada en este dispositivo."); }
});

$("aiPick").addEventListener("click", openAIPickModal);
$("aiGenerate").addEventListener("click", generateAIGuide);

$("btnTrips").addEventListener("click", openTripsModal);

$("btnCompare").addEventListener("click", ()=>{
  const a = state.scenarios.A;
  const b = state.scenarios.B;
  const tot = (sc) => sc.legs.reduce((x,y)=>x+parseMoney(y.cost),0)
    + sc.stays.reduce((x,y)=>x+parseMoney(y.cost),0)
    + sc.activities.reduce((x,y)=>x+parseMoney(y.cost),0)
    + parseMoney(sc.meals.daily) * (parseInt(sc.meals.people||1,10)) * (parseInt(sc.meals.days||1,10));
  const ta = tot(a), tb = tot(b);
  $("compareBox").classList.remove("hidden");
  $("compareBox").innerHTML = `
    <div class="font-extrabold">Comparativa (simple)</div>
    <div class="mt-2 flex justify-between"><span>A</span><span class="font-semibold">${ta.toFixed(2)} ${escapeHtml(state.displayCurrency)}</span></div>
    <div class="flex justify-between"><span>B</span><span class="font-semibold">${tb.toFixed(2)} ${escapeHtml(state.displayCurrency)}</span></div>
    <div class="mt-2 text-sm ${ta<=tb ? "text-emerald-700" : "text-emerald-700"}">
      Mejor: <b>${ta<=tb ? "A" : "B"}</b> (${Math.abs(ta-tb).toFixed(2)} de diferencia)
    </div>
  `;
});

/* Jump nav */
document.querySelectorAll("[data-jump]").forEach(b=>{
  b.addEventListener("click", ()=>{
    const key = b.getAttribute("data-jump");
    const btn = document.querySelector(`[data-acc="${key}"]`);
    const body = document.querySelector(`[data-acc-body="${key}"]`);
    if (body && body.classList.contains("hidden")) btn.click();
    btn.scrollIntoView({ behavior:"smooth", block:"start" });
  });
});

/* ----------------------------- Init ----------------------------- */
loadState();
setupAccordion();
renderAll();
</script>
</body>
</html>
