<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>MI VIAJE ¬∑ V104_TRANSPORT_AC</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    :root { color-scheme: light; }
    html, body { height: 100%; }
    body { -webkit-text-size-adjust: 100%; }
    input, select, textarea { font-size: 16px; } /* iOS no-zoom */
    .no-scrollbar::-webkit-scrollbar{ display:none; }
    .no-scrollbar{ -ms-overflow-style:none; scrollbar-width:none; }

    /* --- Autocomplete overlay (global) --- */
    #__acOverlay{
      position: fixed;
      z-index: 999999;
      display: none;
      background: white;
      border: 1px solid rgb(226 232 240);
      border-radius: 14px;
      box-shadow: 0 10px 25px rgba(0,0,0,.12);
      overflow: auto;
      -webkit-overflow-scrolling: touch;
      transform: translateZ(0);
      will-change: top,left,width,max-height;
    }
    #__acOverlay .ac-item{
      padding: 10px 12px;
      font-size: 14px;
      line-height: 1.2;
      display:flex;
      gap:10px;
      align-items:center;
      cursor:pointer;
    }
    #__acOverlay .ac-item:hover{ background: rgb(248 250 252); }
    #__acOverlay .ac-item:active{ background: rgb(241 245 249); }
    #__acOverlay .ac-meta{ font-size: 12px; color: rgb(100 116 139); }

    /* --- Sheet/body padding so keyboard + nav don't hide content --- */
    #eventSheetBody{ padding-bottom: calc(max(env(safe-area-inset-bottom), 16px) + 110px) !important; }
  </style>
</head>

<body class="bg-slate-50 text-slate-900">

  <!-- Top bar -->
  <header class="sticky top-0 z-30 bg-white/95 backdrop-blur border-b border-slate-200">
    <div class="max-w-xl mx-auto px-4 py-3 flex items-center justify-between">
      <div class="flex items-center gap-3">
        <div class="w-9 h-9 rounded-2xl bg-blue-600 text-white grid place-items-center font-bold">MV</div>
        <div>
          <div class="font-semibold leading-tight">MI VIAJE</div>
          <div class="text-xs text-slate-500 leading-tight">V104_TRANSPORT_AC</div>
        </div>
      </div>
      <div class="flex items-center gap-2">
        <button id="btnOpenSheet" class="px-3 py-2 rounded-2xl bg-blue-600 text-white text-sm font-semibold">Event Sheet</button>
      </div>
    </div>
  </header>

  <!-- Main -->
  <main class="max-w-xl mx-auto px-4 py-4 pb-28">
    <section class="space-y-3">
      <div class="flex items-center justify-between">
        <h2 class="text-lg font-semibold">Transporte</h2>
        <button id="btnAddLeg" class="px-3 py-2 rounded-2xl bg-slate-900 text-white text-sm font-semibold">A√±adir</button>
      </div>
      <div id="legCards" class="space-y-3"></div>
    </section>
  </main>

  <!-- Bottom nav (simple placeholder) -->
  <nav class="fixed bottom-0 left-0 right-0 z-20 bg-white border-t border-slate-200">
    <div class="max-w-xl mx-auto px-4 py-3 text-sm text-slate-600">
      Bottom Nav
    </div>
  </nav>

  <!-- Event Sheet -->
  <div id="sheetBackdrop" class="fixed inset-0 bg-black/40 z-40 hidden"></div>

  <div id="eventSheet" class="fixed inset-x-0 bottom-0 z-50 hidden">
    <div class="max-w-xl mx-auto">
      <div class="bg-white rounded-t-3xl border border-slate-200 shadow-2xl overflow-hidden">
        <div class="px-4 py-3 border-b border-slate-200 flex items-center justify-between">
          <div class="font-semibold">Event Sheet</div>
          <button id="btnCloseSheet" class="px-3 py-2 rounded-2xl bg-slate-100 text-slate-700 text-sm font-semibold">Cerrar</button>
        </div>

        <div id="eventSheetBody" class="max-h-[80vh] overflow-auto no-scrollbar px-4 py-4 space-y-4">
          <div class="flex items-center justify-between">
            <div class="font-semibold">Transporte</div>
            <button id="btnAddLegSheet" class="px-3 py-2 rounded-2xl bg-blue-600 text-white text-sm font-semibold">A√±adir tramo</button>
          </div>
          <div id="sheetLegList" class="space-y-4"></div>
        </div>
      </div>
    </div>
  </div>

  <!-- Autocomplete overlay (global) -->
  <div id="__acOverlay" role="listbox" aria-label="Sugerencias"></div>

<script>
/* =========================================================
   State (kept minimal + stable)
========================================================= */
const STORAGE_KEY = "miviaje_state_transport_v1";
function uid(prefix="id"){ return prefix + "_" + Math.random().toString(16).slice(2) + "_" + Date.now().toString(16); }

const defaultState = () => ({
  legs: []
});

let state = loadState();
function loadState(){
  try{
    const raw = localStorage.getItem(STORAGE_KEY);
    if(!raw) return defaultState();
    const s = JSON.parse(raw);
    if(!s || !Array.isArray(s.legs)) return defaultState();
    return s;
  }catch{ return defaultState(); }
}
function saveState(){
  try{ localStorage.setItem(STORAGE_KEY, JSON.stringify(state)); }catch{}
}

/* =========================================================
   Autocomplete core (overlay + positioning)
   - Cities AC + positioning already good; DO NOT change.
   - Uses fixed overlay and visualViewport offsets; always BELOW input.
========================================================= */
const __ac = {
  overlay: document.getElementById("__acOverlay"),
  activeInput: null,
  provider: null,
  onPick: null,
  maxItems: 8,
  hardCap: 260
};

function __acOpen(input, provider, onPick){
  __ac.activeInput = input;
  __ac.provider = provider;
  __ac.onPick = onPick;
  __acRefresh();
}

function __acClose(){
  __ac.overlay.style.display = "none";
  __ac.overlay.innerHTML = "";
  __ac.activeInput = null;
  __ac.provider = null;
  __ac.onPick = null;
}

function __acRefresh(){
  const input = __ac.activeInput;
  if(!input || !__ac.provider) return __acClose();

  const q = String(input.value || "");
  const items = (__ac.provider(q) || []).slice(0, __ac.maxItems);

  if(!items.length){
    __acClose();
    return;
  }

  // render
  const ov = __ac.overlay;
  ov.innerHTML = "";
  for(const it of items){
    const row = document.createElement("div");
    row.className = "ac-item";
    row.setAttribute("role","option");
    row.addEventListener("pointerdown", (e)=>{ e.preventDefault(); e.stopPropagation(); });
    row.addEventListener("mousedown", (e)=>{ e.preventDefault(); e.stopPropagation(); });
    row.addEventListener("click", (e)=>{
      e.preventDefault(); e.stopPropagation();
      try{ __ac.onPick && __ac.onPick(it); }catch{}
      __acClose();
      try{ input.focus({preventScroll:true}); }catch{ try{ input.focus(); }catch{} }
    });

    const main = document.createElement("div");
    main.className = "flex-1 min-w-0";
    const t = document.createElement("div");
    t.className = "font-semibold truncate";
    t.textContent = it.label ?? String(it);
    main.appendChild(t);

    if(it.meta){
      const m = document.createElement("div");
      m.className = "ac-meta truncate";
      m.textContent = it.meta;
      main.appendChild(m);
    }
    row.appendChild(main);
    ov.appendChild(row);
  }

  ov.style.display = "block";
  __acPosition();
}

function __acPosition(){
  const ov = __ac.overlay;
  const input = __ac.activeInput;
  if(!input || ov.style.display !== "block") return;

  const r = input.getBoundingClientRect();
  const vv = window.visualViewport || null;
  const vvOffTop  = vv ? vv.offsetTop  : 0;
  const vvOffLeft = vv ? vv.offsetLeft : 0;
  const vw = vv ? vv.width  : (window.innerWidth  || document.documentElement.clientWidth);
  const vh = vv ? vv.height : (window.innerHeight || document.documentElement.clientHeight);

  const left = Math.round(r.left + vvOffLeft);
  const width = Math.round(r.width);
  const top = Math.round(r.bottom + vvOffTop); // EXACTLY flush under input (no gap)

  const EDGE = 8;
  const clLeft = Math.min(Math.max(EDGE, left), Math.max(EDGE, vw - width - EDGE));
  const spaceBelow = (vh - EDGE) - top;
  const maxH = Math.max(0, Math.min(__ac.hardCap, Math.floor(spaceBelow)));

  ov.style.left = clLeft + "px";
  ov.style.top = top + "px";
  ov.style.width = width + "px";
  ov.style.maxHeight = maxH + "px";
}

function __attachAutocomplete(input, provider, onPick){
  if(!input) return;

  const onInput = ()=> __acOpen(input, provider, onPick);
  input.addEventListener("input", onInput);
  input.addEventListener("focus", onInput);

  let blurT = null;
  input.addEventListener("blur", ()=>{
    clearTimeout(blurT);
    blurT = setTimeout(()=>__acClose(), 120);
  });
}

/* Keep overlay anchored on scroll/resize/visualViewport */
function __bindAcReposition(){
  const sheet = document.getElementById("eventSheetBody");
  if(sheet) sheet.addEventListener("scroll", ()=>__acPosition(), {passive:true});
  window.addEventListener("resize", ()=>__acPosition(), {passive:true});
  if(window.visualViewport){
    window.visualViewport.addEventListener("resize", ()=>__acPosition(), {passive:true});
    window.visualViewport.addEventListener("scroll", ()=>__acPosition(), {passive:true});
  }
}
__bindAcReposition();

/* =========================================================
   Data: Airports + Cities (kept as-is)
========================================================= */
const __AIRPORT_DB = [
  { iata:"MAD", name:'Adolfo Su√°rez Madrid‚ÄìBarajas', city:'Madrid', country:"ES", tz:"Europe/Madrid" },
  { iata:"BCN", name:'Josep Tarradellas Barcelona‚ÄìEl Prat', city:'Barcelona', country:"ES", tz:"Europe/Madrid" },
  { iata:"VLC", name:'Valencia', city:'Valencia', country:"ES", tz:"Europe/Madrid" },
  { iata:"SVQ", name:'Sevilla', city:'Sevilla', country:"ES", tz:"Europe/Madrid" },
  { iata:"LIS", name:'Humberto Delgado', city:'Lisboa', country:"PT", tz:"Europe/Lisbon" },
  { iata:"OPO", name:'Francisco S√° Carneiro', city:'Oporto', country:"PT", tz:"Europe/Lisbon" },
  { iata:"CDG", name:'Charles de Gaulle', city:'Par√≠s', country:"FR", tz:"Europe/Paris" },
  { iata:"ORY", name:'Orly', city:'Par√≠s', country:"FR", tz:"Europe/Paris" },
  { iata:"LHR", name:'Heathrow', city:'Londres', country:"UK", tz:"Europe/London" },
  { iata:"LGW", name:'Gatwick', city:'Londres', country:"UK", tz:"Europe/London" },
  { iata:"FCO", name:'Fiumicino', city:'Roma', country:"IT", tz:"Europe/Rome" },
  { iata:"MXP", name:'Malpensa', city:'Mil√°n', country:"IT", tz:"Europe/Rome" },
  { iata:"BER", name:'Berlin Brandenburg', city:'Berl√≠n', country:"DE", tz:"Europe/Berlin" },
  { iata:"MUC", name:'Munich', city:'M√∫nich', country:"DE", tz:"Europe/Berlin" },
  { iata:"AMS", name:'Schiphol', city:'√Åmsterdam', country:"NL", tz:"Europe/Amsterdam" },
  { iata:"BRU", name:'Brussels', city:'Bruselas', country:"BE", tz:"Europe/Brussels" },
  { iata:"ZRH", name:'Zurich', city:'Z√∫rich', country:"CH", tz:"Europe/Zurich" },
  { iata:"VIE", name:'Vienna', city:'Viena', country:"AT", tz:"Europe/Vienna" },
  { iata:"PRG", name:'V√°clav Havel', city:'Praga', country:"CZ", tz:"Europe/Prague" },
  { iata:"BUD", name:'Ferenc Liszt', city:'Budapest', country:"HU", tz:"Europe/Budapest" },
  { iata:"DUB", name:'Dublin', city:'Dubl√≠n', country:"IE", tz:"Europe/Dublin" },
  { iata:"ATH", name:'Athens', city:'Atenas', country:"GR", tz:"Europe/Athens" },
  { iata:"JFK", name:'John F. Kennedy', city:'New York', country:"US", tz:"America/New_York" },
  { iata:"LAX", name:'Los Angeles', city:'Los Angeles', country:"US", tz:"America/Los_Angeles" },
  { iata:"SFO", name:'San Francisco', city:'San Francisco', country:"US", tz:"America/Los_Angeles" },
  { iata:"NRT", name:'Narita', city:'Tokyo', country:"JP", tz:"Asia/Tokyo" },
  { iata:"HND", name:'Haneda', city:'Tokyo', country:"JP", tz:"Asia/Tokyo" },
  { iata:"SYD", name:'Sydney', city:'Sydney', country:"AU", tz:"Australia/Sydney" },
  { iata:"AKL", name:'Auckland', city:'Auckland', country:"NZ", tz:"Pacific/Auckland" }
];

/* ========= Transport places DB (for placeOut/placeIn autocomplete) ========= */
const __TRAIN_PLACE_DB = [
  { name:"Madrid-Puerta de Atocha", city:"Madrid" },
  { name:"Madrid-Chamart√≠n", city:"Madrid" },
  { name:"Barcelona-Sants", city:"Barcelona" },
  { name:"Valencia Joaqu√≠n Sorolla", city:"Valencia" },
  { name:"Sevilla-Santa Justa", city:"Sevilla" },
  { name:"M√°laga-Mar√≠a Zambrano", city:"M√°laga" },
  { name:"Zaragoza-Delicias", city:"Zaragoza" },
  { name:"Alicante-Terminal", city:"Alicante" },
  { name:"C√≥rdoba Central", city:"C√≥rdoba" },
  { name:"Granada", city:"Granada" }
];

const __BUS_PLACE_DB = [
  { name:"Estaci√≥n Sur de Autobuses (M√©ndez √Ålvaro)", city:"Madrid" },
  { name:"Intercambiador de Avenida de Am√©rica", city:"Madrid" },
  { name:"Estaci√≥ del Nord (Autobuses)", city:"Barcelona" },
  { name:"Estaci√≥n de Autobuses de Valencia", city:"Valencia" },
  { name:"Estaci√≥n de Autobuses Plaza de Armas", city:"Sevilla" },
  { name:"Estaci√≥n de Autobuses de M√°laga", city:"M√°laga" },
  { name:"Estaci√≥n de Autobuses de Bilbao", city:"Bilbao" },
  { name:"Estaci√≥n de Autobuses de San Sebasti√°n", city:"San Sebasti√°n" }
];

const __PORT_PLACE_DB = [
  { name:"Puerto de Barcelona", city:"Barcelona" },
  { name:"Puerto de Valencia", city:"Valencia" },
  { name:"Puerto de Palma", city:"Palma" },
  { name:"Puerto de Ibiza", city:"Ibiza" },
  { name:"Puerto de M√°laga", city:"M√°laga" },
  { name:"Puerto de C√°diz", city:"C√°diz" },
  { name:"Puerto de Las Palmas", city:"Las Palmas" },
  { name:"Puerto de Santa Cruz de Tenerife", city:"Santa Cruz de Tenerife" }
];

const __CITY_DB = [
  { name:"Madrid", country:"ES" },
  { name:"Barcelona", country:"ES" },
  { name:"Valencia", country:"ES" },
  { name:"Sevilla", country:"ES" },
  { name:"Lisboa", country:"PT" },
  { name:"Oporto", country:"PT" },
  { name:"Par√≠s", country:"FR" },
  { name:"Londres", country:"UK" },
  { name:"Roma", country:"IT" },
  { name:"Mil√°n", country:"IT" },
  { name:"Berl√≠n", country:"DE" },
  { name:"M√∫nich", country:"DE" },
  { name:"√Åmsterdam", country:"NL" },
  { name:"Bruselas", country:"BE" },
  { name:"Z√∫rich", country:"CH" },
  { name:"Viena", country:"AT" },
  { name:"Praga", country:"CZ" },
  { name:"Budapest", country:"HU" },
  { name:"Dubl√≠n", country:"IE" },
  { name:"Atenas", country:"GR" }
];

function __cityProvider(q){
  const qq = String(q||"").trim().toLowerCase();
  const out = [];
  const push = (c)=> out.push({ label: `${c.name} (${c.country})`, value: c.name });

  if(!qq){
    for(const c of __CITY_DB){ push(c); if(out.length>=8) break; }
    return out;
  }
  for(const c of __CITY_DB){
    const s = (c.name+" "+c.country).toLowerCase();
    if(s.startsWith(qq)){ push(c); if(out.length>=8) break; }
  }
  if(out.length<8){
    for(const c of __CITY_DB){
      if(out.length>=8) break;
      const s = (c.name+" "+c.country).toLowerCase();
      if(!s.startsWith(qq) && s.includes(qq)) push(c);
    }
  }
  return out.slice(0,8);
}

function __airportProvider(q){
  const qq = String(q||"").trim().toLowerCase();
  const out = [];
  const push = (a)=> out.push(a);

  if(!qq){
    for(const a of __AIRPORT_DB){ push(a); if(out.length>=8) break; }
    return out;
  }

  // 1) IATA startswith for 1-3 letters
  for(const a of __AIRPORT_DB){
    const i = (a.iata||"").toLowerCase();
    if(i.startsWith(qq)){
      push(a);
      if(out.length>=8) break;
    }
  }
  // 2) name/city matches
  if(out.length<8){
    for(const a of __AIRPORT_DB){
      if(out.length>=8) break;
      const s = (a.name+" "+a.city+" "+a.iata).toLowerCase();
      if(!String(a.iata||"").toLowerCase().startsWith(qq) && s.includes(qq)){
        push(a);
      }
    }
  }
  return out.slice(0,8);
}

function __genericPlaceProvider(q, db){
  const qq = String(q||"").trim().toLowerCase();
  const out = [];
  const push = (p)=>{
    out.push({
      kind:"place",
      label: `${p.name}${p.city ? " ("+p.city+")" : ""}`,
      value: p.name,
      city: p.city || ""
    });
  };
  if(!qq){
    for(const p of db){ push(p); if(out.length>=8) break; }
    return out;
  }
  for(const p of db){
    const s = (p.name+" "+(p.city||"")).toLowerCase();
    if(s.startsWith(qq)){ push(p); if(out.length>=8) break; }
  }
  if(out.length<8){
    for(const p of db){
      if(out.length>=8) break;
      const s = (p.name+" "+(p.city||"")).toLowerCase();
      if(!s.startsWith(qq) && s.includes(qq)) push(p);
    }
  }
  return out.slice(0,8);
}

function __placeProviderByMode(mode, q){
  const m = String(mode||"plane").toLowerCase();
  if(m==="plane" || m==="flight" || m==="avion" || m==="avi√≥n"){
    const airports = __airportProvider(q) || [];
    return airports.slice(0,8).map(a=>{
      const code = a.iata || "";
      const name = a.name || "";
      const city = a.city || "";
      const display = (code && name) ? `${code} ¬∑ ${name}` : (code || name);
      return {
        kind:"plane",
        label: `${display}${city ? " ("+city+")" : ""}`,
        value: display,
        display,
        iata: code,
        city
      };
    });
  }
  if(m==="train") return __genericPlaceProvider(q, __TRAIN_PLACE_DB);
  if(m==="bus") return __genericPlaceProvider(q, __BUS_PLACE_DB);
  if(m==="boat" || m==="ferry") return __genericPlaceProvider(q, __PORT_PLACE_DB);
  return []; // car/other
}

function __getLegModeFromWrap(wrap){
  try{
    const root = wrap?.closest?.("[data-legid], [data-leg-id], .legBlock, .sheetLegBlock, .sheet-block, .card, .rounded-2xl") || wrap;
    const btn = root?.querySelector?.('[data-legmode][aria-pressed="true"], [data-leg-mode][aria-pressed="true"], .legModeChip[aria-pressed="true"]');
    const v = btn ? (btn.getAttribute("data-legmode") || btn.getAttribute("data-leg-mode")) : "";
    if(v) return v;
    const sel = root?.querySelector?.('select[name="mode"], select[data-k="mode"], select[data-mode]');
    if(sel && sel.value) return sel.value;
  }catch{}
  return "plane";
}

/* =========================================================
   Sheet UI rendering
========================================================= */
function legModeIcon(m){
  const v = String(m||"plane");
  if(v==="plane") return "‚úàÔ∏è";
  if(v==="train") return "üöÜ";
  if(v==="bus") return "üöå";
  if(v==="car") return "üöó";
  return "üö¢";
}
function legModeLabel(m){
  const v = String(m||"plane");
  return (v==="plane") ? "Avi√≥n" : (v==="train") ? "Tren" : (v==="bus") ? "Bus" : (v==="car") ? "Coche" : "Barco";
}

function __dispatchInputChange(el){
  try{ el.dispatchEvent(new Event("input",{bubbles:true})); }catch{}
  try{ el.dispatchEvent(new Event("change",{bubbles:true})); }catch{}
}

function render(){
  renderCards();
  renderSheet();
  saveState();
}

function renderCards(){
  const host = document.getElementById("legCards");
  host.innerHTML = "";
  if(!state.legs.length){
    host.innerHTML = `<div class="text-sm text-slate-500">Sin tramos todav√≠a.</div>`;
    return;
  }
  for(const leg of state.legs){
    const card = document.createElement("div");
    card.className = "bg-white border border-slate-200 rounded-3xl p-4 space-y-2";
    card.innerHTML = `
      <div class="flex items-start justify-between gap-3">
        <div>
          <div class="font-semibold">${legModeIcon(leg.mode)} ${legModeLabel(leg.mode)}</div>
          <div class="text-xs text-slate-500">${leg.from || "‚Äî"} ‚Üí ${leg.to || "‚Äî"}</div>
        </div>
        <button class="px-3 py-2 rounded-2xl bg-slate-100 text-slate-700 text-sm font-semibold" data-edit="${leg.id}">Editar</button>
      </div>
      <div class="text-sm">
        <div><span class="text-slate-500">Lugar salida:</span> ${leg.placeOut || "‚Äî"}</div>
        <div><span class="text-slate-500">Lugar llegada:</span> ${leg.placeIn || "‚Äî"}</div>
      </div>
    `;
    card.querySelector('[data-edit]')?.addEventListener("click", ()=>{
      openSheet();
      setTimeout(()=>{
        const el = document.querySelector(`[data-legid="${leg.id}"]`);
        try{ el?.scrollIntoView({behavior:"smooth", block:"start"}); }catch{}
      }, 50);
    });
    host.appendChild(card);
  }
}

function renderSheet(){
  const host = document.getElementById("sheetLegList");
  host.innerHTML = "";
  for(const leg of state.legs){
    host.appendChild(buildLegBlock(leg));
  }
}

function buildLegBlock(leg){
  const wrap = document.createElement("div");
  wrap.className = "bg-slate-50 border border-slate-200 rounded-3xl p-4 space-y-3";
  wrap.setAttribute("data-legid", leg.id);

  const modes = [
    {key:"plane", label:"Avi√≥n"},
    {key:"train", label:"Tren"},
    {key:"bus", label:"Bus"},
    {key:"car", label:"Coche"},
    {key:"boat", label:"Barco"}
  ];

  wrap.innerHTML = `
    <div class="flex items-center justify-between">
      <div class="font-semibold">Tramo</div>
      <button class="px-3 py-2 rounded-2xl bg-red-50 text-red-700 text-sm font-semibold" data-del>Eliminar</button>
    </div>

    <div class="flex gap-2 overflow-x-auto no-scrollbar pb-1">
      ${modes.map(m=>{
        const active = (leg.mode||"plane") === m.key;
        const cls = "legModeChip px-4 py-2 rounded-2xl border text-sm font-semibold whitespace-nowrap " +
          (active ? "bg-slate-900 text-white border-slate-900" : "bg-white text-slate-700 border-slate-200");
        return `<button type="button" class="${cls}" data-legmode="${m.key}" aria-pressed="${active ? "true" : "false"}">${legModeIcon(m.key)} ${m.label}</button>`;
      }).join("")}
    </div>

    <div class="grid grid-cols-2 gap-3">
      <div class="space-y-1">
        <div class="text-xs text-slate-500">Ciudad salida</div>
        <input class="w-full border border-slate-200 rounded-2xl px-3 py-2 bg-white"
          data-sheet-leg="from" value="${escapeHtml(leg.from||"")}" placeholder="Ciudad salida" />
      </div>
      <div class="space-y-1">
        <div class="text-xs text-slate-500">Ciudad llegada</div>
        <input class="w-full border border-slate-200 rounded-2xl px-3 py-2 bg-white"
          data-sheet-leg="to" value="${escapeHtml(leg.to||"")}" placeholder="Ciudad llegada" />
      </div>

      <div class="space-y-1">
        <div class="text-xs text-slate-500">Lugar salida</div>
        <input class="w-full border border-slate-200 rounded-2xl px-3 py-2 bg-white"
          data-sheet-leg="placeOut" value="${escapeHtml(leg.placeOut||"")}" placeholder="Aeropuerto / estaci√≥n / puerto" />
      </div>
      <div class="space-y-1">
        <div class="text-xs text-slate-500">Lugar llegada</div>
        <input class="w-full border border-slate-200 rounded-2xl px-3 py-2 bg-white"
          data-sheet-leg="placeIn" value="${escapeHtml(leg.placeIn||"")}" placeholder="Aeropuerto / estaci√≥n / puerto" />
      </div>

      <div class="space-y-1">
        <div class="text-xs text-slate-500">Zona horaria salida</div>
        <input class="w-full border border-slate-200 rounded-2xl px-3 py-2 bg-white"
          data-sheet-leg="tzFrom" value="${escapeHtml(leg.tzFrom||"")}" placeholder="Europe/Madrid" />
      </div>
      <div class="space-y-1">
        <div class="text-xs text-slate-500">Zona horaria llegada</div>
        <input class="w-full border border-slate-200 rounded-2xl px-3 py-2 bg-white"
          data-sheet-leg="tzTo" value="${escapeHtml(leg.tzTo||"")}" placeholder="Europe/Paris" />
      </div>
    </div>
  `;

  wrap.querySelectorAll("[data-legmode]").forEach(btn=>{
    btn.addEventListener("click", ()=>{
      const m = btn.getAttribute("data-legmode") || "plane";
      leg.mode = m;
      wrap.querySelectorAll("[data-legmode]").forEach(b=>{
        const active = (b.getAttribute("data-legmode")===m);
        b.setAttribute("aria-pressed", active ? "true":"false");
        b.className = "legModeChip px-4 py-2 rounded-2xl border text-sm font-semibold whitespace-nowrap " +
          (active ? "bg-slate-900 text-white border-slate-900" : "bg-white text-slate-700 border-slate-200");
      });
      saveState();
      try{ __acPosition(); }catch{}
    });
  });

  wrap.querySelector("[data-del]")?.addEventListener("click", ()=>{
    state.legs = state.legs.filter(x=>x.id !== leg.id);
    render();
  });

  const fromCity = wrap.querySelector('[data-sheet-leg="from"]');
  const toCity   = wrap.querySelector('[data-sheet-leg="to"]');
  const outPlace = wrap.querySelector('[data-sheet-leg="placeOut"]');
  const inPlace  = wrap.querySelector('[data-sheet-leg="placeIn"]');
  const tzFrom   = wrap.querySelector('[data-sheet-leg="tzFrom"]');
  const tzTo     = wrap.querySelector('[data-sheet-leg="tzTo"]');

  __attachAutocomplete(fromCity, __cityProvider, (it)=>{
    fromCity.value = it.label; __dispatchInputChange(fromCity);
    leg.from = fromCity.value; saveState();
  });
  __attachAutocomplete(toCity, __cityProvider, (it)=>{
    toCity.value = it.label; __dispatchInputChange(toCity);
    leg.to = toCity.value; saveState();
  });

  __attachAutocomplete(outPlace, (q)=>__placeProviderByMode(__getLegModeFromWrap(wrap), q), (it)=>{
    const isPlane = (it && it.kind === "plane");
    outPlace.value = (isPlane ? (it.display || it.value || it.label) : (it.value || it.label || ""));
    __dispatchInputChange(outPlace);
    leg.placeOut = outPlace.value;

    if(fromCity && !String(fromCity.value||"").trim() && it && it.city){
      fromCity.value = it.city; __dispatchInputChange(fromCity);
      leg.from = fromCity.value;
    }
    if(isPlane && it && it.iata){
      const a = __AIRPORT_DB.find(x=>x.iata===it.iata);
      if(a && tzFrom && !String(tzFrom.value||"").trim()){
        tzFrom.value = a.tz || ""; __dispatchInputChange(tzFrom);
        leg.tzFrom = tzFrom.value;
      }
    }
    saveState();
  });

  __attachAutocomplete(inPlace, (q)=>__placeProviderByMode(__getLegModeFromWrap(wrap), q), (it)=>{
    const isPlane = (it && it.kind === "plane");
    inPlace.value = (isPlane ? (it.display || it.value || it.label) : (it.value || it.label || ""));
    __dispatchInputChange(inPlace);
    leg.placeIn = inPlace.value;

    if(toCity && !String(toCity.value||"").trim() && it && it.city){
      toCity.value = it.city; __dispatchInputChange(toCity);
      leg.to = toCity.value;
    }
    if(isPlane && it && it.iata){
      const a = __AIRPORT_DB.find(x=>x.iata===it.iata);
      if(a && tzTo && !String(tzTo.value||"").trim()){
        tzTo.value = a.tz || ""; __dispatchInputChange(tzTo);
        leg.tzTo = tzTo.value;
      }
    }
    saveState();
  });

  [fromCity,toCity,outPlace,inPlace,tzFrom,tzTo].forEach((el)=>{
    if(!el) return;
    el.addEventListener("input", ()=>{
      const k = el.getAttribute("data-sheet-leg");
      if(k==="from") leg.from = el.value;
      if(k==="to") leg.to = el.value;
      if(k==="placeOut") leg.placeOut = el.value;
      if(k==="placeIn") leg.placeIn = el.value;
      if(k==="tzFrom") leg.tzFrom = el.value;
      if(k==="tzTo") leg.tzTo = el.value;
      saveState();
    });
  });

  return wrap;
}

function escapeHtml(s){
  return String(s||"")
    .replaceAll("&","&amp;")
    .replaceAll("<","&lt;")
    .replaceAll(">","&gt;")
    .replaceAll('"',"&quot;")
    .replaceAll("'","&#039;");
}

/* =========================================================
   Sheet open/close + add leg
========================================================= */
function openSheet(){
  document.getElementById("sheetBackdrop").classList.remove("hidden");
  document.getElementById("eventSheet").classList.remove("hidden");
  document.body.style.overflow = "hidden";
}
function closeSheet(){
  document.getElementById("sheetBackdrop").classList.add("hidden");
  document.getElementById("eventSheet").classList.add("hidden");
  document.body.style.overflow = "";
  __acClose();
}

document.getElementById("btnOpenSheet").addEventListener("click", openSheet);
document.getElementById("btnCloseSheet").addEventListener("click", closeSheet);
document.getElementById("sheetBackdrop").addEventListener("click", closeSheet);

function addLeg(){
  state.legs.unshift({
    id: uid("leg"),
    mode: "plane",
    from: "",
    to: "",
    placeOut: "",
    placeIn: "",
    tzFrom: "",
    tzTo: ""
  });
  render();
  openSheet();
  setTimeout(()=>{
    const first = document.querySelector('#sheetLegList [data-sheet-leg="from"]');
    try{ first?.focus({preventScroll:true}); }catch{ try{ first?.focus(); }catch{} }
  }, 60);
}

document.getElementById("btnAddLeg").addEventListener("click", addLeg);
document.getElementById("btnAddLegSheet").addEventListener("click", addLeg);

/* =========================================================
   Init
========================================================= */
render();
</script>

</body>
</html>
